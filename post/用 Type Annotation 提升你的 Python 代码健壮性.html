<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>用 Type Annotation 提升你的 Python 代码健壮性 | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/oDi_oBCBuu3qj6v7hDnrL/_buildManifest.js" defer=""></script><script src="/_next/static/oDi_oBCBuu3qj6v7hDnrL/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><h1 id="用-type-annotation-提升你的-python-代码健壮性"><a class="v-toc-item" href="#用-type-annotation-提升你的-python-代码健壮性">#</a> 用 Type Annotation 提升你的 Python 代码健壮性</h1>
<h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>本文是《提升你的 Python 项目代码健壮性和性能》系列的第一篇文章。</p>
<p>当我刚知道 Python 要添加类型的时候，我的内心是拒绝的。</p>
<p>Why, Why, Why? 就是因为不喜欢类型，也不喜欢特别动态的语言。</p>
<p>但是，尝试了俩个疗程之后，腰也不疼了，腿也不疼了，走起路来都有劲了</p>
<blockquote>
<p>嗯，真香。</p>
</blockquote>
<h2 id="0x01-why-type-annotation"><a class="v-toc-item" href="#0x01-why-type-annotation">#</a> 0x01 Why Type Annotation</h2>
<p>人们常说</p>
<blockquote>
<p>动态类型一时爽，代码重构火葬场。</p>
</blockquote>
<p>在刚写 Python 的前两年里并没有感受很深。</p>
<p>直到，开始和别人协作的时候，才发现各种莫名其妙的问题。</p>
<ol>
<li>大量的使用魔法方法</li>
<li>flake8 分析出某个函数过于复杂</li>
<li>send_message 里面有不少的参数，一不小心就传参错误</li>
<li>None 值</li>
</ol>
<p>动态类型给人极大的灵活性，写的时候很爽，但如果解放了双手，撸起袖子一通写，自己写起来爽了，自己重构的时候或者其他人来看代码的时候，头发就会加速掉落。</p>
<p>聪明的你很容易反问，只要我们团队不犯这些错误，不就好了么？</p>
<p>是的，当我们讨论 Python Annotation 的时候，往往陷入类型之争。</p>
<p>我并不想讨论静态类型和动态类型孰好孰坏。</p>
<p>我想讨论的是<strong>加了 Typing 极大的提升代码的健壮性。</strong></p>
<p>先从 Gradual Typing 说起吧。</p>
<h2 id="0x02-gradual-typing"><a class="v-toc-item" href="#0x02-gradual-typing">#</a> 0x02 Gradual Typing</h2>
<p>在你刚入门一门编程语言的时候，我们常常说，Java 是强类型静态语言，Python 是强类型动态语言</p>
<p>从这两位诞生开始，静态类型和动态类型就一直进行旷日持久的圣战。</p>
<p>然而，而现在的发展趋势是：</p>
<ul>
<li>静态类型的语言觉得自己太过静态，以至于写起来很啰嗦。于是引入了很多类型推断。 Java / Go</li>
<li>动态类型的语言觉得自己太过动态，以至于协作的过程中总是出现低级错误。于是引入了 Gradual Typing , Typescript / Flow / Python Type Annotation</li>
</ul>
<p>什么是 Gradual Typing?</p>
<p>Gradual typing 允许开发者仅在程序的部分地区使用 Annotate/Type. 即，既不是黑猫（静态）, 也不是白猫（动态），从而诞生了熊猫（动静结合）。</p>
<p>话说回来，要知道为什么这么搞，首先要知道动态类型和静态类型会给程序带来什么。</p>
<h3 id="静态类型-vs-动态类型"><a class="v-toc-item" href="#静态类型-vs-动态类型">#</a> 静态类型 VS 动态类型</h3>
<p>静态类型的语言，比如在写 Java 的时候，如果你把一个 int 赋值给了 string 的变量，IDE 会通过<strong>类型检查器</strong>立即报错并告诉你，你这个值赋值错啦。这个就是 Java 程序的检查阶段。 动态类型的语言，比如在写<br>
Python 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。如果线上还是出这个问题，就蛋疼了。</p>
<p>为了进行友好的讨论，本人将精分成 Javaer 和 Pythonist, 通过两人对话的方式，来讨论类型。</p>
<ul>
<li>
<p>Javaer: 我先喝杯咖啡</p>
</li>
<li>
<p>Pythonist: 生命苦短，我用 Python。</p>
</li>
<li>
<p>Javaer: P 哥，请（为什么叫 P 哥？Python 1989 年出生，Java 1995 年）</p>
</li>
<li>
<p>Pythonist: J 弟，请</p>
</li>
<li>
<p>Javaer: 静态类型可以较低成本的提早捕获 BUG, 比如：</p>
<ol>
<li>你在写 Python 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。</li>
<li>如果线上还是出这个问题，就蛋疼了。我这个类型检查可以在<strong>使用 IDE 的时候给我分析出方法参数的类型和返回值</strong>。所谓『上医治未病，中医治已病，下医治大病』, 防范于未然，善之善者也。</li>
</ol>
</li>
<li>
<p>Python: 等等，你小子还广征博引了还，首先，提早捕获 Bug, 我这里也有呀，比如我这里可以通过 flake8 来检查出有些没有定义的变量，<strong>仅仅是类型没有检查而已</strong>。其次，IDE<br>
给我的补全又不是完全无法补全。弱一点罢了。你说的类型检查的问题：</p>
<ol>
<li>可以通过<strong>提升程序员的素质</strong>来解决这个问题，或者让他们长点脑子，别特么在这种低级错误上犯错误。</li>
<li>写测试来<strong>提升测试代码的代码覆盖率</strong>（这个我会在本系列的第二篇文章里深入讲解）来解决这个问题</li>
<li>看看写的代码检查时出现问题，我完全可以<strong>把代码拖到 IPython 里面跑一遍</strong>。这可不仅仅能解决类型不正确带来的问题，还能快速解决代码的逻辑问题</li>
</ol>
</li>
<li>
<p>Java: 关于你说的第三点，我完全可以提升测试代码的覆盖率。哎？似乎我这个开发测试成本也上来了。看来<strong>类型检查也不能解决这个问题</strong></p>
</li>
<li>
<p>Javaer: 来 P 哥</p>
<ol>
<li>静态类型确实以<strong>较低的成本</strong>解决了这种类型的问题，不是么？</li>
<li>并且，如果我其中一小块功能进行了修改，我总不能每次都跑 IPython 吧？我也不能因为想检查一下类型这种小操作就写测试代码覆盖一下？</li>
</ol>
</li>
<li>
<p>Python: 你每次修改，都要加类型，加类型，改类型，直到类型检查器完全接受。不麻烦嘛？面向类型检查器编程？</p>
</li>
<li>
<p>Javaer: 来，</p>
<ol>
<li>每次改代码的时候，又不是改一大推，你是小部分改的，能有多少项目是海量海量改？高内聚，低耦合，模块化开发。</li>
<li>好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。</li>
<li>我大 Java 就是面向重构的语言！我有 Jetbrain 的 IDE, 重构代码我怕谁</li>
</ol>
</li>
<li>
<p>Python: 来，你说的没错，</p>
<ol>
<li><strong>每次改代码的时候，又不是改一大推，你是小部分改的</strong>。这话你说的没错，我也能用啊，因为代码总是一小部分一小部分改的，所以，改完了跑一下 IPython 就结了。</li>
<li>好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。这话你说的也没错，可<strong>我重构的时候没有写测试就重构</strong>，是不是有点莽撞？写了测试了，我还要花时间在类型检查器上，不啰嗦么？</li>
<li>我也有 Jetbrain 的 IDE, 重构代码我又不是不能重构。</li>
</ol>
</li>
<li>
<p>Python: 再来，</p>
<ol>
<li>需求变更上来了，结果往往会出现，你本来是想专注于业务逻辑的更改的，但最后变成了大型<strong>为了让类型检查器通过类型检查而艰苦奋斗的现场</strong>, 我这个场景直接传 int/str/ 字典 / 传对象就很方便，你非要让我写四个函数来<br>
override 方法。</li>
<li>虽然说，好代码确实可以通过重构出来，但动态语言表达能力强呀，你 Java HashMap 啰啰嗦嗦 put 写了半天，我 Python 一个 Dict 一把梭，看起来，清晰，改起来方便。</li>
</ol>
</li>
</ul>
<p>再比如说，</p>
<p>LeetCode 上面有一道题目，叫做最长连续 1</p>
<p>Input 是 [1,1,0,1,1,1] Output 是 3</p>
<p>我们尝试用 Python 来看下</p>
<pre><code class="language-python">def <span class="token function">find_max_consecutive_ones</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>lambda x<span class="token operator">:</span> <span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">for</span> num <span class="token keyword">in</span> nums<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>我们尝试用 Java 来看下</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> int <span class="token function">findMaxConsecutiveOnes</span><span class="token punctuation">(</span><span class="token parameter">int<span class="token punctuation">[</span><span class="token punctuation">]</span> nums</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		int result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		int tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
				tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				tmp <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				result <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>Javaer: 啊咧？P 哥你确实有点短啊！</li>
<li>Pythonist: 你敢说我短？你看看 java 的创始人的头发！</li>
</ul>
<p>『贴图』</p>
<ul>
<li>
<p>Javaer: 我不是那个意思，浓缩就是精华嘛，表达能力弱又怎么样，我 Javaer 可以直接封装好这个功能当成工具类用，从外部使用上用起来差不多好吧，从项目角度表达力并不是决定性因素，静态类型检查可以提早在编译阶段做字节码优化。你的<br>
GIL…</p>
</li>
<li>
<p>Pythonist: 好了，咱就不要提 GIL 了</p>
</li>
<li>
<p>Pythonist: 动态类型不需要花时间写 type annotation, 写起来速度杠杠的。</p>
</li>
<li>
<p>Javaer: 静态语言一时爽，动态类型火葬场好伐？举个例子，太动态的东西，就是不好做类型推断，比如贵圈的著名的 sqlalchemy 做的那么动态，query.get() 结合 flask<br>
来用，YouModel.query.get() 出来的 YouModel 你还要点进去查看一下具体属性，你要用 title 还是 name, 拼错了，怎么办？都不报错的。</p>
</li>
<li>
<p>Javaer: 静态类型迫使你思考程序的时候更加严谨认真，这将会提升你的代码质量。</p>
</li>
<li>
<p>Pythonist: 这点我是不服的，你只是花费了大量的时间在类型检查上，写的认不认真不完全取决于你编程的水平和态度好伐？假如你的观点成立，语言只是武器，峨眉师太拿一把倚天剑，不还是被张三丰空手取来？</p>
</li>
<li>
<p>Javaer: 但你不能否认，峨眉师太拿着倚天剑确实可以秒杀很多人。</p>
</li>
</ul>
<blockquote>
<p>旁白君：有道是，梅须逊雪三分白，雪却输梅一段香。</p>
</blockquote>
<ul>
<li>Guido van Rossum: 好了，我觉得类型不错，我在 dropbox 带领团队实现了 python 的 typing，python 3.7 内置哦。</li>
<li>Pythonist: 我自己打脸一下，动态类型花点时间写 type annotation 代码健壮性杠杠的。</li>
<li>Javaer: 你走开… 你怎么不去解决 GIL 的问题。</li>
</ul>
<h3 id="静态类型-动态类型"><a class="v-toc-item" href="#静态类型-动态类型">#</a> 静态类型 + 动态类型</h3>
<p>Gradual Typing 就是在动态语言的基础上，增加了可选的类型声明 (Type Annotation)</p>
<p>这对于我这种人是福音，</p>
<p>对于我个人而言，我是希望 Python 是有类型的</p>
<ol>
<li>作为某段程序的开发者和维护者，我可以提升我重构的速度。</li>
<li>作为某段程序的调用方，可以快速的知道我调用后得到的东西究竟是什么。</li>
</ol>
<p>但我又不希望这个声明不是强制性的</p>
<ol>
<li>我在构思程序的时候，想专注于接口的设计。在落实编码并且把代码写的足够的 dry 之后，在被调用的一些地方加上类型声明，这样可以提升我写代码的速度。</li>
</ol>
<h2 id="0x03-python-typing-实战-mypy"><a class="v-toc-item" href="#0x03-python-typing-实战-mypy">#</a> 0x03 Python Typing 实战 - MyPY</h2>
<h3 id="mypy"><a class="v-toc-item" href="#mypy">#</a> MyPy</h3>
<p>mypy 是一个可选的静态分析器，官网介绍上说，mypy 将使你的程序更加易懂，调试和维护。</p>
<p>这个程序</p>
<ul>
<li>对于 PHP 有 Hack , 对 JavaScript 有 Flow 和 TypeScript, 对于 Python 有 MyPy</li>
<li>对于 Python, 则有 MyPy , MyPy 彼时还不是很成熟 (2016 年 10 之前）。</li>
</ul>
<p>Dropbox 的团队开发，Guido van Rossum 领导开发</p>
<h3 id="快速入门"><a class="v-toc-item" href="#快速入门">#</a> 快速入门</h3>
<p>本小节部分摘录 Type hints cheat sheet</p>
<p>建议读者收藏原网址 <a href="https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html">https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html</a></p>
<pre><code class="language-python"># 内置类型
x<span class="token operator">:</span> int <span class="token operator">=</span> <span class="token number">1</span>
x<span class="token operator">:</span> float <span class="token operator">=</span> <span class="token number">1.0</span>
x<span class="token operator">:</span> bool <span class="token operator">=</span> True
x<span class="token operator">:</span> str <span class="token operator">=</span> <span class="token string">"test"</span>
x<span class="token operator">:</span> bytes <span class="token operator">=</span> b<span class="token string">"test"</span>

child<span class="token operator">:</span> bool
<span class="token keyword">if</span> age <span class="token operator">&lt;</span> <span class="token number">18</span><span class="token operator">:</span>
    child <span class="token operator">=</span> True
<span class="token keyword">else</span><span class="token operator">:</span>
    child <span class="token operator">=</span> False

# 普通函数
def <span class="token function">stringify</span><span class="token punctuation">(</span>num<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> str<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token function">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>

# 生成器
def <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Iterable<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token operator">:</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> n<span class="token operator">:</span>
        <span class="token keyword">yield</span> i
        i <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre>
<p>直接看起来似乎，加不加 typing 对现在的代码改善并不是很明显嘛。</p>
<p>我们可以给复杂类型起别名：</p>
<pre><code class="language-python">比如：
def <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Union<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> Set<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>str<span class="token punctuation">,</span> List<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span>
def <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Union<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> Set<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>str<span class="token punctuation">,</span> List<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span>

AliasType <span class="token operator">=</span> Union<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> Set<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">[</span>str<span class="token punctuation">,</span> List<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
def <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> AliasType<span class="token operator">:</span>
    <span class="token operator">...</span>
def <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> AliasType<span class="token operator">:</span>
    <span class="token operator">...</span>
</code></pre>
<p>看起来还行，但还是没有感觉到很明显的代码质量改善。</p>
<p>好，再看一例，使用 ClassVar 禁止属性无法在实例上设置</p>
<pre><code class="language-python">from typing <span class="token keyword">import</span> ClassVar

<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token operator">:</span>
    x<span class="token operator">:</span> ClassVar<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  # Class variable only

<span class="token constant">A</span><span class="token punctuation">.</span>x <span class="token operator">+=</span> <span class="token number">1</span>  # <span class="token constant">OK</span>

a <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span>  # Error<span class="token operator">:</span> Cannot assign to <span class="token keyword">class</span> <span class="token class-name">variable</span> <span class="token string">"x"</span> via instance
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span>  # <span class="token constant">OK</span> <span class="token operator">--</span> can be read through an instance
</code></pre>
<p>举个例子，flask-sqlalchemy, 可以通过 YouModel.query.get(id) 来拿到 YouModel 的实例，但 IDE 不能推断出这个实例是什么。</p>
<pre><code class="language-python"># 方法一，Cast
you_model_ins<span class="token operator">:</span> YouModel <span class="token operator">=</span> YouModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
# 方法二，包装一下 <span class="token keyword">get</span> 方法

<span class="token keyword">class</span> <span class="token class-name">YouModel</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token operator">:</span>
	def <span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"YouModel"</span><span class="token operator">:</span> # 注意这里的字符串
		pass
you_model_ins <span class="token operator">=</span> YouModel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

</code></pre>
<p>细心的读者可能看到这里的 YouModel 的返回值类型居然使用了 YouModel 的字符串，如果是 Java 的话，是可以直接写 YouModel 的。</p>
<pre><code class="language-python"># 加上类型延迟求值
from __future__ <span class="token keyword">import</span> annotations

<span class="token keyword">class</span> <span class="token class-name">YouModel</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token operator">:</span>
	def <span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> YouModel<span class="token operator">:</span>
		pass
you_model_ins <span class="token operator">=</span> YouModel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</code></pre>
<p>还有其他的用法，请参考 MyPY 的官方文档</p>
<h2 id="0x04-常见问题"><a class="v-toc-item" href="#0x04-常见问题">#</a> 0x04 常见问题</h2>
<h3 id="如何忽略-mypy-警告"><a class="v-toc-item" href="#如何忽略-mypy-警告">#</a> 如何忽略 mypy 警告</h3>
<p>有的地方的代码不进行检查的话会方便很多。</p>
<p>与 flake8 类似，在注释后面写上标志就可以忽略了。</p>
<pre><code class="language-bash">youcode  # type<span class="token operator">:</span> igonre
</code></pre>
<h3 id="循环导入"><a class="v-toc-item" href="#循环导入">#</a> 循环导入</h3>
<p>我现在有两个文件，一个是 <a href="http://user.py">user.py</a> 另一个是 <a href="http://order.py">order.py</a></p>
<p>在 user 里面有个方法需要返回 order 里面的 Order 列表，order 里面有个 order.owner 需要返回 User 实例。</p>
<p>如果不用类型声明的话，在 user 需要 order 的时候 import 进来即可规避循环导入。</p>
<p>在使用类型声明之后，建议在 user 里面这么写</p>
<pre><code class="language-python"><span class="token keyword">if</span> <span class="token constant">TYPE_CHECKING</span><span class="token operator">:</span>
    from project<span class="token punctuation">.</span>models<span class="token punctuation">.</span>order <span class="token keyword">import</span> Order # noqa

</code></pre>
<h2 id="0x05-typing-anotation-项目最佳实践"><a class="v-toc-item" href="#0x05-typing-anotation-项目最佳实践">#</a> 0x05 Typing Anotation 项目最佳实践</h2>
<p>通过本文了解了基本的 Typing Anotation 的用法，其实效果还不够，本着对爱学习的读者老爷的负责的态度。</p>
<p>所谓『纸上得来终觉浅，绝知此事要宫刑』, 哦不『躬行』</p>
<p>推荐一个超级牛的大项目来让大家了解一下 typing annotation 的最佳实践。</p>
<p><a href="https://github.com/zulip/zulip/">https://github.com/zulip/zulip/</a></p>
<p>当然，从这个项目里面不仅仅能学到 typing annotation, 还能学到大项目下，牛 X 的公司的做法</p>
<ol>
<li>如何组织和划分模块</li>
<li>如何帮助开发者快速启用开发环境。</li>
<li>如何做测试，如何做 CI</li>
<li>如何优化自己的 Workflow</li>
</ol>
<p>有机会的话，我会挑其中的一小部分讲解一下。</p>
<h2 id="0xee-参考"><a class="v-toc-item" href="#0xee-参考">#</a> 0xEE 参考</h2>
<h3 id="pep"><a class="v-toc-item" href="#pep">#</a> PEP</h3>
<ul>
<li>PEP 3107</li>
<li>PEP 483</li>
</ul>
<h3 id="扩展文章"><a class="v-toc-item" href="#扩展文章">#</a> 扩展文章</h3>
<ul>
<li><a href="http://wphomes.soic.indiana.edu/jsiek/what-is-gradual-typing/">关于 gradual typing</a></li>
<li><a href="https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html">https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html</a></li>
<li><a href="https://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/">https://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/</a></li>
<li><a href="https://www.zhihu.com/question/21017354/answer/589574939">https://www.zhihu.com/question/21017354/answer/589574939</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-11-25</strong> 初始化本文</li>
<li><strong>2019-02-16</strong> 重新整理文章</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li><a href="#%E7%94%A8-type-annotation-%E6%8F%90%E5%8D%87%E4%BD%A0%E7%9A%84-python-%E4%BB%A3%E7%A0%81%E5%81%A5%E5%A3%AE%E6%80%A7">用 Type Annotation 提升你的 Python 代码健壮性</a>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-why-type-annotation">0x01 Why Type Annotation</a></li>
<li><a href="#0x02-gradual-typing">0x02 Gradual Typing</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B-vs-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B">静态类型 VS 动态类型</a></li>
<li><a href="#%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B">静态类型 + 动态类型</a></li>
</ul>
</li>
<li><a href="#0x03-python-typing-%E5%AE%9E%E6%88%98-mypy">0x03 Python Typing 实战 - MyPY</a>
<ul>
<li><a href="#mypy">MyPy</a></li>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8">快速入门</a></li>
</ul>
</li>
<li><a href="#0x04-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">0x04 常见问题</a>
<ul>
<li><a href="#%E5%A6%82%E4%BD%95%E5%BF%BD%E7%95%A5-mypy-%E8%AD%A6%E5%91%8A">如何忽略 mypy 警告</a></li>
<li><a href="#%E5%BE%AA%E7%8E%AF%E5%AF%BC%E5%85%A5">循环导入</a></li>
</ul>
</li>
<li><a href="#0x05-typing-anotation-%E9%A1%B9%E7%9B%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">0x05 Typing Anotation 项目最佳实践</a></li>
<li><a href="#0xee-%E5%8F%82%E8%80%83">0xEE 参考</a>
<ul>
<li><a href="#pep">PEP</a></li>
<li><a href="#%E6%89%A9%E5%B1%95%E6%96%87%E7%AB%A0">扩展文章</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["FCPX"],"path":"20181210_PyCode_01.md","title":"用 Type Annotation 提升你的 Python 代码健壮性","slug":"用 Type Annotation 提升你的 Python 代码健壮性","date":"2018-12-10","category":"整洁Python代码","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003ch1 id=\"用-type-annotation-提升你的-python-代码健壮性\"\u003e\u003ca class=\"v-toc-item\" href=\"#用-type-annotation-提升你的-python-代码健壮性\"\u003e#\u003c/a\u003e 用 Type Annotation 提升你的 Python 代码健壮性\u003c/h1\u003e\n\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e本文是《提升你的 Python 项目代码健壮性和性能》系列的第一篇文章。\u003c/p\u003e\n\u003cp\u003e当我刚知道 Python 要添加类型的时候，我的内心是拒绝的。\u003c/p\u003e\n\u003cp\u003eWhy, Why, Why? 就是因为不喜欢类型，也不喜欢特别动态的语言。\u003c/p\u003e\n\u003cp\u003e但是，尝试了俩个疗程之后，腰也不疼了，腿也不疼了，走起路来都有劲了\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e嗯，真香。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"0x01-why-type-annotation\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-why-type-annotation\"\u003e#\u003c/a\u003e 0x01 Why Type Annotation\u003c/h2\u003e\n\u003cp\u003e人们常说\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e动态类型一时爽，代码重构火葬场。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e在刚写 Python 的前两年里并没有感受很深。\u003c/p\u003e\n\u003cp\u003e直到，开始和别人协作的时候，才发现各种莫名其妙的问题。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e大量的使用魔法方法\u003c/li\u003e\n\u003cli\u003eflake8 分析出某个函数过于复杂\u003c/li\u003e\n\u003cli\u003esend_message 里面有不少的参数，一不小心就传参错误\u003c/li\u003e\n\u003cli\u003eNone 值\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e动态类型给人极大的灵活性，写的时候很爽，但如果解放了双手，撸起袖子一通写，自己写起来爽了，自己重构的时候或者其他人来看代码的时候，头发就会加速掉落。\u003c/p\u003e\n\u003cp\u003e聪明的你很容易反问，只要我们团队不犯这些错误，不就好了么？\u003c/p\u003e\n\u003cp\u003e是的，当我们讨论 Python Annotation 的时候，往往陷入类型之争。\u003c/p\u003e\n\u003cp\u003e我并不想讨论静态类型和动态类型孰好孰坏。\u003c/p\u003e\n\u003cp\u003e我想讨论的是\u003cstrong\u003e加了 Typing 极大的提升代码的健壮性。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e先从 Gradual Typing 说起吧。\u003c/p\u003e\n\u003ch2 id=\"0x02-gradual-typing\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-gradual-typing\"\u003e#\u003c/a\u003e 0x02 Gradual Typing\u003c/h2\u003e\n\u003cp\u003e在你刚入门一门编程语言的时候，我们常常说，Java 是强类型静态语言，Python 是强类型动态语言\u003c/p\u003e\n\u003cp\u003e从这两位诞生开始，静态类型和动态类型就一直进行旷日持久的圣战。\u003c/p\u003e\n\u003cp\u003e然而，而现在的发展趋势是：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e静态类型的语言觉得自己太过静态，以至于写起来很啰嗦。于是引入了很多类型推断。 Java / Go\u003c/li\u003e\n\u003cli\u003e动态类型的语言觉得自己太过动态，以至于协作的过程中总是出现低级错误。于是引入了 Gradual Typing , Typescript / Flow / Python Type Annotation\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e什么是 Gradual Typing?\u003c/p\u003e\n\u003cp\u003eGradual typing 允许开发者仅在程序的部分地区使用 Annotate/Type. 即，既不是黑猫（静态）, 也不是白猫（动态），从而诞生了熊猫（动静结合）。\u003c/p\u003e\n\u003cp\u003e话说回来，要知道为什么这么搞，首先要知道动态类型和静态类型会给程序带来什么。\u003c/p\u003e\n\u003ch3 id=\"静态类型-vs-动态类型\"\u003e\u003ca class=\"v-toc-item\" href=\"#静态类型-vs-动态类型\"\u003e#\u003c/a\u003e 静态类型 VS 动态类型\u003c/h3\u003e\n\u003cp\u003e静态类型的语言，比如在写 Java 的时候，如果你把一个 int 赋值给了 string 的变量，IDE 会通过\u003cstrong\u003e类型检查器\u003c/strong\u003e立即报错并告诉你，你这个值赋值错啦。这个就是 Java 程序的检查阶段。 动态类型的语言，比如在写\u003cbr\u003e\nPython 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。如果线上还是出这个问题，就蛋疼了。\u003c/p\u003e\n\u003cp\u003e为了进行友好的讨论，本人将精分成 Javaer 和 Pythonist, 通过两人对话的方式，来讨论类型。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 我先喝杯咖啡\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePythonist: 生命苦短，我用 Python。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: P 哥，请（为什么叫 P 哥？Python 1989 年出生，Java 1995 年）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePythonist: J 弟，请\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 静态类型可以较低成本的提早捕获 BUG, 比如：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e你在写 Python 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。\u003c/li\u003e\n\u003cli\u003e如果线上还是出这个问题，就蛋疼了。我这个类型检查可以在\u003cstrong\u003e使用 IDE 的时候给我分析出方法参数的类型和返回值\u003c/strong\u003e。所谓『上医治未病，中医治已病，下医治大病』, 防范于未然，善之善者也。\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePython: 等等，你小子还广征博引了还，首先，提早捕获 Bug, 我这里也有呀，比如我这里可以通过 flake8 来检查出有些没有定义的变量，\u003cstrong\u003e仅仅是类型没有检查而已\u003c/strong\u003e。其次，IDE\u003cbr\u003e\n给我的补全又不是完全无法补全。弱一点罢了。你说的类型检查的问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e可以通过\u003cstrong\u003e提升程序员的素质\u003c/strong\u003e来解决这个问题，或者让他们长点脑子，别特么在这种低级错误上犯错误。\u003c/li\u003e\n\u003cli\u003e写测试来\u003cstrong\u003e提升测试代码的代码覆盖率\u003c/strong\u003e（这个我会在本系列的第二篇文章里深入讲解）来解决这个问题\u003c/li\u003e\n\u003cli\u003e看看写的代码检查时出现问题，我完全可以\u003cstrong\u003e把代码拖到 IPython 里面跑一遍\u003c/strong\u003e。这可不仅仅能解决类型不正确带来的问题，还能快速解决代码的逻辑问题\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJava: 关于你说的第三点，我完全可以提升测试代码的覆盖率。哎？似乎我这个开发测试成本也上来了。看来\u003cstrong\u003e类型检查也不能解决这个问题\u003c/strong\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 来 P 哥\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e静态类型确实以\u003cstrong\u003e较低的成本\u003c/strong\u003e解决了这种类型的问题，不是么？\u003c/li\u003e\n\u003cli\u003e并且，如果我其中一小块功能进行了修改，我总不能每次都跑 IPython 吧？我也不能因为想检查一下类型这种小操作就写测试代码覆盖一下？\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePython: 你每次修改，都要加类型，加类型，改类型，直到类型检查器完全接受。不麻烦嘛？面向类型检查器编程？\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 来，\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e每次改代码的时候，又不是改一大推，你是小部分改的，能有多少项目是海量海量改？高内聚，低耦合，模块化开发。\u003c/li\u003e\n\u003cli\u003e好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。\u003c/li\u003e\n\u003cli\u003e我大 Java 就是面向重构的语言！我有 Jetbrain 的 IDE, 重构代码我怕谁\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePython: 来，你说的没错，\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003e每次改代码的时候，又不是改一大推，你是小部分改的\u003c/strong\u003e。这话你说的没错，我也能用啊，因为代码总是一小部分一小部分改的，所以，改完了跑一下 IPython 就结了。\u003c/li\u003e\n\u003cli\u003e好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。这话你说的也没错，可\u003cstrong\u003e我重构的时候没有写测试就重构\u003c/strong\u003e，是不是有点莽撞？写了测试了，我还要花时间在类型检查器上，不啰嗦么？\u003c/li\u003e\n\u003cli\u003e我也有 Jetbrain 的 IDE, 重构代码我又不是不能重构。\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePython: 再来，\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e需求变更上来了，结果往往会出现，你本来是想专注于业务逻辑的更改的，但最后变成了大型\u003cstrong\u003e为了让类型检查器通过类型检查而艰苦奋斗的现场\u003c/strong\u003e, 我这个场景直接传 int/str/ 字典 / 传对象就很方便，你非要让我写四个函数来\u003cbr\u003e\noverride 方法。\u003c/li\u003e\n\u003cli\u003e虽然说，好代码确实可以通过重构出来，但动态语言表达能力强呀，你 Java HashMap 啰啰嗦嗦 put 写了半天，我 Python 一个 Dict 一把梭，看起来，清晰，改起来方便。\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e再比如说，\u003c/p\u003e\n\u003cp\u003eLeetCode 上面有一道题目，叫做最长连续 1\u003c/p\u003e\n\u003cp\u003eInput 是 [1,1,0,1,1,1] Output 是 3\u003c/p\u003e\n\u003cp\u003e我们尝试用 Python 来看下\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003edef \u003cspan class=\"token function\"\u003efind_max_consecutive_ones\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enum\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003emax\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elambda x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ejoin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003estr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enum\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e num \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e nums\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'0'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们尝试用 Java 来看下\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSolution\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e int \u003cspan class=\"token function\"\u003efindMaxConsecutiveOnes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eint\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e nums\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tint result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\tint tmp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eint i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e nums\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enums\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\ttmp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\ttmp \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\tresult \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Math\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emax\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etmp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eJavaer: 啊咧？P 哥你确实有点短啊！\u003c/li\u003e\n\u003cli\u003ePythonist: 你敢说我短？你看看 java 的创始人的头发！\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e『贴图』\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 我不是那个意思，浓缩就是精华嘛，表达能力弱又怎么样，我 Javaer 可以直接封装好这个功能当成工具类用，从外部使用上用起来差不多好吧，从项目角度表达力并不是决定性因素，静态类型检查可以提早在编译阶段做字节码优化。你的\u003cbr\u003e\nGIL…\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePythonist: 好了，咱就不要提 GIL 了\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePythonist: 动态类型不需要花时间写 type annotation, 写起来速度杠杠的。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 静态语言一时爽，动态类型火葬场好伐？举个例子，太动态的东西，就是不好做类型推断，比如贵圈的著名的 sqlalchemy 做的那么动态，query.get() 结合 flask\u003cbr\u003e\n来用，YouModel.query.get() 出来的 YouModel 你还要点进去查看一下具体属性，你要用 title 还是 name, 拼错了，怎么办？都不报错的。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 静态类型迫使你思考程序的时候更加严谨认真，这将会提升你的代码质量。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePythonist: 这点我是不服的，你只是花费了大量的时间在类型检查上，写的认不认真不完全取决于你编程的水平和态度好伐？假如你的观点成立，语言只是武器，峨眉师太拿一把倚天剑，不还是被张三丰空手取来？\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eJavaer: 但你不能否认，峨眉师太拿着倚天剑确实可以秒杀很多人。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e旁白君：有道是，梅须逊雪三分白，雪却输梅一段香。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003eGuido van Rossum: 好了，我觉得类型不错，我在 dropbox 带领团队实现了 python 的 typing，python 3.7 内置哦。\u003c/li\u003e\n\u003cli\u003ePythonist: 我自己打脸一下，动态类型花点时间写 type annotation 代码健壮性杠杠的。\u003c/li\u003e\n\u003cli\u003eJavaer: 你走开… 你怎么不去解决 GIL 的问题。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"静态类型-动态类型\"\u003e\u003ca class=\"v-toc-item\" href=\"#静态类型-动态类型\"\u003e#\u003c/a\u003e 静态类型 + 动态类型\u003c/h3\u003e\n\u003cp\u003eGradual Typing 就是在动态语言的基础上，增加了可选的类型声明 (Type Annotation)\u003c/p\u003e\n\u003cp\u003e这对于我这种人是福音，\u003c/p\u003e\n\u003cp\u003e对于我个人而言，我是希望 Python 是有类型的\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e作为某段程序的开发者和维护者，我可以提升我重构的速度。\u003c/li\u003e\n\u003cli\u003e作为某段程序的调用方，可以快速的知道我调用后得到的东西究竟是什么。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e但我又不希望这个声明不是强制性的\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e我在构思程序的时候，想专注于接口的设计。在落实编码并且把代码写的足够的 dry 之后，在被调用的一些地方加上类型声明，这样可以提升我写代码的速度。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"0x03-python-typing-实战-mypy\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-python-typing-实战-mypy\"\u003e#\u003c/a\u003e 0x03 Python Typing 实战 - MyPY\u003c/h2\u003e\n\u003ch3 id=\"mypy\"\u003e\u003ca class=\"v-toc-item\" href=\"#mypy\"\u003e#\u003c/a\u003e MyPy\u003c/h3\u003e\n\u003cp\u003emypy 是一个可选的静态分析器，官网介绍上说，mypy 将使你的程序更加易懂，调试和维护。\u003c/p\u003e\n\u003cp\u003e这个程序\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e对于 PHP 有 Hack , 对 JavaScript 有 Flow 和 TypeScript, 对于 Python 有 MyPy\u003c/li\u003e\n\u003cli\u003e对于 Python, 则有 MyPy , MyPy 彼时还不是很成熟 (2016 年 10 之前）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDropbox 的团队开发，Guido van Rossum 领导开发\u003c/p\u003e\n\u003ch3 id=\"快速入门\"\u003e\u003ca class=\"v-toc-item\" href=\"#快速入门\"\u003e#\u003c/a\u003e 快速入门\u003c/h3\u003e\n\u003cp\u003e本小节部分摘录 Type hints cheat sheet\u003c/p\u003e\n\u003cp\u003e建议读者收藏原网址 \u003ca href=\"https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html\"\u003ehttps://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# 内置类型\nx\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e int \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\nx\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e float \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1.0\u003c/span\u003e\nx\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bool \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e True\nx\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e str \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\nx\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bytes \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e b\u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\n\nchild\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bool\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e age \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e18\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    child \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e True\n\u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    child \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e False\n\n# 普通函数\ndef \u003cspan class=\"token function\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enum\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e int\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e str\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003estr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enum\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n# 生成器\ndef \u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e int\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Iterable\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e n\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eyield\u003c/span\u003e i\n        i \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e直接看起来似乎，加不加 typing 对现在的代码改善并不是很明显嘛。\u003c/p\u003e\n\u003cp\u003e我们可以给复杂类型起别名：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e比如：\ndef \u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Union\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eList\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eTuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e str\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Set\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Tuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e List\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003eb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Union\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eList\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eTuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e str\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Set\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Tuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e List\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\nAliasType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Union\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eList\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eTuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e str\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Set\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Tuple\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e List\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e AliasType\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003eb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e AliasType\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e看起来还行，但还是没有感觉到很明显的代码质量改善。\u003c/p\u003e\n\u003cp\u003e好，再看一例，使用 ClassVar 禁止属性无法在实例上设置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003efrom typing \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e ClassVar\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e ClassVar\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e  # Class variable only\n\n\u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e  # \u003cspan class=\"token constant\"\u003eOK\u003c/span\u003e\n\na \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\na\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e  # Error\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Cannot assign to \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003evariable\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"x\"\u003c/span\u003e via instance\n\u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e  # \u003cspan class=\"token constant\"\u003eOK\u003c/span\u003e \u003cspan class=\"token operator\"\u003e--\u003c/span\u003e can be read through an instance\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e举个例子，flask-sqlalchemy, 可以通过 YouModel.query.get(id) 来拿到 YouModel 的实例，但 IDE 不能推断出这个实例是什么。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# 方法一，Cast\nyou_model_ins\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e YouModel \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e YouModel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003equery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# 方法二，包装一下 \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e 方法\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eYouModel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\tdef \u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"YouModel\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e # 注意这里的字符串\n\t\tpass\nyou_model_ins \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e YouModel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e细心的读者可能看到这里的 YouModel 的返回值类型居然使用了 YouModel 的字符串，如果是 Java 的话，是可以直接写 YouModel 的。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# 加上类型延迟求值\nfrom __future__ \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e annotations\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eYouModel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\tdef \u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e YouModel\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\t\tpass\nyou_model_ins \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e YouModel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e还有其他的用法，请参考 MyPY 的官方文档\u003c/p\u003e\n\u003ch2 id=\"0x04-常见问题\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-常见问题\"\u003e#\u003c/a\u003e 0x04 常见问题\u003c/h2\u003e\n\u003ch3 id=\"如何忽略-mypy-警告\"\u003e\u003ca class=\"v-toc-item\" href=\"#如何忽略-mypy-警告\"\u003e#\u003c/a\u003e 如何忽略 mypy 警告\u003c/h3\u003e\n\u003cp\u003e有的地方的代码不进行检查的话会方便很多。\u003c/p\u003e\n\u003cp\u003e与 flake8 类似，在注释后面写上标志就可以忽略了。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eyoucode  # type\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e igonre\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"循环导入\"\u003e\u003ca class=\"v-toc-item\" href=\"#循环导入\"\u003e#\u003c/a\u003e 循环导入\u003c/h3\u003e\n\u003cp\u003e我现在有两个文件，一个是 \u003ca href=\"http://user.py\"\u003euser.py\u003c/a\u003e 另一个是 \u003ca href=\"http://order.py\"\u003eorder.py\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e在 user 里面有个方法需要返回 order 里面的 Order 列表，order 里面有个 order.owner 需要返回 User 实例。\u003c/p\u003e\n\u003cp\u003e如果不用类型声明的话，在 user 需要 order 的时候 import 进来即可规避循环导入。\u003c/p\u003e\n\u003cp\u003e在使用类型声明之后，建议在 user 里面这么写\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token constant\"\u003eTYPE_CHECKING\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    from project\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eorder \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e Order # noqa\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x05-typing-anotation-项目最佳实践\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x05-typing-anotation-项目最佳实践\"\u003e#\u003c/a\u003e 0x05 Typing Anotation 项目最佳实践\u003c/h2\u003e\n\u003cp\u003e通过本文了解了基本的 Typing Anotation 的用法，其实效果还不够，本着对爱学习的读者老爷的负责的态度。\u003c/p\u003e\n\u003cp\u003e所谓『纸上得来终觉浅，绝知此事要宫刑』, 哦不『躬行』\u003c/p\u003e\n\u003cp\u003e推荐一个超级牛的大项目来让大家了解一下 typing annotation 的最佳实践。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/zulip/zulip/\"\u003ehttps://github.com/zulip/zulip/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e当然，从这个项目里面不仅仅能学到 typing annotation, 还能学到大项目下，牛 X 的公司的做法\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e如何组织和划分模块\u003c/li\u003e\n\u003cli\u003e如何帮助开发者快速启用开发环境。\u003c/li\u003e\n\u003cli\u003e如何做测试，如何做 CI\u003c/li\u003e\n\u003cli\u003e如何优化自己的 Workflow\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e有机会的话，我会挑其中的一小部分讲解一下。\u003c/p\u003e\n\u003ch2 id=\"0xee-参考\"\u003e\u003ca class=\"v-toc-item\" href=\"#0xee-参考\"\u003e#\u003c/a\u003e 0xEE 参考\u003c/h2\u003e\n\u003ch3 id=\"pep\"\u003e\u003ca class=\"v-toc-item\" href=\"#pep\"\u003e#\u003c/a\u003e PEP\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ePEP 3107\u003c/li\u003e\n\u003cli\u003ePEP 483\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"扩展文章\"\u003e\u003ca class=\"v-toc-item\" href=\"#扩展文章\"\u003e#\u003c/a\u003e 扩展文章\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://wphomes.soic.indiana.edu/jsiek/what-is-gradual-typing/\"\u003e关于 gradual typing\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html\"\u003ehttps://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/\"\u003ehttps://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.zhihu.com/question/21017354/answer/589574939\"\u003ehttps://www.zhihu.com/question/21017354/answer/589574939\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eChangeLog:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e2018-11-25\u003c/strong\u003e 初始化本文\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e2019-02-16\u003c/strong\u003e 重新整理文章\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\u003ca href=\"#%E7%94%A8-type-annotation-%E6%8F%90%E5%8D%87%E4%BD%A0%E7%9A%84-python-%E4%BB%A3%E7%A0%81%E5%81%A5%E5%A3%AE%E6%80%A7\"\u003e用 Type Annotation 提升你的 Python 代码健壮性\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-why-type-annotation\"\u003e0x01 Why Type Annotation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-gradual-typing\"\u003e0x02 Gradual Typing\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B-vs-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B\"\u003e静态类型 VS 动态类型\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B\"\u003e静态类型 + 动态类型\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-python-typing-%E5%AE%9E%E6%88%98-mypy\"\u003e0x03 Python Typing 实战 - MyPY\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#mypy\"\u003eMyPy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8\"\u003e快速入门\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98\"\u003e0x04 常见问题\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A6%82%E4%BD%95%E5%BF%BD%E7%95%A5-mypy-%E8%AD%A6%E5%91%8A\"\u003e如何忽略 mypy 警告\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%BE%AA%E7%8E%AF%E5%AF%BC%E5%85%A5\"\u003e循环导入\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x05-typing-anotation-%E9%A1%B9%E7%9B%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5\"\u003e0x05 Typing Anotation 项目最佳实践\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0xee-%E5%8F%82%E8%80%83\"\u003e0xEE 参考\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#pep\"\u003ePEP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%A9%E5%B1%95%E6%96%87%E7%AB%A0\"\u003e扩展文章\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"用 Type Annotation 提升你的 Python 代码健壮性"},"buildId":"oDi_oBCBuu3qj6v7hDnrL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>