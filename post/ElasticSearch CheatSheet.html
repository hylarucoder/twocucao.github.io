<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>ElasticSearch CheatSheet | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/oDi_oBCBuu3qj6v7hDnrL/_buildManifest.js" defer=""></script><script src="/_next/static/oDi_oBCBuu3qj6v7hDnrL/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>本文为 Cheatsheet 类型文章，用于记录我在日常编程中经常使用的 ElasticSearch 相关和命令。</p>
<blockquote>
<p>最早使用 ElasticSearch 是两年前了。最近准备用 Django 写一个全栈式的应用，借用强大的 ES 来做搜索。</p>
</blockquote>
<p>这是我在写程序之余写这篇笔记的原因。最近因为换工作的事情耽误了教程更新，就把这篇笔记放出来吧。不定期更新。</p>
<p>官网介绍 ElasticSearch 不仅仅是全文搜索，也可以结构化搜索（这里用结构化查询会更准确一些），处理人类语言，地理位置，以及关系。</p>
<p>然而，我在项目使用过程中还是主要用到了全文搜索以及推荐。</p>
<p>不用其他的主要原因是因为 ES 尺有所短寸有所长：</p>
<ol>
<li>geo 处理方面 postgis 完全就是神一般的存在。为什么还要用 ES 呢？</li>
<li>关系型数据库的核心不就是处理关系？复杂的关系肯定还是放在关系数据库里面。</li>
</ol>
<ul>
<li>highlighted search</li>
<li>search-as-you-type</li>
<li>did-you-mean suggestions</li>
</ul>
<p>我对 ElasticSearch 在后台组件里的作用在于搜索与推荐：</p>
<ol>
<li>整站的搜索功能</li>
</ol>
<ul>
<li>全文搜索</li>
</ul>
<ol start="2">
<li>推荐</li>
</ol>
<ul>
<li>依据某几个维度的数据进行排序</li>
</ul>
<p>知乎的文章居然不支持 toc, 实在是太蛋疼了。</p>
<p>文章目录如下</p>
<pre><code>  ▼ 0x00 前言 : section
  ▼ 0x01 安装，配置，基本 shell 命令 : section
      1. 安装 : section
      2. 配置 : section
      3. 插件 : section
    0x02 ElasticSearch 配套工具 : section
  ▼ 0x03 ElasticSearch 基础概念 : section
    ▼ 3.1 Elasticsearch CRUDE 以及基本操作 : section
        CURDE : section
        普通搜索 : section
        聚集搜索 : section
  ▼ 0x04 全文搜索的基本概念 : section
      4.1 全文搜索遇到的挑战 : section
    ▼ 4.2 全文搜索的索引时与查询时 : section
        1. 索引时 ES 做了什么？ : section
        2. 查询时 ES 做了什么？ : section
        3. 全文搜索调优之中文分词 : section
        4. 全文搜索调优之停止词 : section
        5. 全文搜索调优之同义词 : section
        6. 全文搜索调优之拼写错误 : section
      ▼ 7. 全文搜索调优之相关性 : section
          索引时三因素 : section
          查询时 : section
          计算公式 : section
    0x05 搜索语法 : section
    0x06 Python SDK : section
    0x07 踩坑集 : section
    0xEE 参考链接 : section
</code></pre>
<!-- more -->
<h2 id="0x01-安装配置基本-shell-命令"><a class="v-toc-item" href="#0x01-安装配置基本-shell-命令">#</a> 0x01 安装，配置，基本 shell 命令</h2>
<h3 id="1-安装"><a class="v-toc-item" href="#1-安装">#</a> 1. 安装</h3>
<p>具体在项目中的配置建议看一下我写的配置文章 <a href="https://zhuanlan.zhihu.com/p/33920401">https://zhuanlan.zhihu.com/p/33920401</a> 和并且参考现有代码 <a href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></p>
<pre><code># 执行如下的命令
curl 'http://localhost:9200/?pretty'
# 输出结果
{
  &quot;name&quot; : &quot;XOGvo8a&quot;,
  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,
  &quot;cluster_uuid&quot; : &quot;fAwp341bQzalzBxRFyD1YA&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;6.2.1&quot;,
    &quot;build_hash&quot; : &quot;7299dc3&quot;,
    &quot;build_date&quot; : &quot;2018-02-07T19:34:26.990113Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;7.2.1&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
</code></pre>
<h3 id="2-配置"><a class="v-toc-item" href="#2-配置">#</a> 2. 配置</h3>
<p>配置略</p>
<h3 id="3-插件"><a class="v-toc-item" href="#3-插件">#</a> 3. 插件</h3>
<p>ES 的插件有很多，截止笔者写这篇文章的时候，ES 最新的版本是 6.2.1 版本。</p>
<blockquote>
<p>PS: 两年前我用的还是 2.3.3 版本。新版本有很多插件配置起来已经有所不同了。比如说 head 现在已经被独立出来作为一个单纯的网页，chrome 商店可以直接下载。</p>
</blockquote>
<p>需要配 ik-analyser. 如果你在 YaDjangoBlog 中起了这个命令，则已经配置完毕。</p>
<h2 id="0x02-elasticsearch-配套工具"><a class="v-toc-item" href="#0x02-elasticsearch-配套工具">#</a> 0x02 ElasticSearch 配套工具</h2>
<p>建议使用 Head 插件来进行简单的查询与调试。</p>
<h2 id="0x03-elasticsearch-基础概念"><a class="v-toc-item" href="#0x03-elasticsearch-基础概念">#</a> 0x03 ElasticSearch 基础概念</h2>
<h3 id="31-elasticsearch-crude-以及基本操作"><a class="v-toc-item" href="#31-elasticsearch-crude-以及基本操作">#</a> 3.1 Elasticsearch CRUDE 以及基本操作</h3>
<p>详细的搜索见 Python SDK</p>
<h4 id="curde"><a class="v-toc-item" href="#curde">#</a> CURDE</h4>
<p>ES 使用的是 RESTFUL API 接口</p>
<p>这也就意味着：</p>
<ul>
<li>PUT 创建记录</li>
<li>GET 获取记录</li>
<li>POST 更新记录</li>
<li>DELETE 删除记录</li>
<li>HEAD 是否存在</li>
</ul>
<h4 id="结构化搜索"><a class="v-toc-item" href="#结构化搜索">#</a> 结构化搜索</h4>
<p>ES 写复杂查询的时候，语法乱，这个过程需要多翻看 guide 和手册。</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html">https://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html</a></p>
<h4 id="全文搜索"><a class="v-toc-item" href="#全文搜索">#</a> 全文搜索</h4>
<p>全文搜索包含两个重要方面：</p>
<ul>
<li>相关性：通过 TF/IDF , 距离 , 模糊相似度，以及其他算法</li>
<li>分析：大文本 token 化，用于形成倒排索引。这个过程见 4.2</li>
</ul>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/full-text-search.html">https://www.elastic.co/guide/en/elasticsearch/guide/current/full-text-search.html</a></p>
<h4 id="聚集搜索"><a class="v-toc-item" href="#聚集搜索">#</a> 聚集搜索</h4>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/aggregations.html">https://www.elastic.co/guide/en/elasticsearch/guide/current/aggregations.html</a></p>
<h2 id="0x04-全文搜索的基本概念"><a class="v-toc-item" href="#0x04-全文搜索的基本概念">#</a> 0x04 全文搜索的基本概念</h2>
<h3 id="41-全文搜索遇到的挑战"><a class="v-toc-item" href="#41-全文搜索遇到的挑战">#</a> 4.1 全文搜索遇到的挑战</h3>
<p>在最初开源搜索引擎技术还不是很成熟的时候，我们一般都会使用 RDBMS 进行简单搜索。</p>
<p>简单搜索，也就是我们常常使用的 like 查询（当然，有的数据库可以使用正则表达式）</p>
<p>这种方式是简单暴力的查询方式，优点是实现起来简单暴力。缺点是在这个场景下性能和准确度很差。</p>
<p>举例：</p>
<ul>
<li>假如站点里文章数量比较大，并且文章内容比较长，则进行一次全表查询，效率可想而知。当然，做好分库分表读写分离也是能用的。</li>
<li>如果我要对搜索到的词语进行高亮，则实现方式就只能是把查询到的文章放在应用层里面进行批量替换。</li>
<li>RDBMS 似乎完全不懂语言与语言之间的区别。比如说：
<ul>
<li>『停止词 / 常用词』有的字我是不需要的，比如南京的狗，其实我想搜的是南京狗，这里的『的』就不是我需要的。</li>
<li>『同义词』有的字我需要的是他的同义词，比如日本黄狗，其实我想搜的是柴犬。</li>
<li>『附加符号』假如说我们搜索一个声调 [nǐ], 总不能让用户打出 [nǐ] 进行搜索吧？总归要转为 ni 才能方便搜索</li>
<li>『词根形式』对于一个单词，假如是动词可能有时态上的区分，如果是名词，可能有单复数的区分。假如我搜 mice, 其实同样的 mouse 也应该被搜索出来。但有事用这种方式也会矫枉过正，比如 organizations 的 原型其实并不是 organization 而是，organ. （当然，overstemming 和 understemming 也是两个不可忽视的问题）
<ul>
<li>Number: fox, foxes</li>
<li>Tense: pay, paid, paying</li>
<li>Gender: waiter, waitress</li>
<li>Person: hear, hears</li>
<li>Case: I, me, my</li>
<li>Aspect: ate, eaten</li>
<li>Mood: so be it, were it so</li>
<li>PS: 万幸的是，中文处理中木词根这个概念。我也就不深入这块了。</li>
</ul>
</li>
<li>『拼写问题』 周杰棍与周杰伦</li>
<li>『分词 / 识别词』中文不像英文，词和词之间是完全没有空格的，也就是说，中文天然要比英文多一个关于分词的步骤。</li>
</ul>
</li>
</ul>
<p>是的，我们需要一种新的姿势，来进行搜索。也就是本文所说的全文搜索。</p>
<h3 id="42-全文搜索的索引时与查询时"><a class="v-toc-item" href="#42-全文搜索的索引时与查询时">#</a> 4.2 全文搜索的索引时与查询时</h3>
<p>本小节先搞清楚两个点，</p>
<ol>
<li>索引时 ES 做了什么？</li>
<li>查询时 ES 做了什么？</li>
</ol>
<ul>
<li>索引时，指的是 ElasticSearch 在存储文档的阶段。</li>
<li>查询时，指的是 ElasticSearch 在查询文档的阶段。</li>
</ul>
<h4 id="1-索引时-es-做了什么"><a class="v-toc-item" href="#1-索引时-es-做了什么">#</a> 1. 索引时 ES 做了什么？</h4>
<blockquote>
<p>这里我们略过定义 index,type,document 仅仅指某个 field 被赋值 document 被保存的时候针对这个被赋值的 text 类型 field 的处理。</p>
</blockquote>
<ul>
<li>第一步：<strong>文本经过 analyzer 处理</strong></li>
<li>第二步：<strong>形成倒排索引</strong></li>
</ul>
<p>先看第一步：</p>
<p>通常在定义 field 的时候显式指定 analyzer（分析器）.</p>
<p>这个 analyzer 一般的作用如下：</p>
<ul>
<li>STEP 1: 令牌化文本为独立的词</li>
<li>STEP 2: 词语转小写</li>
<li>STEP 3: 去除常见的停止词</li>
<li>STEP 4: 获取词的词根的原型</li>
</ul>
<p>不同的 analyzer 作用大同小异，拿我们常用的 <a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a> 的话，则也是类似的步骤（下面步骤是我猜测的，没看源码）</p>
<ol>
<li>令牌化文本为独立的词语 - 分词，并且令牌化文本为独立的词汇</li>
<li>除去常见的停止词</li>
<li>匹配同义词</li>
<li>…</li>
</ol>
<p>可以定义字段的时候可以指定 analyzer（索引时） 与 search_analyzer（查询时）</p>
<p>先看经过第一步之后，就可以进入第二步形成倒排索引了，此时，倒排索引之于 ElasticSearch 可以类比于 btree 之于 MySQL 或者 Gist 之于 PostgreSQL.</p>
<p>那么，倒排索引包含哪些东西呢？</p>
<ul>
<li><strong>Terms dictionary</strong>
<ul>
<li>已排序完毕的 terms, 以及包含这些 terms 的 documents 的数量。</li>
</ul>
</li>
<li><strong>Postings List</strong>
<ul>
<li>哪些 document 包含这些词</li>
</ul>
</li>
<li><strong>Terms frequency</strong>
<ul>
<li>每个 term 在这些文章的频率</li>
</ul>
</li>
<li><strong>Position</strong>
<ul>
<li>每个 term 在每个 document 的位置，这是为了便于 phrase query 和 proximity query</li>
<li>高频词的 phrase query 可能导致 上 G 的数据被读取。虽然有 cache, 但是远远不够。</li>
</ul>
</li>
<li><strong>Offsets</strong>
<ul>
<li>每个 term 在每个 document 的开始和结束，便于高亮</li>
</ul>
</li>
<li><strong>Norms</strong>
<ul>
<li>用于给短 field 更多权重的因素.(TODO: 啥玩意）</li>
</ul>
</li>
</ul>
<p>减少停止词仅仅可以减少少部分 terms dictionary 和 postings list , 但是 positions 和 offsets data 对 index 的影响则是非常大的。</p>
<h4 id="2-查询时-es-做了什么"><a class="v-toc-item" href="#2-查询时-es-做了什么">#</a> 2. 查询时 ES 做了什么？</h4>
<ul>
<li>第一步：<strong>文本经过 analyzer 处理</strong></li>
<li>第二步：<strong>查询倒排索引</strong></li>
</ul>
<p>其实搜索的就是这个玩意。</p>
<ul>
<li><strong>Terms dictionary</strong></li>
<li><strong>Postings List</strong></li>
<li><strong>Terms frequency</strong></li>
<li><strong>Position</strong></li>
<li><strong>Offsets</strong></li>
<li><strong>Norms</strong></li>
</ul>
<p>于是，我们就必须关注如何更好的查询文档了。下面几个小节，你就知道全文搜索是比较难调优的了。好，一个一个来。</p>
<h4 id="3-全文搜索调优之中文分词"><a class="v-toc-item" href="#3-全文搜索调优之中文分词">#</a> 3. 全文搜索调优之中文分词</h4>
<p>中文分词以前是个难点，现在基本有成熟的解决方案，在没有更加牛逼的分词技术解决方案之前，现在分词效果主要是拼词典。</p>
<blockquote>
<p>TODO: 这个话题可能比较大，先挖坑，以后填</p>
</blockquote>
<h4 id="4-全文搜索调优之停止词"><a class="v-toc-item" href="#4-全文搜索调优之停止词">#</a> 4. 全文搜索调优之停止词</h4>
<p>使用停止词是减少索引大小的一种方式（减小索引效果不明显），那么，哪些词语可以呗当做停止词呢？</p>
<ul>
<li>低频词语：低频词语具备高权重</li>
<li>高频词语：高频词语具备低权重</li>
</ul>
<p>当然，是否是高频词语依据个人经验主要依据两点来判断：</p>
<ul>
<li>具体场景：比如在英文中，and/the 之类的会比较多，但是中文会比较少。同样的，中文里面其他语言的东西会少一些。正文八经的文章出现不正经的词汇的概率会低。在技术问里面，『数据库』属于高频词汇，但是在比如简书之类的，可能梦想 / 鸡汤 / 超级 / 震惊会多一些。掘金的『前端』两个字绝壁是高频词。</li>
<li>抽样跑新词发现的程序。社区里多的是新词发现的脚本。对文章内容或者从搜索框记录下来的搜索词跑一下新词发现的程序，然后人工筛选，应该可以发现更多的高频和低频的词汇。</li>
</ul>
<p>是不是用上停止词就好了呢？并不是。</p>
<p>比如：</p>
<ul>
<li>假如停止词里面包含了 not , 那么 happy 和 not happy 搜索出来的结果则一致。</li>
<li>假如停止词里面包含了或，那么，如果有个乐队名字叫做『或或』, 则搜索不出来。</li>
<li>假如停止词里面包含了 to / be / not / or , 则莎士比亚的名言 『To be, or not to be』 则搜索不出来。</li>
</ul>
<h4 id="5-全文搜索调优之同义词"><a class="v-toc-item" href="#5-全文搜索调优之同义词">#</a> 5. 全文搜索调优之同义词</h4>
<p>同义词也有很多种：</p>
<ol>
<li>平级关系：插、戳、刺、扎</li>
<li>包含关系：成人包含男人和女人</li>
<li>不容易分清楚关系：</li>
</ol>
<ul>
<li>炒，煎，贴，烹，炸，溜<br>
　- 汆，涮，煮，炖，煨，焐<br>
　- 蒸，鲊<br>
　- 卤，酱，熏，烤，炝，腌，拌，焗</li>
</ul>
<p>随着场景的不同，上面有些同义词也是不能轻而易举同义的。</p>
<table>
<thead>
<tr>
<th>-</th>
<th>索引时</th>
<th>查询时</th>
</tr>
</thead>
<tbody>
<tr>
<td>索引大小</td>
<td>耗时变多，同义词被索引，大小更大</td>
<td>耗时几乎不变</td>
</tr>
<tr>
<td>相关性</td>
<td>准确度下降，所有同义词相同 IDF, 则在所有文档的索引记录中，常用词和冷门词权重相同</td>
<td>准确度提升，每个同义词的 IDF 将被校正</td>
</tr>
<tr>
<td>性能</td>
<td>性能下降，查询需要涨到</td>
<td>性能下降，查询被重写，用于查找同义词</td>
</tr>
<tr>
<td>灵活性</td>
<td>变差，同义词法则不改变已存在记录，需重新索引</td>
<td>不变，同义词法则可被更新，无需重新索引</td>
</tr>
</tbody>
</table>
<p>由此可见，大部分场景下的索引时如果没有特别的需求，<strong>谨慎使用同义词</strong>。</p>
<blockquote>
<p>同义词使用自定义 filter , 并且在新建 analyzer 并指定 filter 即可。</p>
</blockquote>
<h4 id="6-全文搜索调优之拼写错误"><a class="v-toc-item" href="#6-全文搜索调优之拼写错误">#</a> 6. 全文搜索调优之拼写错误</h4>
<p>有的时候，用户也会输入错误：</p>
<ul>
<li>手误，把『周杰伦』拼成『周杰棍』</li>
</ul>
<p>这个时候，搜索引擎应该提示一下，您搜索的是不是『周杰伦』呢？</p>
<p>这里面就遇到了一个问题，我们显然知道周杰棍和周杰伦是是相似的，为什么呢？或者说，直观上感知的详细，能用数学方式表达出来吗？</p>
<p>有人说，正则匹配 / 通配符匹配呗。这是一个思路。</p>
<p>Vladimir Levenshtein 和 frederic damerau 给出了一种相似度算法 <a href="https://en.wikipedia.org/wiki/Damerau%E2%80%93Levenshtein_distance">https://en.wikipedia.org/wiki/Damerau–Levenshtein_distance</a></p>
<p>一个词组通过转换到另一个词的步数就是其距离：</p>
<ul>
<li>替换：『周杰伦』到『周杰棍』</li>
<li>插入：『周杰』到『周杰棍』</li>
<li>删除：『周杰伦』到『周杰』</li>
<li>相邻字符转换：『周伦杰』和『周杰伦』 , 但是『周杰棍的双节伦』到『周杰伦的双节棍』 并不是相邻字符转换</li>
</ul>
<p>用法：</p>
<blockquote>
<p>指定 “fuzziness”: step 即可</p>
</blockquote>
<p>当 step &gt;=2 的时候，ES 进行查询的时候，每次查询都会遍历 terms 字典，所以，如果 fuzziness 大于 2 的时候遍历 terms 的数量则非常惊人了。</p>
<ul>
<li>方法一：设置 prefix_length, 单词的前面一定长度不进行 fuzzy 匹配。一般设置为 3 （估计这是属于英文的匹配，中文环境做不了参考）;</li>
<li>方法二：设置 max_expansins, 类似于 RDBMS 的 limit, 查询到一定记录之后停止查询。</li>
</ul>
<p>fuzzy match query 也是支持的，比如说，假如你指定 “fuzziness” 为 1, 搜索周杰棍，则将周杰伦，周杰全搜索出来了。似乎搜索的很全面呀，但是问题来了：</p>
<blockquote>
<p>依据 TF/IDF 的高频低权重，低频高权重的计算方式，<strong>周杰棍由于出现次数极少，反而获得了极高的权重。</strong></p>
</blockquote>
<p>跑个题，这种因为『出现次数少，查询的时候反而显得权重较高』的情况。并不仅仅出现在 TF/IDF 算法上。</p>
<p>这方面搜索引擎和人是一样一样的</p>
<ul>
<li>小孩子听腻了家长们所说的『带着脑子去学习』, 反而觉得以前没出现的新词叫『刻意学习』牛逼到爆。</li>
<li>美女听腻了直男癌说的『漂亮』, 反而觉得夸她『品质 / 品味』的话语词词入心。</li>
</ul>
<p>回到正题</p>
<p>所以，一般情况下还是建议拼写错误主要还是用于：</p>
<ul>
<li>Search as you type : completion suggester</li>
<li>Did you mean : phrase suggester</li>
</ul>
<h4 id="7-全文搜索调优之相关性"><a class="v-toc-item" href="#7-全文搜索调优之相关性">#</a> 7. 全文搜索调优之相关性</h4>
<p>我们在接触 RDBMS 的时候系统是没有相关性的说法的，比如说，2017 年 12 月份 xxx 用户的订单，就是直接 select 出来这些订单。因为 where 语句后面包含了界限明确的条件，而全文搜索则不然。</p>
<p>这个时候一个人拍着桌子站起来，说：不对呀，我要搜索包含周杰伦的所有文章。这咋没有条件边界。</p>
<p>嗯，稍等，『选出所有包含周杰伦的文章』条件很清晰。但问题是，排序怎么做？按照日期排？按照点击率排？这篇文章上周已经在在搜索靠前了，已经『长江后浪推前浪了』上了，这周是不是该差不多『前浪死在沙滩上』了？</p>
<p>Elasticsearch 中使用的计算 score 的公式叫做 practical scoring function, 这个公式借鉴于 TF/TDF 以及 矢量空间模型，但有更多的特征比如，条件因素，字段长度正态化，term / query clause boosting</p>
<p>全文搜索不仅仅找到匹配的 documents, 并且按照相关性进行排序（其实就是打分 score)。</p>
<p>为什么需要打分呢？从相亲角度来说，上海内环有房肯定是个超级大加分项。同样是录入信息，在上海内环有房的权重值可是设置的高一些。</p>
<p>嗯，其实相关性的调优是最难的部分。</p>
<h5 id="索引时三因素"><a class="v-toc-item" href="#索引时三因素">#</a> 索引时三因素</h5>
<p>先看前两个因素 TF/IDF</p>
<ul>
<li>tf(t in d) = sqrt(frequency)</li>
<li>idf(t) = 1 + log (numDocs / (docFreq + 1))</li>
</ul>
<p>再看后一个因素 Field-Length norm</p>
<p>标题越短，这个词对这个 field 的代表性越强</p>
<ul>
<li>norm(d) = 1 / sqrt(numTerms)</li>
</ul>
<h5 id="查询时"><a class="v-toc-item" href="#查询时">#</a> 查询时</h5>
<p>几个词 -&gt; 几维度 -&gt; 寻求最佳匹配以及近似匹配</p>
<ul>
<li>最佳匹配应该是通过计算长度（应该是，但不确定）</li>
<li>近似匹配，计算距离最近的 cos 值。</li>
</ul>
<h5 id="计算公式"><a class="v-toc-item" href="#计算公式">#</a> 计算公式</h5>
<p>这个公式调优的时候需要用到</p>
<pre><code class="language-bash"><span class="token function">score</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>d<span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token function">queryNorm</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>
                <span class="token function">·coord</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
                <span class="token function">·∑</span><span class="token punctuation">(</span><span class="token function">tf</span><span class="token punctuation">(</span>t <span class="token keyword">in</span> d<span class="token punctuation">)</span><span class="token function">·idf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>²·t<span class="token punctuation">.</span><span class="token function">getBoost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">·norm</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>t <span class="token keyword">in</span> q<span class="token punctuation">)</span>
</code></pre>
<h2 id="0x05-搜索语法"><a class="v-toc-item" href="#0x05-搜索语法">#</a> 0x05 搜索语法</h2>
<p>Single document APIs</p>
<ul>
<li>Index API</li>
<li>Get API</li>
<li>Delete API</li>
<li>Update API</li>
<li>Multi-document APIs</li>
</ul>
<p>Multi Get API</p>
<ul>
<li>Bulk API</li>
<li>Delete By Query API</li>
<li>Update By Query API</li>
<li>Reindex API</li>
</ul>
<h2 id="0x06-python-sdk"><a class="v-toc-item" href="#0x06-python-sdk">#</a> 0x06 Python SDK</h2>
<p>官方提供了两个 SDK 方便我们进行日常的开发：</p>
<ul>
<li>elasticsearch</li>
<li>elasticsearch_dsl</li>
</ul>
<p>我更喜欢 elasticsearch , 而不是 elasticsearch_dsl, 因为写起来更容易结合 elasticsearch-head 进行 profile</p>
<p>前者偏底层一些，后者偏高层一些，高底层关系的有点类似于 sql 和 sqlalchemy core 之间的关系。</p>
<h2 id="0x07-踩坑集"><a class="v-toc-item" href="#0x07-踩坑集">#</a> 0x07 踩坑集</h2>
<h2 id="0xee-参考链接"><a class="v-toc-item" href="#0xee-参考链接">#</a> 0xEE 参考链接</h2>
<ul>
<li><a href="https://www.zhihu.com/question/19645541">https://www.zhihu.com/question/19645541</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-15</strong> 重修文字</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4">0x01 安装，配置，基本 shell 命令</a>
<ul>
<li><a href="#1-%E5%AE%89%E8%A3%85">1. 安装</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AE">2. 配置</a></li>
<li><a href="#3-%E6%8F%92%E4%BB%B6">3. 插件</a></li>
</ul>
</li>
<li><a href="#0x02-elasticsearch-%E9%85%8D%E5%A5%97%E5%B7%A5%E5%85%B7">0x02 ElasticSearch 配套工具</a></li>
<li><a href="#0x03-elasticsearch-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">0x03 ElasticSearch 基础概念</a>
<ul>
<li><a href="#31-elasticsearch-crude-%E4%BB%A5%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">3.1 Elasticsearch CRUDE 以及基本操作</a>
<ul>
<li><a href="#curde">CURDE</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2">结构化搜索</a></li>
<li><a href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2">全文搜索</a></li>
<li><a href="#%E8%81%9A%E9%9B%86%E6%90%9C%E7%B4%A2">聚集搜索</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#0x04-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">0x04 全文搜索的基本概念</a>
<ul>
<li><a href="#41-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E9%81%87%E5%88%B0%E7%9A%84%E6%8C%91%E6%88%98">4.1 全文搜索遇到的挑战</a></li>
<li><a href="#42-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E7%B4%A2%E5%BC%95%E6%97%B6%E4%B8%8E%E6%9F%A5%E8%AF%A2%E6%97%B6">4.2 全文搜索的索引时与查询时</a>
<ul>
<li><a href="#1-%E7%B4%A2%E5%BC%95%E6%97%B6-es-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88">1. 索引时 ES 做了什么？</a></li>
<li><a href="#2-%E6%9F%A5%E8%AF%A2%E6%97%B6-es-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88">2. 查询时 ES 做了什么？</a></li>
<li><a href="#3-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D">3. 全文搜索调优之中文分词</a></li>
<li><a href="#4-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E5%81%9C%E6%AD%A2%E8%AF%8D">4. 全文搜索调优之停止词</a></li>
<li><a href="#5-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E5%90%8C%E4%B9%89%E8%AF%8D">5. 全文搜索调优之同义词</a></li>
<li><a href="#6-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E6%8B%BC%E5%86%99%E9%94%99%E8%AF%AF">6. 全文搜索调优之拼写错误</a></li>
<li><a href="#7-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9B%B8%E5%85%B3%E6%80%A7">7. 全文搜索调优之相关性</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%97%B6%E4%B8%89%E5%9B%A0%E7%B4%A0">索引时三因素</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E6%97%B6">查询时</a></li>
<li><a href="#%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F">计算公式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#0x05-%E6%90%9C%E7%B4%A2%E8%AF%AD%E6%B3%95">0x05 搜索语法</a></li>
<li><a href="#0x06-python-sdk">0x06 Python SDK</a></li>
<li><a href="#0x07-%E8%B8%A9%E5%9D%91%E9%9B%86">0x07 踩坑集</a></li>
<li><a href="#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">0xEE 参考链接</a></li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["Pandas","Numpy","CheatSheet"],"path":"20180210_ElasticSearchCheatSheet.md","title":"ElasticSearch CheatSheet","slug":"ElasticSearch CheatSheet","date":"2018-02-10","category":"DevOps","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e本文为 Cheatsheet 类型文章，用于记录我在日常编程中经常使用的 ElasticSearch 相关和命令。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e最早使用 ElasticSearch 是两年前了。最近准备用 Django 写一个全栈式的应用，借用强大的 ES 来做搜索。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e这是我在写程序之余写这篇笔记的原因。最近因为换工作的事情耽误了教程更新，就把这篇笔记放出来吧。不定期更新。\u003c/p\u003e\n\u003cp\u003e官网介绍 ElasticSearch 不仅仅是全文搜索，也可以结构化搜索（这里用结构化查询会更准确一些），处理人类语言，地理位置，以及关系。\u003c/p\u003e\n\u003cp\u003e然而，我在项目使用过程中还是主要用到了全文搜索以及推荐。\u003c/p\u003e\n\u003cp\u003e不用其他的主要原因是因为 ES 尺有所短寸有所长：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003egeo 处理方面 postgis 完全就是神一般的存在。为什么还要用 ES 呢？\u003c/li\u003e\n\u003cli\u003e关系型数据库的核心不就是处理关系？复杂的关系肯定还是放在关系数据库里面。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003ehighlighted search\u003c/li\u003e\n\u003cli\u003esearch-as-you-type\u003c/li\u003e\n\u003cli\u003edid-you-mean suggestions\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我对 ElasticSearch 在后台组件里的作用在于搜索与推荐：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e整站的搜索功能\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e全文搜索\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e推荐\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e依据某几个维度的数据进行排序\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e知乎的文章居然不支持 toc, 实在是太蛋疼了。\u003c/p\u003e\n\u003cp\u003e文章目录如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  ▼ 0x00 前言 : section\n  ▼ 0x01 安装，配置，基本 shell 命令 : section\n      1. 安装 : section\n      2. 配置 : section\n      3. 插件 : section\n    0x02 ElasticSearch 配套工具 : section\n  ▼ 0x03 ElasticSearch 基础概念 : section\n    ▼ 3.1 Elasticsearch CRUDE 以及基本操作 : section\n        CURDE : section\n        普通搜索 : section\n        聚集搜索 : section\n  ▼ 0x04 全文搜索的基本概念 : section\n      4.1 全文搜索遇到的挑战 : section\n    ▼ 4.2 全文搜索的索引时与查询时 : section\n        1. 索引时 ES 做了什么？ : section\n        2. 查询时 ES 做了什么？ : section\n        3. 全文搜索调优之中文分词 : section\n        4. 全文搜索调优之停止词 : section\n        5. 全文搜索调优之同义词 : section\n        6. 全文搜索调优之拼写错误 : section\n      ▼ 7. 全文搜索调优之相关性 : section\n          索引时三因素 : section\n          查询时 : section\n          计算公式 : section\n    0x05 搜索语法 : section\n    0x06 Python SDK : section\n    0x07 踩坑集 : section\n    0xEE 参考链接 : section\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"0x01-安装配置基本-shell-命令\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-安装配置基本-shell-命令\"\u003e#\u003c/a\u003e 0x01 安装，配置，基本 shell 命令\u003c/h2\u003e\n\u003ch3 id=\"1-安装\"\u003e\u003ca class=\"v-toc-item\" href=\"#1-安装\"\u003e#\u003c/a\u003e 1. 安装\u003c/h3\u003e\n\u003cp\u003e具体在项目中的配置建议看一下我写的配置文章 \u003ca href=\"https://zhuanlan.zhihu.com/p/33920401\"\u003ehttps://zhuanlan.zhihu.com/p/33920401\u003c/a\u003e 和并且参考现有代码 \u003ca href=\"https://github.com/twocucao/YaDjangoBlog\"\u003ehttps://github.com/twocucao/YaDjangoBlog\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# 执行如下的命令\ncurl 'http://localhost:9200/?pretty'\n# 输出结果\n{\n  \u0026quot;name\u0026quot; : \u0026quot;XOGvo8a\u0026quot;,\n  \u0026quot;cluster_name\u0026quot; : \u0026quot;docker-cluster\u0026quot;,\n  \u0026quot;cluster_uuid\u0026quot; : \u0026quot;fAwp341bQzalzBxRFyD1YA\u0026quot;,\n  \u0026quot;version\u0026quot; : {\n    \u0026quot;number\u0026quot; : \u0026quot;6.2.1\u0026quot;,\n    \u0026quot;build_hash\u0026quot; : \u0026quot;7299dc3\u0026quot;,\n    \u0026quot;build_date\u0026quot; : \u0026quot;2018-02-07T19:34:26.990113Z\u0026quot;,\n    \u0026quot;build_snapshot\u0026quot; : false,\n    \u0026quot;lucene_version\u0026quot; : \u0026quot;7.2.1\u0026quot;,\n    \u0026quot;minimum_wire_compatibility_version\u0026quot; : \u0026quot;5.6.0\u0026quot;,\n    \u0026quot;minimum_index_compatibility_version\u0026quot; : \u0026quot;5.0.0\u0026quot;\n  },\n  \u0026quot;tagline\u0026quot; : \u0026quot;You Know, for Search\u0026quot;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"2-配置\"\u003e\u003ca class=\"v-toc-item\" href=\"#2-配置\"\u003e#\u003c/a\u003e 2. 配置\u003c/h3\u003e\n\u003cp\u003e配置略\u003c/p\u003e\n\u003ch3 id=\"3-插件\"\u003e\u003ca class=\"v-toc-item\" href=\"#3-插件\"\u003e#\u003c/a\u003e 3. 插件\u003c/h3\u003e\n\u003cp\u003eES 的插件有很多，截止笔者写这篇文章的时候，ES 最新的版本是 6.2.1 版本。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePS: 两年前我用的还是 2.3.3 版本。新版本有很多插件配置起来已经有所不同了。比如说 head 现在已经被独立出来作为一个单纯的网页，chrome 商店可以直接下载。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e需要配 ik-analyser. 如果你在 YaDjangoBlog 中起了这个命令，则已经配置完毕。\u003c/p\u003e\n\u003ch2 id=\"0x02-elasticsearch-配套工具\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-elasticsearch-配套工具\"\u003e#\u003c/a\u003e 0x02 ElasticSearch 配套工具\u003c/h2\u003e\n\u003cp\u003e建议使用 Head 插件来进行简单的查询与调试。\u003c/p\u003e\n\u003ch2 id=\"0x03-elasticsearch-基础概念\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-elasticsearch-基础概念\"\u003e#\u003c/a\u003e 0x03 ElasticSearch 基础概念\u003c/h2\u003e\n\u003ch3 id=\"31-elasticsearch-crude-以及基本操作\"\u003e\u003ca class=\"v-toc-item\" href=\"#31-elasticsearch-crude-以及基本操作\"\u003e#\u003c/a\u003e 3.1 Elasticsearch CRUDE 以及基本操作\u003c/h3\u003e\n\u003cp\u003e详细的搜索见 Python SDK\u003c/p\u003e\n\u003ch4 id=\"curde\"\u003e\u003ca class=\"v-toc-item\" href=\"#curde\"\u003e#\u003c/a\u003e CURDE\u003c/h4\u003e\n\u003cp\u003eES 使用的是 RESTFUL API 接口\u003c/p\u003e\n\u003cp\u003e这也就意味着：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePUT 创建记录\u003c/li\u003e\n\u003cli\u003eGET 获取记录\u003c/li\u003e\n\u003cli\u003ePOST 更新记录\u003c/li\u003e\n\u003cli\u003eDELETE 删除记录\u003c/li\u003e\n\u003cli\u003eHEAD 是否存在\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"结构化搜索\"\u003e\u003ca class=\"v-toc-item\" href=\"#结构化搜索\"\u003e#\u003c/a\u003e 结构化搜索\u003c/h4\u003e\n\u003cp\u003eES 写复杂查询的时候，语法乱，这个过程需要多翻看 guide 和手册。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html\"\u003ehttps://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"全文搜索\"\u003e\u003ca class=\"v-toc-item\" href=\"#全文搜索\"\u003e#\u003c/a\u003e 全文搜索\u003c/h4\u003e\n\u003cp\u003e全文搜索包含两个重要方面：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e相关性：通过 TF/IDF , 距离 , 模糊相似度，以及其他算法\u003c/li\u003e\n\u003cli\u003e分析：大文本 token 化，用于形成倒排索引。这个过程见 4.2\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/guide/current/full-text-search.html\"\u003ehttps://www.elastic.co/guide/en/elasticsearch/guide/current/full-text-search.html\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"聚集搜索\"\u003e\u003ca class=\"v-toc-item\" href=\"#聚集搜索\"\u003e#\u003c/a\u003e 聚集搜索\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/guide/current/aggregations.html\"\u003ehttps://www.elastic.co/guide/en/elasticsearch/guide/current/aggregations.html\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"0x04-全文搜索的基本概念\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-全文搜索的基本概念\"\u003e#\u003c/a\u003e 0x04 全文搜索的基本概念\u003c/h2\u003e\n\u003ch3 id=\"41-全文搜索遇到的挑战\"\u003e\u003ca class=\"v-toc-item\" href=\"#41-全文搜索遇到的挑战\"\u003e#\u003c/a\u003e 4.1 全文搜索遇到的挑战\u003c/h3\u003e\n\u003cp\u003e在最初开源搜索引擎技术还不是很成熟的时候，我们一般都会使用 RDBMS 进行简单搜索。\u003c/p\u003e\n\u003cp\u003e简单搜索，也就是我们常常使用的 like 查询（当然，有的数据库可以使用正则表达式）\u003c/p\u003e\n\u003cp\u003e这种方式是简单暴力的查询方式，优点是实现起来简单暴力。缺点是在这个场景下性能和准确度很差。\u003c/p\u003e\n\u003cp\u003e举例：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e假如站点里文章数量比较大，并且文章内容比较长，则进行一次全表查询，效率可想而知。当然，做好分库分表读写分离也是能用的。\u003c/li\u003e\n\u003cli\u003e如果我要对搜索到的词语进行高亮，则实现方式就只能是把查询到的文章放在应用层里面进行批量替换。\u003c/li\u003e\n\u003cli\u003eRDBMS 似乎完全不懂语言与语言之间的区别。比如说：\n\u003cul\u003e\n\u003cli\u003e『停止词 / 常用词』有的字我是不需要的，比如南京的狗，其实我想搜的是南京狗，这里的『的』就不是我需要的。\u003c/li\u003e\n\u003cli\u003e『同义词』有的字我需要的是他的同义词，比如日本黄狗，其实我想搜的是柴犬。\u003c/li\u003e\n\u003cli\u003e『附加符号』假如说我们搜索一个声调 [nǐ], 总不能让用户打出 [nǐ] 进行搜索吧？总归要转为 ni 才能方便搜索\u003c/li\u003e\n\u003cli\u003e『词根形式』对于一个单词，假如是动词可能有时态上的区分，如果是名词，可能有单复数的区分。假如我搜 mice, 其实同样的 mouse 也应该被搜索出来。但有事用这种方式也会矫枉过正，比如 organizations 的 原型其实并不是 organization 而是，organ. （当然，overstemming 和 understemming 也是两个不可忽视的问题）\n\u003cul\u003e\n\u003cli\u003eNumber: fox, foxes\u003c/li\u003e\n\u003cli\u003eTense: pay, paid, paying\u003c/li\u003e\n\u003cli\u003eGender: waiter, waitress\u003c/li\u003e\n\u003cli\u003ePerson: hear, hears\u003c/li\u003e\n\u003cli\u003eCase: I, me, my\u003c/li\u003e\n\u003cli\u003eAspect: ate, eaten\u003c/li\u003e\n\u003cli\u003eMood: so be it, were it so\u003c/li\u003e\n\u003cli\u003ePS: 万幸的是，中文处理中木词根这个概念。我也就不深入这块了。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e『拼写问题』 周杰棍与周杰伦\u003c/li\u003e\n\u003cli\u003e『分词 / 识别词』中文不像英文，词和词之间是完全没有空格的，也就是说，中文天然要比英文多一个关于分词的步骤。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e是的，我们需要一种新的姿势，来进行搜索。也就是本文所说的全文搜索。\u003c/p\u003e\n\u003ch3 id=\"42-全文搜索的索引时与查询时\"\u003e\u003ca class=\"v-toc-item\" href=\"#42-全文搜索的索引时与查询时\"\u003e#\u003c/a\u003e 4.2 全文搜索的索引时与查询时\u003c/h3\u003e\n\u003cp\u003e本小节先搞清楚两个点，\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e索引时 ES 做了什么？\u003c/li\u003e\n\u003cli\u003e查询时 ES 做了什么？\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e索引时，指的是 ElasticSearch 在存储文档的阶段。\u003c/li\u003e\n\u003cli\u003e查询时，指的是 ElasticSearch 在查询文档的阶段。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"1-索引时-es-做了什么\"\u003e\u003ca class=\"v-toc-item\" href=\"#1-索引时-es-做了什么\"\u003e#\u003c/a\u003e 1. 索引时 ES 做了什么？\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003e这里我们略过定义 index,type,document 仅仅指某个 field 被赋值 document 被保存的时候针对这个被赋值的 text 类型 field 的处理。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003e第一步：\u003cstrong\u003e文本经过 analyzer 处理\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e第二步：\u003cstrong\u003e形成倒排索引\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e先看第一步：\u003c/p\u003e\n\u003cp\u003e通常在定义 field 的时候显式指定 analyzer（分析器）.\u003c/p\u003e\n\u003cp\u003e这个 analyzer 一般的作用如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSTEP 1: 令牌化文本为独立的词\u003c/li\u003e\n\u003cli\u003eSTEP 2: 词语转小写\u003c/li\u003e\n\u003cli\u003eSTEP 3: 去除常见的停止词\u003c/li\u003e\n\u003cli\u003eSTEP 4: 获取词的词根的原型\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e不同的 analyzer 作用大同小异，拿我们常用的 \u003ca href=\"https://github.com/medcl/elasticsearch-analysis-ik\"\u003ehttps://github.com/medcl/elasticsearch-analysis-ik\u003c/a\u003e 的话，则也是类似的步骤（下面步骤是我猜测的，没看源码）\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e令牌化文本为独立的词语 - 分词，并且令牌化文本为独立的词汇\u003c/li\u003e\n\u003cli\u003e除去常见的停止词\u003c/li\u003e\n\u003cli\u003e匹配同义词\u003c/li\u003e\n\u003cli\u003e…\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e可以定义字段的时候可以指定 analyzer（索引时） 与 search_analyzer（查询时）\u003c/p\u003e\n\u003cp\u003e先看经过第一步之后，就可以进入第二步形成倒排索引了，此时，倒排索引之于 ElasticSearch 可以类比于 btree 之于 MySQL 或者 Gist 之于 PostgreSQL.\u003c/p\u003e\n\u003cp\u003e那么，倒排索引包含哪些东西呢？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTerms dictionary\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e已排序完毕的 terms, 以及包含这些 terms 的 documents 的数量。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePostings List\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e哪些 document 包含这些词\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTerms frequency\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e每个 term 在这些文章的频率\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePosition\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e每个 term 在每个 document 的位置，这是为了便于 phrase query 和 proximity query\u003c/li\u003e\n\u003cli\u003e高频词的 phrase query 可能导致 上 G 的数据被读取。虽然有 cache, 但是远远不够。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOffsets\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e每个 term 在每个 document 的开始和结束，便于高亮\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNorms\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e用于给短 field 更多权重的因素.(TODO: 啥玩意）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e减少停止词仅仅可以减少少部分 terms dictionary 和 postings list , 但是 positions 和 offsets data 对 index 的影响则是非常大的。\u003c/p\u003e\n\u003ch4 id=\"2-查询时-es-做了什么\"\u003e\u003ca class=\"v-toc-item\" href=\"#2-查询时-es-做了什么\"\u003e#\u003c/a\u003e 2. 查询时 ES 做了什么？\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e第一步：\u003cstrong\u003e文本经过 analyzer 处理\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e第二步：\u003cstrong\u003e查询倒排索引\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e其实搜索的就是这个玩意。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTerms dictionary\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePostings List\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTerms frequency\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePosition\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOffsets\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNorms\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e于是，我们就必须关注如何更好的查询文档了。下面几个小节，你就知道全文搜索是比较难调优的了。好，一个一个来。\u003c/p\u003e\n\u003ch4 id=\"3-全文搜索调优之中文分词\"\u003e\u003ca class=\"v-toc-item\" href=\"#3-全文搜索调优之中文分词\"\u003e#\u003c/a\u003e 3. 全文搜索调优之中文分词\u003c/h4\u003e\n\u003cp\u003e中文分词以前是个难点，现在基本有成熟的解决方案，在没有更加牛逼的分词技术解决方案之前，现在分词效果主要是拼词典。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTODO: 这个话题可能比较大，先挖坑，以后填\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"4-全文搜索调优之停止词\"\u003e\u003ca class=\"v-toc-item\" href=\"#4-全文搜索调优之停止词\"\u003e#\u003c/a\u003e 4. 全文搜索调优之停止词\u003c/h4\u003e\n\u003cp\u003e使用停止词是减少索引大小的一种方式（减小索引效果不明显），那么，哪些词语可以呗当做停止词呢？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e低频词语：低频词语具备高权重\u003c/li\u003e\n\u003cli\u003e高频词语：高频词语具备低权重\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e当然，是否是高频词语依据个人经验主要依据两点来判断：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e具体场景：比如在英文中，and/the 之类的会比较多，但是中文会比较少。同样的，中文里面其他语言的东西会少一些。正文八经的文章出现不正经的词汇的概率会低。在技术问里面，『数据库』属于高频词汇，但是在比如简书之类的，可能梦想 / 鸡汤 / 超级 / 震惊会多一些。掘金的『前端』两个字绝壁是高频词。\u003c/li\u003e\n\u003cli\u003e抽样跑新词发现的程序。社区里多的是新词发现的脚本。对文章内容或者从搜索框记录下来的搜索词跑一下新词发现的程序，然后人工筛选，应该可以发现更多的高频和低频的词汇。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e是不是用上停止词就好了呢？并不是。\u003c/p\u003e\n\u003cp\u003e比如：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e假如停止词里面包含了 not , 那么 happy 和 not happy 搜索出来的结果则一致。\u003c/li\u003e\n\u003cli\u003e假如停止词里面包含了或，那么，如果有个乐队名字叫做『或或』, 则搜索不出来。\u003c/li\u003e\n\u003cli\u003e假如停止词里面包含了 to / be / not / or , 则莎士比亚的名言 『To be, or not to be』 则搜索不出来。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"5-全文搜索调优之同义词\"\u003e\u003ca class=\"v-toc-item\" href=\"#5-全文搜索调优之同义词\"\u003e#\u003c/a\u003e 5. 全文搜索调优之同义词\u003c/h4\u003e\n\u003cp\u003e同义词也有很多种：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e平级关系：插、戳、刺、扎\u003c/li\u003e\n\u003cli\u003e包含关系：成人包含男人和女人\u003c/li\u003e\n\u003cli\u003e不容易分清楚关系：\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e炒，煎，贴，烹，炸，溜\u003cbr\u003e\n　- 汆，涮，煮，炖，煨，焐\u003cbr\u003e\n　- 蒸，鲊\u003cbr\u003e\n　- 卤，酱，熏，烤，炝，腌，拌，焗\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e随着场景的不同，上面有些同义词也是不能轻而易举同义的。\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e-\u003c/th\u003e\n\u003cth\u003e索引时\u003c/th\u003e\n\u003cth\u003e查询时\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e索引大小\u003c/td\u003e\n\u003ctd\u003e耗时变多，同义词被索引，大小更大\u003c/td\u003e\n\u003ctd\u003e耗时几乎不变\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e相关性\u003c/td\u003e\n\u003ctd\u003e准确度下降，所有同义词相同 IDF, 则在所有文档的索引记录中，常用词和冷门词权重相同\u003c/td\u003e\n\u003ctd\u003e准确度提升，每个同义词的 IDF 将被校正\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e性能\u003c/td\u003e\n\u003ctd\u003e性能下降，查询需要涨到\u003c/td\u003e\n\u003ctd\u003e性能下降，查询被重写，用于查找同义词\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e灵活性\u003c/td\u003e\n\u003ctd\u003e变差，同义词法则不改变已存在记录，需重新索引\u003c/td\u003e\n\u003ctd\u003e不变，同义词法则可被更新，无需重新索引\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e由此可见，大部分场景下的索引时如果没有特别的需求，\u003cstrong\u003e谨慎使用同义词\u003c/strong\u003e。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e同义词使用自定义 filter , 并且在新建 analyzer 并指定 filter 即可。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"6-全文搜索调优之拼写错误\"\u003e\u003ca class=\"v-toc-item\" href=\"#6-全文搜索调优之拼写错误\"\u003e#\u003c/a\u003e 6. 全文搜索调优之拼写错误\u003c/h4\u003e\n\u003cp\u003e有的时候，用户也会输入错误：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e手误，把『周杰伦』拼成『周杰棍』\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这个时候，搜索引擎应该提示一下，您搜索的是不是『周杰伦』呢？\u003c/p\u003e\n\u003cp\u003e这里面就遇到了一个问题，我们显然知道周杰棍和周杰伦是是相似的，为什么呢？或者说，直观上感知的详细，能用数学方式表达出来吗？\u003c/p\u003e\n\u003cp\u003e有人说，正则匹配 / 通配符匹配呗。这是一个思路。\u003c/p\u003e\n\u003cp\u003eVladimir Levenshtein 和 frederic damerau 给出了一种相似度算法 \u003ca href=\"https://en.wikipedia.org/wiki/Damerau%E2%80%93Levenshtein_distance\"\u003ehttps://en.wikipedia.org/wiki/Damerau–Levenshtein_distance\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e一个词组通过转换到另一个词的步数就是其距离：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e替换：『周杰伦』到『周杰棍』\u003c/li\u003e\n\u003cli\u003e插入：『周杰』到『周杰棍』\u003c/li\u003e\n\u003cli\u003e删除：『周杰伦』到『周杰』\u003c/li\u003e\n\u003cli\u003e相邻字符转换：『周伦杰』和『周杰伦』 , 但是『周杰棍的双节伦』到『周杰伦的双节棍』 并不是相邻字符转换\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e用法：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e指定 “fuzziness”: step 即可\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e当 step \u0026gt;=2 的时候，ES 进行查询的时候，每次查询都会遍历 terms 字典，所以，如果 fuzziness 大于 2 的时候遍历 terms 的数量则非常惊人了。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e方法一：设置 prefix_length, 单词的前面一定长度不进行 fuzzy 匹配。一般设置为 3 （估计这是属于英文的匹配，中文环境做不了参考）;\u003c/li\u003e\n\u003cli\u003e方法二：设置 max_expansins, 类似于 RDBMS 的 limit, 查询到一定记录之后停止查询。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003efuzzy match query 也是支持的，比如说，假如你指定 “fuzziness” 为 1, 搜索周杰棍，则将周杰伦，周杰全搜索出来了。似乎搜索的很全面呀，但是问题来了：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e依据 TF/IDF 的高频低权重，低频高权重的计算方式，\u003cstrong\u003e周杰棍由于出现次数极少，反而获得了极高的权重。\u003c/strong\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e跑个题，这种因为『出现次数少，查询的时候反而显得权重较高』的情况。并不仅仅出现在 TF/IDF 算法上。\u003c/p\u003e\n\u003cp\u003e这方面搜索引擎和人是一样一样的\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e小孩子听腻了家长们所说的『带着脑子去学习』, 反而觉得以前没出现的新词叫『刻意学习』牛逼到爆。\u003c/li\u003e\n\u003cli\u003e美女听腻了直男癌说的『漂亮』, 反而觉得夸她『品质 / 品味』的话语词词入心。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e回到正题\u003c/p\u003e\n\u003cp\u003e所以，一般情况下还是建议拼写错误主要还是用于：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSearch as you type : completion suggester\u003c/li\u003e\n\u003cli\u003eDid you mean : phrase suggester\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"7-全文搜索调优之相关性\"\u003e\u003ca class=\"v-toc-item\" href=\"#7-全文搜索调优之相关性\"\u003e#\u003c/a\u003e 7. 全文搜索调优之相关性\u003c/h4\u003e\n\u003cp\u003e我们在接触 RDBMS 的时候系统是没有相关性的说法的，比如说，2017 年 12 月份 xxx 用户的订单，就是直接 select 出来这些订单。因为 where 语句后面包含了界限明确的条件，而全文搜索则不然。\u003c/p\u003e\n\u003cp\u003e这个时候一个人拍着桌子站起来，说：不对呀，我要搜索包含周杰伦的所有文章。这咋没有条件边界。\u003c/p\u003e\n\u003cp\u003e嗯，稍等，『选出所有包含周杰伦的文章』条件很清晰。但问题是，排序怎么做？按照日期排？按照点击率排？这篇文章上周已经在在搜索靠前了，已经『长江后浪推前浪了』上了，这周是不是该差不多『前浪死在沙滩上』了？\u003c/p\u003e\n\u003cp\u003eElasticsearch 中使用的计算 score 的公式叫做 practical scoring function, 这个公式借鉴于 TF/TDF 以及 矢量空间模型，但有更多的特征比如，条件因素，字段长度正态化，term / query clause boosting\u003c/p\u003e\n\u003cp\u003e全文搜索不仅仅找到匹配的 documents, 并且按照相关性进行排序（其实就是打分 score)。\u003c/p\u003e\n\u003cp\u003e为什么需要打分呢？从相亲角度来说，上海内环有房肯定是个超级大加分项。同样是录入信息，在上海内环有房的权重值可是设置的高一些。\u003c/p\u003e\n\u003cp\u003e嗯，其实相关性的调优是最难的部分。\u003c/p\u003e\n\u003ch5 id=\"索引时三因素\"\u003e\u003ca class=\"v-toc-item\" href=\"#索引时三因素\"\u003e#\u003c/a\u003e 索引时三因素\u003c/h5\u003e\n\u003cp\u003e先看前两个因素 TF/IDF\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003etf(t in d) = sqrt(frequency)\u003c/li\u003e\n\u003cli\u003eidf(t) = 1 + log (numDocs / (docFreq + 1))\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e再看后一个因素 Field-Length norm\u003c/p\u003e\n\u003cp\u003e标题越短，这个词对这个 field 的代表性越强\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003enorm(d) = 1 / sqrt(numTerms)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch5 id=\"查询时\"\u003e\u003ca class=\"v-toc-item\" href=\"#查询时\"\u003e#\u003c/a\u003e 查询时\u003c/h5\u003e\n\u003cp\u003e几个词 -\u0026gt; 几维度 -\u0026gt; 寻求最佳匹配以及近似匹配\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e最佳匹配应该是通过计算长度（应该是，但不确定）\u003c/li\u003e\n\u003cli\u003e近似匹配，计算距离最近的 cos 值。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch5 id=\"计算公式\"\u003e\u003ca class=\"v-toc-item\" href=\"#计算公式\"\u003e#\u003c/a\u003e 计算公式\u003c/h5\u003e\n\u003cp\u003e这个公式调优的时候需要用到\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003escore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e  \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003equeryNorm\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eq\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token function\"\u003e·coord\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token function\"\u003e·∑\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003etf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e d\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token function\"\u003e·idf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e²·t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetBoost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token function\"\u003e·norm\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e q\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x05-搜索语法\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x05-搜索语法\"\u003e#\u003c/a\u003e 0x05 搜索语法\u003c/h2\u003e\n\u003cp\u003eSingle document APIs\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIndex API\u003c/li\u003e\n\u003cli\u003eGet API\u003c/li\u003e\n\u003cli\u003eDelete API\u003c/li\u003e\n\u003cli\u003eUpdate API\u003c/li\u003e\n\u003cli\u003eMulti-document APIs\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMulti Get API\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBulk API\u003c/li\u003e\n\u003cli\u003eDelete By Query API\u003c/li\u003e\n\u003cli\u003eUpdate By Query API\u003c/li\u003e\n\u003cli\u003eReindex API\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"0x06-python-sdk\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x06-python-sdk\"\u003e#\u003c/a\u003e 0x06 Python SDK\u003c/h2\u003e\n\u003cp\u003e官方提供了两个 SDK 方便我们进行日常的开发：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eelasticsearch\u003c/li\u003e\n\u003cli\u003eelasticsearch_dsl\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我更喜欢 elasticsearch , 而不是 elasticsearch_dsl, 因为写起来更容易结合 elasticsearch-head 进行 profile\u003c/p\u003e\n\u003cp\u003e前者偏底层一些，后者偏高层一些，高底层关系的有点类似于 sql 和 sqlalchemy core 之间的关系。\u003c/p\u003e\n\u003ch2 id=\"0x07-踩坑集\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x07-踩坑集\"\u003e#\u003c/a\u003e 0x07 踩坑集\u003c/h2\u003e\n\u003ch2 id=\"0xee-参考链接\"\u003e\u003ca class=\"v-toc-item\" href=\"#0xee-参考链接\"\u003e#\u003c/a\u003e 0xEE 参考链接\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.zhihu.com/question/19645541\"\u003ehttps://www.zhihu.com/question/19645541\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eChangeLog:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e2018-02-15\u003c/strong\u003e 重修文字\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4\"\u003e0x01 安装，配置，基本 shell 命令\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#1-%E5%AE%89%E8%A3%85\"\u003e1. 安装\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#2-%E9%85%8D%E7%BD%AE\"\u003e2. 配置\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#3-%E6%8F%92%E4%BB%B6\"\u003e3. 插件\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-elasticsearch-%E9%85%8D%E5%A5%97%E5%B7%A5%E5%85%B7\"\u003e0x02 ElasticSearch 配套工具\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-elasticsearch-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5\"\u003e0x03 ElasticSearch 基础概念\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#31-elasticsearch-crude-%E4%BB%A5%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C\"\u003e3.1 Elasticsearch CRUDE 以及基本操作\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#curde\"\u003eCURDE\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2\"\u003e结构化搜索\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2\"\u003e全文搜索\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%81%9A%E9%9B%86%E6%90%9C%E7%B4%A2\"\u003e聚集搜索\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5\"\u003e0x04 全文搜索的基本概念\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#41-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E9%81%87%E5%88%B0%E7%9A%84%E6%8C%91%E6%88%98\"\u003e4.1 全文搜索遇到的挑战\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#42-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E7%B4%A2%E5%BC%95%E6%97%B6%E4%B8%8E%E6%9F%A5%E8%AF%A2%E6%97%B6\"\u003e4.2 全文搜索的索引时与查询时\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#1-%E7%B4%A2%E5%BC%95%E6%97%B6-es-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88\"\u003e1. 索引时 ES 做了什么？\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#2-%E6%9F%A5%E8%AF%A2%E6%97%B6-es-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88\"\u003e2. 查询时 ES 做了什么？\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#3-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D\"\u003e3. 全文搜索调优之中文分词\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#4-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E5%81%9C%E6%AD%A2%E8%AF%8D\"\u003e4. 全文搜索调优之停止词\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#5-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E5%90%8C%E4%B9%89%E8%AF%8D\"\u003e5. 全文搜索调优之同义词\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#6-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E6%8B%BC%E5%86%99%E9%94%99%E8%AF%AF\"\u003e6. 全文搜索调优之拼写错误\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#7-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9B%B8%E5%85%B3%E6%80%A7\"\u003e7. 全文搜索调优之相关性\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E7%B4%A2%E5%BC%95%E6%97%B6%E4%B8%89%E5%9B%A0%E7%B4%A0\"\u003e索引时三因素\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%9F%A5%E8%AF%A2%E6%97%B6\"\u003e查询时\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F\"\u003e计算公式\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x05-%E6%90%9C%E7%B4%A2%E8%AF%AD%E6%B3%95\"\u003e0x05 搜索语法\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x06-python-sdk\"\u003e0x06 Python SDK\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x07-%E8%B8%A9%E5%9D%91%E9%9B%86\"\u003e0x07 踩坑集\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"\u003e0xEE 参考链接\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"ElasticSearch CheatSheet"},"buildId":"oDi_oBCBuu3qj6v7hDnrL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>