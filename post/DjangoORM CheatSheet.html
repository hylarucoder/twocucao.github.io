<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>DjangoORM CheatSheet | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_buildManifest.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><p>本文是《Python ORM 三部曲的第二部 - Django ORM 的用法 / 原理 / 优化》</p>
<p>上一部的地址为《Python ORM 三部曲的第一部 - Python ORM 的三种实现模式》</p>
<p>本文基于最新 Django 版本</p>
<ol>
<li>模型定义</li>
<li>Create/Update/Delete</li>
<li>各种查询 / 链式调用 / F 表达式 / Window 函数 /Lazy Loading / Eager Loading</li>
<li>Join</li>
<li>DEBUG 和 Profile 技巧</li>
</ol>
<p>本文是《Python ORM 三部曲的第一部 - Python 的三种数据源架构模式》</p>
<p>本文适用于：</p>
<ol>
<li>好奇 or 喜欢折腾的程序员</li>
<li>想深入了解 ORM 的程序员</li>
</ol>
<p>本文将解决你以下的疑惑：</p>
<ol>
<li>能不能不用 ORM?</li>
<li>ORM 为什么在某些场景下会胜于写 SQL</li>
<li>不同的 ORM 实现机制会带来什么差异？</li>
</ol>
<h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>新工作的技术栈是以 Flask 为主，SQLAlchemy 是 许多玩 Flask 的人的标配。好，文档读起来，笔记搞起来。</p>
<blockquote>
<p>所以，本文记录的是 Django ORM</p>
</blockquote>
<p>逃。</p>
<p>这篇文章也是我对比 SqlAlchemy 以及 DjangoORM 的产物</p>
<h2 id="0x01-如何快速上手"><a class="v-toc-item" href="#0x01-如何快速上手">#</a> 0x01 如何快速上手</h2>
<p>Django 世界里面，Django 的文档每次刷都会有新的发现。</p>
<h2 id="0x02-djangoorm-的基本功能"><a class="v-toc-item" href="#0x02-djangoorm-的基本功能">#</a> 0x02 DjangoORM 的基本功能</h2>
<h3 id="21-模型定义-model"><a class="v-toc-item" href="#21-模型定义-model">#</a> 2.1 模型定义 Model</h3>
<pre><code>from django.db import models

class Musician(models.Model):
    first_name = models.CharField(max_length=50) # Field
    last_name = models.CharField(max_length=50)
    instrument = models.CharField(max_length=100)

class Album(models.Model):
    artist = models.ForeignKey(Musician, on_delete=models.CASCADE)
    name = models.CharField(max_length=100)
    release_date = models.DateField()
    num_stars = models.IntegerField()

    class Meta: # Model Meta
        order_with_respect_to = 'question'
</code></pre>
<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="models-与-meta"><a class="v-toc-item" href="#models-与-meta">#</a> Models 与 Meta</h4>
<blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，Model 与 session 耦合。</p>
</blockquote>
<h4 id="field-与-field-options"><a class="v-toc-item" href="#field-与-field-options">#</a> Field 与 Field Options</h4>
<h5 id="field"><a class="v-toc-item" href="#field">#</a> Field</h5>
<ul>
<li>AutoField</li>
<li>BigAutoField</li>
<li>BigIntegerField</li>
<li>BinaryField</li>
<li>BooleanField</li>
<li>CharField</li>
<li>DateField</li>
<li>DateTimeField</li>
<li>DecimalField</li>
<li>DurationField</li>
<li>EmailField</li>
<li>FileField</li>
<li>FileField and FieldFile</li>
<li>FilePathField</li>
<li>FloatField</li>
<li>ImageField</li>
<li>IntegerField</li>
<li>GenericIPAddressField</li>
<li>NullBooleanField</li>
<li>PositiveIntegerField</li>
<li>PositiveSmallIntegerField</li>
<li>SlugField</li>
<li>SmallIntegerField</li>
<li>TextField</li>
<li>TimeField</li>
<li>URLField</li>
<li>UUIDField</li>
</ul>
<p>虽然有这么多东东，其实常用的如下</p>
<ul>
<li>BigIntegerField</li>
<li>BooleanField</li>
<li>CharField</li>
<li>DateField</li>
<li>DateTimeField</li>
<li>DecimalField</li>
<li>IntegerField</li>
<li>TextField</li>
<li>TimeField</li>
</ul>
<p>有的字段属于那种，有也可以，没有也可以的。</p>
<p>FileField 之类的 往往现在都被 CDN 取代</p>
<h5 id="field-options"><a class="v-toc-item" href="#field-options">#</a> Field Options</h5>
<ul>
<li>null</li>
<li>blank</li>
<li>choices
<ul>
<li>p.shirt_size</li>
<li>p.get_shirt_size_display()</li>
</ul>
</li>
<li>db_column</li>
<li>db_index</li>
<li>db_tablespace</li>
<li>default</li>
<li>editable</li>
<li>error_messages</li>
<li>help_text</li>
<li>primary_key</li>
<li>unique</li>
<li>unique_for_date</li>
<li>unique_for_month</li>
<li>unique_for_year</li>
<li>verbose_name</li>
<li>validators</li>
</ul>
<p>如此可见，Django 的 ORM 比起 SQLAlchemy 做了不少应用层的校验，一些 help_text</p>
<h4 id="relationship"><a class="v-toc-item" href="#relationship">#</a> Relationship</h4>
<p>表和表之间的关系</p>
<ol>
<li>A 表和 B 表 一对多 / 多对一</li>
<li>A 表和 B 表 一对一 （特殊的一对多）</li>
<li>A 表和 B 表 简单多对多 （借助中间的 Mapping 表进行映射）</li>
<li>A 表和 B 表 复杂多对多</li>
<li>A 表和 B 表 一对多</li>
</ol>
<pre><code>from django.db import models

class Manufacturer(models.Model):
    # ...
    pass

class Car(models.Model):
    manufacturer = models.ForeignKey(Manufacturer, on_delete=models.CASCADE)
    # ...
</code></pre>
<pre><code>from django.db import models

class Topping(models.Model):
    # ...
    pass

class Pizza(models.Model):
    # ...
    toppings = models.ManyToManyField(Topping)
</code></pre>
<pre><code>from django.db import models

class Person(models.Model):
    name = models.CharField(max_length=128)

    def __str__(self):
        return self.name

class Group(models.Model):
    name = models.CharField(max_length=128)
    members = models.ManyToManyField(Person, through='Membership')

    def __str__(self):
        return self.name

class Membership(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE)
    group = models.ForeignKey(Group, on_delete=models.CASCADE)
    date_joined = models.DateField()
    invite_reason = models.CharField(max_length=64)
</code></pre>
<pre><code>Models across files
</code></pre>
<pre><code>objects
</code></pre>
<pre><code>Models 重写方法
</code></pre>
<pre><code>Models 继承
https://docs.djangoproject.com/en/2.0/topics/db/models/#model-inheritance
</code></pre>
<pre><code>组织代码 - 以及应对循环引用
</code></pre>
<h3 id="22-queryset"><a class="v-toc-item" href="#22-queryset">#</a> 2.2 QuerySet</h3>
<h4 id="create"><a class="v-toc-item" href="#create">#</a> Create</h4>
<pre><code>c = Child(name=&quot;苏轼&quot;)
c.save()
p = Parent(name=&quot;苏辙&quot;)
p.best_child = c
p.children.add([c,c2,c3,c4])
p.save()
</code></pre>
<h4 id="retrieve"><a class="v-toc-item" href="#retrieve">#</a> Retrieve</h4>
<p>过滤</p>
<p>filter(**kwargs)<br>
exclude(**kwargs)<br>
.all()</p>
<h5 id="跨关系跨表查询"><a class="v-toc-item" href="#跨关系跨表查询">#</a> 跨关系（跨表）查询</h5>
<p>Blog.objects.filter(entry<strong>headline</strong>contains=‘Lennon’)</p>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships">https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships</a></p>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships">https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships</a></p>
<h5 id="prefetch_related-select_related"><a class="v-toc-item" href="#prefetch_related-select_related">#</a> prefetch_related &amp;&amp; select_related</h5>
<pre><code>select_related

生成 join 的 SQL, 可以用来减少 N+1 , 不过仅仅支持一对多，和一对一

prefetch_related
</code></pre>
<h5 id="limit-offset-分页"><a class="v-toc-item" href="#limit-offset-分页">#</a> Limit / Offset / 分页</h5>
<p>Blog.objects.filter(entry<strong>headline</strong>contains=‘Lennon’)[30:20]</p>
<h5 id="链式调用"><a class="v-toc-item" href="#链式调用">#</a> 链式调用</h5>
<p>query = query.filter(**kwargs)<br>
query = query.exclude(**kwargs)</p>
<h5 id="表达式"><a class="v-toc-item" href="#表达式">#</a> 表达式</h5>
<p>Django 里面最强大的就是其 Q 表达式了</p>
<p>Q(question<strong>startswith=‘Who’) | Q(question</strong>startswith=‘What’)</p>
<p>Poll.objects.get(<br>
Q(question__startswith=‘Who’),<br>
Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))<br>
)</p>
<p>这个表达式甚至可以嵌套超级深从而完成一个比较深的跨表查询。</p>
<blockquote>
<p>并且，这种 API 查询反而在写前端 API 的时候，可以传入 question__startswith 这类参数，从而直接完成一组搜索。</p>
</blockquote>
<p>Q / F</p>
<h5 id="执行查询"><a class="v-toc-item" href="#执行查询">#</a> 执行查询</h5>
<p>需要注意的的是，SQLAlchemy 必须显式执行查询，而 Django 不一定。</p>
<p><a href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated">https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated</a></p>
<p>在 Django 内部实现的时候，一个 queryset 创建 / 过滤 / 切片 / 传送，<strong>除非这个 queryset 被 evaluated 了</strong>, 否则不会做数据库的操作。</p>
<ul>
<li>iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>repr</li>
<li>len</li>
<li>list</li>
<li>bool</li>
</ul>
<pre><code>all()
first()
last()
exist()
</code></pre>
<h5 id="比较"><a class="v-toc-item" href="#比较">#</a> 比较</h5>
<ul>
<li>pk</li>
<li>model</li>
</ul>
<h5 id="复制-实例"><a class="v-toc-item" href="#复制-实例">#</a> 复制 实例</h5>
<pre><code>blog = Blog(name='My blog', tagline='Blogging is easy')
blog.save() # blog.pk == 1

blog.pk = None
blog.save() # blog.pk == 2

# 但这个并不拷贝外键？???
https://docs.djangoproject.com/en/2.0/topics/db/queries/#copying-model-instances
</code></pre>
<h5 id="其他"><a class="v-toc-item" href="#其他">#</a> 其他</h5>
<pre><code># 默认查询的是所有字段，但我希望查询部分字段
# TODO: 阿萨德
# Distinct
# OrderBy

</code></pre>
<h5 id="缓存机制"><a class="v-toc-item" href="#缓存机制">#</a> 缓存机制</h5>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets">https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets</a></p>
<h4 id="update"><a class="v-toc-item" href="#update">#</a> Update</h4>
<p>单个 object 更新</p>
<pre><code>blog.title = &quot;大宝天天见&quot;
blog.save()
</code></pre>
<p>批量更新</p>
<pre><code>query.update(headline=F('blog__name'))
</code></pre>
<p>一对多的更新（类似于 Set 操作）</p>
<pre><code>add(obj1, obj2, ...)
create(**kwargs)
remove(obj1, obj2, ...)
clear()
set(objs)
</code></pre>
<h4 id="delete"><a class="v-toc-item" href="#delete">#</a> Delete</h4>
<h5 id="foreignkey"><a class="v-toc-item" href="#foreignkey">#</a> ForeignKey</h5>
<pre><code>class Car(models.Model):
    manufacturer = models.ForeignKey(
        'production.Manufacturer', # 用来解决循环 circular import
        on_delete=models.CASCADE,
    )
</code></pre>
<p>on_delete 的情况</p>
<ul>
<li>PROTECT 阻止</li>
<li>CASCADE 应用层的级联删除</li>
<li>SET_NULL 应用层的级联 SET_NULL</li>
<li>SET_DEFAULT</li>
<li>DO_NOTHING</li>
<li>SET() 一个 callback</li>
</ul>
<h4 id="聚集查询"><a class="v-toc-item" href="#聚集查询">#</a> 聚集查询</h4>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/aggregation/">https://docs.djangoproject.com/en/2.0/topics/db/aggregation/</a></p>
<pre><code>Book.objects.all().aggregate(Max('price'))
Book.objects.aggregate(price_diff=Max('price', output_field=FloatField()) - Avg('price'))
Book.objects.annotate(num_authors=Count('authors'))
Book.objects.annotate(num_authors=Count('authors')).aggregate(Avg('num_authors')) # {'num_authors__avg': 1.66}
</code></pre>
<h4 id="search"><a class="v-toc-item" href="#search">#</a> Search</h4>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/search/">https://docs.djangoproject.com/en/2.0/topics/db/search/</a></p>
<h4 id="window-function"><a class="v-toc-item" href="#window-function">#</a> Window Function</h4>
<pre><code>Option.objects.annotate(
		rank_num=Window(
				expression=Rank(),
				partition_by=F(&quot;vote_id&quot;),
				order_by=[F(&quot;current_vote_count&quot;).desc(), F(&quot;id&quot;).desc()],
		),
		lag_vote_num=Window(
				expression=Lag(&quot;current_vote_count&quot;),
				partition_by=F(&quot;vote_id&quot;),
				order_by=[F(&quot;current_vote_count&quot;).desc(), F(&quot;id&quot;).desc()],
		),
)
.filter(vote=obj.vote)
.order_by(&quot;-current_vote_count&quot;, &quot;id&quot;)
.values(&quot;id&quot;, &quot;rank_num&quot;, &quot;current_vote_count&quot;, &quot;lag_vote_num&quot;)
</code></pre>
<h3 id="22-model-instances"><a class="v-toc-item" href="#22-model-instances">#</a> 2.2 Model Instances</h3>
<p><a href="https://docs.djangoproject.com/en/2.0/ref/models/instances/">https://docs.djangoproject.com/en/2.0/ref/models/instances/</a></p>
<h3 id="23-模型实例"><a class="v-toc-item" href="#23-模型实例">#</a> 2.3 模型实例</h3>
<h3 id="24-迁移机制"><a class="v-toc-item" href="#24-迁移机制">#</a> 2.4 迁移机制</h3>
<ol>
<li>加 INSTALLED_APPS</li>
</ol>
<h2 id="0x03-django-orm-的高级功能"><a class="v-toc-item" href="#0x03-django-orm-的高级功能">#</a> 0x03 Django ORM 的高级功能</h2>
<h3 id="maneger"><a class="v-toc-item" href="#maneger">#</a> maneger</h3>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/managers/">https://docs.djangoproject.com/en/2.0/topics/db/managers/</a></p>
<h3 id="raw-sql"><a class="v-toc-item" href="#raw-sql">#</a> raw sql</h3>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/sql/">https://docs.djangoproject.com/en/2.0/topics/db/sql/</a></p>
<h4 id="database-fuction"><a class="v-toc-item" href="#database-fuction">#</a> database-fuction</h4>
<p><a href="https://docs.djangoproject.com/en/2.0/ref/models/database-functions/">https://docs.djangoproject.com/en/2.0/ref/models/database-functions/</a></p>
<h2 id="0x04-database-access-optimization"><a class="v-toc-item" href="#0x04-database-access-optimization">#</a> 0x04 Database Access Optimization</h2>
<h3 id="41-使用连接池"><a class="v-toc-item" href="#41-使用连接池">#</a> 4.1 使用连接池</h3>
<p>连接池是一种永远在线模型的实现</p>
<p>连接池：驱动程序类型</p>
<p>连接池：代理类型</p>
<h3 id="42-减少对-mysql-的访问"><a class="v-toc-item" href="#42-减少对-mysql-的访问">#</a> 4.2 减少对 MySQL 的访问</h3>
<pre><code>select count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() and usename = current_user;

</code></pre>
<h3 id="before"><a class="v-toc-item" href="#before">#</a> Before</h3>
<pre><code>select count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() and usename = current_user;

</code></pre>
<h3 id="profile-first"><a class="v-toc-item" href="#profile-first">#</a> Profile First</h3>
<ol>
<li>django-extentions</li>
<li>django-debug-toolbar</li>
</ol>
<p>手动</p>
<pre><code>queryset.explain

from django.db import connection
connection.queries

from django.db import reset_queries
reset_queries()
</code></pre>
<h2 id="0x05-django-orm-under-the-hood"><a class="v-toc-item" href="#0x05-django-orm-under-the-hood">#</a> 0x05 Django ORM Under The Hood</h2>
<h3 id="理解-queryset"><a class="v-toc-item" href="#理解-queryset">#</a> 理解 QuerySet</h3>
<ul>
<li>querysets-are-lazy when-querysets-are-evaluated
<ul>
<li>Iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>len</li>
<li>repr</li>
<li>list</li>
<li>bool</li>
</ul>
</li>
</ul>
<pre><code>obj == nobj # obj.id == nobj.id
</code></pre>
<ul>
<li>caching-and-querysets</li>
</ul>
<h3 id="理解-cached-attributes"><a class="v-toc-item" href="#理解-cached-attributes">#</a> 理解 cached attributes</h3>
<pre><code>&gt;&gt;&gt; entry = Entry.objects.get(id=1)
&gt;&gt;&gt; entry.blog   # Blog object is retrieved at this point
&gt;&gt;&gt; entry.blog   # cached version, no DB access

&gt;&gt;&gt; entry = Entry.objects.get(id=1)
&gt;&gt;&gt; entry.authors.all()   # query performed
&gt;&gt;&gt; entry.authors.all()   # query performed again
</code></pre>
<h2 id="0xee-参考链接"><a class="v-toc-item" href="#0xee-参考链接">#</a> 0xEE 参考链接</h2>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B">0x01 如何快速上手</a></li>
<li><a href="#0x02-djangoorm-%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD">0x02 DjangoORM 的基本功能</a>
<ul>
<li><a href="#21-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89-model">2.1 模型定义 Model</a>
<ul>
<li><a href="#models-%E4%B8%8E-meta">Models 与 Meta</a></li>
<li><a href="#field-%E4%B8%8E-field-options">Field 与 Field Options</a>
<ul>
<li><a href="#field">Field</a></li>
<li><a href="#field-options">Field Options</a></li>
</ul>
</li>
<li><a href="#relationship">Relationship</a></li>
</ul>
</li>
<li><a href="#22-queryset">2.2 QuerySet</a>
<ul>
<li><a href="#create">Create</a></li>
<li><a href="#retrieve">Retrieve</a>
<ul>
<li><a href="#%E8%B7%A8%E5%85%B3%E7%B3%BB%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2">跨关系（跨表）查询</a></li>
<li><a href="#prefetch_related-select_related">prefetch_related &amp;&amp; select_related</a></li>
<li><a href="#limit-offset-%E5%88%86%E9%A1%B5">Limit / Offset / 分页</a></li>
<li><a href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">链式调用</a></li>
<li><a href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F">表达式</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2">执行查询</a></li>
<li><a href="#%E6%AF%94%E8%BE%83">比较</a></li>
<li><a href="#%E5%A4%8D%E5%88%B6-%E5%AE%9E%E4%BE%8B">复制 实例</a></li>
<li><a href="#%E5%85%B6%E4%BB%96">其他</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6">缓存机制</a></li>
</ul>
</li>
<li><a href="#update">Update</a></li>
<li><a href="#delete">Delete</a>
<ul>
<li><a href="#foreignkey">ForeignKey</a></li>
</ul>
</li>
<li><a href="#%E8%81%9A%E9%9B%86%E6%9F%A5%E8%AF%A2">聚集查询</a></li>
<li><a href="#search">Search</a></li>
<li><a href="#window-function">Window Function</a></li>
</ul>
</li>
<li><a href="#22-model-instances">2.2 Model Instances</a></li>
<li><a href="#23-%E6%A8%A1%E5%9E%8B%E5%AE%9E%E4%BE%8B">2.3 模型实例</a></li>
<li><a href="#24-%E8%BF%81%E7%A7%BB%E6%9C%BA%E5%88%B6">2.4 迁移机制</a></li>
</ul>
</li>
<li><a href="#0x03-django-orm-%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">0x03 Django ORM 的高级功能</a>
<ul>
<li><a href="#maneger">maneger</a></li>
<li><a href="#raw-sql">raw sql</a>
<ul>
<li><a href="#database-fuction">database-fuction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#0x04-database-access-optimization">0x04 Database Access Optimization</a>
<ul>
<li><a href="#41-%E4%BD%BF%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0">4.1 使用连接池</a></li>
<li><a href="#42-%E5%87%8F%E5%B0%91%E5%AF%B9-mysql-%E7%9A%84%E8%AE%BF%E9%97%AE">4.2 减少对 MySQL 的访问</a></li>
<li><a href="#before">Before</a></li>
<li><a href="#profile-first">Profile First</a></li>
</ul>
</li>
<li><a href="#0x05-django-orm-under-the-hood">0x05 Django ORM Under The Hood</a>
<ul>
<li><a href="#%E7%90%86%E8%A7%A3-queryset">理解 QuerySet</a></li>
<li><a href="#%E7%90%86%E8%A7%A3-cached-attributes">理解 cached attributes</a></li>
</ul>
</li>
<li><a href="#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">0xEE 参考链接</a></li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["Django","ORM"],"path":"20180428_DjangoORMCheatSheet.md","title":"DjangoORM CheatSheet","slug":"DjangoORM CheatSheet","date":"2018-04-28","category":"Django","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003cp\u003e本文是《Python ORM 三部曲的第二部 - Django ORM 的用法 / 原理 / 优化》\u003c/p\u003e\n\u003cp\u003e上一部的地址为《Python ORM 三部曲的第一部 - Python ORM 的三种实现模式》\u003c/p\u003e\n\u003cp\u003e本文基于最新 Django 版本\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e模型定义\u003c/li\u003e\n\u003cli\u003eCreate/Update/Delete\u003c/li\u003e\n\u003cli\u003e各种查询 / 链式调用 / F 表达式 / Window 函数 /Lazy Loading / Eager Loading\u003c/li\u003e\n\u003cli\u003eJoin\u003c/li\u003e\n\u003cli\u003eDEBUG 和 Profile 技巧\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e本文是《Python ORM 三部曲的第一部 - Python 的三种数据源架构模式》\u003c/p\u003e\n\u003cp\u003e本文适用于：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e好奇 or 喜欢折腾的程序员\u003c/li\u003e\n\u003cli\u003e想深入了解 ORM 的程序员\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e本文将解决你以下的疑惑：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e能不能不用 ORM?\u003c/li\u003e\n\u003cli\u003eORM 为什么在某些场景下会胜于写 SQL\u003c/li\u003e\n\u003cli\u003e不同的 ORM 实现机制会带来什么差异？\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e新工作的技术栈是以 Flask 为主，SQLAlchemy 是 许多玩 Flask 的人的标配。好，文档读起来，笔记搞起来。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e所以，本文记录的是 Django ORM\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e逃。\u003c/p\u003e\n\u003cp\u003e这篇文章也是我对比 SqlAlchemy 以及 DjangoORM 的产物\u003c/p\u003e\n\u003ch2 id=\"0x01-如何快速上手\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-如何快速上手\"\u003e#\u003c/a\u003e 0x01 如何快速上手\u003c/h2\u003e\n\u003cp\u003eDjango 世界里面，Django 的文档每次刷都会有新的发现。\u003c/p\u003e\n\u003ch2 id=\"0x02-djangoorm-的基本功能\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-djangoorm-的基本功能\"\u003e#\u003c/a\u003e 0x02 DjangoORM 的基本功能\u003c/h2\u003e\n\u003ch3 id=\"21-模型定义-model\"\u003e\u003ca class=\"v-toc-item\" href=\"#21-模型定义-model\"\u003e#\u003c/a\u003e 2.1 模型定义 Model\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003efrom django.db import models\n\nclass Musician(models.Model):\n    first_name = models.CharField(max_length=50) # Field\n    last_name = models.CharField(max_length=50)\n    instrument = models.CharField(max_length=100)\n\nclass Album(models.Model):\n    artist = models.ForeignKey(Musician, on_delete=models.CASCADE)\n    name = models.CharField(max_length=100)\n    release_date = models.DateField()\n    num_stars = models.IntegerField()\n\n    class Meta: # Model Meta\n        order_with_respect_to = 'question'\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e可以看出，包含如下的部分：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eModel 与 Model 内部的 Meta\u003c/li\u003e\n\u003cli\u003eField 与 Field 内部的 Options\u003c/li\u003e\n\u003cli\u003eModel 与 Model 之间的关系\u003c/li\u003e\n\u003cli\u003e其他，比如索引\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"models-与-meta\"\u003e\u003ca class=\"v-toc-item\" href=\"#models-与-meta\"\u003e#\u003c/a\u003e Models 与 Meta\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eDjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，Model 与 session 耦合。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"field-与-field-options\"\u003e\u003ca class=\"v-toc-item\" href=\"#field-与-field-options\"\u003e#\u003c/a\u003e Field 与 Field Options\u003c/h4\u003e\n\u003ch5 id=\"field\"\u003e\u003ca class=\"v-toc-item\" href=\"#field\"\u003e#\u003c/a\u003e Field\u003c/h5\u003e\n\u003cul\u003e\n\u003cli\u003eAutoField\u003c/li\u003e\n\u003cli\u003eBigAutoField\u003c/li\u003e\n\u003cli\u003eBigIntegerField\u003c/li\u003e\n\u003cli\u003eBinaryField\u003c/li\u003e\n\u003cli\u003eBooleanField\u003c/li\u003e\n\u003cli\u003eCharField\u003c/li\u003e\n\u003cli\u003eDateField\u003c/li\u003e\n\u003cli\u003eDateTimeField\u003c/li\u003e\n\u003cli\u003eDecimalField\u003c/li\u003e\n\u003cli\u003eDurationField\u003c/li\u003e\n\u003cli\u003eEmailField\u003c/li\u003e\n\u003cli\u003eFileField\u003c/li\u003e\n\u003cli\u003eFileField and FieldFile\u003c/li\u003e\n\u003cli\u003eFilePathField\u003c/li\u003e\n\u003cli\u003eFloatField\u003c/li\u003e\n\u003cli\u003eImageField\u003c/li\u003e\n\u003cli\u003eIntegerField\u003c/li\u003e\n\u003cli\u003eGenericIPAddressField\u003c/li\u003e\n\u003cli\u003eNullBooleanField\u003c/li\u003e\n\u003cli\u003ePositiveIntegerField\u003c/li\u003e\n\u003cli\u003ePositiveSmallIntegerField\u003c/li\u003e\n\u003cli\u003eSlugField\u003c/li\u003e\n\u003cli\u003eSmallIntegerField\u003c/li\u003e\n\u003cli\u003eTextField\u003c/li\u003e\n\u003cli\u003eTimeField\u003c/li\u003e\n\u003cli\u003eURLField\u003c/li\u003e\n\u003cli\u003eUUIDField\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e虽然有这么多东东，其实常用的如下\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBigIntegerField\u003c/li\u003e\n\u003cli\u003eBooleanField\u003c/li\u003e\n\u003cli\u003eCharField\u003c/li\u003e\n\u003cli\u003eDateField\u003c/li\u003e\n\u003cli\u003eDateTimeField\u003c/li\u003e\n\u003cli\u003eDecimalField\u003c/li\u003e\n\u003cli\u003eIntegerField\u003c/li\u003e\n\u003cli\u003eTextField\u003c/li\u003e\n\u003cli\u003eTimeField\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e有的字段属于那种，有也可以，没有也可以的。\u003c/p\u003e\n\u003cp\u003eFileField 之类的 往往现在都被 CDN 取代\u003c/p\u003e\n\u003ch5 id=\"field-options\"\u003e\u003ca class=\"v-toc-item\" href=\"#field-options\"\u003e#\u003c/a\u003e Field Options\u003c/h5\u003e\n\u003cul\u003e\n\u003cli\u003enull\u003c/li\u003e\n\u003cli\u003eblank\u003c/li\u003e\n\u003cli\u003echoices\n\u003cul\u003e\n\u003cli\u003ep.shirt_size\u003c/li\u003e\n\u003cli\u003ep.get_shirt_size_display()\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003edb_column\u003c/li\u003e\n\u003cli\u003edb_index\u003c/li\u003e\n\u003cli\u003edb_tablespace\u003c/li\u003e\n\u003cli\u003edefault\u003c/li\u003e\n\u003cli\u003eeditable\u003c/li\u003e\n\u003cli\u003eerror_messages\u003c/li\u003e\n\u003cli\u003ehelp_text\u003c/li\u003e\n\u003cli\u003eprimary_key\u003c/li\u003e\n\u003cli\u003eunique\u003c/li\u003e\n\u003cli\u003eunique_for_date\u003c/li\u003e\n\u003cli\u003eunique_for_month\u003c/li\u003e\n\u003cli\u003eunique_for_year\u003c/li\u003e\n\u003cli\u003everbose_name\u003c/li\u003e\n\u003cli\u003evalidators\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e如此可见，Django 的 ORM 比起 SQLAlchemy 做了不少应用层的校验，一些 help_text\u003c/p\u003e\n\u003ch4 id=\"relationship\"\u003e\u003ca class=\"v-toc-item\" href=\"#relationship\"\u003e#\u003c/a\u003e Relationship\u003c/h4\u003e\n\u003cp\u003e表和表之间的关系\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eA 表和 B 表 一对多 / 多对一\u003c/li\u003e\n\u003cli\u003eA 表和 B 表 一对一 （特殊的一对多）\u003c/li\u003e\n\u003cli\u003eA 表和 B 表 简单多对多 （借助中间的 Mapping 表进行映射）\u003c/li\u003e\n\u003cli\u003eA 表和 B 表 复杂多对多\u003c/li\u003e\n\u003cli\u003eA 表和 B 表 一对多\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode\u003efrom django.db import models\n\nclass Manufacturer(models.Model):\n    # ...\n    pass\n\nclass Car(models.Model):\n    manufacturer = models.ForeignKey(Manufacturer, on_delete=models.CASCADE)\n    # ...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003efrom django.db import models\n\nclass Topping(models.Model):\n    # ...\n    pass\n\nclass Pizza(models.Model):\n    # ...\n    toppings = models.ManyToManyField(Topping)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003efrom django.db import models\n\nclass Person(models.Model):\n    name = models.CharField(max_length=128)\n\n    def __str__(self):\n        return self.name\n\nclass Group(models.Model):\n    name = models.CharField(max_length=128)\n    members = models.ManyToManyField(Person, through='Membership')\n\n    def __str__(self):\n        return self.name\n\nclass Membership(models.Model):\n    person = models.ForeignKey(Person, on_delete=models.CASCADE)\n    group = models.ForeignKey(Group, on_delete=models.CASCADE)\n    date_joined = models.DateField()\n    invite_reason = models.CharField(max_length=64)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eModels across files\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eobjects\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eModels 重写方法\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eModels 继承\nhttps://docs.djangoproject.com/en/2.0/topics/db/models/#model-inheritance\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e组织代码 - 以及应对循环引用\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"22-queryset\"\u003e\u003ca class=\"v-toc-item\" href=\"#22-queryset\"\u003e#\u003c/a\u003e 2.2 QuerySet\u003c/h3\u003e\n\u003ch4 id=\"create\"\u003e\u003ca class=\"v-toc-item\" href=\"#create\"\u003e#\u003c/a\u003e Create\u003c/h4\u003e\n\u003cpre\u003e\u003ccode\u003ec = Child(name=\u0026quot;苏轼\u0026quot;)\nc.save()\np = Parent(name=\u0026quot;苏辙\u0026quot;)\np.best_child = c\np.children.add([c,c2,c3,c4])\np.save()\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"retrieve\"\u003e\u003ca class=\"v-toc-item\" href=\"#retrieve\"\u003e#\u003c/a\u003e Retrieve\u003c/h4\u003e\n\u003cp\u003e过滤\u003c/p\u003e\n\u003cp\u003efilter(**kwargs)\u003cbr\u003e\nexclude(**kwargs)\u003cbr\u003e\n.all()\u003c/p\u003e\n\u003ch5 id=\"跨关系跨表查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#跨关系跨表查询\"\u003e#\u003c/a\u003e 跨关系（跨表）查询\u003c/h5\u003e\n\u003cp\u003eBlog.objects.filter(entry\u003cstrong\u003eheadline\u003c/strong\u003econtains=‘Lennon’)\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships\u003c/a\u003e\u003c/p\u003e\n\u003ch5 id=\"prefetch_related-select_related\"\u003e\u003ca class=\"v-toc-item\" href=\"#prefetch_related-select_related\"\u003e#\u003c/a\u003e prefetch_related \u0026amp;\u0026amp; select_related\u003c/h5\u003e\n\u003cpre\u003e\u003ccode\u003eselect_related\n\n生成 join 的 SQL, 可以用来减少 N+1 , 不过仅仅支持一对多，和一对一\n\nprefetch_related\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"limit-offset-分页\"\u003e\u003ca class=\"v-toc-item\" href=\"#limit-offset-分页\"\u003e#\u003c/a\u003e Limit / Offset / 分页\u003c/h5\u003e\n\u003cp\u003eBlog.objects.filter(entry\u003cstrong\u003eheadline\u003c/strong\u003econtains=‘Lennon’)[30:20]\u003c/p\u003e\n\u003ch5 id=\"链式调用\"\u003e\u003ca class=\"v-toc-item\" href=\"#链式调用\"\u003e#\u003c/a\u003e 链式调用\u003c/h5\u003e\n\u003cp\u003equery = query.filter(**kwargs)\u003cbr\u003e\nquery = query.exclude(**kwargs)\u003c/p\u003e\n\u003ch5 id=\"表达式\"\u003e\u003ca class=\"v-toc-item\" href=\"#表达式\"\u003e#\u003c/a\u003e 表达式\u003c/h5\u003e\n\u003cp\u003eDjango 里面最强大的就是其 Q 表达式了\u003c/p\u003e\n\u003cp\u003eQ(question\u003cstrong\u003estartswith=‘Who’) | Q(question\u003c/strong\u003estartswith=‘What’)\u003c/p\u003e\n\u003cp\u003ePoll.objects.get(\u003cbr\u003e\nQ(question__startswith=‘Who’),\u003cbr\u003e\nQ(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))\u003cbr\u003e\n)\u003c/p\u003e\n\u003cp\u003e这个表达式甚至可以嵌套超级深从而完成一个比较深的跨表查询。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e并且，这种 API 查询反而在写前端 API 的时候，可以传入 question__startswith 这类参数，从而直接完成一组搜索。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eQ / F\u003c/p\u003e\n\u003ch5 id=\"执行查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#执行查询\"\u003e#\u003c/a\u003e 执行查询\u003c/h5\u003e\n\u003cp\u003e需要注意的的是，SQLAlchemy 必须显式执行查询，而 Django 不一定。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated\"\u003ehttps://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e在 Django 内部实现的时候，一个 queryset 创建 / 过滤 / 切片 / 传送，\u003cstrong\u003e除非这个 queryset 被 evaluated 了\u003c/strong\u003e, 否则不会做数据库的操作。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eiteration\u003c/li\u003e\n\u003cli\u003eSlicing\u003c/li\u003e\n\u003cli\u003ePickling/Caching\u003c/li\u003e\n\u003cli\u003erepr\u003c/li\u003e\n\u003cli\u003elen\u003c/li\u003e\n\u003cli\u003elist\u003c/li\u003e\n\u003cli\u003ebool\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003eall()\nfirst()\nlast()\nexist()\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"比较\"\u003e\u003ca class=\"v-toc-item\" href=\"#比较\"\u003e#\u003c/a\u003e 比较\u003c/h5\u003e\n\u003cul\u003e\n\u003cli\u003epk\u003c/li\u003e\n\u003cli\u003emodel\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch5 id=\"复制-实例\"\u003e\u003ca class=\"v-toc-item\" href=\"#复制-实例\"\u003e#\u003c/a\u003e 复制 实例\u003c/h5\u003e\n\u003cpre\u003e\u003ccode\u003eblog = Blog(name='My blog', tagline='Blogging is easy')\nblog.save() # blog.pk == 1\n\nblog.pk = None\nblog.save() # blog.pk == 2\n\n# 但这个并不拷贝外键？???\nhttps://docs.djangoproject.com/en/2.0/topics/db/queries/#copying-model-instances\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"其他\"\u003e\u003ca class=\"v-toc-item\" href=\"#其他\"\u003e#\u003c/a\u003e 其他\u003c/h5\u003e\n\u003cpre\u003e\u003ccode\u003e# 默认查询的是所有字段，但我希望查询部分字段\n# TODO: 阿萨德\n# Distinct\n# OrderBy\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"缓存机制\"\u003e\u003ca class=\"v-toc-item\" href=\"#缓存机制\"\u003e#\u003c/a\u003e 缓存机制\u003c/h5\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"update\"\u003e\u003ca class=\"v-toc-item\" href=\"#update\"\u003e#\u003c/a\u003e Update\u003c/h4\u003e\n\u003cp\u003e单个 object 更新\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eblog.title = \u0026quot;大宝天天见\u0026quot;\nblog.save()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e批量更新\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003equery.update(headline=F('blog__name'))\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e一对多的更新（类似于 Set 操作）\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eadd(obj1, obj2, ...)\ncreate(**kwargs)\nremove(obj1, obj2, ...)\nclear()\nset(objs)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"delete\"\u003e\u003ca class=\"v-toc-item\" href=\"#delete\"\u003e#\u003c/a\u003e Delete\u003c/h4\u003e\n\u003ch5 id=\"foreignkey\"\u003e\u003ca class=\"v-toc-item\" href=\"#foreignkey\"\u003e#\u003c/a\u003e ForeignKey\u003c/h5\u003e\n\u003cpre\u003e\u003ccode\u003eclass Car(models.Model):\n    manufacturer = models.ForeignKey(\n        'production.Manufacturer', # 用来解决循环 circular import\n        on_delete=models.CASCADE,\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eon_delete 的情况\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePROTECT 阻止\u003c/li\u003e\n\u003cli\u003eCASCADE 应用层的级联删除\u003c/li\u003e\n\u003cli\u003eSET_NULL 应用层的级联 SET_NULL\u003c/li\u003e\n\u003cli\u003eSET_DEFAULT\u003c/li\u003e\n\u003cli\u003eDO_NOTHING\u003c/li\u003e\n\u003cli\u003eSET() 一个 callback\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"聚集查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#聚集查询\"\u003e#\u003c/a\u003e 聚集查询\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/aggregation/\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/aggregation/\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eBook.objects.all().aggregate(Max('price'))\nBook.objects.aggregate(price_diff=Max('price', output_field=FloatField()) - Avg('price'))\nBook.objects.annotate(num_authors=Count('authors'))\nBook.objects.annotate(num_authors=Count('authors')).aggregate(Avg('num_authors')) # {'num_authors__avg': 1.66}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"search\"\u003e\u003ca class=\"v-toc-item\" href=\"#search\"\u003e#\u003c/a\u003e Search\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/search/\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/search/\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"window-function\"\u003e\u003ca class=\"v-toc-item\" href=\"#window-function\"\u003e#\u003c/a\u003e Window Function\u003c/h4\u003e\n\u003cpre\u003e\u003ccode\u003eOption.objects.annotate(\n\t\trank_num=Window(\n\t\t\t\texpression=Rank(),\n\t\t\t\tpartition_by=F(\u0026quot;vote_id\u0026quot;),\n\t\t\t\torder_by=[F(\u0026quot;current_vote_count\u0026quot;).desc(), F(\u0026quot;id\u0026quot;).desc()],\n\t\t),\n\t\tlag_vote_num=Window(\n\t\t\t\texpression=Lag(\u0026quot;current_vote_count\u0026quot;),\n\t\t\t\tpartition_by=F(\u0026quot;vote_id\u0026quot;),\n\t\t\t\torder_by=[F(\u0026quot;current_vote_count\u0026quot;).desc(), F(\u0026quot;id\u0026quot;).desc()],\n\t\t),\n)\n.filter(vote=obj.vote)\n.order_by(\u0026quot;-current_vote_count\u0026quot;, \u0026quot;id\u0026quot;)\n.values(\u0026quot;id\u0026quot;, \u0026quot;rank_num\u0026quot;, \u0026quot;current_vote_count\u0026quot;, \u0026quot;lag_vote_num\u0026quot;)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"22-model-instances\"\u003e\u003ca class=\"v-toc-item\" href=\"#22-model-instances\"\u003e#\u003c/a\u003e 2.2 Model Instances\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/ref/models/instances/\"\u003ehttps://docs.djangoproject.com/en/2.0/ref/models/instances/\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"23-模型实例\"\u003e\u003ca class=\"v-toc-item\" href=\"#23-模型实例\"\u003e#\u003c/a\u003e 2.3 模型实例\u003c/h3\u003e\n\u003ch3 id=\"24-迁移机制\"\u003e\u003ca class=\"v-toc-item\" href=\"#24-迁移机制\"\u003e#\u003c/a\u003e 2.4 迁移机制\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e加 INSTALLED_APPS\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"0x03-django-orm-的高级功能\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-django-orm-的高级功能\"\u003e#\u003c/a\u003e 0x03 Django ORM 的高级功能\u003c/h2\u003e\n\u003ch3 id=\"maneger\"\u003e\u003ca class=\"v-toc-item\" href=\"#maneger\"\u003e#\u003c/a\u003e maneger\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/managers/\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/managers/\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"raw-sql\"\u003e\u003ca class=\"v-toc-item\" href=\"#raw-sql\"\u003e#\u003c/a\u003e raw sql\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/topics/db/sql/\"\u003ehttps://docs.djangoproject.com/en/2.0/topics/db/sql/\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"database-fuction\"\u003e\u003ca class=\"v-toc-item\" href=\"#database-fuction\"\u003e#\u003c/a\u003e database-fuction\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://docs.djangoproject.com/en/2.0/ref/models/database-functions/\"\u003ehttps://docs.djangoproject.com/en/2.0/ref/models/database-functions/\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"0x04-database-access-optimization\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-database-access-optimization\"\u003e#\u003c/a\u003e 0x04 Database Access Optimization\u003c/h2\u003e\n\u003ch3 id=\"41-使用连接池\"\u003e\u003ca class=\"v-toc-item\" href=\"#41-使用连接池\"\u003e#\u003c/a\u003e 4.1 使用连接池\u003c/h3\u003e\n\u003cp\u003e连接池是一种永远在线模型的实现\u003c/p\u003e\n\u003cp\u003e连接池：驱动程序类型\u003c/p\u003e\n\u003cp\u003e连接池：代理类型\u003c/p\u003e\n\u003ch3 id=\"42-减少对-mysql-的访问\"\u003e\u003ca class=\"v-toc-item\" href=\"#42-减少对-mysql-的访问\"\u003e#\u003c/a\u003e 4.2 减少对 MySQL 的访问\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003eselect count(*) from pg_stat_activity where pid \u0026lt;\u0026gt; pg_backend_pid() and usename = current_user;\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"before\"\u003e\u003ca class=\"v-toc-item\" href=\"#before\"\u003e#\u003c/a\u003e Before\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003eselect count(*) from pg_stat_activity where pid \u0026lt;\u0026gt; pg_backend_pid() and usename = current_user;\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"profile-first\"\u003e\u003ca class=\"v-toc-item\" href=\"#profile-first\"\u003e#\u003c/a\u003e Profile First\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003edjango-extentions\u003c/li\u003e\n\u003cli\u003edjango-debug-toolbar\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e手动\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003equeryset.explain\n\nfrom django.db import connection\nconnection.queries\n\nfrom django.db import reset_queries\nreset_queries()\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x05-django-orm-under-the-hood\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x05-django-orm-under-the-hood\"\u003e#\u003c/a\u003e 0x05 Django ORM Under The Hood\u003c/h2\u003e\n\u003ch3 id=\"理解-queryset\"\u003e\u003ca class=\"v-toc-item\" href=\"#理解-queryset\"\u003e#\u003c/a\u003e 理解 QuerySet\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003equerysets-are-lazy when-querysets-are-evaluated\n\u003cul\u003e\n\u003cli\u003eIteration\u003c/li\u003e\n\u003cli\u003eSlicing\u003c/li\u003e\n\u003cli\u003ePickling/Caching\u003c/li\u003e\n\u003cli\u003elen\u003c/li\u003e\n\u003cli\u003erepr\u003c/li\u003e\n\u003cli\u003elist\u003c/li\u003e\n\u003cli\u003ebool\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003eobj == nobj # obj.id == nobj.id\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003ecaching-and-querysets\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"理解-cached-attributes\"\u003e\u003ca class=\"v-toc-item\" href=\"#理解-cached-attributes\"\u003e#\u003c/a\u003e 理解 cached attributes\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; entry = Entry.objects.get(id=1)\n\u0026gt;\u0026gt;\u0026gt; entry.blog   # Blog object is retrieved at this point\n\u0026gt;\u0026gt;\u0026gt; entry.blog   # cached version, no DB access\n\n\u0026gt;\u0026gt;\u0026gt; entry = Entry.objects.get(id=1)\n\u0026gt;\u0026gt;\u0026gt; entry.authors.all()   # query performed\n\u0026gt;\u0026gt;\u0026gt; entry.authors.all()   # query performed again\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0xee-参考链接\"\u003e\u003ca class=\"v-toc-item\" href=\"#0xee-参考链接\"\u003e#\u003c/a\u003e 0xEE 参考链接\u003c/h2\u003e\n\u003chr\u003e\n\u003cp\u003eChangeLog:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e2018-03-09\u003c/strong\u003e 重修文字\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B\"\u003e0x01 如何快速上手\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-djangoorm-%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD\"\u003e0x02 DjangoORM 的基本功能\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#21-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89-model\"\u003e2.1 模型定义 Model\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#models-%E4%B8%8E-meta\"\u003eModels 与 Meta\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#field-%E4%B8%8E-field-options\"\u003eField 与 Field Options\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#field\"\u003eField\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#field-options\"\u003eField Options\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#relationship\"\u003eRelationship\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#22-queryset\"\u003e2.2 QuerySet\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#create\"\u003eCreate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#retrieve\"\u003eRetrieve\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E8%B7%A8%E5%85%B3%E7%B3%BB%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2\"\u003e跨关系（跨表）查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#prefetch_related-select_related\"\u003eprefetch_related \u0026amp;\u0026amp; select_related\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#limit-offset-%E5%88%86%E9%A1%B5\"\u003eLimit / Offset / 分页\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8\"\u003e链式调用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%A1%A8%E8%BE%BE%E5%BC%8F\"\u003e表达式\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2\"\u003e执行查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%AF%94%E8%BE%83\"\u003e比较\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A4%8D%E5%88%B6-%E5%AE%9E%E4%BE%8B\"\u003e复制 实例\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%B6%E4%BB%96\"\u003e其他\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6\"\u003e缓存机制\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#update\"\u003eUpdate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#delete\"\u003eDelete\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#foreignkey\"\u003eForeignKey\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%81%9A%E9%9B%86%E6%9F%A5%E8%AF%A2\"\u003e聚集查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#search\"\u003eSearch\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#window-function\"\u003eWindow Function\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#22-model-instances\"\u003e2.2 Model Instances\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#23-%E6%A8%A1%E5%9E%8B%E5%AE%9E%E4%BE%8B\"\u003e2.3 模型实例\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#24-%E8%BF%81%E7%A7%BB%E6%9C%BA%E5%88%B6\"\u003e2.4 迁移机制\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-django-orm-%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD\"\u003e0x03 Django ORM 的高级功能\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#maneger\"\u003emaneger\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#raw-sql\"\u003eraw sql\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#database-fuction\"\u003edatabase-fuction\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-database-access-optimization\"\u003e0x04 Database Access Optimization\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#41-%E4%BD%BF%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0\"\u003e4.1 使用连接池\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#42-%E5%87%8F%E5%B0%91%E5%AF%B9-mysql-%E7%9A%84%E8%AE%BF%E9%97%AE\"\u003e4.2 减少对 MySQL 的访问\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#before\"\u003eBefore\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#profile-first\"\u003eProfile First\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x05-django-orm-under-the-hood\"\u003e0x05 Django ORM Under The Hood\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E7%90%86%E8%A7%A3-queryset\"\u003e理解 QuerySet\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%90%86%E8%A7%A3-cached-attributes\"\u003e理解 cached attributes\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"\u003e0xEE 参考链接\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"DjangoORM CheatSheet"},"buildId":"uCwe9m-iio9bnoWMgWDqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>