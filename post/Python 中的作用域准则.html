<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Python 中的作用域准则 | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_buildManifest.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>因为最早用的是 Java 和 C#，写 Python 的时候自然也把 Python 作用域的想的和原有的一致。</p>
<p>Python 的作用域变量遵循在大部分情况下是一致的，但也有例外的情况。</p>
<p>本文着通过遇到的一个作用域的小问题来说说 Python 的作用域</p>
<!-- more -->
<h2 id="0x01-作用域的几个实例"><a class="v-toc-item" href="#0x01-作用域的几个实例">#</a> 0x01 作用域的几个实例</h2>
<p>Python 的作用域变量遵循在大部分情况下与其他语言一致，但也有例外的情况。比如：</p>
<h3 id="11-第一个例子"><a class="v-toc-item" href="#11-第一个例子">#</a> 1.1 第一个例子</h3>
<p>作用域第一版代码如下</p>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> # 打印 <span class="token number">1</span> <span class="token number">4465620064</span>
def <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 打印 <span class="token number">1</span> <span class="token number">4465620064</span>
</code></pre>
<p>作用域第一版对应字节码如下</p>
<pre><code>  4           0 LOAD_GLOBAL              0 (print)
              3 LOAD_GLOBAL              1 (a)
              6 LOAD_GLOBAL              2 (id)
              9 LOAD_GLOBAL              1 (a)
             12 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             15 CALL_FUNCTION            2 (2 positional, 0 keyword pair)
             18 POP_TOP
             19 LOAD_CONST               0 (None)
             22 RETURN_VALUE
</code></pre>
<blockquote>
<p>PS: 行 4 表示 代码行数 0 / 3 / 9 … 不知道是啥，我就先管他叫做<strong>条</strong>吧 是 load global<br>
PPS: 注意条 3/6 LOAD_GLOBAL 为从全局变量中加载</p>
</blockquote>
<p>顺手附上本文需要着重理解的几个指令</p>
<pre><code>LOAD_GLOBA          : Loads the global named co_names[namei] onto the stack.
LOAD_FAST(var_num)  : Pushes a reference to the local co_varnames[var_num] onto the stack.
STORE_FAST(var_num) : Stores TOS into the local co_varnames[var_num].
</code></pre>
<p>这点似乎挺符合我们认知的，那么，再深一点呢？既然这个变量是可以 Load 进来的就可以修改咯？</p>
<h3 id="12-第二个例子"><a class="v-toc-item" href="#12-第二个例子">#</a> 1.2 第二个例子</h3>
<p>然而并不是，我们看作用域第二版对应代码如下</p>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> # 打印 <span class="token number">1</span> <span class="token number">4465620064</span>
def <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    a <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # 打印 <span class="token number">2</span> <span class="token number">4465620096</span>
</code></pre>
<p>一看，WTF, 两个 a 内存值不一样。证明这两个变量是完全两个变量。</p>
<p>作用域第二版对应字节码如下</p>
<pre><code>  4           0 LOAD_CONST               1 (2)
              3 STORE_FAST               0 (a)

  5           6 LOAD_GLOBAL              0 (print)
              9 LOAD_FAST                0 (a)
             12 LOAD_GLOBAL              1 (id)
             15 LOAD_FAST                0 (a)
             18 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             21 CALL_FUNCTION            2 (2 positional, 0 keyword pair)
             24 POP_TOP
             25 LOAD_CONST               0 (None)
             28 RETURN_VALUE
</code></pre>
<blockquote>
<p>注意行 4 条 3 (STORE_FAST) 以及行 5 条 9/15 (LOAD_FAST)</p>
</blockquote>
<p>这说明了这里的 a 并不是 LOAD_GLOBAL 而来，而是从该函数的作用域 LOAD_FAST 而来。</p>
<h3 id="13-第三个例子"><a class="v-toc-item" href="#13-第三个例子">#</a> 1.3 第三个例子</h3>
<p>那我们在函数体重修改一下 a 值看看。</p>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>
def <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> # 注释掉此行不影响结论
    a <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # 当调用到这里的时候 local variable <span class="token string">'a'</span> referenced before assignment
# 即 a <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">=></span> a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span> 这里的第二个 a 报错鸟
</code></pre>
<pre><code>  3           0 LOAD_GLOBAL              0 (print)
              3 LOAD_FAST                0 (a)
              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
              9 POP_TOP

  4          10 LOAD_FAST                0 (a)
             13 LOAD_CONST               1 (1)
             16 BINARY_ADD
             17 STORE_FAST               0 (a)

  5          20 LOAD_GLOBAL              0 (print)
             23 LOAD_FAST                0 (a)
             26 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             29 POP_TOP
             30 LOAD_CONST               0 (None)
             33 RETURN_VALUE
</code></pre>
<p>那么，func3 也就自然而言由于没有无法 LOAD_FAST 对应的 a 变量，则报了引用错误。</p>
<p>然后问题来了，a 为基本类型的时候是这样的。如果引用类型呢？我们直接仿照 func3 的实例把 a 改成 list 类型。如下</p>
<h3 id="14-第四个例子"><a class="v-toc-item" href="#14-第四个例子">#</a> 1.4 第四个例子</h3>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
def <span class="token function">func4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> # 这条注不注释掉都一样
    a <span class="token operator">+=</span> <span class="token number">1</span> # 这里我故意写错 按理来说应该是 a<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

# 当调用到这里的时候 local variable <span class="token string">'a'</span> referenced before assignment
</code></pre>
<p>╮(╯▽╰)╭ 看来事情那么简单，结果变量 a 依旧是无法修改。</p>
<p>可按理来说跟应该报下面的错误呀</p>
<pre><code>'int' object is not iterable
</code></pre>
<h3 id="15-第五个例子"><a class="v-toc-item" href="#15-第五个例子">#</a> 1.5 第五个例子</h3>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
def <span class="token function">func5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    a<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func5</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
# <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">4500243208</span>
# <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">4500243208</span>
</code></pre>
<p>这下可以修改了。看一下字节码。</p>
<pre><code>  3           0 LOAD_GLOBAL              0 (print)
              3 LOAD_GLOBAL              1 (a)
              6 LOAD_GLOBAL              2 (id)
              9 LOAD_GLOBAL              1 (a)
             12 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             15 CALL_FUNCTION            2 (2 positional, 0 keyword pair)
             18 POP_TOP

  4          19 LOAD_GLOBAL              1 (a)
             22 LOAD_ATTR                3 (append)
             25 LOAD_CONST               1 (1)
             28 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             31 POP_TOP

  5          32 LOAD_GLOBAL              0 (print)
             35 LOAD_GLOBAL              1 (a)
             38 LOAD_GLOBAL              2 (id)
             41 LOAD_GLOBAL              1 (a)
             44 CALL_FUNCTION            1 (1 positional, 0 keyword pair)
             47 CALL_FUNCTION            2 (2 positional, 0 keyword pair)
             50 POP_TOP
             51 LOAD_CONST               0 (None)
             54 RETURN_VALUE
</code></pre>
<p>从全局拿来 a 变量，执行 append 方法。</p>
<h2 id="0x02-作用域准则以及本地赋值准则"><a class="v-toc-item" href="#0x02-作用域准则以及本地赋值准则">#</a> 0x02 作用域准则以及本地赋值准则</h2>
<h3 id="21-作用域准则"><a class="v-toc-item" href="#21-作用域准则">#</a> 2.1 作用域准则</h3>
<p>看来这是解释器遵循了某种变量查找的法则，似乎就只能从原理上而不是在 CPython 的实现上解释这个问题了。</p>
<p>查找了一些资料，发现 Python 解释器在依据 基于 LEGB 准则 （顺手吐槽一下不是 LGBT）</p>
<p>LEGB 指的变量查找遵循</p>
<ul>
<li>Local</li>
<li>Enclosing-function locals</li>
<li>Global</li>
<li>Built-In</li>
</ul>
<p>StackOverFlow 上 martineau 提供了一个不错的例子用来说明</p>
<pre><code class="language-python">x <span class="token operator">=</span> <span class="token number">100</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"1. Global x:"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>
    y <span class="token operator">=</span> x
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"2. Enclosed y:"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"3. Enclosed x:"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>

    def <span class="token function">method</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"4. Enclosed self.x"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"5. Global x"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        except NameError <span class="token keyword">as</span> e<span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"6."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

    def <span class="token function">method_local_ref</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token keyword">try</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        except UnboundLocalError <span class="token keyword">as</span> e<span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"7."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        x <span class="token operator">=</span> <span class="token number">200</span> # causing <span class="token number">7</span> because has same name
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"8. Local x"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>

inst <span class="token operator">=</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
inst<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
inst<span class="token punctuation">.</span><span class="token function">method_local_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>我们试着用变量查找准则去解释 <strong>第一个例子</strong> 的时候，是解释的通的。</p>
<p>第二个例子，发现函数体内的 a 变量已经不是那个 a 变量了。要是按照这个查找原则的话，似乎有点说不通了。</p>
<p>但当解释第三个例子的时候，就完全说不通了。</p>
<pre><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>
def <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> # 注释掉此行不影响结论
    a <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # 当调用到这里的时候 local variable <span class="token string">'a'</span> referenced before assignment
# 即 a <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">=></span> a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span> 这里的第二个 a 报错鸟
</code></pre>
<p>按照我的猜想，这里的代码执行可能有两种情况：</p>
<ul>
<li>当代码执行到第三行的时候可能是向从 local 找 a, 发现没有，再找 Enclosing-function 发现没有，最后应该在 Global 里面找到才是。注释掉第三行的时候也是同理。</li>
<li>当代码执行到第三行的时候可能是向下从 local 找 a, 发现有，然后代码执行，结束。</li>
</ul>
<p>但如果真的和我的想法接近的话，这两种情况都可以执行，除了变量作用域之外还是有一些其他的考量。我把这个叫做<strong>本地赋值准则</strong> （拍脑袋起的名称）</p>
<p>一般我们管这种考量叫做 <s>Python 作者就是觉得这种编码方式好你爱写不写</s> Python 作者对于变量作用域的权衡。</p>
<p>事实上，当解释器编译函数体为字节码的时候，如果是一个赋值操作 (list.append 之流不是赋值操作），则会被限定这个变量认为是一个 local 变量。如果在 local 中找不到，并不向上查找，就报引用错误。</p>
<pre><code>这不是 BUG
这不是 BUG
这不是 BUG
</code></pre>
<p>这是一种设计权衡 Python 认为 虽然不强求强制声明类型，但假定被赋值的变量是一个 Local 变量。这样减少避免动态语言比如 JavaScript 动不动就修改掉了全局变量的坑。</p>
<p>这也就解释了第四个例子中赋值操作报错，以及第五个例子 append 为什么可以正常执行。</p>
<p>如果我偏要勉强呢？ 可以通过 global 和 nonlocal 来 引入模块级变量 or 上一级变量。</p>
<blockquote>
<p>PS: JS 也开始使用 let 进行声明，小箭头函数内部赋值查找变量也是向上查找。</p>
</blockquote>
<h2 id="0xee-参考链接"><a class="v-toc-item" href="#0xee-参考链接">#</a> 0xEE 参考链接</h2>
<ul>
<li><a href="https://stackoverflow.com/questions/291978/short-description-of-the-scoping-rules">Martineau 的例子</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2017-11-20</strong> 从原有笔记中抽取本文整理而成</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%87%A0%E4%B8%AA%E5%AE%9E%E4%BE%8B">0x01 作用域的几个实例</a>
<ul>
<li><a href="#11-%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90">1.1 第一个例子</a></li>
<li><a href="#12-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E4%BE%8B%E5%AD%90">1.2 第二个例子</a></li>
<li><a href="#13-%E7%AC%AC%E4%B8%89%E4%B8%AA%E4%BE%8B%E5%AD%90">1.3 第三个例子</a></li>
<li><a href="#14-%E7%AC%AC%E5%9B%9B%E4%B8%AA%E4%BE%8B%E5%AD%90">1.4 第四个例子</a></li>
<li><a href="#15-%E7%AC%AC%E4%BA%94%E4%B8%AA%E4%BE%8B%E5%AD%90">1.5 第五个例子</a></li>
</ul>
</li>
<li><a href="#0x02-%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%87%86%E5%88%99%E4%BB%A5%E5%8F%8A%E6%9C%AC%E5%9C%B0%E8%B5%8B%E5%80%BC%E5%87%86%E5%88%99">0x02 作用域准则以及本地赋值准则</a>
<ul>
<li><a href="#21-%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%87%86%E5%88%99">2.1 作用域准则</a></li>
</ul>
</li>
<li><a href="#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">0xEE 参考链接</a></li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["Python"],"path":"20171120_PythonClosureAndScopes.md","title":"Python 中的作用域准则","slug":"Python 中的作用域准则","date":"2017-11-20","category":"Python","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e因为最早用的是 Java 和 C#，写 Python 的时候自然也把 Python 作用域的想的和原有的一致。\u003c/p\u003e\n\u003cp\u003ePython 的作用域变量遵循在大部分情况下是一致的，但也有例外的情况。\u003c/p\u003e\n\u003cp\u003e本文着通过遇到的一个作用域的小问题来说说 Python 的作用域\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"0x01-作用域的几个实例\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-作用域的几个实例\"\u003e#\u003c/a\u003e 0x01 作用域的几个实例\u003c/h2\u003e\n\u003cp\u003ePython 的作用域变量遵循在大部分情况下与其他语言一致，但也有例外的情况。比如：\u003c/p\u003e\n\u003ch3 id=\"11-第一个例子\"\u003e\u003ca class=\"v-toc-item\" href=\"#11-第一个例子\"\u003e#\u003c/a\u003e 1.1 第一个例子\u003c/h3\u003e\n\u003cp\u003e作用域第一版代码如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 打印 \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token number\"\u003e4465620064\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e  # 打印 \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token number\"\u003e4465620064\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e作用域第一版对应字节码如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  4           0 LOAD_GLOBAL              0 (print)\n              3 LOAD_GLOBAL              1 (a)\n              6 LOAD_GLOBAL              2 (id)\n              9 LOAD_GLOBAL              1 (a)\n             12 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             15 CALL_FUNCTION            2 (2 positional, 0 keyword pair)\n             18 POP_TOP\n             19 LOAD_CONST               0 (None)\n             22 RETURN_VALUE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePS: 行 4 表示 代码行数 0 / 3 / 9 … 不知道是啥，我就先管他叫做\u003cstrong\u003e条\u003c/strong\u003e吧 是 load global\u003cbr\u003e\nPPS: 注意条 3/6 LOAD_GLOBAL 为从全局变量中加载\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e顺手附上本文需要着重理解的几个指令\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eLOAD_GLOBA          : Loads the global named co_names[namei] onto the stack.\nLOAD_FAST(var_num)  : Pushes a reference to the local co_varnames[var_num] onto the stack.\nSTORE_FAST(var_num) : Stores TOS into the local co_varnames[var_num].\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这点似乎挺符合我们认知的，那么，再深一点呢？既然这个变量是可以 Load 进来的就可以修改咯？\u003c/p\u003e\n\u003ch3 id=\"12-第二个例子\"\u003e\u003ca class=\"v-toc-item\" href=\"#12-第二个例子\"\u003e#\u003c/a\u003e 1.2 第二个例子\u003c/h3\u003e\n\u003cp\u003e然而并不是，我们看作用域第二版对应代码如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 打印 \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token number\"\u003e4465620064\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 打印 \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token number\"\u003e4465620096\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e一看，WTF, 两个 a 内存值不一样。证明这两个变量是完全两个变量。\u003c/p\u003e\n\u003cp\u003e作用域第二版对应字节码如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  4           0 LOAD_CONST               1 (2)\n              3 STORE_FAST               0 (a)\n\n  5           6 LOAD_GLOBAL              0 (print)\n              9 LOAD_FAST                0 (a)\n             12 LOAD_GLOBAL              1 (id)\n             15 LOAD_FAST                0 (a)\n             18 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             21 CALL_FUNCTION            2 (2 positional, 0 keyword pair)\n             24 POP_TOP\n             25 LOAD_CONST               0 (None)\n             28 RETURN_VALUE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e注意行 4 条 3 (STORE_FAST) 以及行 5 条 9/15 (LOAD_FAST)\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e这说明了这里的 a 并不是 LOAD_GLOBAL 而来，而是从该函数的作用域 LOAD_FAST 而来。\u003c/p\u003e\n\u003ch3 id=\"13-第三个例子\"\u003e\u003ca class=\"v-toc-item\" href=\"#13-第三个例子\"\u003e#\u003c/a\u003e 1.3 第三个例子\u003c/h3\u003e\n\u003cp\u003e那我们在函数体重修改一下 a 值看看。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 注释掉此行不影响结论\n    a \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 当调用到这里的时候 local variable \u003cspan class=\"token string\"\u003e'a'\u003c/span\u003e referenced before assignment\n# 即 a \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e 这里的第二个 a 报错鸟\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e  3           0 LOAD_GLOBAL              0 (print)\n              3 LOAD_FAST                0 (a)\n              6 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n              9 POP_TOP\n\n  4          10 LOAD_FAST                0 (a)\n             13 LOAD_CONST               1 (1)\n             16 BINARY_ADD\n             17 STORE_FAST               0 (a)\n\n  5          20 LOAD_GLOBAL              0 (print)\n             23 LOAD_FAST                0 (a)\n             26 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             29 POP_TOP\n             30 LOAD_CONST               0 (None)\n             33 RETURN_VALUE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e那么，func3 也就自然而言由于没有无法 LOAD_FAST 对应的 a 变量，则报了引用错误。\u003c/p\u003e\n\u003cp\u003e然后问题来了，a 为基本类型的时候是这样的。如果引用类型呢？我们直接仿照 func3 的实例把 a 改成 list 类型。如下\u003c/p\u003e\n\u003ch3 id=\"14-第四个例子\"\u003e\u003ca class=\"v-toc-item\" href=\"#14-第四个例子\"\u003e#\u003c/a\u003e 1.4 第四个例子\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 这条注不注释掉都一样\n    a \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e # 这里我故意写错 按理来说应该是 a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n# 当调用到这里的时候 local variable \u003cspan class=\"token string\"\u003e'a'\u003c/span\u003e referenced before assignment\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e╮(╯▽╰)╭ 看来事情那么简单，结果变量 a 依旧是无法修改。\u003c/p\u003e\n\u003cp\u003e可按理来说跟应该报下面的错误呀\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'int' object is not iterable\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"15-第五个例子\"\u003e\u003ca class=\"v-toc-item\" href=\"#15-第五个例子\"\u003e#\u003c/a\u003e 1.5 第五个例子\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token number\"\u003e4500243208\u003c/span\u003e\n# \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token number\"\u003e4500243208\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这下可以修改了。看一下字节码。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  3           0 LOAD_GLOBAL              0 (print)\n              3 LOAD_GLOBAL              1 (a)\n              6 LOAD_GLOBAL              2 (id)\n              9 LOAD_GLOBAL              1 (a)\n             12 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             15 CALL_FUNCTION            2 (2 positional, 0 keyword pair)\n             18 POP_TOP\n\n  4          19 LOAD_GLOBAL              1 (a)\n             22 LOAD_ATTR                3 (append)\n             25 LOAD_CONST               1 (1)\n             28 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             31 POP_TOP\n\n  5          32 LOAD_GLOBAL              0 (print)\n             35 LOAD_GLOBAL              1 (a)\n             38 LOAD_GLOBAL              2 (id)\n             41 LOAD_GLOBAL              1 (a)\n             44 CALL_FUNCTION            1 (1 positional, 0 keyword pair)\n             47 CALL_FUNCTION            2 (2 positional, 0 keyword pair)\n             50 POP_TOP\n             51 LOAD_CONST               0 (None)\n             54 RETURN_VALUE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e从全局拿来 a 变量，执行 append 方法。\u003c/p\u003e\n\u003ch2 id=\"0x02-作用域准则以及本地赋值准则\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-作用域准则以及本地赋值准则\"\u003e#\u003c/a\u003e 0x02 作用域准则以及本地赋值准则\u003c/h2\u003e\n\u003ch3 id=\"21-作用域准则\"\u003e\u003ca class=\"v-toc-item\" href=\"#21-作用域准则\"\u003e#\u003c/a\u003e 2.1 作用域准则\u003c/h3\u003e\n\u003cp\u003e看来这是解释器遵循了某种变量查找的法则，似乎就只能从原理上而不是在 CPython 的实现上解释这个问题了。\u003c/p\u003e\n\u003cp\u003e查找了一些资料，发现 Python 解释器在依据 基于 LEGB 准则 （顺手吐槽一下不是 LGBT）\u003c/p\u003e\n\u003cp\u003eLEGB 指的变量查找遵循\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLocal\u003c/li\u003e\n\u003cli\u003eEnclosing-function locals\u003c/li\u003e\n\u003cli\u003eGlobal\u003c/li\u003e\n\u003cli\u003eBuilt-In\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStackOverFlow 上 martineau 提供了一个不错的例子用来说明\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ex \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"1. Global x:\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobject\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    y \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e x\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"2. Enclosed y:\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e x \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"3. Enclosed x:\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    def \u003cspan class=\"token function\"\u003emethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"4. Enclosed self.x\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"5. Global x\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        except NameError \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"6.\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    def \u003cspan class=\"token function\"\u003emethod_local_ref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        except UnboundLocalError \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"7.\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e200\u003c/span\u003e # causing \u003cspan class=\"token number\"\u003e7\u003c/span\u003e because has same name\n        \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"8. Local x\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\ninst \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eTest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\ninst\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\ninst\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emethod_local_ref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们试着用变量查找准则去解释 \u003cstrong\u003e第一个例子\u003c/strong\u003e 的时候，是解释的通的。\u003c/p\u003e\n\u003cp\u003e第二个例子，发现函数体内的 a 变量已经不是那个 a 变量了。要是按照这个查找原则的话，似乎有点说不通了。\u003c/p\u003e\n\u003cp\u003e但当解释第三个例子的时候，就完全说不通了。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ea \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\ndef \u003cspan class=\"token function\"\u003efunc3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 注释掉此行不影响结论\n    a \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efunc3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 当调用到这里的时候 local variable \u003cspan class=\"token string\"\u003e'a'\u003c/span\u003e referenced before assignment\n# 即 a \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e 这里的第二个 a 报错鸟\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e按照我的猜想，这里的代码执行可能有两种情况：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e当代码执行到第三行的时候可能是向从 local 找 a, 发现没有，再找 Enclosing-function 发现没有，最后应该在 Global 里面找到才是。注释掉第三行的时候也是同理。\u003c/li\u003e\n\u003cli\u003e当代码执行到第三行的时候可能是向下从 local 找 a, 发现有，然后代码执行，结束。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e但如果真的和我的想法接近的话，这两种情况都可以执行，除了变量作用域之外还是有一些其他的考量。我把这个叫做\u003cstrong\u003e本地赋值准则\u003c/strong\u003e （拍脑袋起的名称）\u003c/p\u003e\n\u003cp\u003e一般我们管这种考量叫做 \u003cs\u003ePython 作者就是觉得这种编码方式好你爱写不写\u003c/s\u003e Python 作者对于变量作用域的权衡。\u003c/p\u003e\n\u003cp\u003e事实上，当解释器编译函数体为字节码的时候，如果是一个赋值操作 (list.append 之流不是赋值操作），则会被限定这个变量认为是一个 local 变量。如果在 local 中找不到，并不向上查找，就报引用错误。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e这不是 BUG\n这不是 BUG\n这不是 BUG\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这是一种设计权衡 Python 认为 虽然不强求强制声明类型，但假定被赋值的变量是一个 Local 变量。这样减少避免动态语言比如 JavaScript 动不动就修改掉了全局变量的坑。\u003c/p\u003e\n\u003cp\u003e这也就解释了第四个例子中赋值操作报错，以及第五个例子 append 为什么可以正常执行。\u003c/p\u003e\n\u003cp\u003e如果我偏要勉强呢？ 可以通过 global 和 nonlocal 来 引入模块级变量 or 上一级变量。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePS: JS 也开始使用 let 进行声明，小箭头函数内部赋值查找变量也是向上查找。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"0xee-参考链接\"\u003e\u003ca class=\"v-toc-item\" href=\"#0xee-参考链接\"\u003e#\u003c/a\u003e 0xEE 参考链接\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/291978/short-description-of-the-scoping-rules\"\u003eMartineau 的例子\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eChangeLog:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e2017-11-20\u003c/strong\u003e 从原有笔记中抽取本文整理而成\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%87%A0%E4%B8%AA%E5%AE%9E%E4%BE%8B\"\u003e0x01 作用域的几个实例\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#11-%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90\"\u003e1.1 第一个例子\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#12-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E4%BE%8B%E5%AD%90\"\u003e1.2 第二个例子\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#13-%E7%AC%AC%E4%B8%89%E4%B8%AA%E4%BE%8B%E5%AD%90\"\u003e1.3 第三个例子\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#14-%E7%AC%AC%E5%9B%9B%E4%B8%AA%E4%BE%8B%E5%AD%90\"\u003e1.4 第四个例子\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#15-%E7%AC%AC%E4%BA%94%E4%B8%AA%E4%BE%8B%E5%AD%90\"\u003e1.5 第五个例子\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%87%86%E5%88%99%E4%BB%A5%E5%8F%8A%E6%9C%AC%E5%9C%B0%E8%B5%8B%E5%80%BC%E5%87%86%E5%88%99\"\u003e0x02 作用域准则以及本地赋值准则\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#21-%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%87%86%E5%88%99\"\u003e2.1 作用域准则\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"\u003e0xEE 参考链接\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"Python 中的作用域准则"},"buildId":"uCwe9m-iio9bnoWMgWDqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>