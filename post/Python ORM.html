<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Python ORM | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_buildManifest.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>Python 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee</p>
<ol>
<li>SQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现</li>
<li>Django ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的话我甚至会考虑将 Django ORM 配置到 Flask 项目中。当然，也有蛋疼的 SqlAlchemy 使用者已经移植给 django 配置了 SQLAlchemy 的库。</li>
<li>Peewee 没用过，不好评论。以后有机会试试。</li>
</ol>
<h2 id="0x01-如何访问数据库"><a class="v-toc-item" href="#0x01-如何访问数据库">#</a> 0x01 如何访问数据库</h2>
<p>那，既然已经可以访问数据库，本着『如无必要，勿增实体』的原则，为什么要不辞劳苦的用个库呢？</p>
<h2 id="0x02-数据库抽象的两种理论"><a class="v-toc-item" href="#0x02-数据库抽象的两种理论">#</a> 0x02 数据库抽象的两种理论</h2>
<h3 id="理论一active-record"><a class="v-toc-item" href="#理论一active-record">#</a> 理论一：Active Record</h3>
<h3 id="理论二data-mapper"><a class="v-toc-item" href="#理论二data-mapper">#</a> 理论二：Data Mapper</h3>
<h2 id="0x03-数据库抽象的两种实现"><a class="v-toc-item" href="#0x03-数据库抽象的两种实现">#</a> 0x03 数据库抽象的两种实现</h2>
<h3 id="实现一django-orm"><a class="v-toc-item" href="#实现一django-orm">#</a> 实现一：Django ORM</h3>
<h3 id="实现二sqlalchemy"><a class="v-toc-item" href="#实现二sqlalchemy">#</a> 实现二：Sqlalchemy</h3>
<h2 id="0x04-工具的强弱"><a class="v-toc-item" href="#0x04-工具的强弱">#</a> 0x04 工具的强弱</h2>
<p><a href="https://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/">https://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/</a></p>
<h3 id="20-sqlalchemy-vs-djangoorm"><a class="v-toc-item" href="#20-sqlalchemy-vs-djangoorm">#</a> 2.0 SQLAlchemy VS DjangoORM</h3>
<p>ORM 通常有 DataMapper 实现和 ActiveRecord 实现两种。</p>
<p>依照我的经验，ActiveRecord 使用起来的更接近对象 (Object) 的操作，DataMapper 使用起来更接近 (Table) 的操作。</p>
<blockquote>
<p>SQLAlchemy 是 DataMapper 模式的实现，在该模式下，session 会暴露出来，即 Model 与 session 并不耦合。</p>
</blockquote>
<blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，session 并不暴露出来，即 Model 与 session 耦合。</p>
</blockquote>
<p>使用 Django ORM 的时候，往往是</p>
<pre><code class="language-python">b <span class="token operator">=</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token operator">**</span>data<span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>使用 SQLAlchemy 的时候，往往是</p>
<pre><code class="language-python">b <span class="token operator">=</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token operator">**</span>data<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre>
<p>由于 Django 帮你屏蔽了 session 的操作。</p>
<p>在通常情况下，</p>
<ol>
<li>DjangoORM 使用起来更加接近 Object 的操作。</li>
<li>SQLAlchemy 使用起来更加接近 Table 的操作。</li>
</ol>
<p>举个例子，</p>
<p>一对多，Father 添加两个小孩（其中一个小孩是已经存在的）</p>
<p>在 DjangoORM 里面， 这里更像是一个 Set 的 add 操作。</p>
<pre><code class="language-python">father<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>new_child<span class="token punctuation">,</span>exsit_child<span class="token punctuation">)</span>
</code></pre>
<p>在 SQLAlchemy 里面，这里更像是一个 table 的 insert 操作。（麻蛋，你要说是一个 list 的 append 操作也行）</p>
<pre><code class="language-python"><span class="token keyword">for</span> child <span class="token keyword">in</span> <span class="token punctuation">(</span>new_child<span class="token punctuation">,</span>exsit_child<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token keyword">if</span> child <span class="token keyword">in</span> father<span class="token punctuation">.</span>children<span class="token operator">:</span>
        father<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
</code></pre>
<blockquote>
<p>写 SQLAlchemy 更接近操作放在数据库里面的数据记录，而 DjangoORM 更接近操作一批放在数据库里面的对象。</p>
</blockquote>
<p>由于 session 的使用姿势不同，所以往往会有很多使用上面的区别。</p>
<p>至于孰优孰劣，难以评判。</p>
<ul>
<li>
<p>技术老大 (Flask 和 React 大神）倾向于使用 SQLAlchemy, 他认为</p>
<ul>
<li>对于一个技术『知其然，知其所以然』</li>
<li>对于 ORM
<ul>
<li>操作数据库，操作最好要落实在成 SQL</li>
<li>如果有可能的话，每一个 SQL 语句都要经过推敲，而且写这个 SQL 和 ORM 过程要反复练习</li>
</ul>
</li>
<li>对于 Migration 机制
<ul>
<li>Alembic 这个迁移工具是为了省事用的，甚至在某些情况下没必要用。完全可以写 SQL 代替</li>
</ul>
</li>
</ul>
</li>
<li>
<p>我 (Django 和 Vue 弱鸡）倾向于使用 DjangoORM, 我认为</p>
<ul>
<li>对于一个技术『先知其大致然，需要深入的时候知其所以然』</li>
<li>对于 ORM
<ul>
<li>操作数据，最好抽象为对对象的操作。</li>
<li>测试到位的情况下，快糙狠先出东西。到需要优化的时候该怎么 Profile 怎么 Profile</li>
</ul>
</li>
<li>对于 Migration 机制
<ul>
<li>用起来啊，能操作对象为什么还要强行到数据库操作？</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="language-python">Active Record<span class="token punctuation">,</span> properly defined<span class="token punctuation">,</span> is a design pattern where an object is represented <span class="token keyword">as</span> a record on a table <span class="token keyword">in</span> a relational database<span class="token punctuation">.</span>
</code></pre>
<h3 id="21-模型定义"><a class="v-toc-item" href="#21-模型定义">#</a> 2.1 模型定义</h3>
<p>先看一组模型</p>
<pre><code class="language-python">from sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
Base <span class="token operator">=</span> <span class="token function">declarative_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # 模型基类
from sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'users'</span>

    id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span>True<span class="token punctuation">)</span> # 主键
    name <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    fullname <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    password <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>

    def <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token operator">:</span>
       <span class="token keyword">return</span> <span class="token string">"&lt;User(name='%s', fullname='%s', password='%s')>"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                            self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> self<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">create_all</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
</code></pre>
<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="models-与-meta"><a class="v-toc-item" href="#models-与-meta">#</a> Models 与 Meta</h4>
<p><a href="https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685">https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685</a></p>
<h4 id="关系"><a class="v-toc-item" href="#关系">#</a> 关系</h4>
<h5 id="one-to-many"><a class="v-toc-item" href="#one-to-many">#</a> One To Many</h5>
<p>母亲有若干个孩子，外键在孩子上。</p>
<pre><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    #<span class="token operator">...</span>
    children <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">"parent"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    #<span class="token operator">...</span>
    parent_id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="many-to-one"><a class="v-toc-item" href="#many-to-one">#</a> Many To One</h5>
<p>多个母亲共享一个孩子，外键在母亲上。</p>
<pre><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    child_id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'child.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    child <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>
</code></pre>
<h5 id="one-to-one"><a class="v-toc-item" href="#one-to-one">#</a> One To One</h5>
<p>One to One 是 One to Many 或者是 Many to One 的简化版本</p>
<pre><code class="language-python"># Many To One
<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>
    child_id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'child.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    child <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token function">backref</span><span class="token punctuation">(</span><span class="token string">"parent"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span>False<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>

# One To Many 改 One To One
<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>
    parent_id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Parent"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token function">backref</span><span class="token punctuation">(</span><span class="token string">"child"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span>False<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="many-to-many"><a class="v-toc-item" href="#many-to-many">#</a> Many To Many</h5>
<pre><code class="language-python">association_table <span class="token operator">=</span> <span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">'association'</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">'left_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'left.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">'right_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'right.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>
    children <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span>
                    secondary<span class="token operator">=</span>association_table<span class="token punctuation">,</span>
                    backref<span class="token operator">=</span><span class="token string">"parents"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    # <span class="token operator">...</span>
</code></pre>
<p>注意事项</p>
<p>执行删除 mapping 表的时候尽量这样。</p>
<pre><code class="language-bash">myparent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>somechild<span class="token punctuation">)</span>
</code></pre>
<p>当你想干掉 somechild 的时候，会执行</p>
<pre><code>session.delete(somechild)
</code></pre>
<ol>
<li>假如 Child 没有 ref Parent 的话，Secondary Table 无删除，则无法删除。</li>
<li>假如 ref 了的话，则删除 secondary 里面的记录。</li>
<li>TODO</li>
</ol>
<h5 id="邻接列表关系"><a class="v-toc-item" href="#邻接列表关系">#</a> 邻接列表关系</h5>
<pre><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token operator">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'node'</span>
    id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span>True<span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> <span class="token function">ForeignKey</span><span class="token punctuation">(</span><span class="token string">'node.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token function">Column</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    children <span class="token operator">=</span> <span class="token function">relationship</span><span class="token punctuation">(</span><span class="token string">"Node"</span><span class="token punctuation">,</span>
                backref<span class="token operator">=</span><span class="token function">backref</span><span class="token punctuation">(</span><span class="token string">'parent'</span><span class="token punctuation">,</span> remote_side<span class="token operator">=</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
</code></pre>
<h5 id="relationship-详解"><a class="v-toc-item" href="#relationship-详解">#</a> relationship 详解</h5>
<h3 id="21-query"><a class="v-toc-item" href="#21-query">#</a> 2.1 Query</h3>
<h4 id="create"><a class="v-toc-item" href="#create">#</a> Create</h4>
<pre><code class="language-python">c1 <span class="token operator">=</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"苏轼"</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"苏辙"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>best_child <span class="token operator">=</span> c1
<span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token punctuation">[</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">,</span>c3<span class="token punctuation">,</span>c4<span class="token punctuation">]</span><span class="token operator">:</span>
    p<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="retrieve"><a class="v-toc-item" href="#retrieve">#</a> Retrieve</h4>
<p>过滤</p>
<pre><code class="language-python"><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
<span class="token function">filter</span><span class="token punctuation">(</span>Singer<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"周杰伦"</span><span class="token punctuation">)</span>
<span class="token function">filter</span><span class="token punctuation">(</span>Singer<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token operator">!</span> <span class="token string">"周杰棍"</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="跨关系跨表查询"><a class="v-toc-item" href="#跨关系跨表查询">#</a> 跨关系（跨表）查询</h5>
<pre><code>session.query(Entry).join(Blog,Blog.entry_id == Entry.id).filter(Blog.name = &quot;SqlAlchemy CheatSheet&quot;)
</code></pre>
<h5 id="limit-offset-分页"><a class="v-toc-item" href="#limit-offset-分页">#</a> Limit / Offset / 分页</h5>
<ul>
<li>limit()</li>
<li>offset()</li>
</ul>
<h5 id="链式调用"><a class="v-toc-item" href="#链式调用">#</a> 链式调用</h5>
<pre><code class="language-python">query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Order<span class="token punctuation">)</span> # query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Order<span class="token punctuation">)</span>
query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Order<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span>f<span class="token string">"%name%"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="二进制表达式"><a class="v-toc-item" href="#二进制表达式">#</a> 二进制表达式</h5>
<p>我们先 type 一下表达式，找到 eq 的类型</p>
<pre><code class="language-python"><span class="token function">type</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>column_name <span class="token operator">==</span> <span class="token string">'asdf'</span><span class="token punctuation">)</span> → sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>BinaryExpression
</code></pre>
<p>是一个二进制表达式。</p>
<pre><code class="language-python"># 等于
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">)</span>
# 不等于
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token string">'ed'</span><span class="token punctuation">)</span>
# Like（有的数据库不区分大小写）
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">'%ed%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">ILIKE</span> <span class="token punctuation">(</span><span class="token keyword">case</span><span class="token operator">-</span>insensitive <span class="token constant">LIKE</span><span class="token punctuation">)</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">ilike</span><span class="token punctuation">(</span><span class="token string">'%ed%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">IN</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">in_</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ed'</span><span class="token punctuation">,</span> <span class="token string">'wendy'</span><span class="token punctuation">,</span> <span class="token string">'jack'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
# Not <span class="token keyword">in</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">~</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">in_</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ed'</span><span class="token punctuation">,</span> <span class="token string">'wendy'</span><span class="token punctuation">,</span> <span class="token string">'jack'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">IS</span> <span class="token constant">NULL</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> None<span class="token punctuation">)</span>
## 如果你用了 pep8<span class="token operator">/</span>linter 的话
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">is_</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">IS</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span><span class="token operator">:</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">!=</span> None<span class="token punctuation">)</span>
## 如果你用了 pep8<span class="token operator">/</span>linter 的话
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">isnot</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">AND</span>
## use <span class="token function">and_</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">and_</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
## or send multiple expressions to <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span>
## or chain multiple <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">filter_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span> calls
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span>
# <span class="token constant">OR</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">or_</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'wendy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
# <span class="token constant">MATCH</span>
query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'wendy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="执行查询"><a class="v-toc-item" href="#执行查询">#</a> 执行查询</h5>
<pre><code class="language-python"><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">one_or_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>YourModel.query.get((pk1, pk2))</p>
<h5 id="比较"><a class="v-toc-item" href="#比较">#</a> 比较</h5>
<blockquote>
<p>同一个 Session 下面，取到的某一条数据对应的 objects 应该是一样的？</p>
</blockquote>
<h5 id="复制-实例"><a class="v-toc-item" href="#复制-实例">#</a> 复制 实例</h5>
<h5 id="其他"><a class="v-toc-item" href="#其他">#</a> 其他</h5>
<pre><code class="language-python"># 查询的是 SomeModel 里面所有的字段 即 select <span class="token operator">*</span>
query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>SomeModel<span class="token punctuation">)</span>
# 查询的是 SomeModel 里面部分的字段 即 select acol<span class="token punctuation">,</span> bcol
query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>SomeModel<span class="token punctuation">.</span>acol<span class="token punctuation">,</span>SomeModel<span class="token punctuation">.</span>bcol<span class="token punctuation">)</span>
# 即 select acol <span class="token punctuation">,</span> bcol
# alias
user_alias <span class="token operator">=</span> <span class="token function">aliased</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_alias'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>user_alias<span class="token punctuation">,</span> user_alias<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    # 即相当于 select name <span class="token keyword">as</span> name_label
    <span class="token function">print</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>user_alias<span class="token punctuation">)</span>

# limit 和 offset
<span class="token keyword">for</span> u <span class="token keyword">in</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order_by</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>

# distinct
session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order_by</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
# order_by
User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">order_by</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>popularity<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>User<span class="token punctuation">.</span>date_created<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="update"><a class="v-toc-item" href="#update">#</a> Update</h4>
<p>单个 object 更新</p>
<pre><code class="language-python">blog<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"大宝天天见"</span>
session<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span>
session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>批量更新</p>
<pre><code class="language-python">session<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Blog<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">"% 敏感词 %"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Blog<span class="token punctuation">.</span>content<span class="token operator">:</span> <span class="token string">"依照相关 XX 无法查看"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>一对多的更新</p>
<pre><code>append
</code></pre>
<h4 id="delete"><a class="v-toc-item" href="#delete">#</a> Delete</h4>
<p>query.delete()</p>
<h4 id="join"><a class="v-toc-item" href="#join">#</a> JOIN</h4>
<p><a href="https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query">https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query</a></p>
<h5 id="两表-innerjoin"><a class="v-toc-item" href="#两表-innerjoin">#</a> 两表 InnerJoin</h5>
<pre><code class="language-python"><span class="token keyword">for</span> u<span class="token punctuation">,</span> a <span class="token keyword">in</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> Address<span class="token punctuation">)</span><span class="token punctuation">.</span>\
                    <span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token operator">==</span>Address<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>\
                    <span class="token function">filter</span><span class="token punctuation">(</span>Address<span class="token punctuation">.</span>email_address<span class="token operator">==</span><span class="token string">'jack@google.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
                    <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
# <span class="token operator">&lt;</span><span class="token function">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'jack'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Jack Bean'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'gjffdd'</span><span class="token punctuation">)</span><span class="token operator">></span>
# <span class="token operator">&lt;</span><span class="token function">Address</span><span class="token punctuation">(</span>email_address<span class="token operator">=</span><span class="token string">'jack@google.com'</span><span class="token punctuation">)</span><span class="token operator">></span>

</code></pre>
<h5 id="多表-innerjoin-leftjoin"><a class="v-toc-item" href="#多表-innerjoin-leftjoin">#</a> 多表 InnerJoin + LeftJoin</h5>
<pre><code class="language-python">query<span class="token punctuation">.</span><span class="token function">outerjoin</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span>   # <span class="token constant">LEFT</span> <span class="token constant">OUTER</span> <span class="token constant">JOIN</span>
</code></pre>
<h4 id="聚集查询"><a class="v-toc-item" href="#聚集查询">#</a> 聚集查询</h4>
<pre><code class="language-python">session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">'%ed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="language-python">from sqlalchemy <span class="token keyword">import</span> func
session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Table<span class="token punctuation">.</span>column<span class="token punctuation">,</span> func<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>Table<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group_by</span><span class="token punctuation">(</span>Table<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>Table<span class="token punctuation">.</span>column1<span class="token punctuation">)</span><span class="token punctuation">,</span>Table<span class="token punctuation">.</span>column1<span class="token punctuation">,</span> Table<span class="token punctuation">.</span>column2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group_by</span><span class="token punctuation">(</span>Table<span class="token punctuation">.</span>column1<span class="token punctuation">,</span> Table<span class="token punctuation">.</span>column2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

from sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> func
session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>Rating<span class="token punctuation">.</span>field2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token string">'average'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Rating<span class="token punctuation">.</span>url<span class="token operator">==</span>url_string<span class="token punctuation">.</span>netloc<span class="token punctuation">)</span>
</code></pre>
<h4 id="缓存机制"><a class="v-toc-item" href="#缓存机制">#</a> 缓存机制</h4>
<p>Query 对象，下文中，我会聊到这个 Query 对象。这里先跳过。</p>
<h3 id="22-原生查询"><a class="v-toc-item" href="#22-原生查询">#</a> 2.2 原生查询</h3>
<pre><code class="language-python">from sqlalchemy <span class="token keyword">import</span> text

sql <span class="token operator">=</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'select name from penguins'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> db<span class="token punctuation">.</span>engine<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token operator">:</span>
    names<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

print names

from collections <span class="token keyword">import</span> namedtuple

Record <span class="token operator">=</span> <span class="token function">namedtuple</span><span class="token punctuation">(</span><span class="token string">'Record'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
records <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">Record</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> result<span class="token punctuation">.</span><span class="token function">fetchall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> r <span class="token keyword">in</span> records<span class="token operator">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

from sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> text

connection <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

# recommended
cmd <span class="token operator">=</span> <span class="token string">'select * from Employees where EmployeeGroup == :group'</span>
employeeGroup <span class="token operator">=</span> <span class="token string">'Staff'</span>
employees <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">text</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span> group <span class="token operator">=</span> employeeGroup<span class="token punctuation">)</span>

</code></pre>
<p>get_or_create</p>
<pre><code class="language-python">def <span class="token function">get_or_create</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> model<span class="token punctuation">,</span> defaults<span class="token operator">=</span>None<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token operator">:</span>
    instance <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter_by</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> instance<span class="token operator">:</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">,</span> False
    <span class="token keyword">else</span><span class="token operator">:</span>
        params <span class="token operator">=</span> <span class="token function">dict</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span><span class="token function">iteritems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> not <span class="token function">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> ClauseElement<span class="token punctuation">)</span><span class="token punctuation">)</span>
        params<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>defaults or <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        instance <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token operator">**</span>params<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">,</span> True
</code></pre>
<h3 id="23-更新查询"><a class="v-toc-item" href="#23-更新查询">#</a> 2.3 更新查询</h3>
<pre><code class="language-python">session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Stuff<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Stuff<span class="token punctuation">.</span>foo<span class="token operator">:</span> Stuff<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="language-python"><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Stuff<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
       c<span class="token punctuation">.</span>foo <span class="token operator">+=</span> <span class="token number">1</span>
   session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">2</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"foo"</span><span class="token operator">:</span> <span class="token punctuation">(</span>Stuff<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">3</span><span class="token punctuation">)</span> conn <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   stmt <span class="token operator">=</span> Stuff<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">values</span><span class="token punctuation">(</span>Stuff<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token punctuation">(</span>Stuff<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   conn<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
</code></pre>
<pre><code class="language-python"><span class="token number">1</span><span class="token punctuation">)</span> user<span class="token punctuation">.</span>no_of_logins <span class="token operator">+=</span> <span class="token number">1</span>
   session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">2</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"no_of_logins"</span><span class="token operator">:</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>no_of_logins <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">3</span><span class="token punctuation">)</span> conn <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   stmt <span class="token operator">=</span> User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">values</span><span class="token punctuation">(</span>no_of_logins<span class="token operator">=</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>no_of_logins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>\
       <span class="token function">where</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
   conn<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>

<span class="token number">4</span><span class="token punctuation">)</span> <span class="token function">setattr</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">'no_of_logins'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>no_of_logins<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
   session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="24-删除"><a class="v-toc-item" href="#24-删除">#</a> 2.4 删除</h3>
<p><a href="https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete">https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete</a></p>
<h4 id="ondelete"><a class="v-toc-item" href="#ondelete">#</a> OnDelete</h4>
<p>ondelete=‘CASCADE’))</p>
<h4 id="批量操作"><a class="v-toc-item" href="#批量操作">#</a> 批量操作</h4>
<p>models.User.query.delete()</p>
<h3 id="如何从-object-到一个-orm"><a class="v-toc-item" href="#如何从-object-到一个-orm">#</a> 如何从 Object 到一个 ORM</h3>
<p>如何追踪 Object 的变化？</p>
<h2 id="0x03-sqlalchemy-的高级特性"><a class="v-toc-item" href="#0x03-sqlalchemy-的高级特性">#</a> 0x03 SQLAlchemy 的高级特性</h2>
<h3 id="表继承"><a class="v-toc-item" href="#表继承">#</a> 表继承</h3>
<p><a href="https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance">https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance</a></p>
<h3 id="啥玩意"><a class="v-toc-item" href="#啥玩意">#</a> 啥玩意</h3>
<p>Flush 和 commit</p>
<p><a href="https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit">https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit</a></p>
<pre><code>x = Foo(bar=1)
print x.id
# None
session.add(x)
session.flush()
# BEGIN
# INSERT INTO foo (bar) VALUES(1)
# COMMIT
print x.id
</code></pre>
<pre><code>qry = DBSession.query(User).filter(
        and_(User.birthday &lt;= '1988-01-17', User.birthday &gt;= '1985-01-17'))
</code></pre>
<h2 id="0x04-sqlalchemy-的基础特性-under-the-hood"><a class="v-toc-item" href="#0x04-sqlalchemy-的基础特性-under-the-hood">#</a> 0x04 SQLAlchemy 的基础特性 Under The Hood</h2>
<h3 id="loading-策略"><a class="v-toc-item" href="#loading-策略">#</a> Loading 策略</h3>
<h4 id="lazy-loading"><a class="v-toc-item" href="#lazy-loading">#</a> Lazy Loading</h4>
<h4 id="eager-loading"><a class="v-toc-item" href="#eager-loading">#</a> Eager Loading</h4>
<pre><code>&gt;&gt;&gt; from sqlalchemy.dialects import postgresql
&gt;&gt;&gt; print str(q.statement.compile(dialect=postgresql.dialect()))
Where q is defined as:

</code></pre>
<h2 id="0x05-sqlalchemy-的高级特性-under-the-hood"><a class="v-toc-item" href="#0x05-sqlalchemy-的高级特性-under-the-hood">#</a> 0x05 SQLAlchemy 的高级特性 Under The Hood</h2>
<h3 id="多线程"><a class="v-toc-item" href="#多线程">#</a> 多线程</h3>
<p><a href="https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy">https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy</a><br>
<a href="https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications">https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications</a></p>
<pre><code>
https://stackoverflow.com/questions/34322471/sqlalchemy-engine-connection-and-session-difference
https://stackoverflow.com/questions/11769366/why-is-sqlalchemy-insert-with-sqlite-25-times-slower-than-using-sqlite3-directly
https://stackoverflow.com/questions/12223335/sqlalchemy-creating-vs-reusing-a-session
session 是个容器

https://stackoverflow.com/questions/18199053/example-of-what-sqlalchemy-can-do-and-django-orm-cannot
https://stackoverflow.com/questions/7389759/memory-efficient-built-in-sqlalchemy-iterator-generator

# 日志
import logging
logging.basicConfig()
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
</code></pre>
<h2 id="0x06-debug-和-profile-技巧"><a class="v-toc-item" href="#0x06-debug-和-profile-技巧">#</a> 0x06 DEBUG 和 Profile 技巧</h2>
<pre><code>SQLALCHEMY_TRACK_MODIFICATIONS = False
</code></pre>
<h3 id="61-查看技巧"><a class="v-toc-item" href="#61-查看技巧">#</a> 6.1 查看技巧</h3>
<p>dict(u)<br>
u.<strong>dict</strong></p>
<p><a href="https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application">https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application</a></p>
<p>如果用上 Flask+SQLAlchemy 一般也要带上，Flask-Migration 与 Flask-SQLAlchemy, 这两个库也是对 Alembic 和 SQLAlchemy 的浅封装。</p>
<p>那么，对于这个 ORM 库还有那些通用性的知识需要了解？</p>
<p>嗯，是时候了解本质了。</p>
<p><a href="http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/">http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/</a></p>
<h2 id="0x07-orm-的本质"><a class="v-toc-item" href="#0x07-orm-的本质">#</a> 0x07 ORM 的本质</h2>
<p>ORM 的本质是 Data Access Layer 上的一层封装。如果你写原生 SQL, 即手写 DAL 的话，开发效率可能会大打折扣。</p>
<h3 id="orm-的两种类型-active-record-与-data-mappers"><a class="v-toc-item" href="#orm-的两种类型-active-record-与-data-mappers">#</a> ORM 的两种类型 Active Record 与 Data Mappers</h3>
<pre><code># ActiveRecord 风格写起来类似于 Django ORM, 大致是这样的

## AR 的模型定义

class User(db.models):
    name = db.StringField(verbose=&quot;xyz&quot;)

## AR 的新增
user = User()
user.name = &quot;123456&quot;
user.save() ## 正好对应数据库中的一行

## AR 的查询

users = User.objects.filter(Q(name=&quot;黄老板的小姨子&quot;)).all()

# Data Mappers 风格写起来类似于 SQLAlchemy ORM, 大致是这样的

## SA 的定义

from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

from sqlalchemy import Column, Integer, String
class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)

Base.metadata.create_all(engine)

## SA 的新增

user = User()
user.name = &quot;123456&quot;
session.add(user)
sessoon.commit() ## 嗯？其实也是对应数据库中的一行。

## SA 的查询

session.query(User).filter(User.name)

</code></pre>
<p>问题来了，这两者到底是什么，看起来似乎相差不大。</p>
<pre><code>class Person:

    lastname
    firstname
    children

    # 数据操作
    def findone(self):
        pass

    def insert(self):
        pass

    def update(self):
        pass

    def delete(self):
        pass

    # 业务逻辑
    def getChildrenTax(self):
        pass

</code></pre>
<p>lastName firstName numberOfDependents</p>
<p>insert update delete</p>
<p>getExemption isFlaggedForAudit getTaxableEarnings</p>
<p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p>
<p>The essence of an Active Record is a Domain Model (116) in which the classes match very closely the record structure of an underlying database. Each Active Record is responsible for saving and loading to the database and also for any domain logic that acts on the data. This may be all the domain logic in the application, or you may ﬁnd that some domain logic is held in Transaction Scripts (110) with common and data-oriented code in the Active Record.</p>
<p>The data structure of the Active Record should exactly match that of the database: one ﬁeld in the class for each column in the table. Type the ﬁelds the way the SQL interface gives you the data—don’t do any conversion at this stage. You may consider Foreign Key Mapping (236), but you may also leave the foreign keys as they are. You can use views or tables with Active Record, although updates through views are obviously harder. Views are particularly useful for reporting purposes.</p>
<p>objects correspond directly to the database tables: an isomorphic schema. If your business logic is complex, you’ll soon want to use your object’s direct relationships, collections, inheritance, and so forth. These don’t map easily onto Active Record, and adding them piecemeal gets very messy. That’s what will lead you to use Data Mapper (165) instead.</p>
<p>Another argument against Active Record is the fact that it couples the object design to the database design. This makes it more difﬁcult to refactor either design as a project goes forward.</p>
<p>Active Record is a good pattern to consider if you’re using Transaction Script (110) and are beginning to feel the pain of code duplication and the difﬁculty in updating scripts and tables that Transaction Script (110) often brings. In this case you can gradually start creating Active Records and then slowly refactor behavior into them. It often helps to wrap the tables as a Gateway (466) ﬁrst, and then start moving behavior so that the tables evolve to a Active Record.</p>
<p>其实为什么不选择设计成 ActiveRecord , 而是选择设计成 Data Mapper, 其实就可以回答这个问题：</p>
<blockquote>
<p>虽然要设计成 ORM, 考虑到数量和性能因素，SQL 数据库（多个表）并不应该是表现像 Object 集合那样（换言之，也就是 AR 表现的像 Object 的集合一样）。<br>
同时，出于更好的抽象，object 集合也应该表现的像表以及行</p>
</blockquote>
<p>于是我们可以得出结论，可以在 SQLAlchemy 上面进行一定的封装，使得最后用起来非常的 Django ORM like，其实 SQLAlchemy 稍加定制还是可以很 Django ORM-like 的。</p>
<p>:TODO: 有机会看看那本书再修改一下本小节</p>
<p>这不，果然有人就这么搞了 <a href="https://github.com/absent1706/sqlalchemy-mixins">https://github.com/absent1706/sqlalchemy-mixins</a></p>
<h2 id="0x09-踩坑集"><a class="v-toc-item" href="#0x09-踩坑集">#</a> 0x09 踩坑集</h2>
<h3 id="关系持久化坑"><a class="v-toc-item" href="#关系持久化坑">#</a> 关系持久化坑</h3>
<ol>
<li>Rows that point to themselves : 比如一个 insert 一个推荐自己的用户，则需要保存 id / ref_id , 但是在这个 user 插入之前，并不存在 id. 所以，一般情况下是先 insert, 然后保存 ref_id</li>
<li>Mutually Dependent Rows</li>
</ol>
<h3 id="sql-注入"><a class="v-toc-item" href="#sql-注入">#</a> SQL 注入</h3>
<p>session.query(MyClass).filter(“foo={}”.format(getArgs[‘val’]))</p>
<h2 id="0xee-参考链接"><a class="v-toc-item" href="#0xee-参考链接">#</a> 0xEE 参考链接</h2>
<ul>
<li>
<p><a href="https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/">https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create">https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create</a></p>
</li>
<li>
<p>除了文档本身，作者在 Stack Overflow 上的回答都是非常值得阅读的。<a href="https://stackoverflow.com/users/34549/zzzeek">https://stackoverflow.com/users/34549/zzzeek</a></p>
</li>
<li>
<p>Patterns of Enterprise Application Architecture - Martin Fowler</p>
</li>
<li>
<p><a href="http://aosabook.org/en/sqlalchemy.html">http://aosabook.org/en/sqlalchemy.html</a></p>
<p><a href="http://techspot.zzzeek.org/">http://techspot.zzzeek.org/</a></p>
</li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93">0x01 如何访问数据库</a></li>
<li><a href="#0x02-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%90%86%E8%AE%BA">0x02 数据库抽象的两种理论</a>
<ul>
<li><a href="#%E7%90%86%E8%AE%BA%E4%B8%80active-record">理论一：Active Record</a></li>
<li><a href="#%E7%90%86%E8%AE%BA%E4%BA%8Cdata-mapper">理论二：Data Mapper</a></li>
</ul>
</li>
<li><a href="#0x03-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0">0x03 数据库抽象的两种实现</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80django-orm">实现一：Django ORM</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E4%BA%8Csqlalchemy">实现二：Sqlalchemy</a></li>
</ul>
</li>
<li><a href="#0x04-%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%BA%E5%BC%B1">0x04 工具的强弱</a>
<ul>
<li><a href="#20-sqlalchemy-vs-djangoorm">2.0 SQLAlchemy VS DjangoORM</a></li>
<li><a href="#21-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89">2.1 模型定义</a>
<ul>
<li><a href="#models-%E4%B8%8E-meta">Models 与 Meta</a></li>
<li><a href="#%E5%85%B3%E7%B3%BB">关系</a>
<ul>
<li><a href="#one-to-many">One To Many</a></li>
<li><a href="#many-to-one">Many To One</a></li>
<li><a href="#one-to-one">One To One</a></li>
<li><a href="#many-to-many">Many To Many</a></li>
<li><a href="#%E9%82%BB%E6%8E%A5%E5%88%97%E8%A1%A8%E5%85%B3%E7%B3%BB">邻接列表关系</a></li>
<li><a href="#relationship-%E8%AF%A6%E8%A7%A3">relationship 详解</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#21-query">2.1 Query</a>
<ul>
<li><a href="#create">Create</a></li>
<li><a href="#retrieve">Retrieve</a>
<ul>
<li><a href="#%E8%B7%A8%E5%85%B3%E7%B3%BB%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2">跨关系（跨表）查询</a></li>
<li><a href="#limit-offset-%E5%88%86%E9%A1%B5">Limit / Offset / 分页</a></li>
<li><a href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">链式调用</a></li>
<li><a href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F">二进制表达式</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2">执行查询</a></li>
<li><a href="#%E6%AF%94%E8%BE%83">比较</a></li>
<li><a href="#%E5%A4%8D%E5%88%B6-%E5%AE%9E%E4%BE%8B">复制 实例</a></li>
<li><a href="#%E5%85%B6%E4%BB%96">其他</a></li>
</ul>
</li>
<li><a href="#update">Update</a></li>
<li><a href="#delete">Delete</a></li>
<li><a href="#join">JOIN</a>
<ul>
<li><a href="#%E4%B8%A4%E8%A1%A8-innerjoin">两表 InnerJoin</a></li>
<li><a href="#%E5%A4%9A%E8%A1%A8-innerjoin-leftjoin">多表 InnerJoin + LeftJoin</a></li>
</ul>
</li>
<li><a href="#%E8%81%9A%E9%9B%86%E6%9F%A5%E8%AF%A2">聚集查询</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6">缓存机制</a></li>
</ul>
</li>
<li><a href="#22-%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2">2.2 原生查询</a></li>
<li><a href="#23-%E6%9B%B4%E6%96%B0%E6%9F%A5%E8%AF%A2">2.3 更新查询</a></li>
<li><a href="#24-%E5%88%A0%E9%99%A4">2.4 删除</a>
<ul>
<li><a href="#ondelete">OnDelete</a></li>
<li><a href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C">批量操作</a></li>
</ul>
</li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BB%8E-object-%E5%88%B0%E4%B8%80%E4%B8%AA-orm">如何从 Object 到一个 ORM</a></li>
</ul>
</li>
<li><a href="#0x03-sqlalchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">0x03 SQLAlchemy 的高级特性</a>
<ul>
<li><a href="#%E8%A1%A8%E7%BB%A7%E6%89%BF">表继承</a></li>
<li><a href="#%E5%95%A5%E7%8E%A9%E6%84%8F">啥玩意</a></li>
</ul>
</li>
<li><a href="#0x04-sqlalchemy-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7-under-the-hood">0x04 SQLAlchemy 的基础特性 Under The Hood</a>
<ul>
<li><a href="#loading-%E7%AD%96%E7%95%A5">Loading 策略</a>
<ul>
<li><a href="#lazy-loading">Lazy Loading</a></li>
<li><a href="#eager-loading">Eager Loading</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#0x05-sqlalchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7-under-the-hood">0x05 SQLAlchemy 的高级特性 Under The Hood</a>
<ul>
<li><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B">多线程</a></li>
</ul>
</li>
<li><a href="#0x06-debug-%E5%92%8C-profile-%E6%8A%80%E5%B7%A7">0x06 DEBUG 和 Profile 技巧</a>
<ul>
<li><a href="#61-%E6%9F%A5%E7%9C%8B%E6%8A%80%E5%B7%A7">6.1 查看技巧</a></li>
</ul>
</li>
<li><a href="#0x07-orm-%E7%9A%84%E6%9C%AC%E8%B4%A8">0x07 ORM 的本质</a>
<ul>
<li><a href="#orm-%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B-active-record-%E4%B8%8E-data-mappers">ORM 的两种类型 Active Record 与 Data Mappers</a></li>
</ul>
</li>
<li><a href="#0x09-%E8%B8%A9%E5%9D%91%E9%9B%86">0x09 踩坑集</a>
<ul>
<li><a href="#%E5%85%B3%E7%B3%BB%E6%8C%81%E4%B9%85%E5%8C%96%E5%9D%91">关系持久化坑</a></li>
<li><a href="#sql-%E6%B3%A8%E5%85%A5">SQL 注入</a></li>
</ul>
</li>
<li><a href="#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">0xEE 参考链接</a></li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["Python","ORM","SQLAlchemy"],"path":"20190412_PythonORM.md","title":"Python ORM","slug":"Python ORM","date":"2019-04-12","category":"Python","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003ePython 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现\u003c/li\u003e\n\u003cli\u003eDjango ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的话我甚至会考虑将 Django ORM 配置到 Flask 项目中。当然，也有蛋疼的 SqlAlchemy 使用者已经移植给 django 配置了 SQLAlchemy 的库。\u003c/li\u003e\n\u003cli\u003ePeewee 没用过，不好评论。以后有机会试试。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"0x01-如何访问数据库\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-如何访问数据库\"\u003e#\u003c/a\u003e 0x01 如何访问数据库\u003c/h2\u003e\n\u003cp\u003e那，既然已经可以访问数据库，本着『如无必要，勿增实体』的原则，为什么要不辞劳苦的用个库呢？\u003c/p\u003e\n\u003ch2 id=\"0x02-数据库抽象的两种理论\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-数据库抽象的两种理论\"\u003e#\u003c/a\u003e 0x02 数据库抽象的两种理论\u003c/h2\u003e\n\u003ch3 id=\"理论一active-record\"\u003e\u003ca class=\"v-toc-item\" href=\"#理论一active-record\"\u003e#\u003c/a\u003e 理论一：Active Record\u003c/h3\u003e\n\u003ch3 id=\"理论二data-mapper\"\u003e\u003ca class=\"v-toc-item\" href=\"#理论二data-mapper\"\u003e#\u003c/a\u003e 理论二：Data Mapper\u003c/h3\u003e\n\u003ch2 id=\"0x03-数据库抽象的两种实现\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-数据库抽象的两种实现\"\u003e#\u003c/a\u003e 0x03 数据库抽象的两种实现\u003c/h2\u003e\n\u003ch3 id=\"实现一django-orm\"\u003e\u003ca class=\"v-toc-item\" href=\"#实现一django-orm\"\u003e#\u003c/a\u003e 实现一：Django ORM\u003c/h3\u003e\n\u003ch3 id=\"实现二sqlalchemy\"\u003e\u003ca class=\"v-toc-item\" href=\"#实现二sqlalchemy\"\u003e#\u003c/a\u003e 实现二：Sqlalchemy\u003c/h3\u003e\n\u003ch2 id=\"0x04-工具的强弱\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-工具的强弱\"\u003e#\u003c/a\u003e 0x04 工具的强弱\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/\"\u003ehttps://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"20-sqlalchemy-vs-djangoorm\"\u003e\u003ca class=\"v-toc-item\" href=\"#20-sqlalchemy-vs-djangoorm\"\u003e#\u003c/a\u003e 2.0 SQLAlchemy VS DjangoORM\u003c/h3\u003e\n\u003cp\u003eORM 通常有 DataMapper 实现和 ActiveRecord 实现两种。\u003c/p\u003e\n\u003cp\u003e依照我的经验，ActiveRecord 使用起来的更接近对象 (Object) 的操作，DataMapper 使用起来更接近 (Table) 的操作。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSQLAlchemy 是 DataMapper 模式的实现，在该模式下，session 会暴露出来，即 Model 与 session 并不耦合。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003eDjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，session 并不暴露出来，即 Model 与 session 耦合。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e使用 Django ORM 的时候，往往是\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eb \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eBlog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e**\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用 SQLAlchemy 的时候，往往是\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eb \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eBlog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e**\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eb\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eb\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e由于 Django 帮你屏蔽了 session 的操作。\u003c/p\u003e\n\u003cp\u003e在通常情况下，\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eDjangoORM 使用起来更加接近 Object 的操作。\u003c/li\u003e\n\u003cli\u003eSQLAlchemy 使用起来更加接近 Table 的操作。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e举个例子，\u003c/p\u003e\n\u003cp\u003e一对多，Father 添加两个小孩（其中一个小孩是已经存在的）\u003c/p\u003e\n\u003cp\u003e在 DjangoORM 里面， 这里更像是一个 Set 的 add 操作。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003efather\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enew_child\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eexsit_child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在 SQLAlchemy 里面，这里更像是一个 table 的 insert 操作。（麻蛋，你要说是一个 list 的 append 操作也行）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e child \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enew_child\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eexsit_child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e child \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e father\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        father\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e写 SQLAlchemy 更接近操作放在数据库里面的数据记录，而 DjangoORM 更接近操作一批放在数据库里面的对象。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e由于 session 的使用姿势不同，所以往往会有很多使用上面的区别。\u003c/p\u003e\n\u003cp\u003e至于孰优孰劣，难以评判。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e技术老大 (Flask 和 React 大神）倾向于使用 SQLAlchemy, 他认为\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e对于一个技术『知其然，知其所以然』\u003c/li\u003e\n\u003cli\u003e对于 ORM\n\u003cul\u003e\n\u003cli\u003e操作数据库，操作最好要落实在成 SQL\u003c/li\u003e\n\u003cli\u003e如果有可能的话，每一个 SQL 语句都要经过推敲，而且写这个 SQL 和 ORM 过程要反复练习\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e对于 Migration 机制\n\u003cul\u003e\n\u003cli\u003eAlembic 这个迁移工具是为了省事用的，甚至在某些情况下没必要用。完全可以写 SQL 代替\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e我 (Django 和 Vue 弱鸡）倾向于使用 DjangoORM, 我认为\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e对于一个技术『先知其大致然，需要深入的时候知其所以然』\u003c/li\u003e\n\u003cli\u003e对于 ORM\n\u003cul\u003e\n\u003cli\u003e操作数据，最好抽象为对对象的操作。\u003c/li\u003e\n\u003cli\u003e测试到位的情况下，快糙狠先出东西。到需要优化的时候该怎么 Profile 怎么 Profile\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e对于 Migration 机制\n\u003cul\u003e\n\u003cli\u003e用起来啊，能操作对象为什么还要强行到数据库操作？\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eActive Record\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e properly defined\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e is a design pattern where an object is represented \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e a record on a table \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e a relational database\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"21-模型定义\"\u003e\u003ca class=\"v-toc-item\" href=\"#21-模型定义\"\u003e#\u003c/a\u003e 2.1 模型定义\u003c/h3\u003e\n\u003cp\u003e先看一组模型\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003efrom sqlalchemy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eext\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edeclarative \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e declarative_base\nBase \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003edeclarative_base\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 模型基类\nfrom sqlalchemy \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e Column\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Integer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e String\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    __tablename__ \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'users'\u003c/span\u003e\n\n    id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e primary_key\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # 主键\n    name \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eString\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    fullname \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eString\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    password \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eString\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    def \u003cspan class=\"token function\"\u003e__repr__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n       \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026lt;User(name='%s', fullname='%s', password='%s')\u003e\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e%\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                            self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efullname\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epassword\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nBase\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emetadata\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreate_all\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eengine\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e可以看出，包含如下的部分：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eModel 与 Model 内部的 Meta\u003c/li\u003e\n\u003cli\u003eField 与 Field 内部的 Options\u003c/li\u003e\n\u003cli\u003eModel 与 Model 之间的关系\u003c/li\u003e\n\u003cli\u003e其他，比如索引\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"models-与-meta\"\u003e\u003ca class=\"v-toc-item\" href=\"#models-与-meta\"\u003e#\u003c/a\u003e Models 与 Meta\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685\"\u003ehttps://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"关系\"\u003e\u003ca class=\"v-toc-item\" href=\"#关系\"\u003e#\u003c/a\u003e 关系\u003c/h4\u003e\n\u003ch5 id=\"one-to-many\"\u003e\u003ca class=\"v-toc-item\" href=\"#one-to-many\"\u003e#\u003c/a\u003e One To Many\u003c/h5\u003e\n\u003cp\u003e母亲有若干个孩子，外键在孩子上。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    #\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n    children \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Child\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e backref\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"parent\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    #\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n    parent_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'parent.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"many-to-one\"\u003e\u003ca class=\"v-toc-item\" href=\"#many-to-one\"\u003e#\u003c/a\u003e Many To One\u003c/h5\u003e\n\u003cp\u003e多个母亲共享一个孩子，外键在母亲上。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    child_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'child.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    child \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Child\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"one-to-one\"\u003e\u003ca class=\"v-toc-item\" href=\"#one-to-one\"\u003e#\u003c/a\u003e One To One\u003c/h5\u003e\n\u003cp\u003eOne to One 是 One to Many 或者是 Many to One 的简化版本\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# Many To One\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n    child_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'child.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    child \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Child\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e backref\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003ebackref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"parent\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e uselist\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eFalse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n# One To Many 改 One To One\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n    parent_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'parent.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    parent \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Parent\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e backref\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003ebackref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"child\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e uselist\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eFalse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"many-to-many\"\u003e\u003ca class=\"v-toc-item\" href=\"#many-to-many\"\u003e#\u003c/a\u003e Many To Many\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eassociation_table \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eTable\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'association'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Base\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emetadata\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'left_id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Integer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'left.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'right_id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Integer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'right.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n    children \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Child\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                    secondary\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eassociation_table\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                    backref\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"parents\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e注意事项\u003c/p\u003e\n\u003cp\u003e执行删除 mapping 表的时候尽量这样。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003emyparent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eremove\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esomechild\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当你想干掉 somechild 的时候，会执行\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esession.delete(somechild)\n\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003e假如 Child 没有 ref Parent 的话，Secondary Table 无删除，则无法删除。\u003c/li\u003e\n\u003cli\u003e假如 ref 了的话，则删除 secondary 里面的记录。\u003c/li\u003e\n\u003cli\u003eTODO\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch5 id=\"邻接列表关系\"\u003e\u003ca class=\"v-toc-item\" href=\"#邻接列表关系\"\u003e#\u003c/a\u003e 邻接列表关系\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eNode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBase\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    __tablename__ \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'node'\u003c/span\u003e\n    id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e primary_key\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    parent_id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInteger\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'node.id'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eColumn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e50\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    children \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erelationship\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Node\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                backref\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003ebackref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'parent'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e remote_side\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"relationship-详解\"\u003e\u003ca class=\"v-toc-item\" href=\"#relationship-详解\"\u003e#\u003c/a\u003e relationship 详解\u003c/h5\u003e\n\u003ch3 id=\"21-query\"\u003e\u003ca class=\"v-toc-item\" href=\"#21-query\"\u003e#\u003c/a\u003e 2.1 Query\u003c/h3\u003e\n\u003ch4 id=\"create\"\u003e\u003ca class=\"v-toc-item\" href=\"#create\"\u003e#\u003c/a\u003e Create\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003ec1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"苏轼\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ec1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eflush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\np \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eParent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"苏辙\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\np\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebest_child \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e c1\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e c \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ec1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ec2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ec3\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ec4\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    p\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ec\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ec1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"retrieve\"\u003e\u003ca class=\"v-toc-item\" href=\"#retrieve\"\u003e#\u003c/a\u003e Retrieve\u003c/h4\u003e\n\u003cp\u003e过滤\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eSinger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"周杰伦\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eSinger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"周杰棍\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"跨关系跨表查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#跨关系跨表查询\"\u003e#\u003c/a\u003e 跨关系（跨表）查询\u003c/h5\u003e\n\u003cpre\u003e\u003ccode\u003esession.query(Entry).join(Blog,Blog.entry_id == Entry.id).filter(Blog.name = \u0026quot;SqlAlchemy CheatSheet\u0026quot;)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"limit-offset-分页\"\u003e\u003ca class=\"v-toc-item\" href=\"#limit-offset-分页\"\u003e#\u003c/a\u003e Limit / Offset / 分页\u003c/h5\u003e\n\u003cul\u003e\n\u003cli\u003elimit()\u003c/li\u003e\n\u003cli\u003eoffset()\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch5 id=\"链式调用\"\u003e\u003ca class=\"v-toc-item\" href=\"#链式调用\"\u003e#\u003c/a\u003e 链式调用\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003equery \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eOrder\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e # query \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eOrder\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nquery \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e query\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eOrder\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elike\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ef\u003cspan class=\"token string\"\u003e\"%name%\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"二进制表达式\"\u003e\u003ca class=\"v-toc-item\" href=\"#二进制表达式\"\u003e#\u003c/a\u003e 二进制表达式\u003c/h5\u003e\n\u003cp\u003e我们先 type 一下表达式，找到 eq 的类型\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token function\"\u003etype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn_name \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'asdf'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e → sqlalchemy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eelements\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eBinaryExpression\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e是一个二进制表达式。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# 等于\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# 不等于\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# Like（有的数据库不区分大小写）\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elike\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'%ed%'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eILIKE\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003einsensitive \u003cspan class=\"token constant\"\u003eLIKE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eilike\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'%ed%'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eIN\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ein_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'wendy'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'jack'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# Not \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e~\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ein_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'wendy'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'jack'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eIS\u003c/span\u003e \u003cspan class=\"token constant\"\u003eNULL\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e None\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n## 如果你用了 pep8\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elinter 的话\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eis_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eNone\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eIS\u003c/span\u003e \u003cspan class=\"token constant\"\u003eNOT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e None\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n## 如果你用了 pep8\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elinter 的话\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisnot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eNone\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eAND\u003c/span\u003e\n## use \u003cspan class=\"token function\"\u003eand_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eand_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efullname \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Ed Jones'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n## or send multiple expressions to \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efullname \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Ed Jones'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n## or chain multiple \u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e calls\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efullname \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Ed Jones'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eOR\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eor_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'wendy'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token constant\"\u003eMATCH\u003c/span\u003e\nquery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ematch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'wendy'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"执行查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#执行查询\"\u003e#\u003c/a\u003e 执行查询\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efirst\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eone_or_none\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003escalar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYourModel.query.get((pk1, pk2))\u003c/p\u003e\n\u003ch5 id=\"比较\"\u003e\u003ca class=\"v-toc-item\" href=\"#比较\"\u003e#\u003c/a\u003e 比较\u003c/h5\u003e\n\u003cblockquote\u003e\n\u003cp\u003e同一个 Session 下面，取到的某一条数据对应的 objects 应该是一样的？\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch5 id=\"复制-实例\"\u003e\u003ca class=\"v-toc-item\" href=\"#复制-实例\"\u003e#\u003c/a\u003e 复制 实例\u003c/h5\u003e\n\u003ch5 id=\"其他\"\u003e\u003ca class=\"v-toc-item\" href=\"#其他\"\u003e#\u003c/a\u003e 其他\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e# 查询的是 SomeModel 里面所有的字段 即 select \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\nquery \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eSomeModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# 查询的是 SomeModel 里面部分的字段 即 select acol\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e bcol\nquery \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eSomeModel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eacol\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eSomeModel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebcol\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# 即 select acol \u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e bcol\n# alias\nuser_alias \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ealiased\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'user_alias'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e row \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser_alias\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e user_alias\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # 即相当于 select name \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e name_label\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erow\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003euser_alias\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n# limit 和 offset\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e u \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eorder_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eu\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n# distinct\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eName\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edistinct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eName\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eorder_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eName\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# order_by\nUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003equery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eorder_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epopularity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edesc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edate_created\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edesc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elimit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"update\"\u003e\u003ca class=\"v-toc-item\" href=\"#update\"\u003e#\u003c/a\u003e Update\u003c/h4\u003e\n\u003cp\u003e单个 object 更新\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eblog\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etitle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"大宝天天见\"\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eblog\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e批量更新\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003esession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003equery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBlog\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econtent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elike\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"% 敏感词 %\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    Blog\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econtent\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"依照相关 XX 无法查看\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e一对多的更新\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eappend\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"delete\"\u003e\u003ca class=\"v-toc-item\" href=\"#delete\"\u003e#\u003c/a\u003e Delete\u003c/h4\u003e\n\u003cp\u003equery.delete()\u003c/p\u003e\n\u003ch4 id=\"join\"\u003e\u003ca class=\"v-toc-item\" href=\"#join\"\u003e#\u003c/a\u003e JOIN\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query\"\u003ehttps://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query\u003c/a\u003e\u003c/p\u003e\n\u003ch5 id=\"两表-innerjoin\"\u003e\u003ca class=\"v-toc-item\" href=\"#两表-innerjoin\"\u003e#\u003c/a\u003e 两表 InnerJoin\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e u\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Address\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n                    \u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token operator\"\u003e==\u003c/span\u003eAddress\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003euser_id\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n                    \u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eAddress\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eemail_address\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\u003cspan class=\"token string\"\u003e'jack@google.com'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n                    \u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eu\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'jack'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullname\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'Jack Bean'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e password\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'gjffdd'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n# \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eAddress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eemail_address\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'jack@google.com'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"多表-innerjoin-leftjoin\"\u003e\u003ca class=\"v-toc-item\" href=\"#多表-innerjoin-leftjoin\"\u003e#\u003c/a\u003e 多表 InnerJoin + LeftJoin\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003equery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eouterjoin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eaddresses\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e   # \u003cspan class=\"token constant\"\u003eLEFT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eOUTER\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJOIN\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"聚集查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#聚集查询\"\u003e#\u003c/a\u003e 聚集查询\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003esession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elike\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'%ed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003efrom sqlalchemy \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e func\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e func\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nself\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efunc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Table\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eTable\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Table\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecolumn2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nfrom sqlalchemy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e func\nsession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efunc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eavg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eRating\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efield2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elabel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'average'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eRating\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eurl\u003cspan class=\"token operator\"\u003e==\u003c/span\u003eurl_string\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enetloc\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"缓存机制\"\u003e\u003ca class=\"v-toc-item\" href=\"#缓存机制\"\u003e#\u003c/a\u003e 缓存机制\u003c/h4\u003e\n\u003cp\u003eQuery 对象，下文中，我会聊到这个 Query 对象。这里先跳过。\u003c/p\u003e\n\u003ch3 id=\"22-原生查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#22-原生查询\"\u003e#\u003c/a\u003e 2.2 原生查询\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003efrom sqlalchemy \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e text\n\nsql \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003etext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'select name from penguins'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nresult \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e db\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eengine\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esql\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nnames \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e row \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e result\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    names\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erow\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nprint names\n\nfrom collections \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e namedtuple\n\nRecord \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003enamedtuple\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'Record'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ekeys\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nrecords \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eRecord\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003er\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e r \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efetchall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e r \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e records\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nfrom sqlalchemy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e text\n\nconnection \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e engine\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econnect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n# recommended\ncmd \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'select * from Employees where EmployeeGroup == :group'\u003c/span\u003e\nemployeeGroup \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Staff'\u003c/span\u003e\nemployees \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e connection\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003etext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecmd\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e group \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e employeeGroup\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eget_or_create\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003edef \u003cspan class=\"token function\"\u003eget_or_create\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esession\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e defaults\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eNone\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    instance \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter_by\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efirst\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e instance\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e instance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e False\n    \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        params \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003edict\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e v\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e k\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e v \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e kwargs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eiteritems\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"token function\"\u003eisinstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ev\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ClauseElement\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        params\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefaults or \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        instance \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003emodel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e**\u003c/span\u003eparams\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einstance\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e instance\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e True\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"23-更新查询\"\u003e\u003ca class=\"v-toc-item\" href=\"#23-更新查询\"\u003e#\u003c/a\u003e 2.3 更新查询\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003esession\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Stuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e c \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n       c\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n   session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e conn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e engine\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econnect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   stmt \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Stuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003evalues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eStuff\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efoo \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estmt\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e user\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eno_of_logins \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n   session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eusername \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e form\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"no_of_logins\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eno_of_logins \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e conn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e engine\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econnect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   stmt \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003evalues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eno_of_logins\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eno_of_logins \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\\\n       \u003cspan class=\"token function\"\u003ewhere\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eusername \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e form\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estmt\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003esetattr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'no_of_logins'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e user\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eno_of_logins\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   session\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"24-删除\"\u003e\u003ca class=\"v-toc-item\" href=\"#24-删除\"\u003e#\u003c/a\u003e 2.4 删除\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete\"\u003ehttps://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"ondelete\"\u003e\u003ca class=\"v-toc-item\" href=\"#ondelete\"\u003e#\u003c/a\u003e OnDelete\u003c/h4\u003e\n\u003cp\u003eondelete=‘CASCADE’))\u003c/p\u003e\n\u003ch4 id=\"批量操作\"\u003e\u003ca class=\"v-toc-item\" href=\"#批量操作\"\u003e#\u003c/a\u003e 批量操作\u003c/h4\u003e\n\u003cp\u003emodels.User.query.delete()\u003c/p\u003e\n\u003ch3 id=\"如何从-object-到一个-orm\"\u003e\u003ca class=\"v-toc-item\" href=\"#如何从-object-到一个-orm\"\u003e#\u003c/a\u003e 如何从 Object 到一个 ORM\u003c/h3\u003e\n\u003cp\u003e如何追踪 Object 的变化？\u003c/p\u003e\n\u003ch2 id=\"0x03-sqlalchemy-的高级特性\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-sqlalchemy-的高级特性\"\u003e#\u003c/a\u003e 0x03 SQLAlchemy 的高级特性\u003c/h2\u003e\n\u003ch3 id=\"表继承\"\u003e\u003ca class=\"v-toc-item\" href=\"#表继承\"\u003e#\u003c/a\u003e 表继承\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance\"\u003ehttps://stackoverflow.com/questions/1337095/sqlalchemy-inheritance\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"啥玩意\"\u003e\u003ca class=\"v-toc-item\" href=\"#啥玩意\"\u003e#\u003c/a\u003e 啥玩意\u003c/h3\u003e\n\u003cp\u003eFlush 和 commit\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit\"\u003ehttps://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ex = Foo(bar=1)\nprint x.id\n# None\nsession.add(x)\nsession.flush()\n# BEGIN\n# INSERT INTO foo (bar) VALUES(1)\n# COMMIT\nprint x.id\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003eqry = DBSession.query(User).filter(\n        and_(User.birthday \u0026lt;= '1988-01-17', User.birthday \u0026gt;= '1985-01-17'))\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x04-sqlalchemy-的基础特性-under-the-hood\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-sqlalchemy-的基础特性-under-the-hood\"\u003e#\u003c/a\u003e 0x04 SQLAlchemy 的基础特性 Under The Hood\u003c/h2\u003e\n\u003ch3 id=\"loading-策略\"\u003e\u003ca class=\"v-toc-item\" href=\"#loading-策略\"\u003e#\u003c/a\u003e Loading 策略\u003c/h3\u003e\n\u003ch4 id=\"lazy-loading\"\u003e\u003ca class=\"v-toc-item\" href=\"#lazy-loading\"\u003e#\u003c/a\u003e Lazy Loading\u003c/h4\u003e\n\u003ch4 id=\"eager-loading\"\u003e\u003ca class=\"v-toc-item\" href=\"#eager-loading\"\u003e#\u003c/a\u003e Eager Loading\u003c/h4\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; from sqlalchemy.dialects import postgresql\n\u0026gt;\u0026gt;\u0026gt; print str(q.statement.compile(dialect=postgresql.dialect()))\nWhere q is defined as:\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x05-sqlalchemy-的高级特性-under-the-hood\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x05-sqlalchemy-的高级特性-under-the-hood\"\u003e#\u003c/a\u003e 0x05 SQLAlchemy 的高级特性 Under The Hood\u003c/h2\u003e\n\u003ch3 id=\"多线程\"\u003e\u003ca class=\"v-toc-item\" href=\"#多线程\"\u003e#\u003c/a\u003e 多线程\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy\"\u003ehttps://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications\"\u003ehttps://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\nhttps://stackoverflow.com/questions/34322471/sqlalchemy-engine-connection-and-session-difference\nhttps://stackoverflow.com/questions/11769366/why-is-sqlalchemy-insert-with-sqlite-25-times-slower-than-using-sqlite3-directly\nhttps://stackoverflow.com/questions/12223335/sqlalchemy-creating-vs-reusing-a-session\nsession 是个容器\n\nhttps://stackoverflow.com/questions/18199053/example-of-what-sqlalchemy-can-do-and-django-orm-cannot\nhttps://stackoverflow.com/questions/7389759/memory-efficient-built-in-sqlalchemy-iterator-generator\n\n# 日志\nimport logging\nlogging.basicConfig()\nlogging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x06-debug-和-profile-技巧\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x06-debug-和-profile-技巧\"\u003e#\u003c/a\u003e 0x06 DEBUG 和 Profile 技巧\u003c/h2\u003e\n\u003cpre\u003e\u003ccode\u003eSQLALCHEMY_TRACK_MODIFICATIONS = False\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"61-查看技巧\"\u003e\u003ca class=\"v-toc-item\" href=\"#61-查看技巧\"\u003e#\u003c/a\u003e 6.1 查看技巧\u003c/h3\u003e\n\u003cp\u003edict(u)\u003cbr\u003e\nu.\u003cstrong\u003edict\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application\"\u003ehttps://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e如果用上 Flask+SQLAlchemy 一般也要带上，Flask-Migration 与 Flask-SQLAlchemy, 这两个库也是对 Alembic 和 SQLAlchemy 的浅封装。\u003c/p\u003e\n\u003cp\u003e那么，对于这个 ORM 库还有那些通用性的知识需要了解？\u003c/p\u003e\n\u003cp\u003e嗯，是时候了解本质了。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/\"\u003ehttp://derrickgilland.com/posts/demystifying-flask-sqlalchemy/\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"0x07-orm-的本质\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x07-orm-的本质\"\u003e#\u003c/a\u003e 0x07 ORM 的本质\u003c/h2\u003e\n\u003cp\u003eORM 的本质是 Data Access Layer 上的一层封装。如果你写原生 SQL, 即手写 DAL 的话，开发效率可能会大打折扣。\u003c/p\u003e\n\u003ch3 id=\"orm-的两种类型-active-record-与-data-mappers\"\u003e\u003ca class=\"v-toc-item\" href=\"#orm-的两种类型-active-record-与-data-mappers\"\u003e#\u003c/a\u003e ORM 的两种类型 Active Record 与 Data Mappers\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e# ActiveRecord 风格写起来类似于 Django ORM, 大致是这样的\n\n## AR 的模型定义\n\nclass User(db.models):\n    name = db.StringField(verbose=\u0026quot;xyz\u0026quot;)\n\n## AR 的新增\nuser = User()\nuser.name = \u0026quot;123456\u0026quot;\nuser.save() ## 正好对应数据库中的一行\n\n## AR 的查询\n\nusers = User.objects.filter(Q(name=\u0026quot;黄老板的小姨子\u0026quot;)).all()\n\n# Data Mappers 风格写起来类似于 SQLAlchemy ORM, 大致是这样的\n\n## SA 的定义\n\nfrom sqlalchemy.ext.declarative import declarative_base\n\nBase = declarative_base()\n\nfrom sqlalchemy import Column, Integer, String\nclass User(Base):\n    __tablename__ = 'users'\n\n    id = Column(Integer, primary_key=True)\n    name = Column(String)\n\nBase.metadata.create_all(engine)\n\n## SA 的新增\n\nuser = User()\nuser.name = \u0026quot;123456\u0026quot;\nsession.add(user)\nsessoon.commit() ## 嗯？其实也是对应数据库中的一行。\n\n## SA 的查询\n\nsession.query(User).filter(User.name)\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e问题来了，这两者到底是什么，看起来似乎相差不大。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eclass Person:\n\n    lastname\n    firstname\n    children\n\n    # 数据操作\n    def findone(self):\n        pass\n\n    def insert(self):\n        pass\n\n    def update(self):\n        pass\n\n    def delete(self):\n        pass\n\n    # 业务逻辑\n    def getChildrenTax(self):\n        pass\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003elastName firstName numberOfDependents\u003c/p\u003e\n\u003cp\u003einsert update delete\u003c/p\u003e\n\u003cp\u003egetExemption isFlaggedForAudit getTaxableEarnings\u003c/p\u003e\n\u003cp\u003eAn object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.\u003c/p\u003e\n\u003cp\u003eThe essence of an Active Record is a Domain Model (116) in which the classes match very closely the record structure of an underlying database. Each Active Record is responsible for saving and loading to the database and also for any domain logic that acts on the data. This may be all the domain logic in the application, or you may ﬁnd that some domain logic is held in Transaction Scripts (110) with common and data-oriented code in the Active Record.\u003c/p\u003e\n\u003cp\u003eThe data structure of the Active Record should exactly match that of the database: one ﬁeld in the class for each column in the table. Type the ﬁelds the way the SQL interface gives you the data—don’t do any conversion at this stage. You may consider Foreign Key Mapping (236), but you may also leave the foreign keys as they are. You can use views or tables with Active Record, although updates through views are obviously harder. Views are particularly useful for reporting purposes.\u003c/p\u003e\n\u003cp\u003eobjects correspond directly to the database tables: an isomorphic schema. If your business logic is complex, you’ll soon want to use your object’s direct relationships, collections, inheritance, and so forth. These don’t map easily onto Active Record, and adding them piecemeal gets very messy. That’s what will lead you to use Data Mapper (165) instead.\u003c/p\u003e\n\u003cp\u003eAnother argument against Active Record is the fact that it couples the object design to the database design. This makes it more difﬁcult to refactor either design as a project goes forward.\u003c/p\u003e\n\u003cp\u003eActive Record is a good pattern to consider if you’re using Transaction Script (110) and are beginning to feel the pain of code duplication and the difﬁculty in updating scripts and tables that Transaction Script (110) often brings. In this case you can gradually start creating Active Records and then slowly refactor behavior into them. It often helps to wrap the tables as a Gateway (466) ﬁrst, and then start moving behavior so that the tables evolve to a Active Record.\u003c/p\u003e\n\u003cp\u003e其实为什么不选择设计成 ActiveRecord , 而是选择设计成 Data Mapper, 其实就可以回答这个问题：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e虽然要设计成 ORM, 考虑到数量和性能因素，SQL 数据库（多个表）并不应该是表现像 Object 集合那样（换言之，也就是 AR 表现的像 Object 的集合一样）。\u003cbr\u003e\n同时，出于更好的抽象，object 集合也应该表现的像表以及行\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e于是我们可以得出结论，可以在 SQLAlchemy 上面进行一定的封装，使得最后用起来非常的 Django ORM like，其实 SQLAlchemy 稍加定制还是可以很 Django ORM-like 的。\u003c/p\u003e\n\u003cp\u003e:TODO: 有机会看看那本书再修改一下本小节\u003c/p\u003e\n\u003cp\u003e这不，果然有人就这么搞了 \u003ca href=\"https://github.com/absent1706/sqlalchemy-mixins\"\u003ehttps://github.com/absent1706/sqlalchemy-mixins\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"0x09-踩坑集\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x09-踩坑集\"\u003e#\u003c/a\u003e 0x09 踩坑集\u003c/h2\u003e\n\u003ch3 id=\"关系持久化坑\"\u003e\u003ca class=\"v-toc-item\" href=\"#关系持久化坑\"\u003e#\u003c/a\u003e 关系持久化坑\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRows that point to themselves : 比如一个 insert 一个推荐自己的用户，则需要保存 id / ref_id , 但是在这个 user 插入之前，并不存在 id. 所以，一般情况下是先 insert, 然后保存 ref_id\u003c/li\u003e\n\u003cli\u003eMutually Dependent Rows\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"sql-注入\"\u003e\u003ca class=\"v-toc-item\" href=\"#sql-注入\"\u003e#\u003c/a\u003e SQL 注入\u003c/h3\u003e\n\u003cp\u003esession.query(MyClass).filter(“foo={}”.format(getArgs[‘val’]))\u003c/p\u003e\n\u003ch2 id=\"0xee-参考链接\"\u003e\u003ca class=\"v-toc-item\" href=\"#0xee-参考链接\"\u003e#\u003c/a\u003e 0xEE 参考链接\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/\"\u003ehttps://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create\"\u003ehttps://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e除了文档本身，作者在 Stack Overflow 上的回答都是非常值得阅读的。\u003ca href=\"https://stackoverflow.com/users/34549/zzzeek\"\u003ehttps://stackoverflow.com/users/34549/zzzeek\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePatterns of Enterprise Application Architecture - Martin Fowler\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"http://aosabook.org/en/sqlalchemy.html\"\u003ehttp://aosabook.org/en/sqlalchemy.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://techspot.zzzeek.org/\"\u003ehttp://techspot.zzzeek.org/\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eChangeLog:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e2018-03-09\u003c/strong\u003e 重修文字\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93\"\u003e0x01 如何访问数据库\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%90%86%E8%AE%BA\"\u003e0x02 数据库抽象的两种理论\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E7%90%86%E8%AE%BA%E4%B8%80active-record\"\u003e理论一：Active Record\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%90%86%E8%AE%BA%E4%BA%8Cdata-mapper\"\u003e理论二：Data Mapper\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0\"\u003e0x03 数据库抽象的两种实现\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%AE%9E%E7%8E%B0%E4%B8%80django-orm\"\u003e实现一：Django ORM\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%AE%9E%E7%8E%B0%E4%BA%8Csqlalchemy\"\u003e实现二：Sqlalchemy\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%BA%E5%BC%B1\"\u003e0x04 工具的强弱\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#20-sqlalchemy-vs-djangoorm\"\u003e2.0 SQLAlchemy VS DjangoORM\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#21-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89\"\u003e2.1 模型定义\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#models-%E4%B8%8E-meta\"\u003eModels 与 Meta\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%B3%E7%B3%BB\"\u003e关系\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#one-to-many\"\u003eOne To Many\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#many-to-one\"\u003eMany To One\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#one-to-one\"\u003eOne To One\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#many-to-many\"\u003eMany To Many\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%82%BB%E6%8E%A5%E5%88%97%E8%A1%A8%E5%85%B3%E7%B3%BB\"\u003e邻接列表关系\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#relationship-%E8%AF%A6%E8%A7%A3\"\u003erelationship 详解\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#21-query\"\u003e2.1 Query\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#create\"\u003eCreate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#retrieve\"\u003eRetrieve\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E8%B7%A8%E5%85%B3%E7%B3%BB%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2\"\u003e跨关系（跨表）查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#limit-offset-%E5%88%86%E9%A1%B5\"\u003eLimit / Offset / 分页\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8\"\u003e链式调用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E4%BA%8C%E8%BF%9B%E5%88%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F\"\u003e二进制表达式\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2\"\u003e执行查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%AF%94%E8%BE%83\"\u003e比较\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A4%8D%E5%88%B6-%E5%AE%9E%E4%BE%8B\"\u003e复制 实例\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%B6%E4%BB%96\"\u003e其他\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#update\"\u003eUpdate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#delete\"\u003eDelete\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#join\"\u003eJOIN\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E4%B8%A4%E8%A1%A8-innerjoin\"\u003e两表 InnerJoin\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A4%9A%E8%A1%A8-innerjoin-leftjoin\"\u003e多表 InnerJoin + LeftJoin\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%81%9A%E9%9B%86%E6%9F%A5%E8%AF%A2\"\u003e聚集查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6\"\u003e缓存机制\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#22-%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2\"\u003e2.2 原生查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#23-%E6%9B%B4%E6%96%B0%E6%9F%A5%E8%AF%A2\"\u003e2.3 更新查询\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#24-%E5%88%A0%E9%99%A4\"\u003e2.4 删除\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#ondelete\"\u003eOnDelete\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C\"\u003e批量操作\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A6%82%E4%BD%95%E4%BB%8E-object-%E5%88%B0%E4%B8%80%E4%B8%AA-orm\"\u003e如何从 Object 到一个 ORM\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-sqlalchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7\"\u003e0x03 SQLAlchemy 的高级特性\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E8%A1%A8%E7%BB%A7%E6%89%BF\"\u003e表继承\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%95%A5%E7%8E%A9%E6%84%8F\"\u003e啥玩意\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-sqlalchemy-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7-under-the-hood\"\u003e0x04 SQLAlchemy 的基础特性 Under The Hood\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#loading-%E7%AD%96%E7%95%A5\"\u003eLoading 策略\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#lazy-loading\"\u003eLazy Loading\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#eager-loading\"\u003eEager Loading\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x05-sqlalchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7-under-the-hood\"\u003e0x05 SQLAlchemy 的高级特性 Under The Hood\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A4%9A%E7%BA%BF%E7%A8%8B\"\u003e多线程\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x06-debug-%E5%92%8C-profile-%E6%8A%80%E5%B7%A7\"\u003e0x06 DEBUG 和 Profile 技巧\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#61-%E6%9F%A5%E7%9C%8B%E6%8A%80%E5%B7%A7\"\u003e6.1 查看技巧\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x07-orm-%E7%9A%84%E6%9C%AC%E8%B4%A8\"\u003e0x07 ORM 的本质\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#orm-%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B-active-record-%E4%B8%8E-data-mappers\"\u003eORM 的两种类型 Active Record 与 Data Mappers\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x09-%E8%B8%A9%E5%9D%91%E9%9B%86\"\u003e0x09 踩坑集\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%B3%E7%B3%BB%E6%8C%81%E4%B9%85%E5%8C%96%E5%9D%91\"\u003e关系持久化坑\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#sql-%E6%B3%A8%E5%85%A5\"\u003eSQL 注入\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0xee-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"\u003e0xEE 参考链接\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"Python ORM"},"buildId":"uCwe9m-iio9bnoWMgWDqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>