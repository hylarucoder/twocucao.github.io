<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Python Profiling/Tracing Tools | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_buildManifest.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><ul>
<li>Profiling 定位与优化耗时、内存使用、CPU 使用</li>
<li>Tracing 用于追踪内存布局</li>
</ul>
<h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>本篇讨论的是优化</p>
<p>当我们在谈优化的的时候，首先要背诵下面三个口诀</p>
<pre><code>优化口诀 1: 先做对，布监控，再做好。
优化口诀 2: 过早优化是万恶之源。
优化口诀 3: 去优化那些需要优化的地方。
</code></pre>
<p>可以参考之前的文章 <a href="https://zhuanlan.zhihu.com/p/58754459">https://zhuanlan.zhihu.com/p/58754459</a></p>
<p>本文讨论的是基于现有代码的诊断。也顺带讨论了无侵入线上 trace 的原理和技巧</p>
<p>优化分为两种：</p>
<ol>
<li>侵入性诊断</li>
<li>侵入性诊断</li>
</ol>
<h2 id="0x01-侵入性诊断"><a class="v-toc-item" href="#0x01-侵入性诊断">#</a> 0x01 侵入性诊断</h2>
<h3 id="基础工具"><a class="v-toc-item" href="#基础工具">#</a> 基础工具</h3>
<ul>
<li>print</li>
<li>logging</li>
<li>timeit</li>
</ul>
<h3 id="profile-vs-cprofile"><a class="v-toc-item" href="#profile-vs-cprofile">#</a> Profile vs cProfile</h3>
<p>cProfile overhead 较高，</p>
<pre><code class="language-python"><span class="token keyword">import</span> cProfile
<span class="token keyword">import</span> re
cProfile<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'re.compile("foo|bar")'</span><span class="token punctuation">)</span>

   <span class="token number">197</span> <span class="token keyword">function</span> <span class="token function">calls</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token number">192</span> primitive calls</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0.002</span> seconds

Ordered by<span class="token operator">:</span> standard name

ncalls  tottime  percall  cumtime  percall filename<span class="token operator">:</span><span class="token function">lineno</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">)</span>
     <span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.001</span>    <span class="token number">0.001</span> <span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">)</span>
     <span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.001</span>    <span class="token number">0.001</span> re<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">212</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>
     <span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.001</span>    <span class="token number">0.001</span> re<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">268</span><span class="token punctuation">(</span>_compile<span class="token punctuation">)</span>
     <span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span> sre_compile<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">172</span><span class="token punctuation">(</span>_compile_charset<span class="token punctuation">)</span>
     <span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span> sre_compile<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">201</span><span class="token punctuation">(</span>_optimize_charset<span class="token punctuation">)</span>
     <span class="token number">4</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span> sre_compile<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">(</span>_identityfunction<span class="token punctuation">)</span>
   <span class="token number">3</span><span class="token operator">/</span><span class="token number">1</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span>    <span class="token number">0.000</span> sre_compile<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">(</span>_compile<span class="token punctuation">)</span>
</code></pre>
<h3 id="speedscope"><a class="v-toc-item" href="#speedscope">#</a> SpeedScope</h3>
<ul>
<li>speedscope</li>
<li>pyspeedscope</li>
</ul>
<h3 id="pyinstrument"><a class="v-toc-item" href="#pyinstrument">#</a> PyInstrument</h3>
<ul>
<li><a href="https://github.com/joerick/pyinstrument">https://github.com/joerick/pyinstrument</a></li>
<li><a href="https://github.com/joerick/pyinstrument_cext">https://github.com/joerick/pyinstrument_cext</a></li>
</ul>
<h3 id="line-profiler"><a class="v-toc-item" href="#line-profiler">#</a> Line Profiler</h3>
<p><a href="https://github.com/pyutils/line_profiler">https://github.com/pyutils/line_profiler</a></p>
<pre><code class="language-bash"><span class="token function">Pystone</span><span class="token punctuation">(</span><span class="token number">1.1</span><span class="token punctuation">)</span> time <span class="token keyword">for</span> <span class="token number">50000</span> passes <span class="token operator">=</span> <span class="token number">2.48</span>
This machine benchmarks at <span class="token number">20161.3</span> pystones<span class="token operator">/</span>second
Wrote profile results to pystone<span class="token punctuation">.</span>py<span class="token punctuation">.</span>lprof
Timer unit<span class="token operator">:</span> <span class="token number">1e-06</span> s

File<span class="token operator">:</span> pystone<span class="token punctuation">.</span>py
Function<span class="token operator">:</span> Proc2 at line <span class="token number">149</span>
Total time<span class="token operator">:</span> <span class="token number">0.606656</span> s

Line #      Hits         Time  Per Hit   <span class="token operator">%</span> Time  Line Contents
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">==</span>
   <span class="token number">149</span>                                           @profile
   <span class="token number">150</span>                                           def <span class="token function">Proc2</span><span class="token punctuation">(</span>IntParIO<span class="token punctuation">)</span><span class="token operator">:</span>
   <span class="token number">151</span>     <span class="token number">50000</span>        <span class="token number">82003</span>      <span class="token number">1.6</span>     <span class="token number">13.5</span>      IntLoc <span class="token operator">=</span> IntParIO <span class="token operator">+</span> <span class="token number">10</span>
   <span class="token number">152</span>     <span class="token number">50000</span>        <span class="token number">63162</span>      <span class="token number">1.3</span>     <span class="token number">10.4</span>      <span class="token keyword">while</span> <span class="token number">1</span><span class="token operator">:</span>
   <span class="token number">153</span>     <span class="token number">50000</span>        <span class="token number">69065</span>      <span class="token number">1.4</span>     <span class="token number">11.4</span>          <span class="token keyword">if</span> Char1Glob <span class="token operator">==</span> <span class="token string">'A'</span><span class="token operator">:</span>
   <span class="token number">154</span>     <span class="token number">50000</span>        <span class="token number">66354</span>      <span class="token number">1.3</span>     <span class="token number">10.9</span>              IntLoc <span class="token operator">=</span> IntLoc <span class="token operator">-</span> <span class="token number">1</span>
   <span class="token number">155</span>     <span class="token number">50000</span>        <span class="token number">67263</span>      <span class="token number">1.3</span>     <span class="token number">11.1</span>              IntParIO <span class="token operator">=</span> IntLoc <span class="token operator">-</span> IntGlob
   <span class="token number">156</span>     <span class="token number">50000</span>        <span class="token number">65494</span>      <span class="token number">1.3</span>     <span class="token number">10.8</span>              EnumLoc <span class="token operator">=</span> Ident1
   <span class="token number">157</span>     <span class="token number">50000</span>        <span class="token number">68001</span>      <span class="token number">1.4</span>     <span class="token number">11.2</span>          <span class="token keyword">if</span> EnumLoc <span class="token operator">==</span> Ident1<span class="token operator">:</span>
   <span class="token number">158</span>     <span class="token number">50000</span>        <span class="token number">63739</span>      <span class="token number">1.3</span>     <span class="token number">10.5</span>              <span class="token keyword">break</span>
   <span class="token number">159</span>     <span class="token number">50000</span>        <span class="token number">61575</span>      <span class="token number">1.2</span>     <span class="token number">10.1</span>      <span class="token keyword">return</span> IntParIO
</code></pre>
<h3 id="其他侵入性-profiling-方案"><a class="v-toc-item" href="#其他侵入性-profiling-方案">#</a> 其他侵入性 Profiling 方案</h3>
<ul>
<li><a href="https://github.com/vmprof/vmprof-python">https://github.com/vmprof/vmprof-python</a></li>
<li><a href="https://github.com/bdarnell/plop">https://github.com/bdarnell/plop</a></li>
</ul>
<h3 id="overhead-基数"><a class="v-toc-item" href="#overhead-基数">#</a> Overhead 基数</h3>
<p>Django template render × 4000</p>
<ul>
<li>Base 0.33s</li>
<li>pyinstrument 0.43s 30%</li>
<li>cProfile 0.61s 84%</li>
<li>profile 6.79s 2057%</li>
</ul>
<h3 id="内存布局"><a class="v-toc-item" href="#内存布局">#</a> 内存布局</h3>
<ul>
<li>memory profiler 检查内存消耗</li>
<li>pympler 快照未 GC 的对象</li>
</ul>
<blockquote>
<p>TODO: python 有无侵入检查内存布局的工具么？</p>
</blockquote>
<h2 id="0x02-无侵入诊断"><a class="v-toc-item" href="#0x02-无侵入诊断">#</a> 0x02 无侵入诊断</h2>
<p>以上的代码都是侵入代码，Java 生态中存在着一些黑科技。可以在线打断点。</p>
<p><a href="https://github.com/qunarcorp/bistoury/blob/master/docs/cn/debug.md">https://github.com/qunarcorp/bistoury/blob/master/docs/cn/debug.md</a></p>
<p>从而实现无侵入在线 tracing 代码，可以理解为一个无需 reload 代码即可实现的热插拔 logging</p>
<p>Python 世界里存在 2 个这样的工具</p>
<h3 id="pyflame"><a class="v-toc-item" href="#pyflame">#</a> pyflame</h3>
<ul>
<li><a href="https://github.com/uber-archive/pyflame">https://github.com/uber-archive/pyflame</a></li>
</ul>
<p>原理</p>
<ul>
<li><a href="https://man7.org/linux/man-pages/man2/ptrace.2.html">https://man7.org/linux/man-pages/man2/ptrace.2.html</a></li>
</ul>
<h3 id="py-spy"><a class="v-toc-item" href="#py-spy">#</a> py-spy</h3>
<ul>
<li><a href="https://github.com/benfred/py-spy">https://github.com/benfred/py-spy</a></li>
</ul>
<p>直接读取 python 程序的内存信息</p>
<ul>
<li>Linux <a href="https://man7.org/linux/man-pages/man2/process_vm_readv.2.html">https://man7.org/linux/man-pages/man2/process_vm_readv.2.html</a></li>
<li>macOS <a href="https://developer.apple.com/documentation/kernel/1585350-vm_read?language=objc">https://developer.apple.com/documentation/kernel/1585350-vm_read?language=objc</a></li>
<li>Windows <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx</a></li>
</ul>
<h2 id="0x03-其他利器"><a class="v-toc-item" href="#0x03-其他利器">#</a> 0x03 其他利器</h2>
<h3 id="django-debug-toolbar"><a class="v-toc-item" href="#django-debug-toolbar">#</a> Django Debug Toolbar</h3>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E4%BE%B5%E5%85%A5%E6%80%A7%E8%AF%8A%E6%96%AD">0x01 侵入性诊断</a>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7">基础工具</a></li>
<li><a href="#profile-vs-cprofile">Profile vs cProfile</a></li>
<li><a href="#speedscope">SpeedScope</a></li>
<li><a href="#pyinstrument">PyInstrument</a></li>
<li><a href="#line-profiler">Line Profiler</a></li>
<li><a href="#%E5%85%B6%E4%BB%96%E4%BE%B5%E5%85%A5%E6%80%A7-profiling-%E6%96%B9%E6%A1%88">其他侵入性 Profiling 方案</a></li>
<li><a href="#overhead-%E5%9F%BA%E6%95%B0">Overhead 基数</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">内存布局</a></li>
</ul>
</li>
<li><a href="#0x02-%E6%97%A0%E4%BE%B5%E5%85%A5%E8%AF%8A%E6%96%AD">0x02 无侵入诊断</a>
<ul>
<li><a href="#pyflame">pyflame</a></li>
<li><a href="#py-spy">py-spy</a></li>
</ul>
</li>
<li><a href="#0x03-%E5%85%B6%E4%BB%96%E5%88%A9%E5%99%A8">0x03 其他利器</a>
<ul>
<li><a href="#django-debug-toolbar">Django Debug Toolbar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["Python","性能优化"],"path":"20201201_PythonProfiling.md","title":"Python Profiling/Tracing Tools","slug":"Python Profiling/Tracing Tools","date":"2020-11-30","category":"Python","lastMod":"2020-12-01","description":"未描述","thumbnail":"","content":"\u003cul\u003e\n\u003cli\u003eProfiling 定位与优化耗时、内存使用、CPU 使用\u003c/li\u003e\n\u003cli\u003eTracing 用于追踪内存布局\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e本篇讨论的是优化\u003c/p\u003e\n\u003cp\u003e当我们在谈优化的的时候，首先要背诵下面三个口诀\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e优化口诀 1: 先做对，布监控，再做好。\n优化口诀 2: 过早优化是万恶之源。\n优化口诀 3: 去优化那些需要优化的地方。\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e可以参考之前的文章 \u003ca href=\"https://zhuanlan.zhihu.com/p/58754459\"\u003ehttps://zhuanlan.zhihu.com/p/58754459\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e本文讨论的是基于现有代码的诊断。也顺带讨论了无侵入线上 trace 的原理和技巧\u003c/p\u003e\n\u003cp\u003e优化分为两种：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e侵入性诊断\u003c/li\u003e\n\u003cli\u003e侵入性诊断\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"0x01-侵入性诊断\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-侵入性诊断\"\u003e#\u003c/a\u003e 0x01 侵入性诊断\u003c/h2\u003e\n\u003ch3 id=\"基础工具\"\u003e\u003ca class=\"v-toc-item\" href=\"#基础工具\"\u003e#\u003c/a\u003e 基础工具\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eprint\u003c/li\u003e\n\u003cli\u003elogging\u003c/li\u003e\n\u003cli\u003etimeit\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"profile-vs-cprofile\"\u003e\u003ca class=\"v-toc-item\" href=\"#profile-vs-cprofile\"\u003e#\u003c/a\u003e Profile vs cProfile\u003c/h3\u003e\n\u003cp\u003ecProfile overhead 较高，\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e cProfile\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e re\ncProfile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e're.compile(\"foo|bar\")'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n   \u003cspan class=\"token number\"\u003e197\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ecalls\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token number\"\u003e192\u003c/span\u003e primitive calls\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.002\u003c/span\u003e seconds\n\nOrdered by\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e standard name\n\nncalls  tottime  percall  cumtime  percall filename\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elineno\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003estring\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003emodule\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e re\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e212\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecompile\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.001\u003c/span\u003e re\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e268\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_compile\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e sre_compile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e172\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_compile_charset\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e sre_compile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e201\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_optimize_charset\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"token number\"\u003e4\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e sre_compile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e25\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_identityfunction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e    \u003cspan class=\"token number\"\u003e0.000\u003c/span\u003e sre_compile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e33\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_compile\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"speedscope\"\u003e\u003ca class=\"v-toc-item\" href=\"#speedscope\"\u003e#\u003c/a\u003e SpeedScope\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003espeedscope\u003c/li\u003e\n\u003cli\u003epyspeedscope\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"pyinstrument\"\u003e\u003ca class=\"v-toc-item\" href=\"#pyinstrument\"\u003e#\u003c/a\u003e PyInstrument\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/joerick/pyinstrument\"\u003ehttps://github.com/joerick/pyinstrument\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/joerick/pyinstrument_cext\"\u003ehttps://github.com/joerick/pyinstrument_cext\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"line-profiler\"\u003e\u003ca class=\"v-toc-item\" href=\"#line-profiler\"\u003e#\u003c/a\u003e Line Profiler\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/pyutils/line_profiler\"\u003ehttps://github.com/pyutils/line_profiler\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003ePystone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1.1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e time \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e passes \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2.48\u003c/span\u003e\nThis machine benchmarks at \u003cspan class=\"token number\"\u003e20161.3\u003c/span\u003e pystones\u003cspan class=\"token operator\"\u003e/\u003c/span\u003esecond\nWrote profile results to pystone\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elprof\nTimer unit\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1e-06\u003c/span\u003e s\n\nFile\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e pystone\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy\nFunction\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Proc2 at line \u003cspan class=\"token number\"\u003e149\u003c/span\u003e\nTotal time\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.606656\u003c/span\u003e s\n\nLine #      Hits         Time  Per Hit   \u003cspan class=\"token operator\"\u003e%\u003c/span\u003e Time  Line Contents\n\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e===\u003c/span\u003e\u003cspan class=\"token operator\"\u003e==\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e149\u003c/span\u003e                                           @profile\n   \u003cspan class=\"token number\"\u003e150\u003c/span\u003e                                           def \u003cspan class=\"token function\"\u003eProc2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eIntParIO\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e151\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e82003\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.6\u003c/span\u003e     \u003cspan class=\"token number\"\u003e13.5\u003c/span\u003e      IntLoc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e IntParIO \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e152\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e63162\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.3\u003c/span\u003e     \u003cspan class=\"token number\"\u003e10.4\u003c/span\u003e      \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e153\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e69065\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.4\u003c/span\u003e     \u003cspan class=\"token number\"\u003e11.4\u003c/span\u003e          \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e Char1Glob \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'A'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e154\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e66354\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.3\u003c/span\u003e     \u003cspan class=\"token number\"\u003e10.9\u003c/span\u003e              IntLoc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e IntLoc \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e155\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e67263\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.3\u003c/span\u003e     \u003cspan class=\"token number\"\u003e11.1\u003c/span\u003e              IntParIO \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e IntLoc \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e IntGlob\n   \u003cspan class=\"token number\"\u003e156\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e65494\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.3\u003c/span\u003e     \u003cspan class=\"token number\"\u003e10.8\u003c/span\u003e              EnumLoc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Ident1\n   \u003cspan class=\"token number\"\u003e157\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e68001\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.4\u003c/span\u003e     \u003cspan class=\"token number\"\u003e11.2\u003c/span\u003e          \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e EnumLoc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e Ident1\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e158\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e63739\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.3\u003c/span\u003e     \u003cspan class=\"token number\"\u003e10.5\u003c/span\u003e              \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n   \u003cspan class=\"token number\"\u003e159\u003c/span\u003e     \u003cspan class=\"token number\"\u003e50000\u003c/span\u003e        \u003cspan class=\"token number\"\u003e61575\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1.2\u003c/span\u003e     \u003cspan class=\"token number\"\u003e10.1\u003c/span\u003e      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e IntParIO\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"其他侵入性-profiling-方案\"\u003e\u003ca class=\"v-toc-item\" href=\"#其他侵入性-profiling-方案\"\u003e#\u003c/a\u003e 其他侵入性 Profiling 方案\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/vmprof/vmprof-python\"\u003ehttps://github.com/vmprof/vmprof-python\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/bdarnell/plop\"\u003ehttps://github.com/bdarnell/plop\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"overhead-基数\"\u003e\u003ca class=\"v-toc-item\" href=\"#overhead-基数\"\u003e#\u003c/a\u003e Overhead 基数\u003c/h3\u003e\n\u003cp\u003eDjango template render × 4000\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBase 0.33s\u003c/li\u003e\n\u003cli\u003epyinstrument 0.43s 30%\u003c/li\u003e\n\u003cli\u003ecProfile 0.61s 84%\u003c/li\u003e\n\u003cli\u003eprofile 6.79s 2057%\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"内存布局\"\u003e\u003ca class=\"v-toc-item\" href=\"#内存布局\"\u003e#\u003c/a\u003e 内存布局\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ememory profiler 检查内存消耗\u003c/li\u003e\n\u003cli\u003epympler 快照未 GC 的对象\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTODO: python 有无侵入检查内存布局的工具么？\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"0x02-无侵入诊断\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-无侵入诊断\"\u003e#\u003c/a\u003e 0x02 无侵入诊断\u003c/h2\u003e\n\u003cp\u003e以上的代码都是侵入代码，Java 生态中存在着一些黑科技。可以在线打断点。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/qunarcorp/bistoury/blob/master/docs/cn/debug.md\"\u003ehttps://github.com/qunarcorp/bistoury/blob/master/docs/cn/debug.md\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e从而实现无侵入在线 tracing 代码，可以理解为一个无需 reload 代码即可实现的热插拔 logging\u003c/p\u003e\n\u003cp\u003ePython 世界里存在 2 个这样的工具\u003c/p\u003e\n\u003ch3 id=\"pyflame\"\u003e\u003ca class=\"v-toc-item\" href=\"#pyflame\"\u003e#\u003c/a\u003e pyflame\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/uber-archive/pyflame\"\u003ehttps://github.com/uber-archive/pyflame\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e原理\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://man7.org/linux/man-pages/man2/ptrace.2.html\"\u003ehttps://man7.org/linux/man-pages/man2/ptrace.2.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"py-spy\"\u003e\u003ca class=\"v-toc-item\" href=\"#py-spy\"\u003e#\u003c/a\u003e py-spy\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/benfred/py-spy\"\u003ehttps://github.com/benfred/py-spy\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e直接读取 python 程序的内存信息\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLinux \u003ca href=\"https://man7.org/linux/man-pages/man2/process_vm_readv.2.html\"\u003ehttps://man7.org/linux/man-pages/man2/process_vm_readv.2.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003emacOS \u003ca href=\"https://developer.apple.com/documentation/kernel/1585350-vm_read?language=objc\"\u003ehttps://developer.apple.com/documentation/kernel/1585350-vm_read?language=objc\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWindows \u003ca href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx\"\u003ehttps://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"0x03-其他利器\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-其他利器\"\u003e#\u003c/a\u003e 0x03 其他利器\u003c/h2\u003e\n\u003ch3 id=\"django-debug-toolbar\"\u003e\u003ca class=\"v-toc-item\" href=\"#django-debug-toolbar\"\u003e#\u003c/a\u003e Django Debug Toolbar\u003c/h3\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E4%BE%B5%E5%85%A5%E6%80%A7%E8%AF%8A%E6%96%AD\"\u003e0x01 侵入性诊断\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7\"\u003e基础工具\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#profile-vs-cprofile\"\u003eProfile vs cProfile\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#speedscope\"\u003eSpeedScope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pyinstrument\"\u003ePyInstrument\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#line-profiler\"\u003eLine Profiler\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%85%B6%E4%BB%96%E4%BE%B5%E5%85%A5%E6%80%A7-profiling-%E6%96%B9%E6%A1%88\"\u003e其他侵入性 Profiling 方案\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#overhead-%E5%9F%BA%E6%95%B0\"\u003eOverhead 基数\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80\"\u003e内存布局\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-%E6%97%A0%E4%BE%B5%E5%85%A5%E8%AF%8A%E6%96%AD\"\u003e0x02 无侵入诊断\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#pyflame\"\u003epyflame\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#py-spy\"\u003epy-spy\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-%E5%85%B6%E4%BB%96%E5%88%A9%E5%99%A8\"\u003e0x03 其他利器\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#django-debug-toolbar\"\u003eDjango Debug Toolbar\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"Python Profiling/Tracing Tools"},"buildId":"uCwe9m-iio9bnoWMgWDqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>