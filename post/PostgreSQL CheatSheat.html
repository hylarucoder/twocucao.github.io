<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>PostgreSQL CheatSheat | 海拉鲁编程客</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/49455a07b6dd33600cdf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/49455a07b6dd33600cdf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-20d43e08bea62467b090.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3050679c6e5142ffcaf5.js" defer=""></script><script src="/_next/static/chunks/ea88be26-9bcf6ead520f4ac26973.js" defer=""></script><script src="/_next/static/chunks/421-f2f33a86b546237f0325.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-173fe2de48c90365db9d.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_buildManifest.js" defer=""></script><script src="/_next/static/uCwe9m-iio9bnoWMgWDqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="v-page"><nav class="shadow"><div class="flex flex-col container mx-auto h-12 px-40 md:flex-row md:items-center md:justify-between"><div class="flex justify-between items-center"><div><a class="text-gray-800 text-xl md:text-xl leading-5" href="/">海拉鲁编程客</a></div><div><button type="button" class="block text-gray-800 hover:text-gray-600 focus:text-gray-600 focus:outline-none md:hidden"><svg viewBox="0 0 24 24" class="h-6 w-6 fill-current"><path d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path></svg></button></div></div><div class="md:flex flex-col md:flex-row md:-mx-4 hidden"><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/">首页</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/archive">归档</a><a class="my-1 text-gray-800 hover:text-blue-500 md:mx-4 md:my-0" href="/about">关于我</a><button style="cursor:pointer;overflow:hidden;width:50px;height:23.5px;appearance:none;-moz-appearance:none;-webkit-appearance:none;border:none;background-color:transparent;padding:0" aria-hidden="true"><div style="display:flex;align-items:center;justify-content:center;margin-top:-28.749999999999996px;margin-left:-16px;width:82.5px;height:82.5px"><div></div></div></button></div></div></nav><div class="v-article"><div class="v-article-main" style="margin:auto;width:786px"><div><h2 id="0x00-前言"><a class="v-toc-item" href="#0x00-前言">#</a> 0x00 前言</h2>
<p>本文为 Cheatsheet 类型文章，用于记录我在日常编程中经常使用的 PostgreSQL 相关和命令。</p>
<p>PostGIS 相关的资料参考文章 <a href="/2016/10/05/UbuntuCheatsheet/">Geo Processing With Python</a></p>
<ul>
<li>安装与基本配置</li>
<li>PostgreSQL 配套工具</li>
<li>PostgreSQL SQL 常用代码片段</li>
<li>Python Driver : psycopg2 , 与两个 ORM ( Django ORM / SQLAlchemy )</li>
</ul>
<p>不定期更新。</p>
<!-- more -->
<h2 id="0x01-安装配置基本-shell-命令"><a class="v-toc-item" href="#0x01-安装配置基本-shell-命令">#</a> 0x01 安装，配置，基本 shell 命令</h2>
<h3 id="安装"><a class="v-toc-item" href="#安装">#</a> 安装</h3>
<h3 id="配置"><a class="v-toc-item" href="#配置">#</a> 配置</h3>
<h3 id="基本-shell-命令"><a class="v-toc-item" href="#基本-shell-命令">#</a> 基本 Shell 命令</h3>
<pre><code># 开启关闭
pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start
pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log stop
pg_ctl -D /usr/local/var/postgres start
pg_ctl -D /usr/local/var/postgres stop -s -m fast
</code></pre>
<h3 id="数据的导入导出"><a class="v-toc-item" href="#数据的导入导出">#</a> 数据的导入导出</h3>
<pre><code class="language-bash">pg_dump <span class="token operator">-</span><span class="token constant">C</span> <span class="token operator">-</span>Fp <span class="token operator">-</span>f dump<span class="token punctuation">.</span>sql <span class="token operator">-</span><span class="token constant">U</span> twocucao <span class="token constant">QCS</span> <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.2</span><span class="token number">.175</span>
pg_dump <span class="token operator">-</span><span class="token constant">C</span> <span class="token operator">-</span>Fp <span class="token operator">-</span>f <span class="token number">20160602</span><span class="token operator">-</span><span class="token number">150144</span><span class="token operator">-</span>dump<span class="token punctuation">.</span>sql <span class="token operator">-</span><span class="token constant">U</span> twocucao <span class="token constant">QCS</span> <span class="token operator">--</span>column<span class="token operator">-</span>inserts <span class="token operator">--</span>data<span class="token operator">-</span>only <span class="token operator">--</span>table<span class="token operator">=</span>users_table <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.2</span><span class="token number">.175</span>
# 插入数据
psql <span class="token operator">-</span><span class="token constant">U</span> twocucao <span class="token operator">-</span>d <span class="token constant">QCS</span> <span class="token operator">-</span>a <span class="token operator">-</span>f insert_doc_ids<span class="token punctuation">.</span>sql <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.2</span><span class="token number">.175</span>
pg_restore <span class="token operator">--</span>verbose <span class="token operator">--</span>clean <span class="token operator">--</span>no<span class="token operator">-</span>acl <span class="token operator">--</span>no<span class="token operator">-</span>owner <span class="token operator">-</span>h localhost example<span class="token punctuation">.</span>dump
</code></pre>
<h2 id="0x02-postgresql-配套工具"><a class="v-toc-item" href="#0x02-postgresql-配套工具">#</a> 0x02 PostgreSQL 配套工具</h2>
<ul>
<li>JetBrain 的 Datagrip 作为 编写大段 SQL 语句的 IDE</li>
<li>通过网络或者 Dash 查看文档</li>
<li>PostgreSQL 官方自带工具</li>
</ul>
<h2 id="0x03-postgresql-sql-常用代码"><a class="v-toc-item" href="#0x03-postgresql-sql-常用代码">#</a> 0x03 PostgreSQL SQL 常用代码</h2>
<h3 id="31-postgresql-相关"><a class="v-toc-item" href="#31-postgresql-相关">#</a> 3.1 PostgreSQL 相关</h3>
<pre><code class="language-sql"><span class="token operator">--</span> 强行中断连接到此数据库的 session
<span class="token constant">SELECT</span>
    <span class="token function">pg_terminate_backend</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
<span class="token constant">FROM</span>
    pg_stat_activity
<span class="token constant">WHERE</span>
    <span class="token operator">--</span> don't kill my own connection<span class="token operator">!</span>
    pid <span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">pg_backend_pid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">--</span> don't kill the connections to other databases
    <span class="token constant">AND</span> datname <span class="token operator">=</span> <span class="token string">'demoweb'</span> <span class="token punctuation">;</span>
</code></pre>
<h3 id="32-dcl-data-control-languge"><a class="v-toc-item" href="#32-dcl-data-control-languge">#</a> 3.2 DCL ( Data Control Languge )</h3>
<pre><code class="language-sql"><span class="token operator">--</span> 创建只读用户
\c demoweb
<span class="token constant">CREATE</span> <span class="token constant">ROLE</span> ro_user <span class="token constant">WITH</span> <span class="token constant">LOGIN</span> <span class="token constant">ENCRYPTED</span> <span class="token constant">PASSWORD</span> <span class="token string">'xxx123456'</span><span class="token punctuation">;</span>
<span class="token constant">GRANT</span> <span class="token constant">CONNECT</span> <span class="token constant">ON</span> <span class="token constant">DATABASE</span> demoweb <span class="token constant">TO</span> ro_user<span class="token punctuation">;</span>
<span class="token operator">--</span> This assumes you're actually connected to mydb<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token constant">GRANT</span> <span class="token constant">USAGE</span> <span class="token constant">ON</span> <span class="token constant">SCHEMA</span> <span class="token keyword">public</span> <span class="token constant">TO</span> ro_user<span class="token punctuation">;</span>
<span class="token constant">GRANT</span> <span class="token constant">SELECT</span> <span class="token constant">ON</span> <span class="token constant">ALL</span> <span class="token constant">TABLES</span> <span class="token constant">IN</span> <span class="token constant">SCHEMA</span> <span class="token keyword">public</span> <span class="token constant">TO</span> ro_user<span class="token punctuation">;</span>
<span class="token constant">GRANT</span> <span class="token constant">SELECT</span> <span class="token constant">ON</span> <span class="token constant">ALL</span> <span class="token constant">SEQUENCES</span> <span class="token constant">IN</span> <span class="token constant">SCHEMA</span> <span class="token keyword">public</span> <span class="token constant">TO</span> ro_user<span class="token punctuation">;</span>

<span class="token operator">--</span> <span class="token function">撤销数据库连接</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token constant">REVOKE</span> <span class="token constant">CONNECT</span> <span class="token constant">ON</span> <span class="token constant">DATABASE</span> demoweb <span class="token constant">FROM</span> <span class="token constant">PUBLIC</span><span class="token punctuation">,</span> demoweb<span class="token punctuation">;</span>
</code></pre>
<h3 id="33-ddl-data-definition-language"><a class="v-toc-item" href="#33-ddl-data-definition-language">#</a> 3.3 DDL ( Data Definition Language )</h3>
<p>CREATE<br>
ALTER<br>
DROP<br>
TRUNCATE<br>
COMMENT<br>
RENAME</p>
<h3 id="34-dml-data-manipulation-languge"><a class="v-toc-item" href="#34-dml-data-manipulation-languge">#</a> 3.4 DML ( Data Manipulation Languge )</h3>
<p>SELECT<br>
INSERT<br>
UPDATE<br>
DELETE<br>
MERGE<br>
CALL<br>
EXPLAIN PLAN<br>
LOCK TABLE</p>
<h3 id="35-tcl-transaction-control-languge"><a class="v-toc-item" href="#35-tcl-transaction-control-languge">#</a> 3.5 TCL ( Transaction Control Languge )</h3>
<h2 id="0x04-常用代码片段"><a class="v-toc-item" href="#0x04-常用代码片段">#</a> 0x04. 常用代码片段</h2>
<h3 id="41-tips-and-hacks"><a class="v-toc-item" href="#41-tips-and-hacks">#</a> 4.1. Tips And Hacks</h3>
<h4 id="recursive-query"><a class="v-toc-item" href="#recursive-query">#</a> Recursive Query</h4>
<pre><code class="language-bash"><span class="token constant">WITH</span> <span class="token function">cte_name</span><span class="token punctuation">(</span>
    CTE_query_definition <span class="token operator">--</span> non<span class="token operator">-</span>recursive term
    <span class="token constant">UNION</span> <span class="token punctuation">[</span><span class="token constant">ALL</span><span class="token punctuation">]</span>
    CTE_query_definition <span class="token operator">--</span> recursive term
<span class="token punctuation">)</span> <span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> cte_name<span class="token punctuation">;</span>
</code></pre>
<h3 id="42-大数据量运算技巧"><a class="v-toc-item" href="#42-大数据量运算技巧">#</a> 4.2. 大数据量运算技巧</h3>
<h3 id="43-备份还原技巧"><a class="v-toc-item" href="#43-备份还原技巧">#</a> 4.3 备份还原技巧</h3>
<pre><code class="language-bash"># 需要备份的机器
<span class="token constant">DB_NAME</span><span class="token operator">=</span><span class="token string">'xxxdb'</span>
<span class="token constant">DUMP_DB_FILE</span><span class="token operator">=</span><span class="token string">'latest_dump.sql.gz'</span>
sudo <span class="token operator">-</span>u postgres pg_dump $<span class="token constant">DB_NAME</span> <span class="token operator">|</span> gzip <span class="token operator">-</span><span class="token number">9</span> <span class="token operator">></span> $<span class="token constant">DUMP_DB_FILE</span>
<span class="token constant">TARGET_HOSTNAME</span><span class="token operator">=</span><span class="token string">'xxx.org'</span>
<span class="token constant">TARGET_PATH</span><span class="token operator">=</span><span class="token string">'/webapps/'</span>
scp $<span class="token constant">DUMP_DB_FILE</span> root@$<span class="token constant">TARGET_HOSTNAME</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">webapps</span><span class="token regex-delimiter">/</span></span>

# 需要还原的机器
<span class="token constant">DB_NAME</span><span class="token operator">=</span><span class="token string">'xxxdb'</span>
<span class="token constant">DUMP_DB_FILE</span><span class="token operator">=</span><span class="token string">'latest_dump.sql.gz'</span>
sudo <span class="token operator">-</span>u postgres dropdb $<span class="token constant">DB_NAME</span>
sudo <span class="token operator">-</span>u postgres createdb $<span class="token constant">DB_NAME</span>
gunzip <span class="token operator">&lt;</span> $<span class="token constant">DUMP_DB_FILE</span> <span class="token operator">|</span> sudo <span class="token operator">-</span>u postgres psql $<span class="token constant">DB_NAME</span>
</code></pre>
<h2 id="0x05-并发优化技巧"><a class="v-toc-item" href="#0x05-并发优化技巧">#</a> 0x05. 并发优化技巧</h2>
<blockquote>
<p>优化技巧请参考我关于 MySQL 的一片文章。</p>
</blockquote>
<h3 id="51-acid"><a class="v-toc-item" href="#51-acid">#</a> 5.1 ACID</h3>
<ul>
<li>Atomicity : 行不行，给个准话</li>
<li>Consistency : 完成时候，数据保持一致（多版本并发控制）</li>
<li>Isolation : 事务与事务之间是隔离的。即一事务无法查看另一个事务正在修改的数据（默认，如果不默认这玩意，则隔离程度是可以设置的）</li>
<li>Durablity : 就是存下来了。</li>
</ul>
<h4 id="多版本并发控制模型"><a class="v-toc-item" href="#多版本并发控制模型">#</a> 多版本并发控制模型</h4>
<ul>
<li>Each query sees only transactions completed before it started</li>
<li>On query start, PostgreSQL records:
<ul>
<li>the transaction counter</li>
<li>all transaction id’s that are in-process</li>
</ul>
</li>
<li>In a multi-statement transaction, a transaction’s own previous queries are also visible</li>
<li>The above assumes the default read committed isolation level</li>
</ul>
<p>使用 MVCC 多版本并发控制比锁定模型的主要优点是在 MVCC 里， 对检索（读）数据的锁要求与写数据的锁要求不冲突， 所以读不会阻塞写，而写也从不阻塞读。<br>
在数据库里也有表和行级别的锁定机制， 用于给那些无法轻松接受 MVCC 行为的应用。 不过，恰当地使用 MVCC 总会提供比锁更好地性能。</p>
<h3 id="52-ddl-事务"><a class="v-toc-item" href="#52-ddl-事务">#</a> 5.2 DDL 事务</h3>
<p>DDL 可以多条放在一起，然后直接 DDL, 据说可以在 sharding 时候用…</p>
<h3 id="53-事务使用"><a class="v-toc-item" href="#53-事务使用">#</a> 5.3 事务使用</h3>
<pre><code class="language-sql">begin<span class="token punctuation">;</span>
<span class="token operator">--</span> insert_somethings<span class="token punctuation">;</span>
savepoint my_savepoint01<span class="token punctuation">;</span>
<span class="token operator">--</span> wrong ops
rollback to my_savepoint01<span class="token punctuation">;</span>
commit<span class="token punctuation">;</span>
</code></pre>
<h3 id="54-事务隔离级别"><a class="v-toc-item" href="#54-事务隔离级别">#</a> 5.4 事务隔离级别</h3>
<ul>
<li>
<p>READ UNCOMMITED</p>
</li>
<li>
<p>READ COMMITED</p>
</li>
<li>
<p>REPEATABLE READ</p>
</li>
<li>
<p>SEARLIZABLE</p>
</li>
<li>
<p>脏读 : 和程序的并发一致 默认是不可能的。</p>
</li>
<li>
<p>不可重复读 : 一个事物重新读取前面读过的数，但是发现被改过了。能读原来则是可重复读。读新的，则是不可重复读。</p>
</li>
<li>
<p>幻读 : （举一个为赋新词强说愁的例子）比如，先 count 一下，然后依照 count 值遍历 cursor, 结果发现数量发生变化。</p>
</li>
</ul>
<p>读已提交，是默认。在这里，脏读（不会）、不可重复读（可能）、幻读（可能）。</p>
<h3 id="55-锁机制"><a class="v-toc-item" href="#55-锁机制">#</a> 5.5 锁机制</h3>
<ul>
<li>表级锁模式</li>
<li>行级锁模式</li>
</ul>
<h3 id="56-死锁"><a class="v-toc-item" href="#56-死锁">#</a> 5.6 死锁</h3>
<p>死锁的典型案例就是：</p>
<ol>
<li>当你找你爸要钱的时候，你爸说，要是你妈给你钱，我就给你钱。</li>
<li>当你找你妈要钱的时候，你妈说，要是你爸给你钱，我就给你钱。</li>
</ol>
<p>死锁的四个必要条件：</p>
<ul>
<li>互斥条件</li>
<li>请求和保持条件</li>
<li>不剥夺条件</li>
<li>环路等待条件</li>
</ul>
<p>避免死锁的方式，一般是按照顺序来。</p>
<p>当然，数据库可以自动检测出死锁，但是由于捕获死锁需要一定的代价。可能会导致应用程序过久地持有排他锁。</p>
<blockquote>
<p>慎用排他锁。</p>
</blockquote>
<h2 id="0x07-踩坑集"><a class="v-toc-item" href="#0x07-踩坑集">#</a> 0x07. 踩坑集</h2>
<ul>
<li>序列问题</li>
</ul>
</div></div><div><ul class="v-article-toc">
<li>
<ul>
<li><a href="#0x00-%E5%89%8D%E8%A8%80">0x00 前言</a></li>
<li><a href="#0x01-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4">0x01 安装，配置，基本 shell 命令</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85">安装</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4">基本 Shell 命令</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA">数据的导入导出</a></li>
</ul>
</li>
<li><a href="#0x02-postgresql-%E9%85%8D%E5%A5%97%E5%B7%A5%E5%85%B7">0x02 PostgreSQL 配套工具</a></li>
<li><a href="#0x03-postgresql-sql-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81">0x03 PostgreSQL SQL 常用代码</a>
<ul>
<li><a href="#31-postgresql-%E7%9B%B8%E5%85%B3">3.1 PostgreSQL 相关</a></li>
<li><a href="#32-dcl-data-control-languge">3.2 DCL ( Data Control Languge )</a></li>
<li><a href="#33-ddl-data-definition-language">3.3 DDL ( Data Definition Language )</a></li>
<li><a href="#34-dml-data-manipulation-languge">3.4 DML ( Data Manipulation Languge )</a></li>
<li><a href="#35-tcl-transaction-control-languge">3.5 TCL ( Transaction Control Languge )</a></li>
</ul>
</li>
<li><a href="#0x04-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5">0x04. 常用代码片段</a>
<ul>
<li><a href="#41-tips-and-hacks">4.1. Tips And Hacks</a>
<ul>
<li><a href="#recursive-query">Recursive Query</a></li>
</ul>
</li>
<li><a href="#42-%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E8%BF%90%E7%AE%97%E6%8A%80%E5%B7%A7">4.2. 大数据量运算技巧</a></li>
<li><a href="#43-%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E6%8A%80%E5%B7%A7">4.3 备份还原技巧</a></li>
</ul>
</li>
<li><a href="#0x05-%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7">0x05. 并发优化技巧</a>
<ul>
<li><a href="#51-acid">5.1 ACID</a>
<ul>
<li><a href="#%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9E%8B">多版本并发控制模型</a></li>
</ul>
</li>
<li><a href="#52-ddl-%E4%BA%8B%E5%8A%A1">5.2 DDL 事务</a></li>
<li><a href="#53-%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8">5.3 事务使用</a></li>
<li><a href="#54-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB">5.4 事务隔离级别</a></li>
<li><a href="#55-%E9%94%81%E6%9C%BA%E5%88%B6">5.5 锁机制</a></li>
<li><a href="#56-%E6%AD%BB%E9%94%81">5.6 死锁</a></li>
</ul>
</li>
<li><a href="#0x07-%E8%B8%A9%E5%9D%91%E9%9B%86">0x07. 踩坑集</a></li>
</ul>
</li>
</ul>
</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["PostgreSQL"],"path":"20170105_PostgreSQLCheatSheet.md","title":"PostgreSQL CheatSheat","slug":"PostgreSQL CheatSheat","date":"2017-01-05","category":"DevOps","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"\u003ch2 id=\"0x00-前言\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x00-前言\"\u003e#\u003c/a\u003e 0x00 前言\u003c/h2\u003e\n\u003cp\u003e本文为 Cheatsheet 类型文章，用于记录我在日常编程中经常使用的 PostgreSQL 相关和命令。\u003c/p\u003e\n\u003cp\u003ePostGIS 相关的资料参考文章 \u003ca href=\"/2016/10/05/UbuntuCheatsheet/\"\u003eGeo Processing With Python\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e安装与基本配置\u003c/li\u003e\n\u003cli\u003ePostgreSQL 配套工具\u003c/li\u003e\n\u003cli\u003ePostgreSQL SQL 常用代码片段\u003c/li\u003e\n\u003cli\u003ePython Driver : psycopg2 , 与两个 ORM ( Django ORM / SQLAlchemy )\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e不定期更新。\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"0x01-安装配置基本-shell-命令\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x01-安装配置基本-shell-命令\"\u003e#\u003c/a\u003e 0x01 安装，配置，基本 shell 命令\u003c/h2\u003e\n\u003ch3 id=\"安装\"\u003e\u003ca class=\"v-toc-item\" href=\"#安装\"\u003e#\u003c/a\u003e 安装\u003c/h3\u003e\n\u003ch3 id=\"配置\"\u003e\u003ca class=\"v-toc-item\" href=\"#配置\"\u003e#\u003c/a\u003e 配置\u003c/h3\u003e\n\u003ch3 id=\"基本-shell-命令\"\u003e\u003ca class=\"v-toc-item\" href=\"#基本-shell-命令\"\u003e#\u003c/a\u003e 基本 Shell 命令\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e# 开启关闭\npg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start\npg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log stop\npg_ctl -D /usr/local/var/postgres start\npg_ctl -D /usr/local/var/postgres stop -s -m fast\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"数据的导入导出\"\u003e\u003ca class=\"v-toc-item\" href=\"#数据的导入导出\"\u003e#\u003c/a\u003e 数据的导入导出\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003epg_dump \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eC\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eFp \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef dump\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eU\u003c/span\u003e twocucao \u003cspan class=\"token constant\"\u003eQCS\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eh \u003cspan class=\"token number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"token number\"\u003e.2\u003c/span\u003e\u003cspan class=\"token number\"\u003e.175\u003c/span\u003e\npg_dump \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eC\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eFp \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token number\"\u003e20160602\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e150144\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003edump\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eU\u003c/span\u003e twocucao \u003cspan class=\"token constant\"\u003eQCS\u003c/span\u003e \u003cspan class=\"token operator\"\u003e--\u003c/span\u003ecolumn\u003cspan class=\"token operator\"\u003e-\u003c/span\u003einserts \u003cspan class=\"token operator\"\u003e--\u003c/span\u003edata\u003cspan class=\"token operator\"\u003e-\u003c/span\u003eonly \u003cspan class=\"token operator\"\u003e--\u003c/span\u003etable\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eusers_table \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eh \u003cspan class=\"token number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"token number\"\u003e.2\u003c/span\u003e\u003cspan class=\"token number\"\u003e.175\u003c/span\u003e\n# 插入数据\npsql \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eU\u003c/span\u003e twocucao \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ed \u003cspan class=\"token constant\"\u003eQCS\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ea \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef insert_doc_ids\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esql \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eh \u003cspan class=\"token number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"token number\"\u003e.2\u003c/span\u003e\u003cspan class=\"token number\"\u003e.175\u003c/span\u003e\npg_restore \u003cspan class=\"token operator\"\u003e--\u003c/span\u003everbose \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eclean \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eno\u003cspan class=\"token operator\"\u003e-\u003c/span\u003eacl \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eno\u003cspan class=\"token operator\"\u003e-\u003c/span\u003eowner \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eh localhost example\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edump\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x02-postgresql-配套工具\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x02-postgresql-配套工具\"\u003e#\u003c/a\u003e 0x02 PostgreSQL 配套工具\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eJetBrain 的 Datagrip 作为 编写大段 SQL 语句的 IDE\u003c/li\u003e\n\u003cli\u003e通过网络或者 Dash 查看文档\u003c/li\u003e\n\u003cli\u003ePostgreSQL 官方自带工具\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"0x03-postgresql-sql-常用代码\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x03-postgresql-sql-常用代码\"\u003e#\u003c/a\u003e 0x03 PostgreSQL SQL 常用代码\u003c/h2\u003e\n\u003ch3 id=\"31-postgresql-相关\"\u003e\u003ca class=\"v-toc-item\" href=\"#31-postgresql-相关\"\u003e#\u003c/a\u003e 3.1 PostgreSQL 相关\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e 强行中断连接到此数据库的 session\n\u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003epg_terminate_backend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eFROM\u003c/span\u003e\n    pg_stat_activity\n\u003cspan class=\"token constant\"\u003eWHERE\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e--\u003c/span\u003e don't kill my own connection\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\n    pid \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003epg_backend_pid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e--\u003c/span\u003e don't kill the connections to other databases\n    \u003cspan class=\"token constant\"\u003eAND\u003c/span\u003e datname \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'demoweb'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"32-dcl-data-control-languge\"\u003e\u003ca class=\"v-toc-item\" href=\"#32-dcl-data-control-languge\"\u003e#\u003c/a\u003e 3.2 DCL ( Data Control Languge )\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e 创建只读用户\n\\c demoweb\n\u003cspan class=\"token constant\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"token constant\"\u003eROLE\u003c/span\u003e ro_user \u003cspan class=\"token constant\"\u003eWITH\u003c/span\u003e \u003cspan class=\"token constant\"\u003eLOGIN\u003c/span\u003e \u003cspan class=\"token constant\"\u003eENCRYPTED\u003c/span\u003e \u003cspan class=\"token constant\"\u003ePASSWORD\u003c/span\u003e \u003cspan class=\"token string\"\u003e'xxx123456'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eGRANT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eCONNECT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eON\u003c/span\u003e \u003cspan class=\"token constant\"\u003eDATABASE\u003c/span\u003e demoweb \u003cspan class=\"token constant\"\u003eTO\u003c/span\u003e ro_user\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e This assumes you're actually connected to mydb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eGRANT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eUSAGE\u003c/span\u003e \u003cspan class=\"token constant\"\u003eON\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSCHEMA\u003c/span\u003e \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token constant\"\u003eTO\u003c/span\u003e ro_user\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eGRANT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eON\u003c/span\u003e \u003cspan class=\"token constant\"\u003eALL\u003c/span\u003e \u003cspan class=\"token constant\"\u003eTABLES\u003c/span\u003e \u003cspan class=\"token constant\"\u003eIN\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSCHEMA\u003c/span\u003e \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token constant\"\u003eTO\u003c/span\u003e ro_user\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eGRANT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eON\u003c/span\u003e \u003cspan class=\"token constant\"\u003eALL\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSEQUENCES\u003c/span\u003e \u003cspan class=\"token constant\"\u003eIN\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSCHEMA\u003c/span\u003e \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token constant\"\u003eTO\u003c/span\u003e ro_user\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e \u003cspan class=\"token function\"\u003e撤销数据库连接\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eREVOKE\u003c/span\u003e \u003cspan class=\"token constant\"\u003eCONNECT\u003c/span\u003e \u003cspan class=\"token constant\"\u003eON\u003c/span\u003e \u003cspan class=\"token constant\"\u003eDATABASE\u003c/span\u003e demoweb \u003cspan class=\"token constant\"\u003eFROM\u003c/span\u003e \u003cspan class=\"token constant\"\u003ePUBLIC\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e demoweb\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"33-ddl-data-definition-language\"\u003e\u003ca class=\"v-toc-item\" href=\"#33-ddl-data-definition-language\"\u003e#\u003c/a\u003e 3.3 DDL ( Data Definition Language )\u003c/h3\u003e\n\u003cp\u003eCREATE\u003cbr\u003e\nALTER\u003cbr\u003e\nDROP\u003cbr\u003e\nTRUNCATE\u003cbr\u003e\nCOMMENT\u003cbr\u003e\nRENAME\u003c/p\u003e\n\u003ch3 id=\"34-dml-data-manipulation-languge\"\u003e\u003ca class=\"v-toc-item\" href=\"#34-dml-data-manipulation-languge\"\u003e#\u003c/a\u003e 3.4 DML ( Data Manipulation Languge )\u003c/h3\u003e\n\u003cp\u003eSELECT\u003cbr\u003e\nINSERT\u003cbr\u003e\nUPDATE\u003cbr\u003e\nDELETE\u003cbr\u003e\nMERGE\u003cbr\u003e\nCALL\u003cbr\u003e\nEXPLAIN PLAN\u003cbr\u003e\nLOCK TABLE\u003c/p\u003e\n\u003ch3 id=\"35-tcl-transaction-control-languge\"\u003e\u003ca class=\"v-toc-item\" href=\"#35-tcl-transaction-control-languge\"\u003e#\u003c/a\u003e 3.5 TCL ( Transaction Control Languge )\u003c/h3\u003e\n\u003ch2 id=\"0x04-常用代码片段\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x04-常用代码片段\"\u003e#\u003c/a\u003e 0x04. 常用代码片段\u003c/h2\u003e\n\u003ch3 id=\"41-tips-and-hacks\"\u003e\u003ca class=\"v-toc-item\" href=\"#41-tips-and-hacks\"\u003e#\u003c/a\u003e 4.1. Tips And Hacks\u003c/h3\u003e\n\u003ch4 id=\"recursive-query\"\u003e\u003ca class=\"v-toc-item\" href=\"#recursive-query\"\u003e#\u003c/a\u003e Recursive Query\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token constant\"\u003eWITH\u003c/span\u003e \u003cspan class=\"token function\"\u003ecte_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    CTE_query_definition \u003cspan class=\"token operator\"\u003e--\u003c/span\u003e non\u003cspan class=\"token operator\"\u003e-\u003c/span\u003erecursive term\n    \u003cspan class=\"token constant\"\u003eUNION\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token constant\"\u003eALL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    CTE_query_definition \u003cspan class=\"token operator\"\u003e--\u003c/span\u003e recursive term\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token constant\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token constant\"\u003eFROM\u003c/span\u003e cte_name\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"42-大数据量运算技巧\"\u003e\u003ca class=\"v-toc-item\" href=\"#42-大数据量运算技巧\"\u003e#\u003c/a\u003e 4.2. 大数据量运算技巧\u003c/h3\u003e\n\u003ch3 id=\"43-备份还原技巧\"\u003e\u003ca class=\"v-toc-item\" href=\"#43-备份还原技巧\"\u003e#\u003c/a\u003e 4.3 备份还原技巧\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# 需要备份的机器\n\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'xxxdb'\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eDUMP_DB_FILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'latest_dump.sql.gz'\u003c/span\u003e\nsudo \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eu postgres pg_dump $\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e gzip \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e9\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e $\u003cspan class=\"token constant\"\u003eDUMP_DB_FILE\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eTARGET_HOSTNAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'xxx.org'\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eTARGET_PATH\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/webapps/'\u003c/span\u003e\nscp $\u003cspan class=\"token constant\"\u003eDUMP_DB_FILE\u003c/span\u003e root@$\u003cspan class=\"token constant\"\u003eTARGET_HOSTNAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token regex\"\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003cspan class=\"token regex-source language-regex\"\u003ewebapps\u003c/span\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003c/span\u003e\n\n# 需要还原的机器\n\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'xxxdb'\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003eDUMP_DB_FILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'latest_dump.sql.gz'\u003c/span\u003e\nsudo \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eu postgres dropdb $\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e\nsudo \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eu postgres createdb $\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e\ngunzip \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e $\u003cspan class=\"token constant\"\u003eDUMP_DB_FILE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e sudo \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eu postgres psql $\u003cspan class=\"token constant\"\u003eDB_NAME\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"0x05-并发优化技巧\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x05-并发优化技巧\"\u003e#\u003c/a\u003e 0x05. 并发优化技巧\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e优化技巧请参考我关于 MySQL 的一片文章。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"51-acid\"\u003e\u003ca class=\"v-toc-item\" href=\"#51-acid\"\u003e#\u003c/a\u003e 5.1 ACID\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eAtomicity : 行不行，给个准话\u003c/li\u003e\n\u003cli\u003eConsistency : 完成时候，数据保持一致（多版本并发控制）\u003c/li\u003e\n\u003cli\u003eIsolation : 事务与事务之间是隔离的。即一事务无法查看另一个事务正在修改的数据（默认，如果不默认这玩意，则隔离程度是可以设置的）\u003c/li\u003e\n\u003cli\u003eDurablity : 就是存下来了。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"多版本并发控制模型\"\u003e\u003ca class=\"v-toc-item\" href=\"#多版本并发控制模型\"\u003e#\u003c/a\u003e 多版本并发控制模型\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eEach query sees only transactions completed before it started\u003c/li\u003e\n\u003cli\u003eOn query start, PostgreSQL records:\n\u003cul\u003e\n\u003cli\u003ethe transaction counter\u003c/li\u003e\n\u003cli\u003eall transaction id’s that are in-process\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIn a multi-statement transaction, a transaction’s own previous queries are also visible\u003c/li\u003e\n\u003cli\u003eThe above assumes the default read committed isolation level\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e使用 MVCC 多版本并发控制比锁定模型的主要优点是在 MVCC 里， 对检索（读）数据的锁要求与写数据的锁要求不冲突， 所以读不会阻塞写，而写也从不阻塞读。\u003cbr\u003e\n在数据库里也有表和行级别的锁定机制， 用于给那些无法轻松接受 MVCC 行为的应用。 不过，恰当地使用 MVCC 总会提供比锁更好地性能。\u003c/p\u003e\n\u003ch3 id=\"52-ddl-事务\"\u003e\u003ca class=\"v-toc-item\" href=\"#52-ddl-事务\"\u003e#\u003c/a\u003e 5.2 DDL 事务\u003c/h3\u003e\n\u003cp\u003eDDL 可以多条放在一起，然后直接 DDL, 据说可以在 sharding 时候用…\u003c/p\u003e\n\u003ch3 id=\"53-事务使用\"\u003e\u003ca class=\"v-toc-item\" href=\"#53-事务使用\"\u003e#\u003c/a\u003e 5.3 事务使用\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003ebegin\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e insert_somethings\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nsavepoint my_savepoint01\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e wrong ops\nrollback to my_savepoint01\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\ncommit\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"54-事务隔离级别\"\u003e\u003ca class=\"v-toc-item\" href=\"#54-事务隔离级别\"\u003e#\u003c/a\u003e 5.4 事务隔离级别\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eREAD UNCOMMITED\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eREAD COMMITED\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eREPEATABLE READ\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSEARLIZABLE\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e脏读 : 和程序的并发一致 默认是不可能的。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e不可重复读 : 一个事物重新读取前面读过的数，但是发现被改过了。能读原来则是可重复读。读新的，则是不可重复读。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e幻读 : （举一个为赋新词强说愁的例子）比如，先 count 一下，然后依照 count 值遍历 cursor, 结果发现数量发生变化。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e读已提交，是默认。在这里，脏读（不会）、不可重复读（可能）、幻读（可能）。\u003c/p\u003e\n\u003ch3 id=\"55-锁机制\"\u003e\u003ca class=\"v-toc-item\" href=\"#55-锁机制\"\u003e#\u003c/a\u003e 5.5 锁机制\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e表级锁模式\u003c/li\u003e\n\u003cli\u003e行级锁模式\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"56-死锁\"\u003e\u003ca class=\"v-toc-item\" href=\"#56-死锁\"\u003e#\u003c/a\u003e 5.6 死锁\u003c/h3\u003e\n\u003cp\u003e死锁的典型案例就是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e当你找你爸要钱的时候，你爸说，要是你妈给你钱，我就给你钱。\u003c/li\u003e\n\u003cli\u003e当你找你妈要钱的时候，你妈说，要是你爸给你钱，我就给你钱。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e死锁的四个必要条件：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e互斥条件\u003c/li\u003e\n\u003cli\u003e请求和保持条件\u003c/li\u003e\n\u003cli\u003e不剥夺条件\u003c/li\u003e\n\u003cli\u003e环路等待条件\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e避免死锁的方式，一般是按照顺序来。\u003c/p\u003e\n\u003cp\u003e当然，数据库可以自动检测出死锁，但是由于捕获死锁需要一定的代价。可能会导致应用程序过久地持有排他锁。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e慎用排他锁。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"0x07-踩坑集\"\u003e\u003ca class=\"v-toc-item\" href=\"#0x07-踩坑集\"\u003e#\u003c/a\u003e 0x07. 踩坑集\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e序列问题\u003c/li\u003e\n\u003c/ul\u003e\n","toc":"\u003cul class=\"v-article-toc\"\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#0x00-%E5%89%8D%E8%A8%80\"\u003e0x00 前言\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x01-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4\"\u003e0x01 安装，配置，基本 shell 命令\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%AE%89%E8%A3%85\"\u003e安装\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%85%8D%E7%BD%AE\"\u003e配置\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%9F%BA%E6%9C%AC-shell-%E5%91%BD%E4%BB%A4\"\u003e基本 Shell 命令\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA\"\u003e数据的导入导出\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x02-postgresql-%E9%85%8D%E5%A5%97%E5%B7%A5%E5%85%B7\"\u003e0x02 PostgreSQL 配套工具\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x03-postgresql-sql-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81\"\u003e0x03 PostgreSQL SQL 常用代码\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#31-postgresql-%E7%9B%B8%E5%85%B3\"\u003e3.1 PostgreSQL 相关\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#32-dcl-data-control-languge\"\u003e3.2 DCL ( Data Control Languge )\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#33-ddl-data-definition-language\"\u003e3.3 DDL ( Data Definition Language )\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#34-dml-data-manipulation-languge\"\u003e3.4 DML ( Data Manipulation Languge )\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#35-tcl-transaction-control-languge\"\u003e3.5 TCL ( Transaction Control Languge )\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x04-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5\"\u003e0x04. 常用代码片段\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#41-tips-and-hacks\"\u003e4.1. Tips And Hacks\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#recursive-query\"\u003eRecursive Query\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#42-%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E8%BF%90%E7%AE%97%E6%8A%80%E5%B7%A7\"\u003e4.2. 大数据量运算技巧\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#43-%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F%E6%8A%80%E5%B7%A7\"\u003e4.3 备份还原技巧\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x05-%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7\"\u003e0x05. 并发优化技巧\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#51-acid\"\u003e5.1 ACID\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9E%8B\"\u003e多版本并发控制模型\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#52-ddl-%E4%BA%8B%E5%8A%A1\"\u003e5.2 DDL 事务\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#53-%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8\"\u003e5.3 事务使用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#54-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB\"\u003e5.4 事务隔离级别\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#55-%E9%94%81%E6%9C%BA%E5%88%B6\"\u003e5.5 锁机制\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#56-%E6%AD%BB%E9%94%81\"\u003e5.6 死锁\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#0x07-%E8%B8%A9%E5%9D%91%E9%9B%86\"\u003e0x07. 踩坑集\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"PostgreSQL CheatSheat"},"buildId":"uCwe9m-iio9bnoWMgWDqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>