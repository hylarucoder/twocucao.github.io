<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Django,VueJS,全栈开发,RestAPI," />





  <link rel="alternate" href="/atom.xml" title="MG的编程小屋" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="0x00 前言本文是 Django 全栈开发教程的第三篇 YaDjangoBlog 之前后端分离 目录在这里，已经更新的文章如下  Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇 Django 全栈开发教程 - YaDjangoBlog 的开发环境配置 Django 全栈开发教程 - YaDjangoBlog 的前后端设计  本文需要成四件事情：  第一">
<meta name="keywords" content="Django,VueJS,全栈开发,RestAPI">
<meta property="og:type" content="article">
<meta property="og:title" content="YaDjangoBlog 之前后端分离篇">
<meta property="og:url" content="http://twocucao.xyz/2018/03/04/YaDjangoBlog前后端分离篇/index.html">
<meta property="og:site_name" content="MG的编程小屋">
<meta property="og:description" content="0x00 前言本文是 Django 全栈开发教程的第三篇 YaDjangoBlog 之前后端分离 目录在这里，已经更新的文章如下  Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇 Django 全栈开发教程 - YaDjangoBlog 的开发环境配置 Django 全栈开发教程 - YaDjangoBlog 的前后端设计  本文需要成四件事情：  第一">
<meta property="og:updated_time" content="2018-03-04T14:57:22.459Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YaDjangoBlog 之前后端分离篇">
<meta name="twitter:description" content="0x00 前言本文是 Django 全栈开发教程的第三篇 YaDjangoBlog 之前后端分离 目录在这里，已经更新的文章如下  Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇 Django 全栈开发教程 - YaDjangoBlog 的开发环境配置 Django 全栈开发教程 - YaDjangoBlog 的前后端设计  本文需要成四件事情：  第一">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://twocucao.xyz/2018/03/04/YaDjangoBlog前后端分离篇/"/>





  <title>YaDjangoBlog 之前后端分离篇 | MG的编程小屋</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?299254d95898cdfa110fc6d914eba9c4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MG的编程小屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Get Busy Living, Or Get Busy Dying</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/04/YaDjangoBlog前后端分离篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">YaDjangoBlog 之前后端分离篇</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T08:38:47+08:00">
                2018-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,786
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>本文是 Django 全栈开发教程的第三篇 YaDjangoBlog 之前后端分离</p>
<p>目录在这里，已经更新的文章如下</p>
<ul>
<li>Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的开发环境配置</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的前后端设计</li>
</ul>
<p><strong>本文需要成四件事情：</strong></p>
<ul>
<li>第一件事情，解读 DjangoRestFramework, 通过简单的例子来引入用 DRF 的必要性，并且简单介绍 DRF 的 CBV 实现。</li>
<li>第二件事情，简单介绍 DRF 在本项目 YaDjangoBlog 中的使用</li>
<li>第三件事情，简单聊聊 RESTFULAPI 规范，并给出最佳实践参考。</li>
<li>第四件事情，简单解读一下 Django 处理请求流程代码。</li>
</ul>
<p>PS: 为了打字方便，下面的：</p>
<ul>
<li>DRF 指的是 DjangoRestFramework</li>
<li>CBV 指的是 Class Based View</li>
<li>FBV 指的是 Function Based View</li>
</ul>
<blockquote>
<p>坐稳了，开车了。</p>
</blockquote>
<h2 id="0x01-DjangorestFramework-解读"><a href="#0x01-DjangorestFramework-解读" class="headerlink" title="0x01 DjangorestFramework 解读"></a>0x01 DjangorestFramework 解读</h2><h3 id="为什么要用-DRF-呢？"><a href="#为什么要用-DRF-呢？" class="headerlink" title="为什么要用 DRF 呢？"></a>为什么要用 DRF 呢？</h3><p>使用一个库的原因，无非就是为了：</p>
<ol>
<li>节省开发者自己造轮子的时间。</li>
<li>有利于代码的可维护性 / 或者程序的健壮性。</li>
</ol>
<p>具体落实到 DRF, 有哪些具体的优点呢？</p>
<ol>
<li>可直接浏览调试的界面。让前端调试起来欲罢不能的功能。</li>
<li>用 DRF 的方式快速批量开接口</li>
<li>分页、序列化、校验、登录、权限、Web 附加文档、限流，高度的可扩展性。哪里不爽扩展哪里，so easy</li>
<li>算的上是 Django 社区最好的 RESTFUL 框架的轮子了。</li>
<li>完善的社区支持，比如 guardian/django-filter 等等结合。</li>
</ol>
<h3 id="不使用-DRF-应该如何写-WebAPI-做呢？"><a href="#不使用-DRF-应该如何写-WebAPI-做呢？" class="headerlink" title="不使用 DRF 应该如何写 WebAPI 做呢？"></a>不使用 DRF 应该如何写 WebAPI 做呢？</h3><p>我们先看看，不使用 DRF 的时代，API 是如何编写的。</p>
<p>这里我们用 function based view 来简单说明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 最简单版本</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_hello</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> JsonResponse(&#123;</div><div class="line">        <span class="string">"这就是 key"</span>: <span class="string">"这就是 value"</span>,</div><div class="line">        <span class="string">"时间"</span>: time.time()</div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
<p>刚开始学 DRF 的时候，我也有这种疑惑，这有必要需要一个 RESTFULAPI 的框架嘛？捋起袖子，JSON API 甩起来开咯。</p>
<p>之所以得出这个结论，是因为这个例子实在是过于简单。</p>
<p>当涉及到一定复杂程度的 API 的时候，问题就来了：</p>
<ol>
<li>权限是否需要区分？</li>
<li>分页需不需要做？</li>
<li>前端人员提交 Form 表单时，只能通过命令行或者是 POSTMAN 之类的工具提交参数，这会不会带来不便？后端人员写这些表单的各个字段，也是很手酸的事情。</li>
<li>拼接字典或者是字符串倒也还好，能不能有个序列器帮我直接序列化这模型，并且如果模型和模型之间有联系，最好也可以帮我完成模型和模型之间的关联。</li>
<li>Profile API 应该如何做？</li>
</ol>
<p>这都是我们需要考虑的。</p>
<p>如果不用 DRF, 而是由后端程序员直接写这些代码的话，也不是不行。</p>
<ol>
<li>对于第一点，可以直接在 fbv 上面加装饰器。</li>
<li>对于第二点，分页的时候可以直接将逻辑写在 fbv 里面。</li>
<li>前端 er 直接使用 PostMan 之类的工具就好了。</li>
<li>序列化，可以借助内置的序列化方法。</li>
<li>Profile 可以在提交参数的时候，附加一个参数比如 debug, 渲染的时候，将使用 HTML 里面内置一个 JSON 字符串的方式渲染出来。这样的话，就可以使用 Django Debug Tools 进行 Profile 了。</li>
</ol>
<p>很显然，这是个系统性的活。 假如接下来还要考虑限流、RESTFULAPI 的设计，这就相当蛋疼了。</p>
<p>显然，我们的 FBV 就会是这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@a_authority</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">complex_hello</span><span class="params">(request)</span>:</span></div><div class="line">    params = getParams(request)</div><div class="line">    .....</div><div class="line">    query_results = SomeModels.some_query()</div><div class="line">    .....</div><div class="line">    results = SomeModelsSerial(query_results)</div><div class="line">    .....</div><div class="line">    <span class="keyword">return</span> JsonResponse(results)</div></pre></td></tr></table></figure>
<p>看起来似乎是有规律可循的，既然有规律可循，就能封装一下，减轻负担。FBV 已经这样了，显然只能每次都要硬编码这些取参数，查询，序列化。当然，如果用生成器也能简化一部分函数代码。yield 实现方法太丑还是弃用吧。</p>
<p>我们试试 CBV 看看如何。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 继承并重写方法</span></div><div class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span><span class="params">(View)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></div><div class="line">        query_results = SomeModels.some_query()</div><div class="line">        .....</div><div class="line">        results = SomeModelsSerial(query_results)</div><div class="line">        .....</div><div class="line">        <span class="keyword">return</span> results</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></div><div class="line">        query_results = SomeModels.some_query()</div><div class="line">        .....</div><div class="line">        results = SomeModelsSerial(query_results)</div><div class="line">        .....</div><div class="line">        <span class="keyword">return</span> results</div><div class="line"></div><div class="line">    .....</div><div class="line"></div><div class="line">    <span class="comment"># 这里相当于 view 函数</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="comment"># 这里处理正式处理之前的逻辑，比如权限判断。</span></div><div class="line">        <span class="comment"># 如果是 GET 方法，则调用</span></div><div class="line">        results = self.get(request, *args, **kwargs):</div><div class="line">        <span class="comment"># 这里处理正式处理之后的逻辑，比如统计 list 的 total 值，加上时间戳</span></div><div class="line">        <span class="keyword">return</span> JsonResponse(results)</div></pre></td></tr></table></figure>
<p>于是，除了使用 FBV 进行硬编码之外，还可以使用 CBV 的基类 进行扩展定制。</p>
<p>我们思考一下：</p>
<ol>
<li>假如我想渲染某个模型的 JSON 列表，就可以定制一个 ListViewAPI 出来。如果需要一个 DetailViewAPI, 就定制一个 DetailViewAPI 出来。</li>
<li>我们再声明一些 Permission 类，序列化类，模型，然后在 dispatch 中直接使用这些东西的话，就只需要在 get 和 post 里面编写一些最核心的逻辑了。</li>
<li>甚至，指定了分页器和查询，都完全不需要再 get 和 post 里面写代码。</li>
</ol>
<p>恭喜你，读到这里，你已经可以写一个极简的 DRF 出来了。</p>
<p>但写成 DRF 这种量级的程序，还需要做很多很多事情。</p>
<h3 id="DRF-处理请求的流程"><a href="#DRF-处理请求的流程" class="headerlink" title="DRF 处理请求的流程"></a>DRF 处理请求的流程</h3><p>要知道 DRF 的处理请求的流程，就要先知道 Django 的处理请求流程。</p>
<p>宏观来看</p>
<ol>
<li>请求先经过 MiddleWare , 接着判断 urlconf （默认为 ROOT_URLCONF),</li>
<li>匹配 URL, 将请求上下文 dispatch 到具体的 view.</li>
<li>处理完毕，经过 MiddleWare</li>
</ol>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/http/urls/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/http/urls/</a></p>
<p>在本文的结尾的时候，我也将带大家从源码角度过一下，涉及到这个流程的相关的源码。这里先跳过。</p>
<p>那么，DRF 是如何处理一个请求的呢？我们忽略路由之类的东西，直接看对应的 CBV 的源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span><span class="params">(View)</span>:</span></div><div class="line"></div><div class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</div><div class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</div><div class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</div><div class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</div><div class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</div><div class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</div><div class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</div><div class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</div><div class="line"></div><div class="line">    <span class="comment"># ...... 其他方法</span></div><div class="line"></div><div class="line">    <span class="comment"># Dispatch methods</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Returns the initial request object.</div><div class="line">        """</div><div class="line">        parser_context = self.get_parser_context(request)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Request(</div><div class="line">            request,</div><div class="line">            parsers=self.get_parsers(),</div><div class="line">            authenticators=self.get_authenticators(),</div><div class="line">            negotiator=self.get_content_negotiator(),</div><div class="line">            parser_context=parser_context</div><div class="line">        )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initial</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Runs anything that needs to occur prior to calling the method handler.</div><div class="line">        """</div><div class="line">        self.format_kwarg = self.get_format_suffix(**kwargs)</div><div class="line"></div><div class="line">        <span class="comment"># Perform content negotiation and store the accepted info on the request</span></div><div class="line">        neg = self.perform_content_negotiation(request)</div><div class="line">        request.accepted_renderer, request.accepted_media_type = neg</div><div class="line"></div><div class="line">        <span class="comment"># Determine the API version, if versioning is in use.</span></div><div class="line">        version, scheme = self.determine_version(request, *args, **kwargs)</div><div class="line">        request.version, request.versioning_scheme = version, scheme</div><div class="line"></div><div class="line">        <span class="comment"># Ensure that the incoming request is permitted</span></div><div class="line">        self.perform_authentication(request)</div><div class="line">        self.check_permissions(request)</div><div class="line">        self.check_throttles(request)</div><div class="line"></div><div class="line">    <span class="comment"># Note: Views are made CSRF exempt from within `as_view` as to prevent</span></div><div class="line">    <span class="comment"># accidental removal of this exemption in cases where `dispatch` needs to</span></div><div class="line">    <span class="comment"># be overridden.</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        `.dispatch()` is pretty much the same as Django's regular dispatch,</div><div class="line">        but with extra hooks for startup, finalize, and exception handling.</div><div class="line">        """</div><div class="line">        self.args = args</div><div class="line">        self.kwargs = kwargs</div><div class="line">        <span class="comment"># 这里需要注意</span></div><div class="line">        request = self.initialize_request(request, *args, **kwargs)</div><div class="line">        self.request = request</div><div class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># 这里需要注意</span></div><div class="line">            self.initial(request, *args, **kwargs)</div><div class="line"></div><div class="line">            <span class="comment"># Get the appropriate handler method</span></div><div class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</div><div class="line">                handler = getattr(self, request.method.lower(),</div><div class="line">                                  self.http_method_not_allowed)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                handler = self.http_method_not_allowed</div><div class="line"></div><div class="line">            response = handler(request, *args, **kwargs)</div><div class="line"></div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">            response = self.handle_exception(exc)</div><div class="line"></div><div class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</div><div class="line">        <span class="keyword">return</span> self.response</div></pre></td></tr></table></figure>
<p>可以看出，当请求到达 dispatch 的时候，DRF 添加了一些钩子函数，用于开始 / 结束 / 错误控制。</p>
<ol>
<li>在 initialize_request 的时候，对 request 进行封装，添加上 parser / auth / negoriator / parser context</li>
<li>接着在 initial 方法里面校验了版本，进行了认证和鉴权，检查了限流</li>
</ol>
<p>一看，其实与我们之前想封装 APIView 的想法不谋而合，而我们只是想想，DRF 是详细实现。</p>
<h2 id="0x02-DjangorestFramework-的使用案例"><a href="#0x02-DjangorestFramework-的使用案例" class="headerlink" title="0x02 DjangorestFramework 的使用案例"></a>0x02 DjangorestFramework 的使用案例</h2><h3 id="如何开-WebAPI-接口"><a href="#如何开-WebAPI-接口" class="headerlink" title="如何开 WebAPI 接口"></a>如何开 WebAPI 接口</h3><p>回到我们的 yadjangoblog 上面来。这个时候我们想开一个博文列表 API:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1. 定义序列器，用于序列化查询的每一条。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostListSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></div><div class="line">    category = BlogCategorySerializer(read_only=<span class="keyword">True</span>)</div><div class="line">    tags = BlogTagSerializer(many=<span class="keyword">True</span>, read_only=<span class="keyword">True</span>)</div><div class="line">    title = serializers.CharField()</div><div class="line">    id = serializers.IntegerField()</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = BlogPost</div><div class="line">        fields = (<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'char_num'</span>, <span class="string">'vote_num'</span>, <span class="string">'category'</span>, <span class="string">'tags'</span>, <span class="string">'publish_date'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 2. 定义过滤器，可以通过过滤器进行查询</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostFilter</span><span class="params">(filters.FilterSet)</span>:</span></div><div class="line">    title = filters.CharFilter(lookup_expr=<span class="string">'contains'</span>)</div><div class="line">    having_tags = filters.Filter(name=<span class="string">"tags"</span>, lookup_expr=<span class="string">'in'</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = BlogPost</div><div class="line">        fields = (<span class="string">'title'</span>, <span class="string">'char_num'</span>, <span class="string">'category'</span>, <span class="string">'tags'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 3. 指定其他设置，具体大家看源码就好了。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostListAPIView</span><span class="params">(generics.ListAPIView)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    依照 category , tags , 时间 （年 / 月 / 日  年 / 月 年）</div><div class="line">    """</div><div class="line">    queryset = BlogPost.objects.all()</div><div class="line">    serializer_class = BlogPostListSerializer</div><div class="line">    filter_backends = (filters.DjangoFilterBackend, OrderingFilter,)</div><div class="line">    filter_class = BlogPostFilter</div><div class="line">    ordering_fields = (<span class="string">'publish_date'</span>,)</div><div class="line">    ordering = (<span class="string">'publish_date'</span>,)</div><div class="line">    permission_classes = (permissions.AllowAny,)</div><div class="line">    pagination_class = SmallResultsSetPagination</div></pre></td></tr></table></figure>
<p>在指定上面的操作之后，一个接口就快速的开出来了。</p>
<p>: TODO 插入一张图</p>
<p>当然，DRF 认认真真通读一遍的话，还是可以给自己节省不少时间的。</p>
<p>这是开接口，似乎，还少了什么，比如 Restful API.</p>
<h3 id="前端如何使用-WebAPI-接口"><a href="#前端如何使用-WebAPI-接口" class="headerlink" title="前端如何使用 WebAPI 接口"></a>前端如何使用 WebAPI 接口</h3><p>什么是 CORS 可以参考阮一峰的文章 <a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
<p>在调试的时候，我们肯定是使用 ajax / fetch 方式请求。这就会遇到一个问题：</p>
<ul>
<li>跨域</li>
</ul>
<p>解决方式也很简单，服务端只要服务器实现了 CORS 接口，就可以跨源通信。</p>
<p>安装 django-cors-headers, 并在 settings 中开启 CORS_ORIGIN_ALLOW_ALL = True 即可。</p>
<p>这里参考了临书的解决方案，要感谢 @临书 , 附上参考地址 <a href="https://zhuanlan.zhihu.com/p/24893786" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/24893786</a></p>
<p>对于本项目而言，使用了 axios 请求库，直接 get 即可。详细看前端代码即可。</p>
<h2 id="0x03-RESTFUL-API-设计"><a href="#0x03-RESTFUL-API-设计" class="headerlink" title="0x03 RESTFUL API 设计"></a>0x03 RESTFUL API 设计</h2><p>开发过程中，尽量靠近 RESTFUL API 的设计，而不是照搬。</p>
<p>举个其他领域的例子，有的人表述美就只有：</p>
<ul>
<li>已撸</li>
</ul>
<p>但是不同的美各有各的模样：</p>
<ul>
<li>手如柔荑，肤如凝脂，领如蝤蛴，齿如瓠犀，螓首蛾眉，巧笑倩兮，美目盼兮。</li>
</ul>
<p>同样，放在 RESFUL 的时候确实也出现了这种情况：</p>
<p>几乎所有的业务逻辑最后会落实到数据表的 CURDE, 但是所有业务逻辑并不能完全使用 CRUDE 描述。</p>
<p>我们看下面的例子</p>
<h3 id="关于请求"><a href="#关于请求" class="headerlink" title="关于请求"></a>关于请求</h3><p>举个例子，RESTFUL 适合纯粹 CURDE 的设计风格。</p>
<p>比如，新增博客，更新博客，查询博客，删除博客，查看是否含有博客</p>
<p>但语义在某些场景下表述不足， 比如，设计订单的时候，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">URL: /api/v1/user/some_user/orders</div><div class="line">你查看订单集合，这个好理解。get 方法</div><div class="line">你新增订单，这个好理解。put 方法</div><div class="line">URL: /api/v1/user/some_user/order/xxxxxxx</div><div class="line">你删除订单，这个好理解。delete 方法</div><div class="line">你获取订单，这个好理解。get 方法</div><div class="line">你修改订单，这个好理解。post 方法</div><div class="line"></div><div class="line">但修改订单，有的时候可能会比较复杂，有可能是取消订单，有可能是评价订单，有可能是其他。而 RESTFUL 表达这种情况就有些语义不足了。</div></pre></td></tr></table></figure>
<p>当然，个人经验是，字段越多，越难靠近 RESTFUL 规范</p>
<p>这个时候，就需要设计者做好 RESTFULAPI 的设计与语义化的平衡了。</p>
<h3 id="关于响应"><a href="#关于响应" class="headerlink" title="关于响应"></a>关于响应</h3><p>关于响应设计，主要有两点需要注意：</p>
<ul>
<li>状态码 (HTTP 状态码，也业务逻辑通用状态码）</li>
<li>响应内容 包含 业务逻辑通用状态码，剩下的视具体情况而定。</li>
</ul>
<p>HTTP 状态码用于标记资源情况，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">200 表示获取资源</div><div class="line">404 表示 NOT FOUND</div></pre></td></tr></table></figure>
<p>但有时候也存在语义表达不足问题，一般前后端也会约定一个通用的状态码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">通用状态码 错误信息 含义 HTTP 状态码</div><div class="line">999	    unknow_v2_error	未知错误	400</div><div class="line">1000	need_permission	需要权限	403</div><div class="line">1001	uri_not_found	资源不存在	404</div><div class="line">1002	missing_args	参数不全	400</div><div class="line">1003	image_too_large	上传的图片太大	400</div><div class="line">....</div></pre></td></tr></table></figure>
<p>至于响应内容，一般都是见招拆招的。建议查看文章末尾的 Douban 的相关 API 规范来提升姿势。</p>
<h2 id="0x04-Django-的处理请求流程代码解读"><a href="#0x04-Django-的处理请求流程代码解读" class="headerlink" title="0x04 Django 的处理请求流程代码解读"></a>0x04 Django 的处理请求流程代码解读</h2><p>这小节属于一时兴起写的番外篇。和本文主体内容没啥必要的关联。不感兴趣的可以直接跳转到文章末尾点赞哈。</p>
<p>WSGI 全称叫做 web 服务器网关接口，通常情况下，gunicorn 或者 uwsgi 接收来自 nginx 转发来的请求之后，向 web app 提供了环境信息（叫请求上下文会不会好些）以及一个 callback. 这样的话，web app 就可以接收这个环境信息，处理完毕，通过回调函数处理请求，并返回响应。一个极简的 webapp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    <span class="string">"""Simplest possible application object"""</span></div><div class="line">    data = <span class="string">'Hello, World!\n'</span></div><div class="line">    status = <span class="string">'200 OK'</span></div><div class="line">    response_headers = [</div><div class="line">        (<span class="string">'Content-type'</span>,<span class="string">'text/plain'</span>),</div><div class="line">        (<span class="string">'Content-Length'</span>, str(len(data)))</div><div class="line">    ]</div><div class="line">    start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> iter([data])</div></pre></td></tr></table></figure>
<p>现在我们看看 django 中是如何处理请求的。首先查看相关的 wsgi.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wsgi.py</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> django.core.wsgi <span class="keyword">import</span> get_wsgi_application</div><div class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"config.settings"</span>)</div><div class="line">application = get_wsgi_application()</div><div class="line"></div><div class="line"><span class="comment"># 接着查看 get_wsgi_application</span></div><div class="line"><span class="keyword">import</span> django</div><div class="line"><span class="keyword">from</span> django.core.handlers.wsgi <span class="keyword">import</span> WSGIHandler</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_wsgi_application</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    The public interface to Django's WSGI support. Return a WSGI callable.</div><div class="line"></div><div class="line">    Avoids making django.core.handlers.WSGIHandler a public API, in case the</div><div class="line">    internal WSGI implementation changes or moves in the future.</div><div class="line">    """</div><div class="line">    django.setup(set_prefix=<span class="keyword">False</span>)</div><div class="line">    <span class="keyword">return</span> WSGIHandler()</div><div class="line"></div><div class="line"><span class="comment"># 于是自然而言的看到了 WSGIHandler</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIHandler</span><span class="params">(base.BaseHandler)</span>:</span></div><div class="line">    request_class = WSGIRequest</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        super().__init__(*args, **kwargs)</div><div class="line">        self.load_middleware()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        <span class="comment"># 有木有看到 environ 和 start_response ?? 这就是极简 web app 中的 webapp 核心方法。</span></div><div class="line">        set_script_prefix(get_script_name(environ))</div><div class="line">        signals.request_started.send(sender=self.__class__, environ=environ)</div><div class="line">        request = self.request_class(environ)</div><div class="line">        <span class="comment"># 注意这一行，有请求处理逻辑 具体要见下面代码</span></div><div class="line">        response = self.get_response(request)</div><div class="line">        <span class="comment"># ......</span></div><div class="line">        <span class="keyword">return</span> response</div></pre></td></tr></table></figure>
<p>嗯，看到了子类，就要看看基类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span>:</span></div><div class="line">    _request_middleware = <span class="keyword">None</span></div><div class="line">    _view_middleware = <span class="keyword">None</span></div><div class="line">    _template_response_middleware = <span class="keyword">None</span></div><div class="line">    _response_middleware = <span class="keyword">None</span></div><div class="line">    _exception_middleware = <span class="keyword">None</span></div><div class="line">    _middleware_chain = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_middleware</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        注册 MiddleWare, 并赋值 _middleware_chain 方法，使之调用的时候可以先按照顺序从 setting 的 middleware 里面处理 requests</div><div class="line">        并在处理 request 的最后调用 私有方法 _get_response</div><div class="line">        """</div><div class="line">        self._request_middleware = []</div><div class="line">        self._view_middleware = []</div><div class="line">        self._template_response_middleware = []</div><div class="line">        self._response_middleware = []</div><div class="line">        self._exception_middleware = []</div><div class="line"></div><div class="line">        handler = convert_exception_to_response(self._get_response)</div><div class="line">        <span class="comment"># 注意，这里面是倒着来的 代码中越在前面，实际运行的时候处理就越在后面</span></div><div class="line">        <span class="keyword">for</span> middleware_path <span class="keyword">in</span> reversed(settings.MIDDLEWARE):</div><div class="line">            <span class="comment"># 依次添加 view middleware / template middleware / exception middleware</span></div><div class="line">            middleware = import_string(middleware_path)</div><div class="line">            mw_instance = middleware(handler)</div><div class="line">            handler = convert_exception_to_response(mw_instance)</div><div class="line"></div><div class="line">        <span class="comment"># We only assign to this when initialization is complete as it is used</span></div><div class="line">        <span class="comment"># as a flag for initialization being complete.</span></div><div class="line">        self._middleware_chain = handler</div><div class="line"></div><div class="line">    .....</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_response</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="string">"""Return an HttpResponse object for the given HttpRequest."""</span></div><div class="line">        <span class="comment"># Setup default url resolver for this thread</span></div><div class="line">        set_urlconf(settings.ROOT_URLCONF)</div><div class="line"></div><div class="line">        response = self._middleware_chain(request)</div><div class="line">        <span class="comment"># ......</span></div><div class="line">        <span class="keyword">return</span> response</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_response</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Resolve and call the view, then apply view, exception, and</div><div class="line">        template_response middleware. This method is everything that happens</div><div class="line">        inside the request/response middleware.</div><div class="line">        """</div><div class="line">        response = <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="comment"># 1. 接着判断 urlconf （默认为 ROOT_URLCONF), 可以通过 middleware 进行设置</span></div><div class="line">        <span class="keyword">if</span> hasattr(request, <span class="string">'urlconf'</span>):</div><div class="line">            urlconf = request.urlconf</div><div class="line">            set_urlconf(urlconf)</div><div class="line">            resolver = get_resolver(urlconf)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            resolver = get_resolver()</div><div class="line"></div><div class="line">        resolver_match = resolver.resolve(request.path_info)</div><div class="line">        callback, callback_args, callback_kwargs = resolver_match</div><div class="line">        request.resolver_match = resolver_match</div><div class="line"></div><div class="line">        <span class="comment"># Apply view middleware....</span></div><div class="line">        <span class="comment"># 注意，这个就是 view 函数</span></div><div class="line">        wrapped_callback = self.make_view_atomic(callback)</div><div class="line">        response = wrapped_callback(request, *callback_args, **callback_kwargs)</div><div class="line">        <span class="comment"># Complain if the view returned None (a common error).</span></div><div class="line">        <span class="keyword">return</span> response</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception_by_middleware</span><span class="params">(self, exception, request)</span>:</span></div><div class="line">        <span class="comment"># ......</span></div></pre></td></tr></table></figure>
<p>上面代码比较表达的意思比较简单，值得注意的地方我都加了注释。</p>
<p>需要特别注意的就是 middleware_chain 这个属性（实际上是一个方法）, 正是这个方法使得注册的 middleware （在 load_middleware 方法里）可以在 fbv 或者 cbv 处理 request 之前，通过对 request 进行处理。</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE. 参考链接"></a>0xEE. 参考链接</h2><p>还犹豫啥，Django 前后端分离最佳实践，点赞后，快上车吧</p>
<ul>
<li>前端代码 <a href="https://github.com/twocucao/YaVueBlog" target="_blank" rel="external">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a href="https://github.com/twocucao/YaDjangoBlog" target="_blank" rel="external">https://github.com/twocucao/YaDjangoBlog</a></li>
<li>扩展阅读之 douban restful api 设计  <a href="https://developers.douban.com/wiki/?title=api_v2" target="_blank" rel="external">https://developers.douban.com/wiki/?title=api_v2</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-22</strong> 开启本文</li>
<li><strong>2018-03-04</strong> 重修文字</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Django/" rel="tag"># Django</a>
          
            <a href="/tags/VueJS/" rel="tag"># VueJS</a>
          
            <a href="/tags/全栈开发/" rel="tag"># 全栈开发</a>
          
            <a href="/tags/RestAPI/" rel="tag"># RestAPI</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/09/Flask源码解析/" rel="next" title="Flask 源码初步解读">
                <i class="fa fa-chevron-left"></i> Flask 源码初步解读
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/23/YaDjangoBlog的前后端初步设计/" rel="prev" title="YaDjangoBlog 的前后端设计">
                YaDjangoBlog 的前后端设计 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oh1n2bfoj.bkt.clouddn.com/avatar.png"
               alt="Micheal Gardner" />
          <p class="site-author-name" itemprop="name">Micheal Gardner</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">72</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">91</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/twocucao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/twocucao" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/twocucao" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-前言"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-DjangorestFramework-解读"><span class="nav-number">2.</span> <span class="nav-text">0x01 DjangorestFramework 解读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要用-DRF-呢？"><span class="nav-number">2.1.</span> <span class="nav-text">为什么要用 DRF 呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不使用-DRF-应该如何写-WebAPI-做呢？"><span class="nav-number">2.2.</span> <span class="nav-text">不使用 DRF 应该如何写 WebAPI 做呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF-处理请求的流程"><span class="nav-number">2.3.</span> <span class="nav-text">DRF 处理请求的流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-DjangorestFramework-的使用案例"><span class="nav-number">3.</span> <span class="nav-text">0x02 DjangorestFramework 的使用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何开-WebAPI-接口"><span class="nav-number">3.1.</span> <span class="nav-text">如何开 WebAPI 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端如何使用-WebAPI-接口"><span class="nav-number">3.2.</span> <span class="nav-text">前端如何使用 WebAPI 接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-RESTFUL-API-设计"><span class="nav-number">4.</span> <span class="nav-text">0x03 RESTFUL API 设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于请求"><span class="nav-number">4.1.</span> <span class="nav-text">关于请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于响应"><span class="nav-number">4.2.</span> <span class="nav-text">关于响应</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Django-的处理请求流程代码解读"><span class="nav-number">5.</span> <span class="nav-text">0x04 Django 的处理请求流程代码解读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xEE-参考链接"><span class="nav-number">6.</span> <span class="nav-text">0xEE. 参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Micheal Gardner</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

</body>
</html>
