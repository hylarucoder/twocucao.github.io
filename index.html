<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Python , Micheal Gardner , 无与童比 , twocucao , Django" />





  <link rel="alternate" href="/atom.xml" title="MG的编程小屋" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
<meta property="og:type" content="website">
<meta property="og:title" content="MG的编程小屋">
<meta property="og:url" content="http://twocucao.xyz/index.html">
<meta property="og:site_name" content="MG的编程小屋">
<meta property="og:description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MG的编程小屋">
<meta name="twitter:description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://twocucao.xyz/"/>





  <title>MG的编程小屋</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?299254d95898cdfa110fc6d914eba9c4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MG的编程小屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Get Busy Living, Or Get Busy Dying</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/07/10/PhotographyDevice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/10/PhotographyDevice/" itemprop="url">摄影入门指北</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-10T07:38:19+08:00">
                2018-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/写在人生的边上/" itemprop="url" rel="index">
                    <span itemprop="name">写在人生的边上</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  1,947
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><h3 id="本文目录"><a href="#本文目录" class="headerlink" title="本文目录"></a>本文目录</h3><h2 id="0x01-硬件选择"><a href="#0x01-硬件选择" class="headerlink" title="0x01 硬件选择"></a>0x01 硬件选择</h2><h3 id="机身"><a href="#机身" class="headerlink" title="机身"></a>机身</h3><p>a6000 是笔者的第一款相机，a6500 是第二款相机。</p>
<p>之所以这么选择，其实原因很简单 — 因为贫穷限制了我的设备。</p>
<p>如果觉得花在机身和镜头的钱可以在 3W-4W 左右，出门右转索尼 A7RM3 + 中高端镜头配置。</p>
<p>在预算不足的情况下，为什么是 A6000 和 A65000？</p>
<blockquote>
<p>A6000 基本上入门微单的性价比之王。</p>
</blockquote>
<p>所以，我刚入门的时候，选择的是 A6000，当然，如果站在现在的需求角度来说的话，肯定应该是一步到位，直接 A6500 合适（因为现在舍得花这个钱了，当时不舍得）。</p>
<p>当时选择 a6000</p>
<ol>
<li>具备足够使用的基本功能</li>
<li>对焦速度快</li>
<li>性价比高</li>
<li>WIFI/NFC 导图，Sony Play Memory 还是很实用的。</li>
</ol>
<p>当然，其实这些特点往往都会有个前提，即：</p>
<p>比如说对焦速度快，我实际想说的是，在这个价位下，对焦速度快。</p>
<p>机身往往代表的是机身性能和操作体验上的不同。也就是说，如果只是基本的拍照，比如说只拍人物小清新，A6500 和 A6000 都可以胜任。</p>
<p>我觉得有什么是 A6500 做得到但是 A6000 做不到的呢</p>
<p>但比如说，你拍运动场景或者是拍视频，A6000 的对焦速度明显就跟不上了。究其原因，无非是对焦点位数量少，机器处理性能也不足。究其本质经济原因，无非就是一个字 – 穷。<br>但比如说，你拍完照片相机需要写照片到 SD 卡中。这个过程对于 A6000 是同步的，也就是等待写入完毕才可以进行操作。但是对于 A6500 几乎算是异步的（我猜应该是图片渲染是同步，写入是异步，但由于渲染速度比较快，写入速度比较慢，所以将写入做成了异步）</p>
<p>我觉得有什么是 A6500 改善了我的拍照工作流，但是 A6000 没有改善我的工作流呢？</p>
<ul>
<li>更加流畅：机身性能摆在那</li>
<li>无脑的对焦：触屏对焦 + 加上更加强悍的追焦系统</li>
<li>更好的防抖：在不带三脚架的情况下，五轴防抖的功能可以减少我拍糊掉的几率，特别是光线不够好的情况下。可以让我在一些场景里不需要动用三脚架，轻装上阵。拥有更好的防抖时候可以在 M 档选择更慢的快门，弥补光线上的不足。</li>
</ul>
<p>笔者比较倾向于抓拍，这两点可以让笔者显著提升抓拍数量和质量，从而选出高质量照片。</p>
<p>摄影是一个综合性的技能，如果你的目的是拍出好看的照片，而不是尝试各种风格 / 场景。 笔者认为选一个超出预算的器材会让你的工作流更加顺畅一些，但并不是必须要换个。</p>
<ol>
<li>机身性能不足，防抖功能不足的情况下，可以通过预先在心里构思好拍摄。心里多做些推演工作，就好了。</li>
<li>光线亮度不够，一来可以通过提升周围环境的亮度来解决（打光，闪光灯加柔光罩之类），二来可以提升光圈大小，带上三脚架来提升曝光。三来比如你在夜景下，可以找选择一个比较好场景来拍。比如借助商场的灯完全可以拍个人像大片出来。天时地利人和就没得调整么？非要选个乌漆麻黑的伸手不见五指的拍夜景？</li>
</ol>
<p>虽然说，一般是越贵的机身越好。</p>
<p>但机身真的那么万能嘛：</p>
<ul>
<li>能解决烂手骚操作么？</li>
<li>能解决烂场景强行拍好片么？</li>
<li>能解决审美问题么？</li>
<li>能引导模特的摆姿么？</li>
<li>能解决外部光线么？</li>
<li>能解决构图么？</li>
<li>能解决后期不会调整么？</li>
</ul>
<p>帮助真的很有限。</p>
<h3 id="镜头"><a href="#镜头" class="headerlink" title="镜头"></a>镜头</h3><p>我入手了几款镜头，用下来觉得还行的镜头如下：</p>
<h4 id="索尼-E-18135"><a href="#索尼-E-18135" class="headerlink" title="索尼 E 18135"></a>索尼 E 18135</h4><ul>
<li>根本目标：用于覆盖焦距</li>
<li>优点：画质好，光学防抖</li>
<li>使用状况： 带出</li>
</ul>
<h4 id="索尼-E-50-1-8"><a href="#索尼-E-50-1-8" class="headerlink" title="索尼 E 50 1.8"></a>索尼 E 50 1.8</h4><ul>
<li>根本目标：人像室外专用</li>
<li>优点：近中距离拍妹子好看拍妹子好看拍妹子好看</li>
<li>缺点：小室内拍摄距离比较不好控制。</li>
<li>使用状况： 带出</li>
</ul>
<h4 id="适马-E-30-1-4"><a href="#适马-E-30-1-4" class="headerlink" title="适马 E 30 1.4"></a>适马 E 30 1.4</h4><ul>
<li>根本目标：室内人像、室外人像纪实</li>
<li>优点：近距拍妹子好看拍妹子好看拍妹子好看</li>
<li>缺点：近中距内拍摄容易乱入路人甲。</li>
<li>使用状况： 带出</li>
</ul>
<h4 id="七巧匠-E-12-2-8"><a href="#七巧匠-E-12-2-8" class="headerlink" title="七巧匠 E 12 2.8"></a>七巧匠 E 12 2.8</h4><ul>
<li>根本目标：覆盖广角</li>
<li>优点：经济</li>
<li>使用状况： 带出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 自带头 E 16-50	相对而言一般般	闲置（不过录像效果还是不错滴）</div><div class="line"># 索尼 E 55-210	远距离拍摄 / 小动物	看情况（不过拍出来的画面比较肉）</div></pre></td></tr></table></figure>
<h3 id="灯光"><a href="#灯光" class="headerlink" title="灯光"></a>灯光</h3><p>布光是摄影师必备技能之一</p>
<p>我入手了一款闪光灯 + 柔光罩，用于弥补某些暗场景下的光线不足的问题。毕竟笔者是业余爱好者，也懒得动用专业的设备了，太折腾。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>摄影包</li>
<li>充电器</li>
<li>存储卡</li>
<li>其他牌子的电池</li>
</ul>
<h2 id="0x02-摄影参数"><a href="#0x02-摄影参数" class="headerlink" title="0x02 摄影参数"></a>0x02 摄影参数</h2><p>曝光正常的参数</p>
<h3 id="曝光三要素"><a href="#曝光三要素" class="headerlink" title="曝光三要素"></a>曝光三要素</h3><h4 id="光圈"><a href="#光圈" class="headerlink" title="光圈"></a>光圈</h4><h5 id="如何影响照片"><a href="#如何影响照片" class="headerlink" title="如何影响照片"></a>如何影响照片</h5><p>通关孔的大小影响：</p>
<pre><code>- 进光量
</code></pre><h5 id="影响照片参数"><a href="#影响照片参数" class="headerlink" title="影响照片参数"></a>影响照片参数</h5><p>亮度<br>景深</p>
<h5 id="使用基本方法"><a href="#使用基本方法" class="headerlink" title="使用基本方法"></a>使用基本方法</h5><ol>
<li>大光圈<ul>
<li>背景虚化</li>
<li>提升快门速度</li>
</ul>
</li>
<li>小光圈<ul>
<li>整体清晰</li>
<li>降低快门速度</li>
</ul>
</li>
</ol>
<h4 id="快门"><a href="#快门" class="headerlink" title="快门"></a>快门</h4><h5 id="如何影响照片-1"><a href="#如何影响照片-1" class="headerlink" title="如何影响照片"></a>如何影响照片</h5><p>进光时间</p>
<h5 id="影响照片参数-1"><a href="#影响照片参数-1" class="headerlink" title="影响照片参数"></a>影响照片参数</h5><h5 id="使用基本方法-1"><a href="#使用基本方法-1" class="headerlink" title="使用基本方法"></a>使用基本方法</h5><h4 id="感光度"><a href="#感光度" class="headerlink" title="感光度"></a>感光度</h4><h5 id="如何影响照片-2"><a href="#如何影响照片-2" class="headerlink" title="如何影响照片"></a>如何影响照片</h5><pre><code>CCD 感光敏感度
</code></pre><h5 id="影响照片参数-2"><a href="#影响照片参数-2" class="headerlink" title="影响照片参数"></a>影响照片参数</h5><pre><code>1. 亮度
2. 噪点
</code></pre><h5 id="使用基本方法-2"><a href="#使用基本方法-2" class="headerlink" title="使用基本方法"></a>使用基本方法</h5><pre><code>1. 通常情况下设置比较低
2. 除非是光圈和快门被限制
</code></pre><h4 id="曝光三要素综合应用"><a href="#曝光三要素综合应用" class="headerlink" title="曝光三要素综合应用"></a>曝光三要素综合应用</h4><pre><code>1. 大光圈
2. 大长焦
3. 镜头离主体要近
4. 主体离背景要远
</code></pre><h3 id="曝光模式"><a href="#曝光模式" class="headerlink" title="曝光模式"></a>曝光模式</h3><p>自动 / 手动控制曝光</p>
<ol>
<li>智能自动</li>
<li>P 档：光圈和快门由相机设置，但是 ISO/ 对焦区域 / 测光模式 （比如夜景，当然，可能需要三脚架）</li>
<li>A 档：快门由相机设置，光圈和 ISO 可以自己调节 （比如大光圈的人像，小光圈的风景）</li>
<li>S 档：快门和 ISO 由相机设置，快门 /ISO 由自己调节。（比如快速移动的物品 / 慢速快门拍尾灯拉丝）</li>
<li>M 档：手动档位，可以用于更加细腻的操作。</li>
</ol>
<h3 id="测光模式"><a href="#测光模式" class="headerlink" title="测光模式"></a>测光模式</h3><ol>
<li>多重测光 （多重测光的弊病在于如果整体较亮，而主体较暗，就容易拍不亮主体）</li>
<li>点测光 （适用于拍摄夕阳 / 逆光人像，缺点就是 ISO 的值会比较高）</li>
</ol>
<h3 id="曝光补偿"><a href="#曝光补偿" class="headerlink" title="曝光补偿"></a>曝光补偿</h3><p>笔者一般会用 LR 做一个简单的后期，所以用 RAW 作为图片格式。</p>
<h2 id="0x03-拍清照片"><a href="#0x03-拍清照片" class="headerlink" title="0x03 拍清照片"></a>0x03 拍清照片</h2><h3 id="对焦错误"><a href="#对焦错误" class="headerlink" title="对焦错误"></a>对焦错误</h3><pre><code>1. 半按快门对焦
2. 对焦对偏了
    a. 拍人对焦不准 : 笑脸 / 人脸检测
    b. 拍静物 / 风景时对焦不准 : 自由点对焦
    c. 给自己打光
3. 对焦模式不对
    a. AF-S 单次自动对焦 - 静物
    b. AF-C 连续自动对焦 - 动物
    c. AF-A 智能自动对焦 - 对方可能动 / 可能不动
</code></pre><h3 id="手抖了"><a href="#手抖了" class="headerlink" title="手抖了"></a>手抖了</h3><pre><code>1. 拍照姿势不对
2. 安全快门时间 = 1 / （焦距 * 1.5)
3. 光线比较暗导致快门低于 1/30 s
</code></pre><h2 id="0xEE-结论"><a href="#0xEE-结论" class="headerlink" title="0xEE 结论"></a>0xEE 结论</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/06/29/PythonBugWithZipfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/29/PythonBugWithZipfile/" itemprop="url">记一个有趣的 Python ZipInfo 的副作用</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-29T08:31:11+08:00">
                2018-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  845
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>昨天修了一个有趣的 BUG，顺手分享出来。</p>
<h3 id="本文目录"><a href="#本文目录" class="headerlink" title="本文目录"></a>本文目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">▼ 0x00 前言 : section</div><div class="line">    本文目录 : section</div><div class="line">▼ 0x01 场景 1 - 空文件打包问题 : section</div><div class="line">▼ 0x02 场景 2 - zipinfo 带来的一个副作用 : section</div><div class="line">▼ 0x03 处理 BUG 的一种姿势 : section</div><div class="line">▼ 0xEE 结论 : section</div></pre></td></tr></table></figure>
<h2 id="0x01-场景-1-空文件打包问题"><a href="#0x01-场景-1-空文件打包问题" class="headerlink" title="0x01 场景 1 - 空文件打包问题"></a>0x01 场景 1 - 空文件打包问题</h2><p>原始场景是这样的，在打包文件夹的时候，一切正常，但如果打包空文件夹的时候，就出问题了。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/164492147450b039?w=756&amp;h=256&amp;f=png&amp;s=37953" alt=""></p>
<p>精简了这一段代码，当打包空文件夹的时候，大致逻辑如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import zipfile</div><div class="line"></div><div class="line">zfile = zipfile.ZipFile(&quot;tmp.zip&quot;,&apos;w&apos;)</div><div class="line"># 递归打包所有子文件</div><div class="line">zfile.close()</div></pre></td></tr></table></figure>
<p>这段代码很明显是造了一个空 zip 文件。</p>
<p>这个和我要的效果还不太一样。我要的是这个 zip 文件包含空目录 tmp/ 好，调整了一下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">import zipfile</div><div class="line"></div><div class="line">zfile = zipfile.ZipFile(&quot;tmp.zip&quot;,&apos;w&apos;)</div><div class="line">zif = zipfile.ZipInfo(&quot;tmp/&quot;)</div><div class="line">zfile.writestr(zif,&quot;&quot;)</div><div class="line"># 递归打包所有子文件</div><div class="line">zfile.close()</div></pre></td></tr></table></figure>
<p>嗯，现在下载成功了。解压缩也正常。</p>
<h2 id="0x02-场景-2-zipinfo-带来的一个副作用"><a href="#0x02-场景-2-zipinfo-带来的一个副作用" class="headerlink" title="0x02 场景 2 - zipinfo 带来的一个副作用"></a>0x02 场景 2 - zipinfo 带来的一个副作用</h2><p>显然，如果上面的东西皆大欢喜的结束了，我就没必要写这篇文章了。</p>
<p>问题来了，当我递归打包子文件的时候，文件会莫名其妙多了一个文件夹出来。</p>
<p>比如我打包文件夹 tmp，tmp 的内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ tree tmp</div><div class="line">tmp</div><div class="line">├── test.md</div><div class="line"></div><div class="line">1 file</div></pre></td></tr></table></figure>
<p>打包完毕多出了一个 tmp 文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ tree tmp</div><div class="line">tmp</div><div class="line">├── test.md</div><div class="line">└── tmp</div><div class="line"></div><div class="line">1 directory, 1 file</div></pre></td></tr></table></figure>
<p>这种多出一个 tmp 的文件夹就是按照我这种方式使用 zipinfo 副作用。</p>
<p>WTF，怀着老鹿蹒跚的内心，打开了《伤心太平洋》：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">一波还未平息</div><div class="line">一波又来侵袭</div><div class="line">茫茫人海 狂风暴雨</div></pre></td></tr></table></figure>
<p>用代码复现一波场景</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 先造一个测试文件夹</div><div class="line">mkdir /tmp/test_folder/</div><div class="line">touch /tmp/test_folder/test.md</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import zipfile</div><div class="line">file_path = &quot;/tmp/test_folder/test.md&quot;</div><div class="line">rel_name = &quot;test.md&quot;</div><div class="line">zfile = zipfile.ZipFile(&quot;tmp.zip&quot;,&apos;w&apos;)</div><div class="line">zif = zipfile.ZipInfo(&quot;tmp/&quot;)</div><div class="line">zfile.writestr(zif,&quot;&quot;)</div><div class="line">zfile.write(file_path, rel_name)</div><div class="line">zfile.close()</div></pre></td></tr></table></figure>
<h2 id="0x03-处理-BUG-的一种姿势"><a href="#0x03-处理-BUG-的一种姿势" class="headerlink" title="0x03 处理 BUG 的一种姿势"></a>0x03 处理 BUG 的一种姿势</h2><ol>
<li>场景能否描述出来 - 描述不出来的就没法准确定位问题</li>
<li>能否复现 - 复现不出来的 BUG 最难调试</li>
<li>业务问题还是技术问题 - 业务问题可能要和别人打交道，技术问题可能要多翻翻文档之类的。</li>
<li>时间是否来得及 - 如果时间来的及，就想办法弄懂，填坑；时间来不及就想办法规避，绕坑。</li>
</ol>
<p>前三点自然不用说了，直接第四点，时间上还算充裕，</p>
<ol>
<li>我翻了半天 zipfile 模块，并没有理解这个 BUG 的出现原因。</li>
<li>好，退后一步是人生，用代码规避掉这个问题。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import zipfile</div><div class="line"></div><div class="line">if 是空文件夹：</div><div class="line">    zfile = zipfile.ZipFile(&quot;tmp.zip&quot;,&apos;w&apos;)</div><div class="line">    zif = zipfile.ZipInfo(&quot;tmp/&quot;)</div><div class="line">else 不是空文件夹：</div><div class="line">    zfile.writestr(zif,&quot;&quot;)</div><div class="line">    zfile.write(file_path, rel_name)</div><div class="line">zfile.close()</div></pre></td></tr></table></figure>
<h2 id="0xEE-结论"><a href="#0xEE-结论" class="headerlink" title="0xEE 结论"></a>0xEE 结论</h2><p>其实处理大部分的 BUG 基本上就是这么个思路：</p>
<ul>
<li>往前一步是黄昏：打破沙锅问到底的去探究，填坑</li>
<li>退后一步是人生：没那么多时间搞明白细枝末节，用代码规避掉这个神奇 BUG，先让业务可以跑通，绕坑。</li>
</ul>
<p>最后，欢迎关注我的知乎专栏，咱们聊聊我所知道的 Python / NodeJS/ Mac / DevOps 全栈（干）工程师的一些有趣的技术</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/twocucao" target="_blank" rel="external">MG 的编程小屋</a></li>
<li><a href="https://github.com/twocucao" target="_blank" rel="external">MG 的 Github</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/06/10/SynologyNas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/10/SynologyNas/" itemprop="url">Synology 群晖 NAS 入门指北</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-10T11:52:36+08:00">
                2018-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  1,471
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>百度云的人工智障总是误删我的文件，于是开始寻找其他存储方案。决定入手一台 NAS.</p>
<h3 id="组装机-品牌机"><a href="#组装机-品牌机" class="headerlink" title="组装机 / 品牌机"></a>组装机 / 品牌机</h3><p>视具体情况，笔者缺乏足够的精力去折腾，如果精力足够，我还是很倾向于自己组装一台 nas 的。不过，现在年纪大了，还是老老实实买个品牌的 NAS 好了，折腾大抵是年轻人的事情。</p>
<p>为啥买群晖？因为看到很多喜欢折腾的人都安装黑群晖，所以直接买了个白群晖。</p>
<h3 id="本文目录"><a href="#本文目录" class="headerlink" title="本文目录"></a>本文目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">▼ 0x00 前言 : section</div><div class="line">    组装机 / 品牌机 : section</div><div class="line">  ▼ 0x01 安装 / 配置 : section</div><div class="line">      STEP-0 设备 : section</div><div class="line">      STEP-1 组装 : section</div><div class="line">      STEP-2 组网 : section</div><div class="line">      STEP-3 安装系统 : section</div><div class="line">  ▼ 0x02 一些私人化的需求 : section</div><div class="line">      2.1 内网 NAS 使用 : section</div><div class="line">      2.2 外网 NAS 使用 : section</div><div class="line">    ▼ 2.3 与百度云结合 : section</div><div class="line">        如何同步数据 : section</div><div class="line">      2.3 Time Machine : section</div><div class="line">    0xEE 结论 : section</div></pre></td></tr></table></figure>
<h2 id="0x01-安装-配置"><a href="#0x01-安装-配置" class="headerlink" title="0x01 安装 / 配置"></a>0x01 安装 / 配置</h2><h3 id="STEP-0-设备"><a href="#STEP-0-设备" class="headerlink" title="STEP-0 设备"></a>STEP-0 设备</h3><ul>
<li>路由器一台</li>
<li>网线一根</li>
<li>Synology 一台，笔者使用的是 DS218j 2 盘位 NAS （这款家用基本上够用了）</li>
<li>硬盘两个，推荐 WD 的红盘或者希捷的狼盘。</li>
</ul>
<h3 id="STEP-1-组装"><a href="#STEP-1-组装" class="headerlink" title="STEP-1 组装"></a>STEP-1 组装</h3><p>把硬盘安装在 nas 里需要三个步骤</p>
<ol>
<li>打开 nas 外壳</li>
<li>把硬盘塞进去</li>
<li>把盒子盖上</li>
</ol>
<h3 id="STEP-2-组网"><a href="#STEP-2-组网" class="headerlink" title="STEP-2 组网"></a>STEP-2 组网</h3><ol>
<li>如果你的路由器可以直连宽带接口的话，则直接连接。</li>
<li>如果你的路由器上一级有个路由器的话，可以使用桥接模式，把这台路由器连到上一台路由器上。</li>
</ol>
<p>nas 建议直接用网线连接到路由器上。</p>
<p>那么，现在你的手机 / 笔记本 / 平板等等放到该局域网中。</p>
<blockquote>
<p>PS: 为什么需要这么做？因为所有环境放在一个局域网内的话，安全性和速度较好。</p>
</blockquote>
<h3 id="STEP-3-安装系统"><a href="#STEP-3-安装系统" class="headerlink" title="STEP-3 安装系统"></a>STEP-3 安装系统</h3><p>打开群晖机器开关，在同一局域网内的访问</p>
<p><a href="http://find.synology.com/" target="_blank" rel="external">http://find.synology.com/</a></p>
<p>然后按照要求进行注册登陆</p>
<p>期间需要注册群晖的账号，以及本台机器的用户名和密码。</p>
<h2 id="0x02-一些私人化的需求"><a href="#0x02-一些私人化的需求" class="headerlink" title="0x02 一些私人化的需求"></a>0x02 一些私人化的需求</h2><h3 id="2-1-内网-NAS-使用"><a href="#2-1-内网-NAS-使用" class="headerlink" title="2.1 内网 NAS 使用"></a>2.1 内网 NAS 使用</h3><p>笔者使用的是 Mac 电脑，在 Finder 中直接链接服务器，输入 smb://mynas 即可访问。剩下的操作基本上和本地磁盘使用起来没有什么大的差别。</p>
<p>对于手机和平板，安装群晖对应的 Drive 即可。</p>
<h3 id="2-2-外网-NAS-使用"><a href="#2-2-外网-NAS-使用" class="headerlink" title="2.2 外网 NAS 使用"></a>2.2 外网 NAS 使用</h3><p>外网可以直接使用群晖的账号登录群晖的官网，接着控制这台群晖的机器进行下载。但速度不够。</p>
<p>使用下来感觉效果并不好。建议阅读下一章和百度云配合使用。</p>
<h3 id="2-3-与百度云结合"><a href="#2-3-与百度云结合" class="headerlink" title="2.3 与百度云结合"></a>2.3 与百度云结合</h3><p>百度云这个东西让人又爱又恨。</p>
<ul>
<li>爱的是，容量不错，部分热门资源的下载速度也可。</li>
<li>恨的是，老是莫名其妙删掉我的文件。冷门资源那下载速度真的是….</li>
</ul>
<p>而现在，现在我的文件就分为两种：</p>
<ul>
<li>一种是合规的不可丢失的文件</li>
<li>一种是合规的可丢失的文件</li>
</ul>
<p>像我这样贯彻社会主义核心价值观的人，所有文件都是合法合规的。接受文件的审查倒也能接受，但人工智障老是误删我的合法文件这尼玛给我工作生活带来困扰啊。</p>
<p>所以，</p>
<ul>
<li>对于丢失零容忍的文件可以考虑放在 Nas 中。</li>
<li>对于丢失可容忍的文件可以考虑放在百度云中。</li>
<li>对于日常使用的文档可以放在百度云中。</li>
</ul>
<h4 id="如何同步数据"><a href="#如何同步数据" class="headerlink" title="如何同步数据"></a>如何同步数据</h4><p>鉴于百度云开放了应用接口，群晖的 Nas 也可以实现百度云同步数据到 Nas 上。</p>
<p>安装 CloudSync 选择第三方供应商。百度云，完成授权。</p>
<p>设置双向同步到 DMS 的某个文件夹下。比如，笔者同步百度云的文件到本地 DSM /CloudDrive/BaiduPan/ 即完成最基本的设置了。</p>
<p><strong>如何同步本地数据到云端呢？</strong></p>
<p>然后随便复制一个文件到该文件夹下，然后在百度云的 Web 端的『我的应用数据 /Cloud Sync 』 文件夹下就可以看到资源了。</p>
<p><strong>那么，如何同步云端的数据到本地呢？</strong></p>
<p>把云端的数据（文件 / 文件夹）拖动到 『我的应用数据 /Cloud Sync 』里即可。</p>
<p>像一些非私密性的文件，扔百度云就好了。</p>
<p>这个 Nas 就相当于一个远程的拥有高容量的弱鸡服务器，可以用来跑跑一些下载任务之类。</p>
<h3 id="2-3-Time-Machine"><a href="#2-3-Time-Machine" class="headerlink" title="2.3 Time Machine"></a>2.3 Time Machine</h3><p>Nas 另一个吸引我的地方就是可以 Time Machine 进行备份了。步骤大致如下。</p>
<ol>
<li>『共享文件夹』里面新建文件夹 Time Machine</li>
<li>『文件服务』中开启 SMB/AFP 服务，在高级设置中启用 Bonjour , 启用 SMB/AFP 的 TimeMachine 播送，指定为 Time Machine 文件夹</li>
<li>『用户管理』里新建用户 TimeMachine, 容量限制一下，建议 1TB 即可。</li>
<li>打开 Mac 电脑，选择磁盘，然后开始备份。</li>
</ol>
<p>PS: 但我这边初次备份 TM 的时候，需要备份 300+GB 的文件，速度确实堪忧。和直接外接接口连接硬盘完全没法比。但慢慢备份下来，其实速度也能接受。</p>
<h2 id="0xEE-结论"><a href="#0xEE-结论" class="headerlink" title="0xEE 结论"></a>0xEE 结论</h2><p>NAS 解决了我的几个痛点。</p>
<ul>
<li>跨平台共享文件</li>
<li>文件集中化管理</li>
<li>硬盘容量大</li>
<li>私密性较好</li>
<li>不会有人工智障来删我东西</li>
<li>速度在可接受范围内。我在用 LR 修图的时候只是稍微比本地的慢一点。</li>
</ul>
<p>不过似乎还有一些其他的功能可以继续发掘一下。以后有机会再分享一下。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/06/06/CPython/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/06/CPython/" itemprop="url">CPython 源码初步阅读笔记</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-06T10:08:12+08:00">
                2018-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  222
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>先挖坑，以后有机会填</p>
<p>├── Grammar # 语法<br>├── Include # C 语言头文件，如果需要自定义模块扩展 Python, 也需要这块。<br>├── Modules # C 语言编写的模块，对速度要求高，比如 random<br>├── Objects # 内建对象 包含整数，list,dict 等。<br>├── Parser # Scanner 和 parser<br>├── Python # 各种 Python 共享库<br>├── Lib # Python 自带的所有标准库<br>├── Doc # 文档<br>├── Tools # 一些 Python 程序，方便扩展 Python<br>├── Misc # 不清楚放哪，就放这里好了<br>├── PC # Windows 编译姿势<br>├── PCbuild # Windows 编译姿势<br>├── Mac # Mac 上编译姿势<br>├── Programs<br>├── README.rst<br>├── aclocal.m4<br>├── config.guess<br>├── config.sub<br>├── configure<br>├── configure.ac<br>├── install-sh<br>├── m4<br>├── pyconfig.h.in<br>├── setup.py<br>├── LICENSE<br>├── Makefile.pre.in</p>
<h2 id="Ch01-Python-对象初探"><a href="#Ch01-Python-对象初探" class="headerlink" title="Ch01 Python 对象初探"></a>Ch01 Python 对象初探</h2><p>一切都是对象</p>
<p>类型对象</p>
<ul>
<li>内置对象：int / string / dict</li>
<li>自定义对象：class A</li>
</ul>
<p>实例对象</p>
<h3 id="1-1-Python-内的对象"><a href="#1-1-Python-内的对象" class="headerlink" title="1.1 Python 内的对象"></a>1.1 Python 内的对象</h3><p>Python 里的对象就是 C 中结构体在堆上申请的一块内存。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/05/22/pipenv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/22/pipenv/" itemprop="url">Python 自动化工具 Fabric 支持 Python3 了</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-22T21:11:03+08:00">
                2018-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  610
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>当大家还在纠结 Python2 与 Python3 的时候，我其实早就入了 python3 的门了。</p>
<p>后来</p>
<ul>
<li><del>我总算学会了如何去爱。<del></del></del></li>
<li>我喜欢的工具陆陆续续支持了 Python3</li>
<li>Scrapy 支持了 Python3</li>
<li>Ansible 支持了 Python3</li>
</ul>
<p>只有 Fabric 这个工具，死撑着没有支持 Python3 的的迹象。</p>
<p>2018-05-08 的时候，Fabric 悄悄升级了 2.0 版本。</p>
<p>而就在前两天，我升级网站的时候，突然发现 fabric (1.14 版本） 不能用了。</p>
<p>查了一下版本，发现 fabric 更新到了 2.0 版本，支持了 python3.4</p>
<p>在发现这个问题之后，火速刷了一波官方文档，把手头 Fabric 1.14 版本的脚本做了一些升级。</p>
<h3 id="从-V1-到-V2"><a href="#从-V1-到-V2" class="headerlink" title="从 V1 到 V2"></a>从 V1 到 V2</h3><p>Fabric v2 基于 invoke 和 paramiko 两个库构建而成。</p>
<ul>
<li>invoke 库提供了 subprocess command execution 和 command-line</li>
<li>paramiko 提供了 ssh 协议实现</li>
</ul>
<p>在这两者的基础上，做了一些扩展。</p>
<p>甚至，如果你只用其中的本地功能，你都完全不需要使用 fabric, 直接用 invoke 即可。没错，我已经打算把我的本地脚本全部使用 invoke Python3 化了。</p>
<p>v1 版本和 v2 版本初步用起来，个人觉得 v1 用起来 API 更加符合直觉一些。</p>
<p>这东西怎么用呢？</p>
<p>我们先定义 fabfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># fabfile.py</div><div class="line">from invoke import task</div><div class="line"></div><div class="line">def expand_path(c, path):</div><div class="line">    return &apos;&quot;$(echo %s)&quot;&apos; % path</div><div class="line"></div><div class="line">def exists(c, path):</div><div class="line">    cmd = &apos;stat %s&apos; % expand_path(c, path)</div><div class="line">    return c.run(cmd, warn=True, hide=True).ok</div><div class="line"></div><div class="line">@task</div><div class="line">def deploy(c):</div><div class="line">    c.local(&quot;youcmd&quot;)</div><div class="line">    c.put()</div><div class="line">    c.get()</div><div class="line">    c.run()</div><div class="line">    c.run(&quot;sudo youcmd&quot;)</div><div class="line">    ......</div><div class="line"></div><div class="line">@task</div><div class="line">def other_stuff(c):</div><div class="line">    ......</div></pre></td></tr></table></figure>
<p>需要注意的是，invoke 里面默认的 replace_env 设置为了 False ,fabric 里面给 runner 设置了 replace_env 为 True , 这也就意味着默认情况下，执行 c.local 的时候会找不到自定义的环境变量，这意味着：</p>
<ol>
<li>你的 PATH 被重置了，这意味着你用 brew 安装的软件可能已经完全找不到了。</li>
<li>你的环境变量 LANG 并不一定是 en_US.UTF-8 了</li>
</ol>
<p>于是设置一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># ~/.fabric.py</div><div class="line">#!/usr/bin/env python</div><div class="line"># encoding: utf-8</div><div class="line"></div><div class="line">run = &#123;</div><div class="line">    &quot;replace_env&quot;: False</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我要部署的时候直接执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fab -H webserver01,webserver02,webserver03,webserver04 deploy</div></pre></td></tr></table></figure>
<p>到这里大家基本上看出来了，我并没有在文件中 import fabric 只是简单了配置了一个配置文件和执行一下 fab 命令。</p>
<p>这个 v2 版本的 fabric 相当于 invoke 的包装。但我们也可以显式的 import fabric 里面的东西进行更加进阶的操作。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/05/22/fabric2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/22/fabric2/" itemprop="url">PyCon 2018 之 pipenv -- 未来的 Python 依赖管理工具</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-22T21:11:03+08:00">
                2018-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  1,094
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>PyCon 2018 有很多精彩的演讲，今天的文章里，介绍一下 K 神的演讲 『Python 未来的包管理工具 pipenv』</p>
<p>Kenneth Reitz 出品，必属精品。</p>
<h3 id="Python-打包历史"><a href="#Python-打包历史" class="headerlink" title="Python 打包历史"></a>Python 打包历史</h3><p>刚开始的时候，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl http://pypi.python.org/packages/alsdasdl/requests.tar.gz | tar zxf</div><div class="line">cd requests/</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<p>这个问题初看起来不是问题，但是随着你安装程序的增多就知道有多么痛苦了。</p>
<ol>
<li>有的依赖库依赖别的库你怎么解决？比如 pandas 需要安装 numpy</li>
<li>有的依赖库依赖 c 库怎么办？比如 LXML</li>
<li>在 python2.6.5 下，如果我需要安装两个不同版本的 Django 开发不同的软件怎么办？难道只能动态复制文件到 site-packages 里面？</li>
</ol>
<p>后来，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">easy_install requests</div></pre></td></tr></table></figure>
<p>我们可以直接从 pypi 进行安装了。但尼玛，为什么 easy_install 安装很 easy, 但是没有 easy_uninstall?</p>
<p>好，2010 年后，我们继续前进：</p>
<ul>
<li>可以通过 pip 替代 easy_install 了。</li>
<li>可以通过 virtualenv 管理项目的依赖库了。虽然说，还是不能像 ruby gem 一样同时把多个版本的的软件装在同一个系统里。</li>
<li>可以通过 requirements 锁依赖了。</li>
</ul>
<p>但，同期的其他编程语言社区分别出现了如下的包管理工具：</p>
<ul>
<li>node -&gt; yarn &amp;&amp; npm , 有 lockfile</li>
<li>php -&gt; composer , 有 lockfile</li>
<li>rust -&gt; cargo , 有 lockfile</li>
<li>ruby -&gt; bundler , 有 lockfile</li>
</ul>
<p>而我大 Python 居然没跟上潮流</p>
<ul>
<li>python -&gt; pip &amp;&amp; virtualenv/venv , 无 lockfile</li>
</ul>
<blockquote>
<p>PS: Python3.3 之后，默认可以直接使用 venv 模块，不需要再安装 virtualenv 了。但还是需要手动，并且用起来比较反直觉。</p>
</blockquote>
<p>关于 requirements.txt</p>
<ul>
<li>如果你使用 pip freeze 来形成这个文件，则不直观，完全看不出来哪个依赖库依赖哪个依赖。</li>
<li>如果你直接手动指定你所需要的库，比如 flask 的话，似乎又有些太直观了。</li>
</ul>
<p>如果能有一个东西，既可以表示 freeze 的结果 (what you want)，又可以表示你需要的库 (what you need). 就好了。</p>
<blockquote>
<p>这当然可以考虑用两份 requirements 来解决。先安装 what you need 用来开发，然后 freeze 为 what you want 去部署。</p>
</blockquote>
<p>当然，铺垫了这么多 K 神肯定是来介绍他的 pipenv 的。</p>
<p>比如说，我想查看，本项目的依赖库，直接 pipenv graph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">coverage==4.5.1</div><div class="line">fabric==2.0.1</div><div class="line">  - cryptography [required: &gt;=1.1, installed: 2.2.2]</div><div class="line">    - asn1crypto [required: &gt;=0.21.0, installed: 0.24.0]</div><div class="line">    - cffi [required: &gt;=1.7, installed: 1.11.5]</div><div class="line">      - pycparser [required: Any, installed: 2.18]</div><div class="line">    - idna [required: &gt;=2.1, installed: 2.6]</div><div class="line">    - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">  - invoke [required: &lt;2.0,&gt;=1.0, installed: 1.0.0]</div><div class="line">  - paramiko [required: &gt;=2.4, installed: 2.4.1]</div><div class="line">    - bcrypt [required: &gt;=3.1.3, installed: 3.1.4]</div><div class="line">      - cffi [required: &gt;=1.1, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">    - cryptography [required: &gt;=1.5, installed: 2.2.2]</div><div class="line">      - asn1crypto [required: &gt;=0.21.0, installed: 0.24.0]</div><div class="line">      - cffi [required: &gt;=1.7, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - idna [required: &gt;=2.1, installed: 2.6]</div><div class="line">      - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">    - pyasn1 [required: &gt;=0.1.7, installed: 0.4.2]</div><div class="line">    - pynacl [required: &gt;=1.0.1, installed: 1.2.1]</div><div class="line">      - cffi [required: &gt;=1.4.1, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - six [required: Any, installed: 1.11.0]</div><div class="line">flake8==3.5.0</div><div class="line">  - mccabe [required: &gt;=0.6.0,&lt;0.7.0, installed: 0.6.1]</div><div class="line">  - pycodestyle [required: &lt;2.4.0,&gt;=2.0.0, installed: 2.3.1]</div><div class="line">  - pyflakes [required: &gt;=1.5.0,&lt;1.7.0, installed: 1.6.0]</div><div class="line"># 其他省略</div></pre></td></tr></table></figure>
<p>如何尝鲜？我最近更新到了之前写的一个库（代码写的惨不忍赌，最近准备重构，勿喷）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">git clone git@github.com:twocucao/YaPyLib.git</div><div class="line">cd YaPyLib/</div><div class="line">brew install pipenv</div><div class="line">pipenv --three</div><div class="line">pipenv install --dev</div><div class="line">pipenv shell</div></pre></td></tr></table></figure>
<p>记住几个命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pipenv --venv # 查看 venv 位置</div><div class="line">pipenv --python 3.6.5</div><div class="line">exit 退出 pipenv shell</div></pre></td></tr></table></figure>
<p>至于其他的功能，参考官网自己摸索吧。</p>
<h3 id="FAQ-环节"><a href="#FAQ-环节" class="headerlink" title="FAQ 环节"></a>FAQ 环节</h3><p>FAQ 环节有一个问题非常有趣，应该把 lockfile 放在 git 仓库里面吗？</p>
<p>k 神是这么回答的 yes。 这个问题很久之前就在 issue 上回答过了</p>
<p><a href="https://github.com/pypa/pipenv/issues/598" target="_blank" rel="external">https://github.com/pypa/pipenv/issues/598</a></p>
<p>我刚开始觉得不提交会好一些，后来觉得 track 一下也无妨。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><blockquote>
<p>在用 npm 和 yarn 的时候，我有这么一个想法，希望 python 圈子里面能出一个类似于包管理工具。今年 2 月份的时候把自己的项目迁移过来，发现 pipenv 用起来很挺舒服的。</p>
<p>pipenv 是未来。火速用上吧。</p>
<p>觉得有趣就点个赞或者关注下呗。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/05/16/PyConDjango/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/16/PyConDjango/" itemprop="url">PyCon 2018 之 Django 专题与 未来的包管理工具 pipenv</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-16T19:18:35+08:00">
                2018-05-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  2,147
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>PyCon 2018 有很多精彩的演讲，今天的文章里，挑出 Django 的几篇演讲大致讲讲。</p>
<blockquote>
<p>注意：为什么是大致讲讲呢？因为即便是你看了我的这篇文章，依然需要多下点功夫自己去看演讲，自己去查资料，自己去消化。我的这篇文章只不过是我看演讲查资料慢慢消化过程中的产物而已。</p>
</blockquote>
<h2 id="0x01-演讲-1-Taking-Django-Async"><a href="#0x01-演讲-1-Taking-Django-Async" class="headerlink" title="0x01 演讲 1 - Taking Django Async"></a>0x01 演讲 1 - Taking Django Async</h2><p>本演讲其实就是为了推广 Django 的新库。django-channels</p>
<p>这个库从 2015 年首发，现在已经经过了三年的进程。应该算是相对成熟了。</p>
<p>这个库有什么不走寻常路的地方吗？答案是有的：</p>
<ol>
<li>使得 Django 增加了异步协议，比如说 WebSocket 协议</li>
<li>使得 Django 可运行后台任务。</li>
</ol>
<p>作为 v2 版本的核心开发，作者必然是要吐槽一下 v1 版本，然后推荐一下 v2 版本。</p>
<p>v1 版本的架构设计是这样的。</p>
<p>核心开发给出了这样的评价：</p>
<ol>
<li>在 Python2.7 的时候，就只能这么搞了。</li>
<li>需要维护的东西太多</li>
<li>没有 asyncio support</li>
<li>搬砖时候一不小心容易砸到脚</li>
</ol>
<blockquote>
<p>TODO : 补充一些其他的缺点</p>
</blockquote>
<p>异步与同步接口耦合</p>
<p>作者认为此并非长久之计。</p>
<p>v2 时候，</p>
<p>重写 75% 的代码</p>
<p>异步与同步接口分离</p>
<p>这么设计的话，需要解决接下来的一个问题，同步转异步，异步转同步。</p>
<p>比如，我访问 view, 实际上是 async 转 sync, 然后才能调用 django 相关的方法，接着返回响应内容的时候，我还需要 sync 转 async.<br>再比如，我使用 websocket, 访问一条数据，但 ORM 是 sync 的方法，我还是要 async 转 sync 再转 async</p>
<p>这个 async 和 sync 的相互转换应该怎么做呢？</p>
<p>于是，两个适配方法就诞生了：</p>
<ul>
<li>sync_to_async : 接收一个 async 的 function, 使之 awaitable, 然后使之在后台线程里运行。</li>
<li>async_to_sync : 接收一个 awaitable 的 coroutine , 使之转化成一个同步的 function, 该 function 暂停你调用的当前的线程，跳转到包含 eventloop 的主线程执行完毕，然后跳转回来。</li>
</ul>
<p><a href="https://www.aeracode.org/2018/02/19/python-async-simplified/" target="_blank" rel="external">https://www.aeracode.org/2018/02/19/python-async-simplified/</a></p>
<h3 id="WSGI-如何运行-async"><a href="#WSGI-如何运行-async" class="headerlink" title="WSGI 如何运行 async"></a>WSGI 如何运行 async</h3><h3 id="ASGI-如何运行-A"><a href="#ASGI-如何运行-A" class="headerlink" title="ASGI 如何运行 A"></a>ASGI 如何运行 A</h3><h3 id="这对-Django-意味着什么？"><a href="#这对-Django-意味着什么？" class="headerlink" title="这对 Django 意味着什么？"></a>这对 Django 意味着什么？</h3><h3 id="如何保持兼容性"><a href="#如何保持兼容性" class="headerlink" title="如何保持兼容性"></a>如何保持兼容性</h3><h2 id="0x02-演讲-2-Beyond-Django-Basic"><a href="#0x02-演讲-2-Beyond-Django-Basic" class="headerlink" title="0x02 演讲 2 - Beyond Django Basic"></a>0x02 演讲 2 - Beyond Django Basic</h2><p>作为一名有一定经验的 Django 开发者，用快进的方式看完了这个演讲。毕竟，我已经不是 Django 新手了。</p>
<blockquote>
<p>毕竟这篇演讲只是给那些学完 tutorial 的人</p>
</blockquote>
<p>想深入了解 Django, 多刷几遍文档比什么都好。</p>
<p>嗯，就不介绍了。</p>
<h2 id="0x03-演讲-3-Introduction-to-TDD-with-Django-amp-amp-Intermediate-testing-with-Django"><a href="#0x03-演讲-3-Introduction-to-TDD-with-Django-amp-amp-Intermediate-testing-with-Django" class="headerlink" title="0x03 演讲 3 - Introduction to TDD with Django &amp;&amp; Intermediate testing with Django"></a>0x03 演讲 3 - Introduction to TDD with Django &amp;&amp; Intermediate testing with Django</h2><p>本演讲主要内容是 TDD 测试和 Mock 的技巧。</p>
<p>建议熟手直接看演讲者的书吧，本视频本人仅仅匆匆倍速看了一遍，估计并没有超出他的书的范围。</p>
<p>简单介绍了以下内容</p>
<ul>
<li>单元测试和功能性测试</li>
<li>通过 Selenium browser 进行自动化测试</li>
<li>unittest 标准库</li>
<li>Django models, views and templates</li>
<li>测试前后端代码</li>
<li>基于测试的重构</li>
<li>TDD workflow</li>
</ul>
<p>地址如下</p>
<p><a href="https://www.obeythetestinggoat.com/book/praise.harry.html" target="_blank" rel="external">https://www.obeythetestinggoat.com/book/praise.harry.html</a></p>
<p>说说个人对测试和 TDD 测试的基本态度，我觉得测试是好事，适当的测试是可以提升代码质量和程序稳定性的。</p>
<p>说测试会降低开发速度的，八成是没有善用测试。如果测试拖慢了你的开发速度，只能说明没有进行合适的测试，比如对一些无关紧要的功能进行测试。</p>
<p>但，这篇演讲和配套资料很好，不过有些美中不足。 这里基本上都还在用 Django 的 MTV 这一套。</p>
<blockquote>
<p>我反正是不用这一套了。这个年头流行 SPA 呀。</p>
</blockquote>
<p>所以，我们这篇演讲指的关注的内容就变成如下内容了。</p>
<ul>
<li>单元测试和功能性测试</li>
<li>unittest 标准库</li>
<li>Django models</li>
<li>基于测试的重构</li>
<li>TDD workflow</li>
</ul>
<p>而且，对于 API 的测试，现在基本上流行 POSTMAN</p>
<p>用 POSTMAN 的优点就在于可以把参数缓存下来下次接着用。有个小技巧就是从 chrome 拷贝一下 curl 到 postman 中。非常好用。</p>
<p>既然流行 SPA, 那么本次有没有介绍开 API 的利器呢？</p>
<h2 id="0x04-演讲-4-API-Driven-Django"><a href="#0x04-演讲-4-API-Driven-Django" class="headerlink" title="0x04 演讲 4 - API-Driven Django"></a>0x04 演讲 4 - API-Driven Django</h2><p>嗯，Django + django-rest-framework 实在是开 WebAPI 的神器。</p>
<p>这篇演讲，算是普及了一下常识。并没有想象当中的深入。</p>
<p>想用 Django 和 DjangoRestFramework 搞事情的，可以过来看我这篇文章。</p>
<p><a href="https://zhuanlan.zhihu.com/p/33903527" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/33903527</a></p>
<blockquote>
<p>需要注意的是，本次 PyCon 中有很多人已经用上了 pipenv 了。</p>
</blockquote>
<h2 id="0x05-演讲-5-pipenv-未来的-Python-包管理工具"><a href="#0x05-演讲-5-pipenv-未来的-Python-包管理工具" class="headerlink" title="0x05 演讲 5 - pipenv 未来的 Python 包管理工具"></a>0x05 演讲 5 - pipenv 未来的 Python 包管理工具</h2><p>Kenneth Reitz 出品，必属精品。</p>
<h3 id="Python-打包历史"><a href="#Python-打包历史" class="headerlink" title="Python 打包历史"></a>Python 打包历史</h3><p>刚开始，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl http://pypi.python.org/packages/alsdasdl/requests.tar.gz | tar zxf</div><div class="line">cd requests/</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<p>这个问题初看起来不是问题，但是随着你安装程序的增多就知道有多么痛苦了。</p>
<ol>
<li>有的依赖库依赖别的库你怎么解决？比如 pandas 需要安装 numpy</li>
<li>有的依赖库依赖 c 库怎么办？比如 LXML</li>
<li>在 python2.6.5 下，如果我需要安装两个不同版本的 Django 开发不同的软件怎么办？难道只能动态复制文件到 site-packages 里面？</li>
</ol>
<p>后来，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">easy_install requests</div></pre></td></tr></table></figure>
<p>我们可以直接从 pypi 进行安装了。但尼玛，为什么 easy_install 安装很 easy, 但是没有 easy_uninstall?</p>
<p>好，2010 年后，我们继续前进：</p>
<ul>
<li>可以通过 pip 替代 easy_install 了。</li>
<li>可以通过 virtualenv 管理项目的依赖库了。虽然说，还是不能像 ruby gem 一样同时把多个版本的的软件装在同一个系统里。</li>
<li>可以通过 requirements 锁依赖了。</li>
</ul>
<p>但，其他编程语言社区分别出现了如下的包管理工具：</p>
<ul>
<li>node -&gt; yarn &amp;&amp; npm , 有 lockfile</li>
<li>php -&gt; composer , 有 lockfile</li>
<li>rust -&gt; cargo , 有 lockfile</li>
<li>ruby -&gt; bundler , 有 lockfile</li>
</ul>
<p>而生命苦短一方居然</p>
<ul>
<li>python -&gt; pip &amp;&amp; virtualenv/venv , 无 lockfile</li>
</ul>
<blockquote>
<p>PS: Python3.3 之后，默认可以直接使用 venv 模块，不需要再安装 virtualenv 了。但还是需要手动，并且用起来比较反直觉。</p>
</blockquote>
<p>关于 requirements.txt</p>
<ul>
<li>如果你使用 pip freeze 来形成这个文件，则不直观，完全看不出来哪个依赖库依赖哪个依赖。</li>
<li>如果你直接手动指定你所需要的库，比如 flask 的话，似乎又有些太直观了。</li>
</ul>
<p>如果能有一个东西，既可以表示 freeze 的结果 (what you want)，又可以表示你需要的库 (what you need). 就好了。</p>
<blockquote>
<p>这当然可以考虑用两份 requirements 来解决。先安装 what you need 用来开发，然后 freeze 为 what you want 去部署。</p>
</blockquote>
<p>当然，铺垫了这么多 K 神肯定是来介绍他的 pipenv 的。</p>
<p>比如说，我想查看，本项目的依赖库，直接 pipenv graph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">coverage==4.5.1</div><div class="line">fabric==2.0.1</div><div class="line">  - cryptography [required: &gt;=1.1, installed: 2.2.2]</div><div class="line">    - asn1crypto [required: &gt;=0.21.0, installed: 0.24.0]</div><div class="line">    - cffi [required: &gt;=1.7, installed: 1.11.5]</div><div class="line">      - pycparser [required: Any, installed: 2.18]</div><div class="line">    - idna [required: &gt;=2.1, installed: 2.6]</div><div class="line">    - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">  - invoke [required: &lt;2.0,&gt;=1.0, installed: 1.0.0]</div><div class="line">  - paramiko [required: &gt;=2.4, installed: 2.4.1]</div><div class="line">    - bcrypt [required: &gt;=3.1.3, installed: 3.1.4]</div><div class="line">      - cffi [required: &gt;=1.1, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">    - cryptography [required: &gt;=1.5, installed: 2.2.2]</div><div class="line">      - asn1crypto [required: &gt;=0.21.0, installed: 0.24.0]</div><div class="line">      - cffi [required: &gt;=1.7, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - idna [required: &gt;=2.1, installed: 2.6]</div><div class="line">      - six [required: &gt;=1.4.1, installed: 1.11.0]</div><div class="line">    - pyasn1 [required: &gt;=0.1.7, installed: 0.4.2]</div><div class="line">    - pynacl [required: &gt;=1.0.1, installed: 1.2.1]</div><div class="line">      - cffi [required: &gt;=1.4.1, installed: 1.11.5]</div><div class="line">        - pycparser [required: Any, installed: 2.18]</div><div class="line">      - six [required: Any, installed: 1.11.0]</div><div class="line">flake8==3.5.0</div><div class="line">  - mccabe [required: &gt;=0.6.0,&lt;0.7.0, installed: 0.6.1]</div><div class="line">  - pycodestyle [required: &lt;2.4.0,&gt;=2.0.0, installed: 2.3.1]</div><div class="line">  - pyflakes [required: &gt;=1.5.0,&lt;1.7.0, installed: 1.6.0]</div><div class="line"># 其他省略</div></pre></td></tr></table></figure>
<p>如何尝鲜？我最近更新到了之前写的一个库（代码写的惨不忍赌，最近准备重构）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">git clone git@github.com:twocucao/YaPyLib.git</div><div class="line">cd YaPyLib/</div><div class="line">brew install pipenv</div><div class="line">pipenv --three</div><div class="line">pipenv install --dev</div><div class="line">pipenv shell</div></pre></td></tr></table></figure>
<p>至于其他的功能，参考官网自己摸索吧。</p>
<blockquote>
<p>在用 npm 和 yarn 的时候，我有这么一个想法，希望 python 圈子里面能出一个类似于包管理工具。今年 2 月份的时候把自己的项目迁移过来，发现 pipenv 用起来很挺舒服的。</p>
<p>pipenv 是未来。火速用上吧。</p>
</blockquote>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/04/28/DjangoORMCheatSheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/DjangoORMCheatSheet/" itemprop="url">DjangoORMCheatSheet</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-28T18:29:58+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  1,088
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>新工作的技术栈是以 Flask 为主，SQLAlchemy 是 许多玩 Flask 的人的标配。好，文档读起来，笔记搞起来。</p>
<p>所以，本文记录的是 Django ORM</p>
<p>逃。</p>
<p>这篇文章也是我对比 SqlAlchemy 以及 DjangoORM 的产物</p>
<h2 id="0x01-如何快速上手"><a href="#0x01-如何快速上手" class="headerlink" title="0x01 如何快速上手"></a>0x01 如何快速上手</h2><p>Django 世界里面，Django 的文档每次刷都会有新的发现。</p>
<h2 id="0x02-DjangoORM-的基本功能"><a href="#0x02-DjangoORM-的基本功能" class="headerlink" title="0x02 DjangoORM 的基本功能"></a>0x02 DjangoORM 的基本功能</h2><h3 id="2-1-模型定义-Model"><a href="#2-1-模型定义-Model" class="headerlink" title="2.1 模型定义 Model"></a>2.1 模型定义 Model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">from django.db import models</div><div class="line"></div><div class="line">class Musician(models.Model):</div><div class="line">    first_name = models.CharField(max_length=50) # Field</div><div class="line">    last_name = models.CharField(max_length=50)</div><div class="line">    instrument = models.CharField(max_length=100)</div><div class="line"></div><div class="line">class Album(models.Model):</div><div class="line">    artist = models.ForeignKey(Musician, on_delete=models.CASCADE)</div><div class="line">    name = models.CharField(max_length=100)</div><div class="line">    release_date = models.DateField()</div><div class="line">    num_stars = models.IntegerField()</div><div class="line"></div><div class="line">    class Meta: # Model Meta</div><div class="line">        order_with_respect_to = &apos;question&apos;</div></pre></td></tr></table></figure>
<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="Models-与-Meta"><a href="#Models-与-Meta" class="headerlink" title="Models 与 Meta"></a>Models 与 Meta</h4><blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，Model 与 session 耦合。</p>
</blockquote>
<h4 id="Field-与-Field-Options"><a href="#Field-与-Field-Options" class="headerlink" title="Field 与 Field Options"></a>Field 与 Field Options</h4><h5 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h5><ul>
<li>AutoField</li>
<li>BigAutoField</li>
<li>BigIntegerField</li>
<li>BinaryField</li>
<li>BooleanField</li>
<li>CharField</li>
<li>DateField</li>
<li>DateTimeField</li>
<li>DecimalField</li>
<li>DurationField</li>
<li>EmailField</li>
<li>FileField</li>
<li>FileField and FieldFile</li>
<li>FilePathField</li>
<li>FloatField</li>
<li>ImageField</li>
<li>IntegerField</li>
<li>GenericIPAddressField</li>
<li>NullBooleanField</li>
<li>PositiveIntegerField</li>
<li>PositiveSmallIntegerField</li>
<li>SlugField</li>
<li>SmallIntegerField</li>
<li>TextField</li>
<li>TimeField</li>
<li>URLField</li>
<li>UUIDField</li>
</ul>
<p>虽然有这么多东东，但是还是建议直接</p>
<h5 id="Field-Options"><a href="#Field-Options" class="headerlink" title="Field Options"></a>Field Options</h5><ul>
<li>null</li>
<li>blank</li>
<li>choices<ul>
<li>p.shirt_size</li>
<li>p.get_shirt_size_display()</li>
</ul>
</li>
<li>db_column</li>
<li>db_index</li>
<li>db_tablespace</li>
<li>default</li>
<li>editable</li>
<li>error_messages</li>
<li>help_text</li>
<li>primary_key</li>
<li>unique</li>
<li>unique_for_date</li>
<li>unique_for_month</li>
<li>unique_for_year</li>
<li>verbose_name</li>
<li>validators</li>
</ul>
<h5 id="ForeignKey-的-Models"><a href="#ForeignKey-的-Models" class="headerlink" title="ForeignKey 的 Models"></a>ForeignKey 的 Models</h5><p>on_delete=models.CASCADE</p>
<h4 id="Relationship"><a href="#Relationship" class="headerlink" title="Relationship"></a>Relationship</h4><p>表和表之间的关系</p>
<ol>
<li>A 表和 B 表 一对多 / 多对一</li>
<li>A 表和 B 表 一对一 （特殊的一对多）</li>
<li>A 表和 B 表 简单多对多 （借助中间的 Mapping 表进行映射）</li>
<li>A 表和 B 表 复杂多对多</li>
<li>A 表和 B 表 一对多</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from django.db import models</div><div class="line"></div><div class="line">class Manufacturer(models.Model):</div><div class="line">    # ...</div><div class="line">    pass</div><div class="line"></div><div class="line">class Car(models.Model):</div><div class="line">    manufacturer = models.ForeignKey(Manufacturer, on_delete=models.CASCADE)</div><div class="line">    # ...</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from django.db import models</div><div class="line"></div><div class="line">class Topping(models.Model):</div><div class="line">    # ...</div><div class="line">    pass</div><div class="line"></div><div class="line">class Pizza(models.Model):</div><div class="line">    # ...</div><div class="line">    toppings = models.ManyToManyField(Topping)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from django.db import models</div><div class="line"></div><div class="line">class Person(models.Model):</div><div class="line">    name = models.CharField(max_length=128)</div><div class="line"></div><div class="line">    def __str__(self):</div><div class="line">        return self.name</div><div class="line"></div><div class="line">class Group(models.Model):</div><div class="line">    name = models.CharField(max_length=128)</div><div class="line">    members = models.ManyToManyField(Person, through=&apos;Membership&apos;)</div><div class="line"></div><div class="line">    def __str__(self):</div><div class="line">        return self.name</div><div class="line"></div><div class="line">class Membership(models.Model):</div><div class="line">    person = models.ForeignKey(Person, on_delete=models.CASCADE)</div><div class="line">    group = models.ForeignKey(Group, on_delete=models.CASCADE)</div><div class="line">    date_joined = models.DateField()</div><div class="line">    invite_reason = models.CharField(max_length=64)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Models across files</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objects</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Models 重写方法</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Models 继承</div><div class="line">https://docs.djangoproject.com/en/2.0/topics/db/models/#model-inheritance</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">组织代码 - 以及应对循环引用</div></pre></td></tr></table></figure>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><h3 id="2-2-QuerySet"><a href="#2-2-QuerySet" class="headerlink" title="2.2 QuerySet"></a>2.2 QuerySet</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">c = Child(name=&quot;苏轼&quot;)</div><div class="line">c.save()</div><div class="line">p = Parent(name=&quot;苏辙&quot;)</div><div class="line">p.best_child = c</div><div class="line">p.children.add([c,c2,c3,c4])</div><div class="line">p.save()</div></pre></td></tr></table></figure>
<h4 id="Retrieve"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve</h4><p>过滤</p>
<p>filter(<strong>kwargs)<br>exclude(</strong>kwargs)<br>.all()</p>
<h5 id="跨关系（跨表）查询"><a href="#跨关系（跨表）查询" class="headerlink" title="跨关系（跨表）查询"></a>跨关系（跨表）查询</h5><p>Blog.objects.filter(entry<strong>headline</strong>contains=’Lennon’)</p>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships</a></p>
<p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships</a></p>
<h5 id="Limit-Offset-分页"><a href="#Limit-Offset-分页" class="headerlink" title="Limit / Offset / 分页"></a>Limit / Offset / 分页</h5><p>Blog.objects.filter(entry<strong>headline</strong>contains=’Lennon’)[30:20]</p>
<h5 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h5><p>query = query.filter(<strong>kwargs)<br>query = query.exclude(</strong>kwargs)</p>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>Django 里面最强大的就是其 Q 表达式了</p>
<p>Q(question<strong>startswith=’Who’) | Q(question</strong>startswith=’What’)</p>
<p>Poll.objects.get(<br>    Q(question__startswith=’Who’),<br>    Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))<br>)</p>
<p>这个表达式甚至可以嵌套超级深从而完成一个比较深的跨表查询。</p>
<blockquote>
<p>并且，这种 API 查询反而在写前端 API 的时候，可以传入 question__startswith 这类参数，从而直接完成一组搜索。</p>
</blockquote>
<p>Q / F</p>
<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><p>需要注意的的是，SQLAlchemy 必须显式执行查询，而 Django 不一定。</p>
<p><a href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated</a></p>
<p>在 Django 内部实现的时候，一个 queryset 创建 / 过滤 / 切片 / 传送，<strong>除非这个 queryset 被 evaluated 了</strong>, 否则不会做数据库的操作。</p>
<ul>
<li>iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>repr</li>
<li>len</li>
<li>list</li>
<li>bool</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">all()</div><div class="line">first()</div><div class="line">last()</div><div class="line">exist()</div></pre></td></tr></table></figure>
<h5 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h5><ul>
<li>pk</li>
<li>model</li>
</ul>
<h5 id="复制-实例"><a href="#复制-实例" class="headerlink" title="复制 实例"></a>复制 实例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">blog = Blog(name=&apos;My blog&apos;, tagline=&apos;Blogging is easy&apos;)</div><div class="line">blog.save() # blog.pk == 1</div><div class="line"></div><div class="line">blog.pk = None</div><div class="line">blog.save() # blog.pk == 2</div><div class="line"></div><div class="line"># 但这个并不拷贝外键？???</div><div class="line">https://docs.djangoproject.com/en/2.0/topics/db/queries/#copying-model-instances</div></pre></td></tr></table></figure>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 默认查询的是所有字段，但我希望查询部分字段</div><div class="line"># TODO: 阿萨德</div><div class="line"># Distinct</div><div class="line"># OrderBy</div></pre></td></tr></table></figure>
<h5 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h5><p><a href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets</a></p>
<h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><p>单个 object 更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">blog.title = &quot;大宝天天见&quot;</div><div class="line">blog.save()</div></pre></td></tr></table></figure>
<p>批量更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query.update(headline=F(&apos;blog__name&apos;))</div></pre></td></tr></table></figure>
<p>一对多的更新（类似于 Set 操作）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">add(obj1, obj2, ...)</div><div class="line">create(**kwargs)</div><div class="line">remove(obj1, obj2, ...)</div><div class="line">clear()</div><div class="line">set(objs)</div></pre></td></tr></table></figure>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><h4 id="聚集查询"><a href="#聚集查询" class="headerlink" title="聚集查询"></a>聚集查询</h4><p><a href="https://docs.djangoproject.com/en/2.0/topics/db/aggregation/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/aggregation/</a></p>
<h4 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h4><p><a href="https://docs.djangoproject.com/en/2.0/topics/db/search/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/search/</a></p>
<h3 id="2-2-Model-Instances"><a href="#2-2-Model-Instances" class="headerlink" title="2.2 Model Instances"></a>2.2 Model Instances</h3><p><a href="https://docs.djangoproject.com/en/2.0/ref/models/instances/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/ref/models/instances/</a></p>
<h3 id="2-3-模型实例"><a href="#2-3-模型实例" class="headerlink" title="2.3 模型实例"></a>2.3 模型实例</h3><h3 id="2-4-迁移机制"><a href="#2-4-迁移机制" class="headerlink" title="2.4 迁移机制"></a>2.4 迁移机制</h3><ol>
<li>加 INSTALLED_APPS</li>
</ol>
<h2 id="0x03-Django-ORM-的高级功能"><a href="#0x03-Django-ORM-的高级功能" class="headerlink" title="0x03 Django ORM 的高级功能"></a>0x03 Django ORM 的高级功能</h2><h3 id="maneger"><a href="#maneger" class="headerlink" title="maneger"></a>maneger</h3><p><a href="https://docs.djangoproject.com/en/2.0/topics/db/managers/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/managers/</a></p>
<h3 id="raw-sql"><a href="#raw-sql" class="headerlink" title="raw sql"></a>raw sql</h3><p><a href="https://docs.djangoproject.com/en/2.0/topics/db/sql/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/topics/db/sql/</a></p>
<h4 id="database-fuction"><a href="#database-fuction" class="headerlink" title="database-fuction"></a>database-fuction</h4><p><a href="https://docs.djangoproject.com/en/2.0/ref/models/database-functions/" target="_blank" rel="external">https://docs.djangoproject.com/en/2.0/ref/models/database-functions/</a></p>
<h2 id="0x04-Django-ORM-Under-The-Hood"><a href="#0x04-Django-ORM-Under-The-Hood" class="headerlink" title="0x04 Django ORM Under The Hood"></a>0x04 Django ORM Under The Hood</h2><h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/31/SQLAlchemyCheatSheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/31/SQLAlchemyCheatSheet/" itemprop="url">SQLAlchemyCheatSheet</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-31T17:16:35+08:00">
                2018-03-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,607
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>新工作的技术栈是以 Flask 为主，SQLAlchemy 是 许多玩 Flask 的人的标配。好，文档读起来，笔记搞起来。</p>
<p>本笔记于 2018-03-31 开启，SQLAlchemy 版本为 1.2.0。</p>
<p>Python 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee</p>
<ol>
<li>SQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现</li>
<li>Django ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的话我甚至会考虑将 Django ORM 配置到 Flask 项目中。当然，也有蛋疼的 SqlAlchemy 使用者已经移植给 django 配置了 SQLAlchemy 的库。</li>
<li>Peewee 没用过，不好评论。以后有机会试试。</li>
</ol>
<h2 id="0x01-如何快速上手"><a href="#0x01-如何快速上手" class="headerlink" title="0x01 如何快速上手"></a>0x01 如何快速上手</h2><p>了解一个框架，最好是从下面几处入手：</p>
<ul>
<li>官方 Tuorial</li>
<li>官方 Example</li>
<li>官方 Guide</li>
<li>官方 APIDocument</li>
<li>源码</li>
</ul>
<p>对框架掌握越深，就越需要使用者多多从上开始逐渐向下了解。</p>
<p>其实还有一些途径：</p>
<ul>
<li>Github 上面的 issue</li>
<li>Stack Overflow 的高 vote 常见问题</li>
<li><strong>如果作者有一些活跃的社区的话，可以火速前往</strong></li>
</ul>
<p>鉴于我们的目标在于入手，所以可以火速过一下：</p>
<ul>
<li>官方 Tuorial</li>
<li>官方 Example</li>
<li>官方 Guide</li>
<li>Github 上面的 issue</li>
<li>Stack Overflow 的高 vote 常见问题</li>
<li><strong>如果作者有一些活跃的社区的话，可以火速前往</strong></li>
</ul>
<h2 id="0x02-SQLAlchemy-的基本功能"><a href="#0x02-SQLAlchemy-的基本功能" class="headerlink" title="0x02 SQLAlchemy 的基本功能"></a>0x02 SQLAlchemy 的基本功能</h2><h3 id="2-0-SQLAlchemy-VS-DjangoORM"><a href="#2-0-SQLAlchemy-VS-DjangoORM" class="headerlink" title="2.0 SQLAlchemy VS DjangoORM"></a>2.0 SQLAlchemy VS DjangoORM</h3><p>ORM 通常有 DataMapper 实现和 ActiveRecord 实现两种。</p>
<p>依照我的经验，ActiveRecord 使用起来的更接近对象 (Object) 的操作，DataMapper 使用起来更接近 (Table) 的操作。</p>
<blockquote>
<p>SQLAlchemy 是 DataMapper 模式的实现，在该模式下，session 会暴露出来，即 Model 与 session 并不耦合。</p>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，session 并不暴露出来，即 Model 与 session 耦合。</p>
</blockquote>
<p>使用 Django ORM 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">b = Blog(**data)</div><div class="line">b.save()</div></pre></td></tr></table></figure>
<p>使用 SQLAlchemy 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">b = Blog(**data)</div><div class="line">session.add(b)</div><div class="line">session.session(b)</div></pre></td></tr></table></figure>
<p>由于 Django 帮你屏蔽了 session 的操作。</p>
<p>在通常情况下，</p>
<ol>
<li>DjangoORM 使用起来更加接近 Object 的操作。</li>
<li>SQLAlchemy 使用起来更加接近 Table 的操作。</li>
</ol>
<p>举个例子，</p>
<p>一对多，Father 添加两个小孩（其中一个小孩是已经存在的）</p>
<p>在 DjangoORM 里面， 这里更像是一个 Set 的 add 操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">father.children.add(new_child,exsit_child)</div></pre></td></tr></table></figure>
<p>在 SQLAlchemy 里面，这里更像是一个 table 的 insert 操作。（麻蛋，你要说是一个 list 的 append 操作也行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">for child in (new_child,exsit_child):</div><div class="line">    if child in father.children:</div><div class="line">        father.children.append(child)</div></pre></td></tr></table></figure>
<blockquote>
<p>写 SQLAlchemy 更接近操作放在数据库里面的数据记录，而 DjangoORM 更接近操作一批放在数据库里面的对象。</p>
</blockquote>
<p>由于 session 的使用姿势不同，所以往往会有很多使用上面的区别。</p>
<p>至于孰优孰劣，难以评判。</p>
<ul>
<li><p>技术老大 (Flask 和 React 大神）倾向于使用 SQLAlchemy, 他认为</p>
<ul>
<li>对于一个技术『知其然，知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据库，操作最好要落实在成 SQL</li>
<li>如果有可能的话，每一个 SQL 语句都要经过推敲，而且写这个 SQL 和 ORM 过程要反复练习</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>Alembic 这个迁移工具是为了省事用的，甚至在某些情况下没必要用。完全可以写 SQL 代替</li>
</ul>
</li>
</ul>
</li>
<li><p>我 (Django 和 Vue 弱鸡）倾向于使用 DjangoORM, 我认为</p>
<ul>
<li>对于一个技术『先知其大致然，需要深入的时候知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据，最好抽象为对对象的操作。</li>
<li>测试到位的情况下，快糙狠先出东西。到需要优化的时候该怎么 Profile 怎么 Profile</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>用起来啊，能操作对象为什么还要强行到数据库操作？</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-1-模型定义"><a href="#2-1-模型定义" class="headerlink" title="2.1 模型定义"></a>2.1 模型定义</h3><p>先看一组模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</div><div class="line">Base = declarative_base() <span class="comment"># 模型基类</span></div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'users'</span></div><div class="line"></div><div class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>) <span class="comment"># 主键</span></div><div class="line">    name = Column(String)</div><div class="line">    fullname = Column(String)</div><div class="line">    password = Column(String)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">       <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> % (</div><div class="line">                            self.name, self.fullname, self.password)</div><div class="line">Base.metadata.create_all(engine)</div></pre></td></tr></table></figure>
<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="Models-与-Meta"><a href="#Models-与-Meta" class="headerlink" title="Models 与 Meta"></a>Models 与 Meta</h4><p><a href="https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685" target="_blank" rel="external">https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685</a></p>
<h4 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h4><h5 id="One-To-Many"><a href="#One-To-Many" class="headerlink" title="One To Many"></a>One To Many</h5><p>母亲有若干个孩子，外键在孩子上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">class Parent(Base):</div><div class="line">    #...</div><div class="line">    children = relationship(&quot;Child&quot;, backref=&quot;parent&quot;)</div><div class="line"></div><div class="line">class Child(Base):</div><div class="line">    #...</div><div class="line">    parent_id = Column(Integer, ForeignKey(&apos;parent.id&apos;))</div></pre></td></tr></table></figure>
<h5 id="Many-To-One"><a href="#Many-To-One" class="headerlink" title="Many To One"></a>Many To One</h5><p>多个母亲共享一个孩子，外键在母亲上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class Parent(Base):</div><div class="line">    child_id = Column(Integer, ForeignKey(&apos;child.id&apos;))</div><div class="line">    child = relationship(&quot;Child&quot;)</div><div class="line"></div><div class="line">class Child(Base):</div><div class="line">    # ...</div></pre></td></tr></table></figure>
<h5 id="One-To-One"><a href="#One-To-One" class="headerlink" title="One To One"></a>One To One</h5><p>One to One 是 One to Many 或者是 Many to One 的简化版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># Many To One</div><div class="line">class Parent(Base):</div><div class="line">    # ...</div><div class="line">    child_id = Column(Integer, ForeignKey(&apos;child.id&apos;))</div><div class="line">    child = relationship(&quot;Child&quot;, backref=backref(&quot;parent&quot;, uselist=False))</div><div class="line"></div><div class="line">class Child(Base):</div><div class="line">    # ...</div><div class="line"></div><div class="line"># One To Many 改 One To One</div><div class="line">class Parent(Base):</div><div class="line">    # ...</div><div class="line"></div><div class="line">class Child(Base):</div><div class="line">    # ...</div><div class="line">    parent_id = Column(Integer, ForeignKey(&apos;parent.id&apos;))</div><div class="line">    parent = relationship(&quot;Parent&quot;, backref=backref(&quot;child&quot;, uselist=False))</div></pre></td></tr></table></figure>
<h5 id="Many-To-Many"><a href="#Many-To-Many" class="headerlink" title="Many To Many"></a>Many To Many</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">association_table = Table(&apos;association&apos;, Base.metadata,</div><div class="line">    Column(&apos;left_id&apos;, Integer, ForeignKey(&apos;left.id&apos;)),</div><div class="line">    Column(&apos;right_id&apos;, Integer, ForeignKey(&apos;right.id&apos;))</div><div class="line">)</div><div class="line"></div><div class="line">class Parent(Base):</div><div class="line">    # ...</div><div class="line">    children = relationship(&quot;Child&quot;,</div><div class="line">                    secondary=association_table,</div><div class="line">                    backref=&quot;parents&quot;)</div><div class="line"></div><div class="line">class Child(Base):</div><div class="line">    # ...</div></pre></td></tr></table></figure>
<p>注意事项</p>
<p>执行删除 mapping 表的时候尽量这样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">myparent.children.remove(somechild)</div></pre></td></tr></table></figure>
<p>当你想干掉 somechild 的时候，会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session.delete(somechild)</div></pre></td></tr></table></figure>
<ol>
<li>假如 Child 没有 ref Parent 的话，Secondary Table 无删除，则无法删除。</li>
<li>假如 ref 了的话，则删除 secondary 里面的记录。</li>
<li>TODO</li>
</ol>
<h5 id="邻接列表关系"><a href="#邻接列表关系" class="headerlink" title="邻接列表关系"></a>邻接列表关系</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Node(Base):</div><div class="line">    __tablename__ = &apos;node&apos;</div><div class="line">    id = Column(Integer, primary_key=True)</div><div class="line">    parent_id = Column(Integer, ForeignKey(&apos;node.id&apos;))</div><div class="line">    data = Column(String(50))</div><div class="line">    children = relationship(&quot;Node&quot;,</div><div class="line">                backref=backref(&apos;parent&apos;, remote_side=[id])</div><div class="line">            )</div></pre></td></tr></table></figure>
<h5 id="relationship-详解"><a href="#relationship-详解" class="headerlink" title="relationship 详解"></a>relationship 详解</h5><h3 id="2-1-Query"><a href="#2-1-Query" class="headerlink" title="2.1 Query"></a>2.1 Query</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">c1 = Child(name=&quot;苏轼&quot;)</div><div class="line">session.add(c1)</div><div class="line">session.flush()</div><div class="line">p = Parent(name=&quot;苏辙&quot;)</div><div class="line">p.best_child = c1</div><div class="line">for c in [c1,c2,c3,c4]:</div><div class="line">    p.children.append(c)</div><div class="line">session.add(c1)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<h4 id="Retrieve"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve</h4><p>过滤</p>
<p>filter(**kwargs)<br>filter(Singer.name == “周杰伦”)<br>filter(Singer.name =! “周杰棍”)</p>
<h5 id="跨关系（跨表）查询"><a href="#跨关系（跨表）查询" class="headerlink" title="跨关系（跨表）查询"></a>跨关系（跨表）查询</h5><p>session.query(Entry).join(Blog,Blog.entry_id == Entry.id).filter(Blog.name = “SqlAlchemy CheatSheet”)</p>
<h5 id="Limit-Offset-分页"><a href="#Limit-Offset-分页" class="headerlink" title="Limit / Offset / 分页"></a>Limit / Offset / 分页</h5><ul>
<li>limit()</li>
<li>offset()</li>
</ul>
<h5 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">query = session.query(Order) # query = session.query(Order)</div><div class="line">query = query.filter(Order.name.like(f&quot;%name%&quot;))</div></pre></td></tr></table></figure>
<h5 id="二进制表达式"><a href="#二进制表达式" class="headerlink" title="二进制表达式"></a>二进制表达式</h5><p>我们先 type 一下表达式，找到 eq 的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">type(model.column_name == <span class="string">'asdf'</span>) → sqlalchemy.sql.elements.BinaryExpression</div></pre></td></tr></table></figure>
<p>是一个二进制表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 等于</span></div><div class="line">query.filter(User.name == <span class="string">'ed'</span>)</div><div class="line"><span class="comment"># 不等于</span></div><div class="line">query.filter(User.name != <span class="string">'ed'</span>)</div><div class="line"><span class="comment"># Like（有的数据库不区分大小写）</span></div><div class="line">query.filter(User.name.like(<span class="string">'%ed%'</span>))</div><div class="line"><span class="comment"># ILIKE (case-insensitive LIKE)</span></div><div class="line">query.filter(User.name.ilike(<span class="string">'%ed%'</span>))</div><div class="line"><span class="comment"># IN</span></div><div class="line">query.filter(User.name.in_([<span class="string">'ed'</span>, <span class="string">'wendy'</span>, <span class="string">'jack'</span>]))</div><div class="line"><span class="comment"># Not in</span></div><div class="line">query.filter(~User.name.in_([<span class="string">'ed'</span>, <span class="string">'wendy'</span>, <span class="string">'jack'</span>]))</div><div class="line"><span class="comment"># IS NULL</span></div><div class="line">query.filter(User.name == <span class="keyword">None</span>)</div><div class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></div><div class="line">query.filter(User.name.is_(<span class="keyword">None</span>))</div><div class="line"><span class="comment"># IS NOT NULL:</span></div><div class="line">query.filter(User.name != <span class="keyword">None</span>)</div><div class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></div><div class="line">query.filter(User.name.isnot(<span class="keyword">None</span>))</div><div class="line"><span class="comment"># AND</span></div><div class="line"><span class="comment">## use and_()</span></div><div class="line">query.filter(and_(User.name == <span class="string">'ed'</span>, User.fullname == <span class="string">'Ed Jones'</span>))</div><div class="line"><span class="comment">## or send multiple expressions to .filter()</span></div><div class="line">query.filter(User.name == <span class="string">'ed'</span>, User.fullname == <span class="string">'Ed Jones'</span>)</div><div class="line"><span class="comment">## or chain multiple filter()/filter_by() calls</span></div><div class="line">query.filter(User.name == <span class="string">'ed'</span>).filter(User.fullname == <span class="string">'Ed Jones'</span>)</div><div class="line"><span class="comment"># OR</span></div><div class="line">query.filter(or_(User.name == <span class="string">'ed'</span>, User.name == <span class="string">'wendy'</span>))</div><div class="line"><span class="comment"># MATCH</span></div><div class="line">query.filter(User.name.match(<span class="string">'wendy'</span>))</div></pre></td></tr></table></figure>
<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">all()</div><div class="line">first()</div><div class="line">one()</div><div class="line">one_or_none()</div><div class="line">scalar()</div></pre></td></tr></table></figure>
<p>YourModel.query.get((pk1, pk2))</p>
<h5 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h5><blockquote>
<p>同一个 Session 下面，取到的某一条数据对应的 objects 应该是一样的？</p>
</blockquote>
<h5 id="复制-实例"><a href="#复制-实例" class="headerlink" title="复制 实例"></a>复制 实例</h5><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 查询的是 SomeModel 里面所有的字段 即 select *</div><div class="line">query = session.query(SomeModel)</div><div class="line"># 查询的是 SomeModel 里面部分的字段 即 select acol, bcol</div><div class="line">query = session.query(SomeModel.acol,SomeModel.bcol)</div><div class="line"># 即 select acol , bcol</div><div class="line"># alias</div><div class="line">user_alias = aliased(User, name=&apos;user_alias&apos;)</div><div class="line">for row in session.query(user_alias, user_alias.name).all():</div><div class="line">    # 即相当于 select name as name_label</div><div class="line">    print(row.user_alias)</div><div class="line"></div><div class="line"># limit 和 offset</div><div class="line">for u in session.query(User).order_by(User.id)[1:3]:</div><div class="line">    print(u)</div><div class="line"></div><div class="line"># distinct</div><div class="line">session.query(model.Name).distinct(model.Name.value).order_by(model.Name.value)</div><div class="line"># order_by</div><div class="line">User.query.order_by(User.popularity.desc(),User.date_created.desc()).limit(10).all()</div></pre></td></tr></table></figure>
<h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><p>单个 object 更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">blog.title = &quot;大宝天天见&quot;</div><div class="line">session.add(blog)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<p>批量更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">session.query.filter(Blog.content.like(&quot;% 敏感词 %&quot;)).update(&#123;</div><div class="line">    Blog.content: &quot;依照相关 XX 无法查看&quot;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>一对多的更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">append</div></pre></td></tr></table></figure>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><p>query.delete()</p>
<h4 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h4><p><a href="https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query" target="_blank" rel="external">https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query</a></p>
<h5 id="两表-InnerJoin"><a href="#两表-InnerJoin" class="headerlink" title="两表 InnerJoin"></a>两表 InnerJoin</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> u, a <span class="keyword">in</span> session.query(User, Address).\</div><div class="line">                    filter(User.id==Address.user_id).\</div><div class="line">                    filter(Address.email_address==<span class="string">'jack@google.com'</span>).\</div><div class="line">                    all():</div><div class="line">    print(u)</div><div class="line">    print(a)</div><div class="line"><span class="comment"># &lt;User(name='jack', fullname='Jack Bean', password='gjffdd')&gt;</span></div><div class="line"><span class="comment"># &lt;Address(email_address='jack@google.com')&gt;</span></div></pre></td></tr></table></figure>
<h5 id="多表-InnerJoin-LeftJoin"><a href="#多表-InnerJoin-LeftJoin" class="headerlink" title="多表 InnerJoin + LeftJoin"></a>多表 InnerJoin + LeftJoin</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query.outerjoin(User.addresses)   # LEFT OUTER JOIN</div></pre></td></tr></table></figure>
<h4 id="聚集查询"><a href="#聚集查询" class="headerlink" title="聚集查询"></a>聚集查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session.query(User).filter(User.name.like(&apos;%ed&apos;)).count()</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from sqlalchemy import func</div><div class="line">session.query(Table.column, func.count(Table.column)).group_by(Table.column).all()</div><div class="line"></div><div class="line">self.session.query(func.count(Table.column1),Table.column1, Table.column2).group_by(Table.column1, Table.column2).all()</div><div class="line"></div><div class="line">from sqlalchemy.sql import func</div><div class="line">session.query(func.avg(Rating.field2).label(&apos;average&apos;)).filter(Rating.url==url_string.netloc)</div></pre></td></tr></table></figure>
<h4 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h4><p>Query 对象，下文中，我会聊到这个 Query 对象。这里先跳过。</p>
<h3 id="2-2-原生查询"><a href="#2-2-原生查询" class="headerlink" title="2.2 原生查询"></a>2.2 原生查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">from sqlalchemy import text</div><div class="line"></div><div class="line">sql = text(&apos;select name from penguins&apos;)</div><div class="line">result = db.engine.execute(sql)</div><div class="line">names = []</div><div class="line">for row in result:</div><div class="line">    names.append(row[0])</div><div class="line"></div><div class="line">print names</div><div class="line"></div><div class="line">from collections import namedtuple</div><div class="line"></div><div class="line">Record = namedtuple(&apos;Record&apos;, result.keys())</div><div class="line">records = [Record(*r) for r in result.fetchall()]</div><div class="line">for r in records:</div><div class="line">    print(r)</div><div class="line"></div><div class="line">from sqlalchemy.sql import text</div><div class="line"></div><div class="line">connection = engine.connect()</div><div class="line"></div><div class="line"># recommended</div><div class="line">cmd = &apos;select * from Employees where EmployeeGroup == :group&apos;</div><div class="line">employeeGroup = &apos;Staff&apos;</div><div class="line">employees = connection.execute(text(cmd), group = employeeGroup)</div></pre></td></tr></table></figure>
<p>get_or_create</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">def get_or_create(session, model, defaults=None, **kwargs):</div><div class="line">    instance = session.query(model).filter_by(**kwargs).first()</div><div class="line">    if instance:</div><div class="line">        return instance, False</div><div class="line">    else:</div><div class="line">        params = dict((k, v) for k, v in kwargs.iteritems() if not isinstance(v, ClauseElement))</div><div class="line">        params.update(defaults or &#123;&#125;)</div><div class="line">        instance = model(**params)</div><div class="line">        session.add(instance)</div><div class="line">        return instance, True</div></pre></td></tr></table></figure>
<h3 id="2-3-更新查询"><a href="#2-3-更新查询" class="headerlink" title="2.3 更新查询"></a>2.3 更新查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session.query(Stuff).update(&#123;Stuff.foo: Stuff.foo + 1&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">1) for c in session.query(Stuff).all():</div><div class="line">       c.foo += 1</div><div class="line">   session.commit()</div><div class="line"></div><div class="line">2) session.query().\</div><div class="line">       update(&#123;&quot;foo&quot;: (Stuff.foo + 1)&#125;)</div><div class="line">   session.commit()</div><div class="line"></div><div class="line">3) conn = engine.connect()</div><div class="line">   stmt = Stuff.update().\</div><div class="line">       values(Stuff.foo = (Stuff.foo + 1))</div><div class="line">   conn.execute(stmt)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">1) user.no_of_logins += 1</div><div class="line">   session.commit()</div><div class="line"></div><div class="line">2) session.query().\</div><div class="line">       filter(User.username == form.username.data).\</div><div class="line">       update(&#123;&quot;no_of_logins&quot;: (User.no_of_logins +1)&#125;)</div><div class="line">   session.commit()</div><div class="line"></div><div class="line">3) conn = engine.connect()</div><div class="line">   stmt = User.update().\</div><div class="line">       values(no_of_logins=(User.no_of_logins + 1)).\</div><div class="line">       where(User.username == form.username.data)</div><div class="line">   conn.execute(stmt)</div><div class="line"></div><div class="line">4) setattr(user, &apos;no_of_logins&apos;, user.no_of_logins+1)</div><div class="line">   session.commit()</div></pre></td></tr></table></figure>
<h3 id="2-4-删除"><a href="#2-4-删除" class="headerlink" title="2.4 删除"></a>2.4 删除</h3><p><a href="https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete" target="_blank" rel="external">https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete</a></p>
<h4 id="OnDelete"><a href="#OnDelete" class="headerlink" title="OnDelete"></a>OnDelete</h4><p>ondelete=’CASCADE’))</p>
<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><p>models.User.query.delete()</p>
<h3 id="如何从-Object-到一个-ORM"><a href="#如何从-Object-到一个-ORM" class="headerlink" title="如何从 Object 到一个 ORM"></a>如何从 Object 到一个 ORM</h3><p>如何追踪 Object 的变化？</p>
<h2 id="0x03-SQLAlchemy-的高级特性"><a href="#0x03-SQLAlchemy-的高级特性" class="headerlink" title="0x03 SQLAlchemy 的高级特性"></a>0x03 SQLAlchemy 的高级特性</h2><h3 id="表继承"><a href="#表继承" class="headerlink" title="表继承"></a>表继承</h3><p><a href="https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance" target="_blank" rel="external">https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance</a></p>
<h3 id="啥玩意"><a href="#啥玩意" class="headerlink" title="啥玩意"></a>啥玩意</h3><p>Flush 和 commit</p>
<p><a href="https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit" target="_blank" rel="external">https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">x = Foo(bar=1)</div><div class="line">print x.id</div><div class="line"># None</div><div class="line">session.add(x)</div><div class="line">session.flush()</div><div class="line"># BEGIN</div><div class="line"># INSERT INTO foo (bar) VALUES(1)</div><div class="line"># COMMIT</div><div class="line">print x.id</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">qry = DBSession.query(User).filter(</div><div class="line">        and_(User.birthday &lt;= &apos;1988-01-17&apos;, User.birthday &gt;= &apos;1985-01-17&apos;))</div></pre></td></tr></table></figure>
<h2 id="0x04-SQLAlchemy-的基础特性-Under-The-Hood"><a href="#0x04-SQLAlchemy-的基础特性-Under-The-Hood" class="headerlink" title="0x04 SQLAlchemy 的基础特性 Under The Hood"></a>0x04 SQLAlchemy 的基础特性 Under The Hood</h2><h3 id="Loading-策略"><a href="#Loading-策略" class="headerlink" title="Loading 策略"></a>Loading 策略</h3><h4 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h4><h4 id="Eager-Loading"><a href="#Eager-Loading" class="headerlink" title="Eager Loading"></a>Eager Loading</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from sqlalchemy.dialects import postgresql</div><div class="line">&gt;&gt;&gt; print str(q.statement.compile(dialect=postgresql.dialect()))</div><div class="line">Where q is defined as:</div></pre></td></tr></table></figure>
<h2 id="0x05-SQLAlchemy-的高级特性-Under-The-Hood"><a href="#0x05-SQLAlchemy-的高级特性-Under-The-Hood" class="headerlink" title="0x05 SQLAlchemy 的高级特性 Under The Hood"></a>0x05 SQLAlchemy 的高级特性 Under The Hood</h2><h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p><a href="https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy" target="_blank" rel="external">https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy</a><br><a href="https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications" target="_blank" rel="external">https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">https://stackoverflow.com/questions/34322471/sqlalchemy-engine-connection-and-session-difference</div><div class="line">https://stackoverflow.com/questions/11769366/why-is-sqlalchemy-insert-with-sqlite-25-times-slower-than-using-sqlite3-directly</div><div class="line">https://stackoverflow.com/questions/12223335/sqlalchemy-creating-vs-reusing-a-session</div><div class="line">session 是个容器</div><div class="line"></div><div class="line">https://stackoverflow.com/questions/18199053/example-of-what-sqlalchemy-can-do-and-django-orm-cannot</div><div class="line">https://stackoverflow.com/questions/7389759/memory-efficient-built-in-sqlalchemy-iterator-generator</div><div class="line"></div><div class="line"># 日志</div><div class="line">import logging</div><div class="line">logging.basicConfig()</div><div class="line">logging.getLogger(&apos;sqlalchemy.engine&apos;).setLevel(logging.INFO)</div></pre></td></tr></table></figure>
<h2 id="配置篇"><a href="#配置篇" class="headerlink" title="配置篇"></a>配置篇</h2><p>SQLALCHEMY_TRACK_MODIFICATIONS = False</p>
<h2 id="0x06-DEBUG-和-Profile-技巧"><a href="#0x06-DEBUG-和-Profile-技巧" class="headerlink" title="0x06 DEBUG 和 Profile 技巧"></a>0x06 DEBUG 和 Profile 技巧</h2><h3 id="6-1-查看技巧"><a href="#6-1-查看技巧" class="headerlink" title="6.1 查看技巧"></a>6.1 查看技巧</h3><p>dict(u)<br>u.<strong>dict</strong></p>
<p><a href="https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application" target="_blank" rel="external">https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application</a></p>
<h2 id="0x07-ORM-的本质"><a href="#0x07-ORM-的本质" class="headerlink" title="0x07 ORM 的本质"></a>0x07 ORM 的本质</h2><p>ORM 的本质是 Data Access Layer 上的一层封装。如果你写原生 SQL, 即手写 DAL 的话，开发效率可能会大打折扣。</p>
<h3 id="ORM-的两种类型-Active-Record-与-Data-Mappers"><a href="#ORM-的两种类型-Active-Record-与-Data-Mappers" class="headerlink" title="ORM 的两种类型 Active Record 与 Data Mappers"></a>ORM 的两种类型 Active Record 与 Data Mappers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"># ActiveRecord 风格写起来类似于 Django ORM, 大致是这样的</div><div class="line"></div><div class="line">## AR 的模型定义</div><div class="line"></div><div class="line">class User(db.models):</div><div class="line">    name = db.StringField(verbose=&quot;xyz&quot;)</div><div class="line"></div><div class="line">## AR 的新增</div><div class="line">user = User()</div><div class="line">user.name = &quot;123456&quot;</div><div class="line">user.save() ## 正好对应数据库中的一行</div><div class="line"></div><div class="line">## AR 的查询</div><div class="line"></div><div class="line">users = User.objects.filter(Q(name=&quot;黄老板的小姨子&quot;)).all()</div><div class="line"></div><div class="line"># Data Mappers 风格写起来类似于 SQLAlchemy ORM, 大致是这样的</div><div class="line"></div><div class="line">## SA 的定义</div><div class="line"></div><div class="line">from sqlalchemy.ext.declarative import declarative_base</div><div class="line"></div><div class="line">Base = declarative_base()</div><div class="line"></div><div class="line">from sqlalchemy import Column, Integer, String</div><div class="line">class User(Base):</div><div class="line">    __tablename__ = &apos;users&apos;</div><div class="line"></div><div class="line">    id = Column(Integer, primary_key=True)</div><div class="line">    name = Column(String)</div><div class="line"></div><div class="line">Base.metadata.create_all(engine)</div><div class="line"></div><div class="line">## SA 的新增</div><div class="line"></div><div class="line">user = User()</div><div class="line">user.name = &quot;123456&quot;</div><div class="line">session.add(user)</div><div class="line">sessoon.commit() ## 嗯？其实也是对应数据库中的一行。</div><div class="line"></div><div class="line">## SA 的查询</div><div class="line"></div><div class="line">session.query(User).filter(User.name)</div></pre></td></tr></table></figure>
<p>问题来了，这两者到底是什么，看起来似乎相差不大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">class Person:</div><div class="line"></div><div class="line">    lastname</div><div class="line">    firstname</div><div class="line">    children</div><div class="line"></div><div class="line">    # 数据操作</div><div class="line">    def findone(self):</div><div class="line">        pass</div><div class="line"></div><div class="line">    def insert(self):</div><div class="line">        pass</div><div class="line"></div><div class="line">    def update(self):</div><div class="line">        pass</div><div class="line"></div><div class="line">    def delete(self):</div><div class="line">        pass</div><div class="line"></div><div class="line">    # 业务逻辑</div><div class="line">    def getChildrenTax(self):</div><div class="line">        pass</div></pre></td></tr></table></figure>
<p>lastName firstName numberOfDependents</p>
<p>insert update delete</p>
<p>getExemption isFlaggedForAudit getTaxableEarnings</p>
<p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p>
<p>The essence of an Active Record is a Domain Model (116) in which the classes match very closely the record structure of an underlying database. Each Active Record is responsible for saving and loading to the database and also for any domain logic that acts on the data. This may be all the domain logic in the application, or you may ﬁnd that some domain logic is held in Transaction Scripts (110) with common and data-oriented code in the Active Record.</p>
<p>The data structure of the Active Record should exactly match that of the database: one ﬁeld in the class for each column in the table. Type the ﬁelds the way the SQL interface gives you the data—don’t do any conversion at this stage. You may consider Foreign Key Mapping (236), but you may also leave the foreign keys as they are. You can use views or tables with Active Record, although updates through views are obviously harder. Views are particularly useful for reporting purposes.</p>
<p>objects correspond directly to the database tables: an isomorphic schema. If your business logic is complex, you’ll soon want to use your object’s direct relationships, collections, inheritance, and so forth. These don’t map easily onto Active Record, and adding them piecemeal gets very messy. That’s what will lead you to use Data Mapper (165) instead.</p>
<p>Another argument against Active Record is the fact that it couples the object design to the database design. This makes it more difﬁcult to refactor either design as a project goes forward.</p>
<p>Active Record is a good pattern to consider if you’re using Transaction Script (110) and are beginning to feel the pain of code duplication and the difﬁculty in updating scripts and tables that Transaction Script (110) often brings. In this case you can gradually start creating Active Records and then slowly refactor behavior into them. It often helps to wrap the tables as a Gateway (466) ﬁrst, and then start moving behavior so that the tables evolve to a Active Record.</p>
<p>其实为什么不选择设计成 ActiveRecord , 而是选择设计成 Data Mapper, 其实就可以回答这个问题：</p>
<blockquote>
<p>虽然要设计成 ORM, 考虑到数量和性能因素，SQL 数据库（多个表）并不应该是表现像 Object 集合那样（换言之，也就是 AR 表现的像 Object 的集合一样）。<br>同时，出于更好的抽象，object 集合也应该表现的像表以及行</p>
</blockquote>
<p>于是我们可以得出结论，可以在 SQLAlchemy 上面进行一定的封装，使得最后用起来非常的 Django ORM like，其实 SQLAlchemy 稍加定制还是可以很 Django ORM-like 的。</p>
<p>:TODO: 有机会看看那本书再修改一下本小节</p>
<p>这不，果然有人就这么搞了 <a href="https://github.com/absent1706/sqlalchemy-mixins" target="_blank" rel="external">https://github.com/absent1706/sqlalchemy-mixins</a></p>
<h2 id="0x07-其他"><a href="#0x07-其他" class="headerlink" title="0x07 其他"></a>0x07 其他</h2><h3 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h3><p>session.query(MyClass).filter(“foo={}”.format(getArgs[‘val’]))</p>
<h2 id="0x02-SQLAlchemy-及其生态"><a href="#0x02-SQLAlchemy-及其生态" class="headerlink" title="0x02 SQLAlchemy 及其生态"></a>0x02 SQLAlchemy 及其生态</h2><p>如果用上 Flask+SQLAlchemy 一般也要带上，Flask-Migration 与 Flask-SQLAlchemy, 这两个库也是对 Alembic 和 SQLAlchemy 的浅封装。</p>
<h3 id="如何快速上手-ORM"><a href="#如何快速上手-ORM" class="headerlink" title="如何快速上手 ORM"></a>如何快速上手 ORM</h3><p>那么，对于这个 ORM 库还有那些通用性的知识需要了解？</p>
<p>嗯，是时候了解本质了。</p>
<p><a href="http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/" target="_blank" rel="external">http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/</a></p>
<h2 id="0xFF-Glossary"><a href="#0xFF-Glossary" class="headerlink" title="0xFF Glossary"></a>0xFF Glossary</h2><h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><ul>
<li><a href="https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/" target="_blank" rel="external">https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/</a></li>
<li><a href="https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create" target="_blank" rel="external">https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create</a></li>
<li>除了文档本身，作者在 Stack Overflow 上的回答都是非常值得阅读的。<a href="https://stackoverflow.com/users/34549/zzzeek" target="_blank" rel="external">https://stackoverflow.com/users/34549/zzzeek</a></li>
<li>Patterns of Enterprise Application Architecture - Martin Fowler</li>
<li><p><a href="http://aosabook.org/en/sqlalchemy.html" target="_blank" rel="external">http://aosabook.org/en/sqlalchemy.html</a></p>
<p>  <a href="http://techspot.zzzeek.org/" target="_blank" rel="external">http://techspot.zzzeek.org/</a></p>
</li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/09/Flask源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oh1n2bfoj.bkt.clouddn.com/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/09/Flask源码解析/" itemprop="url">Flask 源码初步解读</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-09T16:27:03+08:00">
                2018-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端开发/" itemprop="url" rel="index">
                    <span itemprop="name">后端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,050
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>系列文章先暂时停更一下。今天换换口味。</p>
<p>久闻 Flask 是众多 Pythonist 喜欢的框架。这次借着换工作的机会熟悉一下 Flask</p>
<ol>
<li>本文先分享我阅读代码的一些小经验</li>
<li>接着通过最简单的一个 WSGI APP 开始，带着<strong>如何设计一个 Web 框架</strong>这个问题，先头脑风暴，从而脑补（而不是实现）出一个 Web 框架的基本要素。</li>
<li>从源码角度理解，Flask 从启动到接受第一个请求、返回第一个响应期间都发生了什么。</li>
<li>最后交代一些自己在这个过程中的一些突发的想法。</li>
</ol>
<blockquote>
<p>将解读 Flask 的源码放在一篇文章里，势必会造成广度有余而深度不足。所以本想定位于 Flask 源码初步解读。</p>
</blockquote>
<h2 id="0x01-阅读-Flask-代码的一种较好的姿势"><a href="#0x01-阅读-Flask-代码的一种较好的姿势" class="headerlink" title="0x01 阅读 Flask 代码的一种较好的姿势"></a>0x01 阅读 Flask 代码的一种较好的姿势</h2><p>之前在 <a href="https://www.zhihu.com/question/28509408/answer/299763091" target="_blank" rel="external">https://www.zhihu.com/question/28509408/answer/299763091</a> 分享过自己一点阅读代码的粗浅的经验，是以阅读一个 Django 的应用为案例的。这里借着读 Flask 本身分享一下我的看法。</p>
<p>读源码，是一个技术活。一是忌讳要想读懂全部，另一个忌讳是以为自己能一下子毫无障碍的读懂全部代码。</p>
<ol>
<li>建议 0 : 看源码的时候，<strong>务必务必带着问题去读</strong>。每一次阅读其实都是在尝试回答或小或大的问题（当然，读书看文章莫不如是）。</li>
<li>建议 1 : 先读现成的文档，不要上来就对着代码一通瞎看。</li>
<li>建议 2 : 所谓『横看成岭侧成峰，远近高低都不同』 你需要从不同的角度来读源码。</li>
<li>建议 3 : 抓大放小，该略读就略读（比如知道 Nginx 的大致作用就好，做优化请求响应的时候再翻看文档），该精读则精读（具体一个关键的功能）。</li>
</ol>
<blockquote>
<p>好，坐好，预备，开车。</p>
</blockquote>
<h2 id="0x02-问题-1-如何设计一个-Web-框架"><a href="#0x02-问题-1-如何设计一个-Web-框架" class="headerlink" title="0x02 问题 1: 如何设计一个 Web 框架"></a>0x02 问题 1: 如何设计一个 Web 框架</h2><h3 id="头脑风暴"><a href="#头脑风暴" class="headerlink" title="头脑风暴"></a>头脑风暴</h3><p>Flask 是一个微 Web 框架，换而言之，代码量少的 Web 框架。当然，其实 Flask 框架是一个微框架，但『常规的 Flask 应用』本身的代码加起来一点都不比『Django 应用』少。这个地方我们后面会讲到。</p>
<p>在阅读 Flask 相关代码的之前，先头脑风暴一下：</p>
<blockquote>
<p>如何设计一个 Web 框架？</p>
</blockquote>
<p>当心中对这个问题有一定的了解之后，读 Flask 代码会更好。</p>
<p>首先，Web 框架是为了提升 Web 开发的。(XX 框架是为了提升 XX 开发的）, 这种提升可能会是 开发体验 / 性能。</p>
<p>我们来看看那个 Python 世界最基础的 wsgi app 相关代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)])</div><div class="line">    <span class="keyword">return</span> [<span class="string">'Hello World!'</span>]</div></pre></td></tr></table></figure>
<p>在之前的文章，我也借 Django 的 DRF 提到过这个极简的代码。</p>
<p>但这个简单的 webapp，显然是啥玩意都不够用的。比如说：</p>
<ul>
<li>没有路由，我访问啥玩意都是 hello world。</li>
<li>单线程 IO 阻塞模型基本上啥都不能干。你比如说，启动这个 webapp 的时候在 return 数据之前直接 sleep 十秒，然后请求都进不来。</li>
<li>没有数据存取，连个数据库链接 CURDE 啥玩意都没有</li>
<li>environ 太过于底层，如果是判断 headers 啥的太麻烦，要是像 django 里面一样能拿到一个 request 对象返回一个 response 对象就好了。</li>
<li>没有模板语言</li>
<li>还有其他能够提升开发体验的东西，比如自带 http server 代码热加载之类。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    <span class="comment"># 直接 thread local 支持多个请求。</span></div><div class="line">    <span class="comment"># 依据 environ 判断路由</span></div><div class="line">    <span class="comment"># 依据 路由 执行相关 view 层方法</span></div><div class="line">    <span class="comment"># 在相关 view 层方法内执行相关逻辑</span></div><div class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)])</div><div class="line">    <span class="comment"># 返回对应响应</span></div><div class="line">    <span class="keyword">return</span> response</div></pre></td></tr></table></figure>
<p>当然，思路是这么个思路，这个思路也确实非常的命令式，非常的面向过程。</p>
<p>至于我们如何把这个面向过程的思路变成面向对象的设计与实现，则需要更加细致的思考这些问题。</p>
<ol>
<li>能不能把 request 和 response 封装一下？方便在 view 里面处理？</li>
<li>能不能有个 URLDisparch 之类的东西，帮你解决 url 和 view 的 mapping 问题。或者路由能不能直接搞成 装饰器类型的比如 @router(“/“) 直接放在 view 层的 function 上。</li>
<li>能不能有个方便对数据库进行 CURDE 的东西？比如 ORM/ODM</li>
<li>这玩意会不会线程不安全，假如我想每一个请求都有单独的变量集合的话，线程怎么管理？</li>
<li>……</li>
</ol>
<h3 id="设计-Web-框架"><a href="#设计-Web-框架" class="headerlink" title="设计 Web 框架"></a>设计 Web 框架</h3><p>利用 Flask 作者的另一个库 werkzeug 的案例中有这么一个东西。</p>
<p><a href="https://github.com/pallets/werkzeug/blob/master/examples/shortly/shortly.py" target="_blank" rel="external">https://github.com/pallets/werkzeug/blob/master/examples/shortly/shortly.py</a></p>
<p>几百行代码就不贴在这里了。仔细看看还是挺有趣的。 这个可以算作另一个超简的 Webapp 了。</p>
<p>Flask 算作在这个基础上进行一定的扩展而成。</p>
<p>看完上面这个就可以出去吹牛逼可以自己写一个极简 Web 框架了。</p>
<p>那么，你可能有疑问，为何有了 Flask 之后，是否需要看这个更底层的 Werkzeug 的库，当然，有必要咯，Python 世界除了老牌的比较流行的 Django/Flask, 还有一个新星，叫做 APIStar</p>
<p><a href="https://github.com/encode/apistar" target="_blank" rel="external">https://github.com/encode/apistar</a></p>
<h2 id="0x02-问题-2-请求流程是怎么样的"><a href="#0x02-问题-2-请求流程是怎么样的" class="headerlink" title="0x02 问题 2: 请求流程是怎么样的"></a>0x02 问题 2: 请求流程是怎么样的</h2><p>我们就拿这个 flask 的极简案例，进行<strong>首次</strong>阅读 Flask 代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># hello.py</span></div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello, World!'</span></div><div class="line"></div><div class="line">$ FLASK_APP=hello.py flask run</div></pre></td></tr></table></figure>
<blockquote>
<p>从请求到响应的整个流程，Flask 的是怎么处理请求的？</p>
</blockquote>
<h3 id="2-1-服务器是怎么起来的"><a href="#2-1-服务器是怎么起来的" class="headerlink" title="2.1 服务器是怎么起来的"></a>2.1 服务器是怎么起来的</h3><p>首先 flask run 之后，发生了什么？</p>
<p>先初始化环境变量，然后导入 dotenv 文件，然后执行 run_command 方法，找到 hello.py 然后导入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cli.py#run_command 方法</span></div><div class="line">app = DispatchingApp(info.load_app, use_eager_loading=eager_loading)</div><div class="line"><span class="comment"># 上一行代表着其实我们每次在本地 flask run 的时候，起的服务并不是 flask_app, 而是被 DispatchingApp 包装了一层的 flask app</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</div><div class="line">run_simple(host, port, app, use_reloader=reload, use_debugger=debugger,</div><div class="line">            threaded=with_threads, ssl_context=cert)</div></pre></td></tr></table></figure>
<p>进行这层包装之后，就可以显示 WERKZEUG 的所谓在浏览器中的 报错信息了。</p>
<p>通常开发时这里的 run_simple 最后会调用 run_with_reloader , 每当程序退出的时候，reloader 就依照策略重新跑一次 reload 一次。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_reloader</span><span class="params">(main_func, extra_files=None, interval=<span class="number">1</span>,</span></span></div><div class="line">                      reloader_type=<span class="string">'auto'</span>):</div><div class="line">    <span class="string">"""Run the given function in an independent python interpreter."""</span></div><div class="line">    <span class="keyword">import</span> signal</div><div class="line">    reloader = reloader_loops[reloader_type](extra_files, interval)</div><div class="line">    signal.signal(signal.SIGTERM, <span class="keyword">lambda</span> *args: sys.exit(<span class="number">0</span>))</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">if</span> os.environ.get(<span class="string">'WERKZEUG_RUN_MAIN'</span>) == <span class="string">'true'</span>:</div><div class="line">            t = threading.Thread(target=main_func, args=())</div><div class="line">            t.setDaemon(<span class="keyword">True</span>)</div><div class="line">            t.start()</div><div class="line">            reloader.run()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            sys.exit(reloader.restart_with_reloader())</div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt:</div><div class="line">        <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>好，服务起来了。</p>
<h3 id="2-2-请求-响应的流程"><a href="#2-2-请求-响应的流程" class="headerlink" title="2.2 请求-响应的流程"></a>2.2 请求-响应的流程</h3><p>我们先看 Flask 类里面的比较关键的两个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    <span class="comment"># 一些方法 ......</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 主要是执行一些方法，最后返回响应</span></div><div class="line">        self.try_trigger_before_first_request_functions()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            request_started.send(self)</div><div class="line">            rv = self.preprocess_request()</div><div class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                rv = self.dispatch_request()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            rv = self.handle_user_exception(e)</div><div class="line">        <span class="comment"># ??? TODO</span></div><div class="line">        <span class="keyword">return</span> self.finalize_request(rv)</div><div class="line"></div><div class="line">    <span class="comment"># 这里是我们熟悉的 environ, 和 start_response</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        :param environ: a WSGI environment</div><div class="line">        :param start_response: a callable accepting a status code,</div><div class="line">                               a list of headers and an optional</div><div class="line">                               exception context to start the response</div><div class="line">        """</div><div class="line">        <span class="comment"># 在这里对 environ 进行封装，创建请求上下文</span></div><div class="line">        ctx = self.request_context(environ)</div><div class="line">        error = <span class="keyword">None</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="comment"># 这里将请求上下文压入 _request_ctx_stack</span></div><div class="line">                ctx.push()</div><div class="line">                response = self.full_dispatch_request()</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                error = e</div><div class="line">                response = self.handle_exception(e)</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                error = sys.exc_info()[<span class="number">1</span>]</div><div class="line">                <span class="keyword">raise</span></div><div class="line">            <span class="keyword">return</span> response(environ, start_response)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            <span class="keyword">if</span> self.should_ignore_error(error):</div><div class="line">                error = <span class="keyword">None</span></div><div class="line">            <span class="comment"># 这里将创建的请求上下文从中 _request_ctx_stack pop 出来</span></div><div class="line">            ctx.auto_pop(error)</div></pre></td></tr></table></figure>
<p>从 wsgi_app 泪看，就可以看到我们之前在当时在开脑洞时候看到的。</p>
<ol>
<li>把 request 和 response 封装一下？方便在 view 里面处理？</li>
<li>有个 URLDisparch 之类的东西，帮你解决 url 和 view 的 mapping 问题。</li>
</ol>
<p>话说回来？</p>
<blockquote>
<p>这个 ctx 是啥？<br>当然，flask 不带 ORM, 这我们也就不研究了。</p>
</blockquote>
<p>– TODO: 在这里需要重构一下</p>
<p>不过话说回来 请求上下文的容器 request_ctx_stack 到底是啥？</p>
<blockquote>
<p>另一种本地数据存储方式。</p>
</blockquote>
<p>在多线程的情况下，每一个请求都会创建一个线程，从这个请求被发起到销毁，我想拥有单独的变量（修改这个变量不会影响到其他变量），比如 sessions 之类。</p>
<p>显然，在多线程的情况下，以上的需求完全可以通过 threadlocal 来实现。</p>
<p>翻了 werkzeug 的文档，找到了原因：</p>
<blockquote>
<p>因为 python 里面的并发模型并不只有多线程一种。比如 greenlets, 每一个请求，都在一个线程里面。</p>
</blockquote>
<h2 id="0x02-问题-2-Flask-中-Context-机制"><a href="#0x02-问题-2-Flask-中-Context-机制" class="headerlink" title="0x02 问题 2: Flask 中 Context 机制"></a>0x02 问题 2: Flask 中 Context 机制</h2><p>在 Django 完成一个 View 层的逻辑是这样的，Django 封装好了请求，请求经过 middleware 的处理，最后调用 login 函数，并且传入 request 方便 view 函数进行处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        error = someerror</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, error=error)</div></pre></td></tr></table></figure>
<p>在 Flask 完成一个 View 层的逻辑是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"><span class="meta">@app.route('/login', methods=['POST', 'GET'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        error = someerror</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, error=error)</div></pre></td></tr></table></figure>
<p>假如我是一个爱问问题的年轻人，这里肯定会有疑惑：</p>
<blockquote>
<p>从外部 import 过来，那就是利用了 python 自带的 import 单例模式。 那么线程和线程之间拿到的肯定是同一个 request 呀。但 Django 里面每个 request 都是不一样的，否则一些很基础功能的比如已经认证的用户就无法拿到了。</p>
</blockquote>
<p>我已经不是那个爱问问题的年轻人，因为年纪已经不小了。逃…</p>
<p>显然，每一次在 view 层引用的 request 肯定不是同一个 request , 那么，这是如何做到的呢？比如用 ThreadLocal , ThreadLocal 通过每个线程不同的 ID 拿到的本地变量，于是我们查看一下对应的实现。 这个 request 来自于 global.py , 使用了一个 werkzeug.local 里面的 LocalProxy</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</div><div class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalStack, LocalProxy</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _request_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> top.app</div><div class="line"></div><div class="line"><span class="comment"># context locals</span></div><div class="line">_request_ctx_stack = LocalStack()</div><div class="line">_app_ctx_stack = LocalStack()</div><div class="line">current_app = LocalProxy(_find_app)</div><div class="line"><span class="comment"># 这就是我们需要的注意的地方，LocalProxy</span></div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div><div class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</div><div class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">'g'</span>))</div></pre></td></tr></table></figure>
<p>看到这里一阵蛋疼，貌似没有 threadlocal ？再次查看相关实现最后还是定位到了如何区分不同的 request 的核心代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># since each thread has its own greenlet we can just use those as identifiers</span></div><div class="line"><span class="comment"># for the context.  If greenlets are not available we fall back to the</span></div><div class="line"><span class="comment"># current thread ident depending on where it is.</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</div><div class="line">    <span class="comment"># greenlet 的代码是 C, 时间长没看 C 代码了，看了半天没看明白</span></div><div class="line">    <span class="comment"># 翻了文档返回当前的 greenlet, 也就是返回调用此函数的 greenlet</span></div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</div><div class="line">    <span class="keyword">except</span> ImportError:</div><div class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></div><div class="line">    __slots__ = (<span class="string">'__storage__'</span>, <span class="string">'__ident_func__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        object.__setattr__(self, <span class="string">'__storage__'</span>, &#123;&#125;)</div><div class="line">        <span class="comment"># 这里传递的 ident 就可以直接</span></div><div class="line">        object.__setattr__(self, <span class="string">'__ident_func__'</span>, get_ident)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span>:</span></div><div class="line">    <span class="comment"># 用 local 实现的栈</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span>:</span></div><div class="line">    <span class="comment"># 一个 local 的代理器</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">    <span class="keyword">if</span> name == <span class="string">'__members__'</span>:</div><div class="line">        <span class="keyword">return</span> dir(self._get_current_object())</div><div class="line">    <span class="keyword">return</span> getattr(self._get_current_object(), name)</div></pre></td></tr></table></figure>
<p>即：</p>
<ol>
<li>当 Flask 以多线程模型运行的时候，则使用的是 threadlocal 方式</li>
<li>当 Flask 以 greenlet 的模型运行的时候，则使用的是 greenlet 区分不同</li>
</ol>
<p>接下来回头看一下处理 request 的逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"><span class="meta">@app.route('/login', methods=['POST', 'GET'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># 这个 request 哪里来？</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        error = someerror</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, error=error)</div></pre></td></tr></table></figure>
<p>于是，我们就知道了，当引用 request 这个 LocalProxy 的时候，引用的确实是同一个名称为 request 变量，并且这个变量也确实是 LocalProxy 的实例</p>
<blockquote>
<p>但是当使用 request.method 的时候，LocalProxy 重载了 取到的则是另一个『请求对象』的 method.</p>
</blockquote>
<p>于是拿到当前请求的信息。</p>
<p>当然，其实我们也可以依据利用这个技巧写一个 currentuser 的 ProxyLocal, 然后在每个 view 层里面使用 user.has_something 进行操作。</p>
<h2 id="0x03-问题-3-Flask-中官方的机制"><a href="#0x03-问题-3-Flask-中官方的机制" class="headerlink" title="0x03 问题 3: Flask 中官方的机制"></a>0x03 问题 3: Flask 中官方的机制</h2><h2 id="0x04-问题-3-Flask-中是如何做到优雅扩展的"><a href="#0x04-问题-3-Flask-中是如何做到优雅扩展的" class="headerlink" title="0x04 问题 3: Flask 中是如何做到优雅扩展的"></a>0x04 问题 3: Flask 中是如何做到优雅扩展的</h2><h2 id="0x05-其他问题"><a href="#0x05-其他问题" class="headerlink" title="0x05 其他问题"></a>0x05 其他问题</h2><h3 id="Flask-应用"><a href="#Flask-应用" class="headerlink" title="Flask 应用"></a>Flask 应用</h3><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oh1n2bfoj.bkt.clouddn.com/avatar.png"
               alt="Micheal Gardner" />
          <p class="site-author-name" itemprop="name">Micheal Gardner</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">80</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">94</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/twocucao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/twocucao" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/twocucao" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Micheal Gardner</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

</body>
</html>
