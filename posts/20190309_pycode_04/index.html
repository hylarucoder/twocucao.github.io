<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>这几招，让你快速提升 Python 项目的性能 - 海拉鲁编程客</title><meta name="Description" content="这篇文章展示了基本的 Markdown 语法和格式."><meta property="og:title" content="这几招，让你快速提升 Python 项目的性能" />
<meta property="og:description" content="这篇文章展示了基本的 Markdown 语法和格式." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://twocucao.xyz/posts/20190309_pycode_04/" />
<meta property="article:published_time" content="2019-03-05T21:57:40+08:00" />
<meta property="article:modified_time" content="2020-01-01T16:45:40+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="这几招，让你快速提升 Python 项目的性能"/>
<meta name="twitter:description" content="这篇文章展示了基本的 Markdown 语法和格式."/>
<meta name="application-name" content="海拉鲁编程客">
<meta name="apple-mobile-web-app-title" content="海拉鲁编程客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://twocucao.xyz/posts/20190309_pycode_04/" /><link rel="prev" href="http://twocucao.xyz/posts/20190210_%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9/" /><link rel="next" href="http://twocucao.xyz/posts/20190308_pycode_03/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "这几招，让你快速提升 Python 项目的性能",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/twocucao.xyz\/posts\/20190309_pycode_04\/"
        },"genre": "posts","keywords": "Python","wordcount":  642 ,
        "url": "http:\/\/twocucao.xyz\/posts\/20190309_pycode_04\/","datePublished": "2019-03-05T21:57:40+08:00","dateModified": "2020-01-01T16:45:40+08:00","publisher": {
            "@type": "Organization",
            "name": "twocucao"},"author": {
                "@type": "Person",
                "name": "twocucao"
            },"description": "这篇文章展示了基本的 Markdown 语法和格式."
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/posts/"> 存档 </a><a class="menu-item" href="/tags/"> 标签 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/posts/" title="">存档</a><a class="menu-item" href="/tags/" title="">标签</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">这几招，让你快速提升 Python 项目的性能</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://twocucao.xyz" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas"></i>twocucao</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-03-05">2019-03-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 642 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>本文是《提升你的 Python 项目代码健壮性和性能》系列的第四篇文章。</p>
<p>第一篇，讲的是如何 用 Type Annotation 提升你的 Python 代码健壮性
第二篇，讲的是 如何通过测试提升 Python 代码的健壮性
第三篇，讲的是在一定并发量的情况下，如何保证 Django 项目的数据一致性</p>
<p>第四篇，即本文，9012 年</p>
<p>当你觉得某个地方运行比较慢了，此时此刻的你，有哪些小技巧可以快速的帮
你定位性能问题。
目录如下</p>
<p>▼ 这几招，让你快速提升 Python 项目的性能 : section
0x00 前言 : section
▼ 0x01 Python 优化的五件武器 : section
第一件武器 timeit : section
第二件武器 profile 与 cprofile : section
第三件武器 line profiler : section
第四件武器 memory profiler : section
第五件武器 pympler : section
其他神器 : section
▼ 0x02 优化 Web 项目 : section
提前优化 : section
做好监控 : section
▼ 0x03 性能优化建议 : section
建议 1. 务必了解 Python 里面的负优化常识 : section
建议 2. 能用内置的模块就不要手动实现 : section
建议 3. 能用优质的第三方库就不要手动实现 : section
0xDD 结论 : section
0xEE 参考链接 : section
0x00 前言
本文主要目的在于介绍一些 Python 项目常规的性能优化的姿势与技巧。</p>
<p>优化的最简单的途径就是，没用户 + 调用次数少</p>
<p>嗯？但这种优化方式&hellip;&hellip; 实在是没什么好说的。</p>
<p>优化口诀 1: 先做对，布监控，再做好。
优化口诀 2: 过早优化是万恶之源。
优化口诀 3: 去优化那些需要优化的地方。
即</p>
<p>Step 1. Get it right.
Step 2. Test it&rsquo;s right.
Step 3. Monitor.
Step 4. Profile if slow.
Step 5. Try Optimize.
Step 6. Repeat from 2.
有的人站出来说，我写程序就是要一步到位，把能优化的点一次性搞定。</p>
<p>请不要听他的，因为优化是无止境的。唯快不破</p>
<p>能一次写出优雅清晰而且性能高的代码的人，一般很少见到。毕竟需要考虑的点太多了。</p>
<p>基于上面的认知，代码的可维护性是第一位的。</p>
<p>写代码的首先应该是代码很清晰，非常容易维护。
然后在没有过分降低可维护性的情况下，作出性能的优化。
0x01 Python 优化的五件武器
钟声响起归家的讯号，刚回到家。</p>
<p>公司群响起加班的讯号，用户反应服务响应总是超时。</p>
<p>你打开电脑，隐隐约约觉得是某个函数的问题。这个函数的功能比较多，调试了很久才调试通。</p>
<p>浏览代码。大致定位了这个问题可能会在下面的几个函数中。</p>
<p>def red_packet_calculation_algorithm():
pass</p>
<p>def user_stats_calculation_algorithm():
pass</p>
<p>def dashboard_calculation_algorithm():
pass
如何确定是哪个函数需要优化呢？</p>
<p>很简单，到 IPython 里面执行一下就就知道了。感觉慢的就是目标函数。</p>
<p>总觉得执行一下这个操作有点不稳定。如果有个工具，可以直接执行很多次，然后作出统计就好了。</p>
<p>这就是 Python 代码优化第一件武器 timeit</p>
<p>第一件武器 timeit
通常某段代码有问题，最直接的方法就是跑一下这段代码。</p>
<p>在 IPython 里执行</p>
<h1 id="ipython">ipython</h1>
<p>%time your-algorithm
timeit 将代码执行多次，取均值</p>
<p>一般这个时候，你就可以初步定位问题所在了。</p>
<p>比如，发现 user_stats_calculation_algorithm 在 一个 for 循环里面走了数据库查询。
也有一些函数并不是那么容易定位。</p>
<p>即，通过这个 timeit 知道了某个函数执行比较慢，但那个函数 里面还有很多函数，通过肉眼观察，还是没有办法来解决呀。</p>
<p>这个时候你想了，如果能看到哪些语句执行的次数多一些，耗时长一些，就好了。</p>
<p>这就是 Python 代码优化第二件武器 profile 。</p>
<p>第二件武器 profile 与 cprofile
在 ipython 中运行</p>
<p>这么一看，耗时操作一览无遗。</p>
<p>语句级别的 Profile 有了，但其实，很多时候也并不能解决你的问题。</p>
<p>如果能有这么个东西，即，能在代码旁边注释一下，执行次数和耗时就好了。</p>
<p>这就是 Python 代码优化第三件武器 line profile。</p>
<p>第三件武器 line profiler
能在代码旁边注释，执行次数和耗时。如下</p>
<p>Pystone(1.1) time for 50000 passes = 2.48
This machine benchmarks at 20161.3 pystones/second
Wrote profile results to pystone.py.lprof
Timer unit: 1e-06 s</p>
<p>File: pystone.py
Function: Proc2 at line 149
Total time: 0.606656 s</p>
<h1 id="line-------hits---------time--per-hit----time--line-contents">Line #      Hits         Time  Per Hit   % Time  Line Contents</h1>
<p>149                                           @profile
150                                           def Proc2(IntParIO):
151     50000        82003      1.6     13.5      IntLoc = IntParIO + 10
152     50000        63162      1.3     10.4      while 1:
153     50000        69065      1.4     11.4          if Char1Glob == &lsquo;A&rsquo;:
154     50000        66354      1.3     10.9              IntLoc = IntLoc - 1
155     50000        67263      1.3     11.1              IntParIO = IntLoc - IntGlob
156     50000        65494      1.3     10.8              EnumLoc = Ident1
157     50000        68001      1.4     11.2          if EnumLoc == Ident1:
158     50000        63739      1.3     10.5              break
159     50000        61575      1.2     10.1      return IntParIO
这个可谓是 Python 世界里时间性能优化的顶级工具了。</p>
<p>第四件武器 memory profiler
说完了时间上的优化，再说说空间上的优化。</p>
<p>如何检查内存呢？</p>
<p>这需要 Python 代码优化第四件武器 memory profiler。</p>
<p>这个工具用于查看 Python 程序的内存占用情况</p>
<p>但，知道了执行某些代码之后，内存是多少又能如何呢？</p>
<p>不见得能定位出来是什么东西</p>
<p>内存中这么多 objects 我上哪看去？</p>
<p>假设内存泄漏了，我再怎么 profile, 内存都是一直泄漏的呀。</p>
<p>总要想办法定位出是哪些类型的有问题。</p>
<p>第五件武器 pympler
这需要 Python 代码优化第五件武器 pympler。这是我从雨痕的《 Python学习笔记 》里看到的</p>
<p>这个工具特别适合给当前所有的 objects 的内存占用情况做简单统计。</p>
<p>之前的一次线上代码出内存泄漏，检查了自己的代码确定没有问题之后，将目光放在了第三
方库上。</p>
<p>但第三方库也有不少，检查半天依旧没有什么进展。</p>
<p>from pympler import tracker</p>
<h1 id="在多处打点并且将结果打到日志里">在多处打点，并且将结果打到日志里。</h1>
<p>memory_tracker = tracker.SummaryTracker()
每次打印出来的结果大致是这样子的。</p>
<p>types |   # objects |   total size
================== | =========== | ============
dict |           1 |     280    B
list |           1 |     176    B
_sre.SRE_Pattern |           1 |      88    B
tuple |           1 |      80    B
str |           0 |       7    B
刚开始都还挺正常，运行了一段时间之后，日志中的部分涉及到 flask-sqlalchemy
的 objects 和 total size 保持了坚挺的增长。</p>
<p>最后发现 flask-sqlalchemy 如果 设置了 SQLALCHEMY_RECORD_QUERIES 为 True 的话，</p>
<p>每次查询都会往 current_app.sqlalchemy_queries 里增加 DebugQueryTuple, 很快就内存泄漏了。</p>
<p>queries = _app_ctx_stack.top.sqlalchemy_queries
queries.append(_DebugQueryTuple((
statement, parameters, context._query_start_time, _timer(),
_calling_context(self.app_package)
)))
其他神器
可视化调用</p>
<p>当然, 也有一些比较方便的工具是用来查看函数的调用信息的</p>
<p>效果大概是这样子</p>
<p>当然, 也有其他的工具</p>
<p><a href="https://stackoverflow.com/questions/582336/how-can-you-profile-a-python-script">https://stackoverflow.com/questions/582336/how-can-you-profile-a-python-script</a></p>
<p>0x02 优化 Web 项目
提前优化
在使用 Django 项目的时候，我必须要安装的第三方库就是 djangodebugtools</p>
<p>这个工具用起来有多舒服呢？</p>
<p>可以直接 Profile SQL 语句</p>
<p>甚至可以直接 explain sql 以及 查看缓存情况</p>
<p>做好监控
如何监控，监控什么指标？这属于日志的范畴了。</p>
<p>日志的道术器分别是什么，这将在下一篇文章来具体介绍一下如何打日志。</p>
<p>0x03 性能优化建议
笔者列了一些大方向上的优化建议，具体是要靠积累。</p>
<p>建议 1. 务必了解 Python 里面的负优化常识
不要在 for loop 里面不断的链接 string, 用列表 +JOIN 的方式会更加合适。
建议 2. 能用内置的模块就不要手动实现
比如，当你想做一些字符串上的变动的时候，不防先查看一下 string / textwrap / re / difflib 里是不是满足你的要求了
比如你操作一组比较类似的数据类型，可以考虑看下 enum / collection / itertools / array
/ heapq 里面是不是已经满足你的要求了。
笔者在 <a href="https://zhuanlan.zhihu.com/p/32504320">https://zhuanlan.zhihu.com/p/32504320</a> 中曾经遇到过统计的问题。</p>
<p>当时遇到的问题场景是</p>
<p>有 400 组 UUID 集合，每个列表数量在 1000000 左右，列表和列表之间重复部分并不是很大。我想拿到去重之后的所有 UUID，应该怎么处理</p>
<h1 id="版本一运行遥遥无期">版本一，运行遥遥无期</h1>
<p>list_of_uuid_set = [ set1 , set2 &hellip; set400 ]
all_uuid_set = reduce(lambda x: x | y, list_of_uuid_set)</p>
<h1 id="版本二运行遥遥无期">版本二，运行遥遥无期</h1>
<p>def merge(list1,list2):
list1.append(list2)
return list1</p>
<p>list_of_uuid_list = [ list1 , list2 &hellip; list400 ]
all_uuid_set = set(reduce(merge, list_of_uuid_list))</p>
<h1 id="版本三5s">版本三，5s</h1>
<p>list_of_uuid_list = [ list1 , list2 &hellip; list400 ]
all_uuid_set = set(list(itertools.chain(*list_of_uuid_list)))
合适的数据结构和合适的算法，确实能让代码变得清晰，高效，优雅。</p>
<p>建议 3. 能用优质的第三方库就不要手动实现
除了一些内置的模块，</p>
<p>一些优秀的软件所依赖的第三方包也是非常值得留意的。
一般能上 C 库的，用于解析的依赖包性能不错，比如 LXML/Numpy 这类包
0xDD 结论
本文讲的是，当你觉得某个地方运行比较慢了，此时此刻的你，有哪些小技巧可以快速的帮
你定位性能问题。
其实还有很多悬而未决的问题：</p>
<p>定位了问题，如何解决问题？
如何觉察到某个地方运行比较慢呢？
对于第一点，还是得多看多搜多练。用《亮剑》中的李云龙的话说：</p>
<p>真正的神枪手是战场上用子弹喂出来的。打得多了，感觉就有了，眼到手就到，抬枪就有，弹弹咬肉，这就叫神枪手。
对于第二点，就是下一篇文章需要解决的问题了。</p>
<p>通过日志来判断。
通过打点和结合 APMServer 来判断。
0xEE 参考链接
<a href="https://zhuanlan.zhihu.com/p/32504320">https://zhuanlan.zhihu.com/p/32504320</a>
<a href="https://pynash.org/2013/03/06/timing-and-profiling/">https://pynash.org/2013/03/06/timing-and-profiling/</a>
<a href="https://wiki.python.org/moin/P">https://wiki.python.org/moin/P</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">Python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20190210_%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9/" class="prev" rel="prev" title="秒杀系统的一些注意点"><i class="fas fa-angle-left fa-fw"></i>秒杀系统的一些注意点</a>
            <a href="/posts/20190308_pycode_03/" class="next" rel="next" title="如何保证 Django 项目的数据一致性">如何保证 Django 项目的数据一致性<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://twocucao.xyz" target="_blank">twocucao</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
