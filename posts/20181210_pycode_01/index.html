<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>用 Type Anotation 提升你的 Python 代码健壮性 - 海拉鲁编程客</title><meta name="Description" content="这篇文章展示了基本的 Markdown 语法和格式."><meta property="og:title" content="用 Type Anotation 提升你的 Python 代码健壮性" />
<meta property="og:description" content="这篇文章展示了基本的 Markdown 语法和格式." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://twocucao.xyz/posts/20181210_pycode_01/" />
<meta property="article:published_time" content="2018-12-10T21:57:40+08:00" />
<meta property="article:modified_time" content="2020-01-01T16:45:40+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="用 Type Anotation 提升你的 Python 代码健壮性"/>
<meta name="twitter:description" content="这篇文章展示了基本的 Markdown 语法和格式."/>
<meta name="application-name" content="海拉鲁编程客">
<meta name="apple-mobile-web-app-title" content="海拉鲁编程客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://twocucao.xyz/posts/20181210_pycode_01/" /><link rel="prev" href="http://twocucao.xyz/posts/20181125_finalcutprox/" /><link rel="next" href="http://twocucao.xyz/posts/20181223_vlogcheatsheet/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "用 Type Anotation 提升你的 Python 代码健壮性",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/twocucao.xyz\/posts\/20181210_pycode_01\/"
        },"genre": "posts","keywords": "Python, 系列文章","wordcount":  704 ,
        "url": "http:\/\/twocucao.xyz\/posts\/20181210_pycode_01\/","datePublished": "2018-12-10T21:57:40+08:00","dateModified": "2020-01-01T16:45:40+08:00","publisher": {
            "@type": "Organization",
            "name": "twocucao"},"author": {
                "@type": "Person",
                "name": "twocucao"
            },"description": "这篇文章展示了基本的 Markdown 语法和格式."
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/posts/"> 存档 </a><a class="menu-item" href="/tags/"> 标签 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/posts/" title="">存档</a><a class="menu-item" href="/tags/" title="">标签</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">用 Type Anotation 提升你的 Python 代码健壮性</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://twocucao.xyz" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas"></i>twocucao</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python-%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E5%81%A5%E5%A3%AE%E6%80%A7%E5%92%8C%E6%80%A7%E8%83%BD/"><i class="far fa-folder fa-fw"></i>Python 项目代码健壮性和性能</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-12-10">2018-12-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 704 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x00-前言">0x00 前言</a></li>
    <li><a href="#0x01-why-type-annotation">0x01 Why Type Annotation</a></li>
    <li><a href="#0x02-gradual-typing">0x02 Gradual Typing</a>
      <ul>
        <li><a href="#静态类型-vs-动态类型">静态类型 VS 动态类型</a></li>
        <li><a href="#静态类型--动态类型">静态类型 + 动态类型</a></li>
      </ul>
    </li>
    <li><a href="#0x03-python-typing-实战---mypy">0x03 Python Typing 实战 - MyPY</a>
      <ul>
        <li><a href="#mypy">MyPy</a></li>
        <li><a href="#快速入门">快速入门</a></li>
      </ul>
    </li>
    <li><a href="#0x04-常见问题">0x04 常见问题</a>
      <ul>
        <li><a href="#如何忽略-mypy-警告">如何忽略 mypy 警告</a></li>
        <li><a href="#循环导入">循环导入</a></li>
      </ul>
    </li>
    <li><a href="#0x05-typing-anotation-项目最佳实践">0x05 Typing Anotation 项目最佳实践</a></li>
    <li><a href="#0xee-参考">0xEE 参考</a>
      <ul>
        <li><a href="#pep">PEP</a></li>
        <li><a href="#扩展文章">扩展文章</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="0x00-前言">0x00 前言</h2>
<p>本文是《提升你的 Python 项目代码健壮性和性能》系列的第一篇文章。</p>
<p>当我刚知道 Python 要添加类型的时候，我的内心是拒绝的。</p>
<p>Why, Why, Why? 就是因为不喜欢类型，也不喜欢特别动态的语言。</p>
<p>但是，尝试了俩个疗程之后，腰也不疼了，腿也不疼了，走起路来都有劲了</p>
<blockquote>
<p>嗯，真香。</p>
</blockquote>
<h2 id="0x01-why-type-annotation">0x01 Why Type Annotation</h2>
<p>人们常说</p>
<blockquote>
<p>动态类型一时爽，代码重构火葬场。</p>
</blockquote>
<p>在刚写 Python 的前两年里并没有感受很深。</p>
<p>直到，开始和别人协作的时候，才发现各种莫名其妙的问题。</p>
<ol>
<li>大量的使用魔法方法</li>
<li>flake8 分析出某个函数过于复杂</li>
<li>send_message 里面有不少的参数，一不小心就传参错误</li>
<li>None 值</li>
</ol>
<p>动态类型给人极大的灵活性，写的时候很爽，但如果解放了双手，撸起袖子一通写，自己写起来爽了，自己重构的时候或者其他人来看代码的时候，头发就会加速掉落。</p>
<p>聪明的你很容易反问，只要我们团队不犯这些错误，不就好了么？</p>
<p>是的，当我们讨论 Python Annotation 的时候，往往陷入类型之争。</p>
<p>我并不想讨论静态类型和动态类型孰好孰坏。</p>
<p>我想讨论的是<strong>加了 Typing 极大的提升代码的健壮性。</strong></p>
<p>先从 Gradual Typing 说起吧。</p>
<h2 id="0x02-gradual-typing">0x02 Gradual Typing</h2>
<p>在你刚入门一门编程语言的时候，我们常常说，Java 是强类型静态语言，Python 是强类型动态语言</p>
<p>从这两位诞生开始，静态类型和动态类型就一直进行旷日持久的圣战。</p>
<p>然而，而现在的发展趋势是：</p>
<ul>
<li>静态类型的语言觉得自己太过静态，以至于写起来很啰嗦。于是引入了很多类型推断。 Java / Go</li>
<li>动态类型的语言觉得自己太过动态，以至于协作的过程中总是出现低级错误。于是引入了 Gradual Typing , Typescript / Flow / Python Type Annotation</li>
</ul>
<p>什么是 Gradual Typing?</p>
<p>Gradual typing 允许开发者仅在程序的部分地区使用 Annotate/Type. 即，既不是黑猫（静态）, 也不是白猫（动态），从而诞生了熊猫（动静结合）。</p>
<p>话说回来，要知道为什么这么搞，首先要知道动态类型和静态类型会给程序带来什么。</p>
<h3 id="静态类型-vs-动态类型">静态类型 VS 动态类型</h3>
<p>静态类型的语言，比如在写 Java 的时候，如果你把一个 int 赋值给了 string 的变量，IDE 会通过<strong>类型检查器</strong>立即报错并告诉你，你这个值赋值错啦。这个就是 Java 程序的检查阶段。
动态类型的语言，比如在写 Python 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。如果线上还是出这个问题，就蛋疼了。</p>
<p>为了进行友好的讨论，本人将精分成 Javaer 和 Pythonist, 通过两人对话的方式，来讨论类型。</p>
<ul>
<li>
<p>Javaer: 我先喝杯咖啡</p>
</li>
<li>
<p>Pythonist: 生命苦短，我用 Python。</p>
</li>
<li>
<p>Javaer: P 哥，请（为什么叫 P 哥？Python 1989 年出生，Java 1995 年）</p>
</li>
<li>
<p>Pythonist: J 弟，请</p>
</li>
<li>
<p>Javaer: 静态类型可以较低成本的提早捕获 BUG, 比如：</p>
<ol>
<li>你在写 Python 的时候，如果不用一些额外的手段，这种低级的错误，并不会在检查时爆出来，只会在运行时爆出来。</li>
<li>如果线上还是出这个问题，就蛋疼了。我这个类型检查可以在<strong>使用 IDE 的时候给我分析出方法参数的类型和返回值</strong>。所谓『上医治未病，中医治已病，下医治大病』, 防范于未然，善之善者也。</li>
</ol>
</li>
<li>
<p>Python: 等等，你小子还广征博引了还，首先，提早捕获 Bug, 我这里也有呀，比如我这里可以通过 flake8 来检查出有些没有定义的变量，<strong>仅仅是类型没有检查而已</strong>。其次，IDE 给我的补全又不是完全无法补全。弱一点罢了。你说的类型检查的问题：</p>
<ol>
<li>可以通过<strong>提升程序员的素质</strong>来解决这个问题，或者让他们长点脑子，别特么在这种低级错误上犯错误。</li>
<li>写测试来<strong>提升测试代码的代码覆盖率</strong>（这个我会在本系列的第二篇文章里深入讲解）来解决这个问题</li>
<li>看看写的代码检查时出现问题，我完全可以<strong>把代码拖到 IPython 里面跑一遍</strong>。这可不仅仅能解决类型不正确带来的问题，还能快速解决代码的逻辑问题</li>
</ol>
</li>
<li>
<p>Java: 关于你说的第三点，我完全可以提升测试代码的覆盖率。哎？似乎我这个开发测试成本也上来了。看来<strong>类型检查也不能解决这个问题</strong></p>
</li>
<li>
<p>Javaer: 来 P 哥</p>
<ol>
<li>静态类型确实以<strong>较低的成本</strong>解决了这种类型的问题，不是么？</li>
<li>并且，如果我其中一小块功能进行了修改，我总不能每次都跑 IPython 吧？我也不能因为想检查一下类型这种小操作就写测试代码覆盖一下？</li>
</ol>
</li>
<li>
<p>Python: 你每次修改，都要加类型，加类型，改类型，直到类型检查器完全接受。不麻烦嘛？面向类型检查器编程？</p>
</li>
<li>
<p>Javaer: 来，</p>
<ol>
<li>每次改代码的时候，又不是改一大推，你是小部分改的，能有多少项目是海量海量改？高内聚，低耦合，模块化开发。</li>
<li>好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。</li>
<li>我大 Java 就是面向重构的语言！我有 Jetbrain 的 IDE, 重构代码我怕谁</li>
</ol>
</li>
<li>
<p>Python: 来，你说的没错，</p>
<ol>
<li><strong>每次改代码的时候，又不是改一大推，你是小部分改的</strong>。这话你说的没错，我也能用啊，因为代码总是一小部分一小部分改的，所以，改完了跑一下 IPython 就结了。</li>
<li>好的代码是重构出来的，修改你的类型来让类型检查器通过。你的代码会被更好的组织起来。这话你说的也没错，可<strong>我重构的时候没有写测试就重构</strong>，是不是有点莽撞？写了测试了，我还要花时间在类型检查器上，不啰嗦么？</li>
<li>我也有 Jetbrain 的 IDE, 重构代码我又不是不能重构。</li>
</ol>
</li>
<li>
<p>Python: 再来，</p>
<ol>
<li>需求变更上来了，结果往往会出现，你本来是想专注于业务逻辑的更改的，但最后变成了大型<strong>为了让类型检查器通过类型检查而艰苦奋斗的现场</strong>, 我这个场景直接传 int/str/ 字典 / 传对象就很方便，你非要让我写四个函数来 override 方法。</li>
<li>虽然说，好代码确实可以通过重构出来，但动态语言表达能力强呀，你 Java HashMap 啰啰嗦嗦 put 写了半天，我 Python 一个 Dict 一把梭，看起来，清晰，改起来方便。</li>
</ol>
</li>
</ul>
<p>再比如说，</p>
<p>LeetCode 上面有一道题目，叫做最长连续 1</p>
<p>Input 是 [1,1,0,1,1,1] Output 是 3</p>
<p>我们尝试用 Python 来看下</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">find_max_consecutive_ones</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)))</span>
</code></pre></div><p>我们尝试用 Java 来看下</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Solution</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">findMaxConsecutiveOnes</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">tmp</span> <span class="o">+=</span> <span class="n">1</span><span class="o">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">tmp</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><ul>
<li>Javaer: 啊咧？P 哥你确实有点短啊！</li>
<li>Pythonist: 你敢说我短？你看看 java 的创始人的头发！</li>
</ul>
<p>『贴图』</p>
<ul>
<li>
<p>Javaer: 我不是那个意思，浓缩就是精华嘛，表达能力弱又怎么样，我 Javaer 可以直接封装好这个功能当成工具类用，从外部使用上用起来差不多好吧，从项目角度表达力并不是决定性因素，静态类型检查可以提早在编译阶段做字节码优化。你的 GIL&hellip;</p>
</li>
<li>
<p>Pythonist: 好了，咱就不要提 GIL 了</p>
</li>
<li>
<p>Pythonist: 动态类型不需要花时间写 type annotation, 写起来速度杠杠的。</p>
</li>
<li>
<p>Javaer: 静态语言一时爽，动态类型火葬场好伐？举个例子，太动态的东西，就是不好做类型推断，比如贵圈的著名的 sqlalchemy 做的那么动态，query.get() 结合 flask 来用，YouModel.query.get() 出来的 YouModel 你还要点进去查看一下具体属性，你要用 title 还是 name, 拼错了，怎么办？都不报错的。</p>
</li>
<li>
<p>Javaer: 静态类型迫使你思考程序的时候更加严谨认真，这将会提升你的代码质量。</p>
</li>
<li>
<p>Pythonist: 这点我是不服的，你只是花费了大量的时间在类型检查上，写的认不认真不完全取决于你编程的水平和态度好伐？假如你的观点成立，语言只是武器，峨眉师太拿一把倚天剑，不还是被张三丰空手取来？</p>
</li>
<li>
<p>Javaer: 但你不能否认，峨眉师太拿着倚天剑确实可以秒杀很多人。</p>
</li>
</ul>
<blockquote>
<p>旁白君：有道是，梅须逊雪三分白，雪却输梅一段香。</p>
</blockquote>
<ul>
<li>Guido van Rossum: 好了，我觉得类型不错，我在 dropbox 带领团队实现了 python 的 typing，python 3.7 内置哦。</li>
<li>Pythonist: 我自己打脸一下，动态类型花点时间写 type annotation 代码健壮性杠杠的。</li>
<li>Javaer: 你走开&hellip; 你怎么不去解决 GIL 的问题。</li>
</ul>
<h3 id="静态类型--动态类型">静态类型 + 动态类型</h3>
<p>Gradual Typing 就是在动态语言的基础上，增加了可选的类型声明 (Type Annotation)</p>
<p>这对于我这种人是福音，</p>
<p>对于我个人而言，我是希望 Python 是有类型的</p>
<ol>
<li>作为某段程序的开发者和维护者，我可以提升我重构的速度。</li>
<li>作为某段程序的调用方，可以快速的知道我调用后得到的东西究竟是什么。</li>
</ol>
<p>但我又不希望这个声明不是强制性的</p>
<ol>
<li>我在构思程序的时候，想专注于接口的设计。在落实编码并且把代码写的足够的 dry 之后，在被调用的一些地方加上类型声明，这样可以提升我写代码的速度。</li>
</ol>
<h2 id="0x03-python-typing-实战---mypy">0x03 Python Typing 实战 - MyPY</h2>
<h3 id="mypy">MyPy</h3>
<p>mypy 是一个可选的静态分析器，官网介绍上说，mypy 将使你的程序更加易懂，调试和维护。</p>
<p>这个程序</p>
<ul>
<li>对于 PHP 有 Hack , 对 JavaScript 有 Flow 和 TypeScript, 对于 Python 有 MyPy</li>
<li>对于 Python, 则有 MyPy , MyPy 彼时还不是很成熟 (2016 年 10 之前）。</li>
</ul>
<p>Dropbox 的团队开发，Guido van Rossum 领导开发</p>
<h3 id="快速入门">快速入门</h3>
<p>本小节部分摘录 Type hints cheat sheet</p>
<p>建议读者收藏原网址 <a href="https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html">https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html</a></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 内置类型</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;test&#34;</span>

<span class="n">child</span><span class="p">:</span> <span class="nb">bool</span>
<span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="n">child</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">child</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># 普通函数</span>
<span class="k">def</span> <span class="nf">stringify</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

<span class="c1"># 生成器</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div><p>直接看起来似乎，加不加 typing 对现在的代码改善并不是很明显嘛。</p>
<p>我们可以给复杂类型起别名：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="err">比如：</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>

<span class="n">AliasType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AliasType</span><span class="p">:</span>
    <span class="o">...</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AliasType</span><span class="p">:</span>
    <span class="o">...</span>
</code></pre></div><p>看起来还行，但还是没有感觉到很明显的代码质量改善。</p>
<p>好，再看一例，使用 ClassVar 禁止属性无法在实例上设置</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Class variable only</span>

<span class="n">A</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># OK</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Error: Cannot assign to class variable &#34;x&#34; via instance</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># OK -- can be read through an instance</span>
</code></pre></div><p>举个例子，flask-sqlalchemy, 可以通过 YouModel.query.get(id) 来拿到 YouModel 的实例，但 IDE 不能推断出这个实例是什么。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 方法一，Cast</span>
<span class="n">you_model_ins</span><span class="p">:</span> <span class="n">YouModel</span> <span class="o">=</span> <span class="n">YouModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="c1"># 方法二，包装一下 get 方法</span>

<span class="k">class</span> <span class="nc">YouModel</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&#34;YouModel&#34;</span><span class="p">:</span> <span class="c1"># 注意这里的字符串</span>
		<span class="k">pass</span>
<span class="n">you_model_ins</span> <span class="o">=</span> <span class="n">YouModel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

</code></pre></div><p>细心的读者可能看到这里的 YouModel 的返回值类型居然使用了 YouModel 的字符串，如果是 Java 的话，是可以直接写 YouModel 的。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 加上类型延迟求值</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="k">class</span> <span class="nc">YouModel</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YouModel</span><span class="p">:</span>
		<span class="k">pass</span>
<span class="n">you_model_ins</span> <span class="o">=</span> <span class="n">YouModel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div><p>还有其他的用法，请参考 MyPY 的官方文档</p>
<h2 id="0x04-常见问题">0x04 常见问题</h2>
<h3 id="如何忽略-mypy-警告">如何忽略 mypy 警告</h3>
<p>有的地方的代码不进行检查的话会方便很多。</p>
<p>与 flake8 类似，在注释后面写上标志就可以忽略了。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">youcode  <span class="c1"># type: igonre</span>
</code></pre></div><h3 id="循环导入">循环导入</h3>
<p>我现在有两个文件，一个是 user.py 另一个是 order.py</p>
<p>在 user 里面有个方法需要返回 order 里面的 Order 列表，order 里面有个 order.owner 需要返回 User 实例。</p>
<p>如果不用类型声明的话，在 user 需要 order 的时候 import 进来即可规避循环导入。</p>
<p>在使用类型声明之后，建议在 user 里面这么写</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">project.models.order</span> <span class="kn">import</span> <span class="n">Order</span> <span class="c1"># noqa</span>
</code></pre></div><h2 id="0x05-typing-anotation-项目最佳实践">0x05 Typing Anotation 项目最佳实践</h2>
<p>通过本文了解了基本的 Typing Anotation 的用法，其实效果还不够，本着对爱学习的读者老爷的负责的态度。</p>
<p>所谓『纸上得来终觉浅，绝知此事要宫刑』, 哦不『躬行』</p>
<p>推荐一个超级牛的大项目来让大家了解一下 typing annotation 的最佳实践。</p>
<p><a href="https://github.com/zulip/zulip/">https://github.com/zulip/zulip/</a></p>
<p>当然，从这个项目里面不仅仅能学到 typing annotation, 还能学到大项目下，牛 X 的公司的做法</p>
<ol>
<li>如何组织和划分模块</li>
<li>如何帮助开发者快速启用开发环境。</li>
<li>如何做测试，如何做 CI</li>
<li>如何优化自己的 Workflow</li>
</ol>
<p>有机会的话，我会挑其中的一小部分讲解一下。</p>
<h2 id="0xee-参考">0xEE 参考</h2>
<h3 id="pep">PEP</h3>
<ul>
<li>PEP 3107</li>
<li>PEP 483</li>
</ul>
<h3 id="扩展文章">扩展文章</h3>
<ul>
<li><a href="http://wphomes.soic.indiana.edu/jsiek/what-is-gradual-typing/" target="_blank" rel="noopener noreffer">关于 gradual typing</a></li>
<li><a href="https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html">https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html</a></li>
<li><a href="https://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/">https://blog.zulip.org/2016/10/13/static-types-in-python-oh-mypy/</a></li>
<li><a href="https://www.zhihu.com/question/21017354/answer/589574939">https://www.zhihu.com/question/21017354/answer/589574939</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-11-25</strong> 初始化本文</li>
<li><strong>2019-02-16</strong> 重新整理文章</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/">系列文章</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20181125_finalcutprox/" class="prev" rel="prev" title="Final Cut Pro X CheatSheat"><i class="fas fa-angle-left fa-fw"></i>Final Cut Pro X CheatSheat</a>
            <a href="/posts/20181223_vlogcheatsheet/" class="next" rel="next" title="旅拍 Vlog CheatSheet">旅拍 Vlog CheatSheet<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://twocucao.xyz" target="_blank">twocucao</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
