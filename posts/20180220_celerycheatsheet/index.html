<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Celery 快速入门指北 - 海拉鲁编程客</title><meta name="Description" content="这篇文章展示了基本的 Markdown 语法和格式."><meta property="og:title" content="Celery 快速入门指北" />
<meta property="og:description" content="这篇文章展示了基本的 Markdown 语法和格式." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://twocucao.xyz/posts/20180220_celerycheatsheet/" />
<meta property="article:published_time" content="2018-02-02T21:57:40+08:00" />
<meta property="article:modified_time" content="2020-01-01T16:45:40+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Celery 快速入门指北"/>
<meta name="twitter:description" content="这篇文章展示了基本的 Markdown 语法和格式."/>
<meta name="application-name" content="海拉鲁编程客">
<meta name="apple-mobile-web-app-title" content="海拉鲁编程客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://twocucao.xyz/posts/20180220_celerycheatsheet/" /><link rel="prev" href="http://twocucao.xyz/posts/20180128_tmuxwithtmuxinatorworkflow/" /><link rel="next" href="http://twocucao.xyz/posts/20180203_numpycheatsheet/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Celery 快速入门指北",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/twocucao.xyz\/posts\/20180220_celerycheatsheet\/"
        },"genre": "posts","keywords": "Celery, 消息队列","wordcount":  387 ,
        "url": "http:\/\/twocucao.xyz\/posts\/20180220_celerycheatsheet\/","datePublished": "2018-02-02T21:57:40+08:00","dateModified": "2020-01-01T16:45:40+08:00","publisher": {
            "@type": "Organization",
            "name": "twocucao"},"author": {
                "@type": "Person",
                "name": "twocucao"
            },"description": "这篇文章展示了基本的 Markdown 语法和格式."
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/posts/"> 存档 </a><a class="menu-item" href="/tags/"> 标签 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/posts/" title="">存档</a><a class="menu-item" href="/tags/" title="">标签</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Celery 快速入门指北</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://twocucao.xyz" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas"></i>twocucao</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-02-02">2018-02-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 387 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 2 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x00-前言">0x00 前言</a></li>
    <li><a href="#0x01-celery">0x01 Celery</a>
      <ul>
        <li><a href="#为什么需要-celery">为什么需要 Celery</a></li>
      </ul>
    </li>
    <li><a href="#0x02-celery-快速开始">0x02 Celery 快速开始</a></li>
    <li><a href="#0x03-celery-guide">0x03 Celery Guide</a>
      <ul>
        <li><a href="#application">Application</a></li>
        <li><a href="#tasks">Tasks</a></li>
        <li><a href="#application-1">Application</a></li>
        <li><a href="#tasks-1">Tasks</a></li>
        <li><a href="#calling-tasks">Calling Tasks</a></li>
        <li><a href="#canvas-designing-work-flows">Canvas: Designing Work-flows</a></li>
        <li><a href="#workers-guide">Workers Guide</a></li>
        <li><a href="#daemonization">Daemonization</a></li>
        <li><a href="#periodic-tasks">Periodic Tasks</a></li>
        <li><a href="#routing-tasks">Routing Tasks</a></li>
        <li><a href="#monitoring-and-management-guide">Monitoring and Management Guide</a></li>
        <li><a href="#security">Security</a></li>
        <li><a href="#optimizing">Optimizing</a></li>
        <li><a href="#debugging">Debugging</a></li>
        <li><a href="#concurrency">Concurrency</a></li>
        <li><a href="#signals">Signals</a></li>
        <li><a href="#testing-with-celery">Testing with Celery</a></li>
        <li><a href="#extensions-and-bootsteps">Extensions and Bootsteps</a></li>
        <li><a href="#configuration-and-defaults">Configuration and defaults</a></li>
      </ul>
    </li>
    <li><a href="#0x03-rabbitmq">0x03 RabbitMQ</a>
      <ul>
        <li><a href="#简单步骤">简单步骤</a></li>
      </ul>
    </li>
    <li><a href="#0x07-踩坑集">0x07 踩坑集</a></li>
    <li><a href="#0xee-参考链接">0xEE 参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="0x00-前言">0x00 前言</h2>
<p>本文编写于 2018 年初，于 2019 四月进行修订，也是笔者对 Celery 的系统梳理。</p>
<p>在我的文章如何保证 Django 项目的数据一致性中，提到了这么一个解决超卖的方案。</p>
<ol>
<li>在 Redis 里面直接生成 200 个订单号</li>
<li>然后用户来一个取走一个订单号码</li>
<li>通过 Celery 削峰 排队走异步任务</li>
<li>最后通过数据表的 uniq 约束来防止下单超过 200 个。</li>
</ol>
<p><a href="https://zhuanlan.zhihu.com/p/57668068">https://zhuanlan.zhihu.com/p/57668068</a></p>
<p>有朋友和我讲，你这个方法是有问题的，走异步任务容易并发量太大，容易把数据库打爆。</p>
<p>其实是可以的，Celery 可以对 Worker 的 Task 限流 (ratelimit)。</p>
<h2 id="0x01-celery">0x01 Celery</h2>
<h3 id="为什么需要-celery">为什么需要 Celery</h3>
<p>在日常开发的时候，常常有一些『任务』需要处理。</p>
<ol>
<li>为了提升系统的响应速度，比如发送短信 / 发送邮箱，这类的『任务』可以走异步。</li>
<li>为了在某个时间执行耗时操作，比如统计用户的文章 / 点赞 / 活跃度。</li>
<li>为了削减峰值，比如秒杀系统的削峰走异步</li>
<li>为了业务代码解耦，比如当我在知乎上更新文章，可能就会触发『推荐系统』,『文章管理系统』,『用户通知系统』</li>
</ol>
<p>不用 Celery 的话，其实上面的业务也是能做的。 比如 1 中，可以直接启一个线程来做。比如 2 完全可以 Crontab 做一个定时任务。</p>
<p>那为什么要用 Celery 呢？</p>
<ol>
<li>把目光聚焦在 Task 的分发上面。而非线程，Deamon 之类细节的处理。</li>
<li>方便，简单，易维护，高可用。</li>
<li>便于监控。</li>
<li>扩展性好。</li>
</ol>
<p>基本上满足了你九成的需求。</p>
<h2 id="0x02-celery-快速开始">0x02 Celery 快速开始</h2>
<p>本文的讨论基于 Broker 为 RabbitMQ, Result Backend 为 Redis,  Django 的 Web 应用，叫做 djoo</p>
<pre><code>sudo rabbitmqctl add_user djoo djoo
sudo rabbitmqctl add_vhost djoo
sudo rabbitmqctl set_user_tags djoo djoo
sudo rabbitmqctl set_permissions -p djoo djoo &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
</code></pre><pre><code>CELERY_BROKER_URL = 'amqp://djoo:djoo@localhost:5672/djoo'

CELERY_RESULT_BACKEND = &quot;redis://{host}:{port}/1&quot;.format(
    host=os.getenv(&quot;REDIS_HOST&quot;, &quot;localhost&quot;), port=os.getenv(&quot;REDIS_PORT&quot;, &quot;6379&quot;)
)

</code></pre><p>泛读文档之后，需要搞清楚几个概念。</p>
<ul>
<li>Broker: 携带 Task 的消息中间件，是发送消息和接收消息的解决方案，比如 RabbitMQ</li>
<li>Result Backend: Task 执行结果。</li>
<li>Application: Celery 的实例</li>
<li>Worker: 执行任务者</li>
<li>Beat: 或叫做 Schedule, 一般用于执行定时任务。</li>
<li>Task: 任务</li>
</ul>
<h2 id="0x03-celery-guide">0x03 Celery Guide</h2>
<h3 id="application">Application</h3>
<p>Application 可以针对整个 Celery 实例进行配置，比如配置时区，重写 Application 里的基类</p>
<h3 id="tasks">Tasks</h3>
<p>Task 是一个 Class, 并且可以从任意 Callable 的对象创建。</p>
<p>Task Message 除非被 Acked, 否则不会从队列中移除。</p>
<blockquote>
<p>NOTE: 那什么时候算是 Acked?</p>
</blockquote>
<pre><code>@app.task(name=&quot;xsum&quot;)
def xsum(numbers):
    return sum(numbers)
</code></pre><ul>
<li>Tasks</li>
<li>Calling Tasks</li>
<li>Canvas: Designing Work-flows</li>
<li>Workers Guide</li>
<li>Daemonization</li>
<li>Periodic Tasks</li>
<li>Routing Tasks</li>
<li>Monitoring and Management Guide</li>
<li>Security</li>
<li>Optimizing</li>
<li>Debugging</li>
<li>Concurrency</li>
<li>Signals</li>
<li>Testing with Celery</li>
<li>Extensions and Bootsteps</li>
<li>Configuration and defaults</li>
</ul>
<h3 id="application-1">Application</h3>
<h3 id="tasks-1">Tasks</h3>
<h3 id="calling-tasks">Calling Tasks</h3>
<h3 id="canvas-designing-work-flows">Canvas: Designing Work-flows</h3>
<h3 id="workers-guide">Workers Guide</h3>
<h3 id="daemonization">Daemonization</h3>
<h3 id="periodic-tasks">Periodic Tasks</h3>
<h3 id="routing-tasks">Routing Tasks</h3>
<h3 id="monitoring-and-management-guide">Monitoring and Management Guide</h3>
<h3 id="security">Security</h3>
<h3 id="optimizing">Optimizing</h3>
<h3 id="debugging">Debugging</h3>
<h3 id="concurrency">Concurrency</h3>
<h3 id="signals">Signals</h3>
<h3 id="testing-with-celery">Testing with Celery</h3>
<h3 id="extensions-and-bootsteps">Extensions and Bootsteps</h3>
<h3 id="configuration-and-defaults">Configuration and defaults</h3>
<h2 id="0x03-rabbitmq">0x03 RabbitMQ</h2>
<p>发布者的消息经过交换机，分发到不同的队列，最后由接收方进行处理。</p>
<p>那么问题来了，交换机都是用来干嘛的</p>
<ul>
<li>Direct 单播路由：扔一条消息到一个队列中，依照 routingkey 投递</li>
<li>Topic  多播路由：发给某几类队列（通知）.</li>
<li>Fanout 广播路由：发给全部绑定在该路由上面的队列。</li>
<li>Headers</li>
</ul>
<ol>
<li>应用解耦。（平台无关，语言无关）</li>
</ol>
<p>比如说，但项目足够大的时候，更新一个活动，可能需要更新用户的一些状态，可能要更新一波统计数据，可能要记录一批日志。这个时候原来的代码可能这么写：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">update_activity<span class="o">()</span>
update_user<span class="o">()</span>
update_user_cache<span class="o">()</span>
update_stats<span class="o">()</span>
record_user_log<span class="o">()</span>
</code></pre></div><p>现在代码就可能这么写：</p>
<pre><code>send_task_update_activity()
send_task_update_user()
send_task_update_user_cache()
send_task_update_stats()
send_task_record_user_log()
</code></pre><ol start="2">
<li>异步通信。（减轻请求峰值）</li>
</ol>
<p>原本一个 webapp 不做异步的话，也能搞定，但做了异步之后，可以大幅度提升吞吐量和响应时间。</p>
<ol start="3">
<li>数据持久化。（不丢失消息）</li>
<li>送达保证。(ack late)</li>
</ol>
<h3 id="简单步骤">简单步骤</h3>
<ol>
<li>定义 app, 指定 broker 和 backend</li>
<li>定义 tasks</li>
<li>指定 worker</li>
<li>调用 Task , 调用后返回 AsyncResult 实例，</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;lopri&#39;</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div><h4 id="groups">Groups</h4>
<pre><code># 并行
group(add.s(i, i) for i in xrange(10))().get()
# [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]
# partial group
g = group(add.s(i) for i in xrange(10))
g(10).get()
</code></pre><h4 id="chains">Chains</h4>
<pre><code>chain(add.s(4, 4) | mul.s(8))().get()
(add.s(4, 4) | mul.s(8))().get()
# partial chain
g = chain(add.s(4) | mul.s(8))
g(4).get()
</code></pre><h4 id="chords">Chords</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="c1"># eg : upload_document.s(file) | group(apply_filter.s() for filter in filters)</span>
</code></pre></div><h2 id="0x07-踩坑集">0x07 踩坑集</h2>
<ul>
<li>序列问题</li>
</ul>
<h2 id="0xee-参考链接">0xEE 参考链接</h2>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-20</strong> 初始化</li>
<li><strong>2019-04-04</strong> 重修文字</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/celery/">Celery</a>,&nbsp;<a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20180128_tmuxwithtmuxinatorworkflow/" class="prev" rel="prev" title="用 tmux 与 tmuxinator 打造开发工作流"><i class="fas fa-angle-left fa-fw"></i>用 tmux 与 tmuxinator 打造开发工作流</a>
            <a href="/posts/20180203_numpycheatsheet/" class="next" rel="next" title="NumPy CheatSheet">NumPy CheatSheet<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://twocucao.xyz" target="_blank">twocucao</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
