<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>为你的项目快速搭建 ELKFA 日志系统 - 海拉鲁编程客</title><meta name="Description" content="这篇文章展示了基本的 Markdown 语法和格式."><meta property="og:title" content="为你的项目快速搭建 ELKFA 日志系统" />
<meta property="og:description" content="这篇文章展示了基本的 Markdown 语法和格式." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://twocucao.xyz/posts/20190310_pycode_05/" />
<meta property="article:published_time" content="2019-03-10T21:57:40+08:00" />
<meta property="article:modified_time" content="2020-01-01T16:45:40+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="为你的项目快速搭建 ELKFA 日志系统"/>
<meta name="twitter:description" content="这篇文章展示了基本的 Markdown 语法和格式."/>
<meta name="application-name" content="海拉鲁编程客">
<meta name="apple-mobile-web-app-title" content="海拉鲁编程客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://twocucao.xyz/posts/20190310_pycode_05/" /><link rel="prev" href="http://twocucao.xyz/posts/20190308_pycode_03/" /><link rel="next" href="http://twocucao.xyz/posts/20190216_pycode_02/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "为你的项目快速搭建 ELKFA 日志系统",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/twocucao.xyz\/posts\/20190310_pycode_05\/"
        },"genre": "posts","keywords": "Python, 系列文章","wordcount":  448 ,
        "url": "http:\/\/twocucao.xyz\/posts\/20190310_pycode_05\/","datePublished": "2019-03-10T21:57:40+08:00","dateModified": "2020-01-01T16:45:40+08:00","publisher": {
            "@type": "Organization",
            "name": "twocucao"},"author": {
                "@type": "Person",
                "name": "twocucao"
            },"description": "这篇文章展示了基本的 Markdown 语法和格式."
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/posts/"> 存档 </a><a class="menu-item" href="/tags/"> 标签 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/posts/" title="">存档</a><a class="menu-item" href="/tags/" title="">标签</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">为你的项目快速搭建 ELKFA 日志系统</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://twocucao.xyz" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas"></i>twocucao</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python-%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E5%81%A5%E5%A3%AE%E6%80%A7%E5%92%8C%E6%80%A7%E8%83%BD/"><i class="far fa-folder fa-fw"></i>Python 项目代码健壮性和性能</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-03-10">2019-03-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 448 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x00-前言">0x00 前言</a></li>
    <li><a href="#0x01-任务-1-分析-nginx-日志">0x01 任务 1: 分析 Nginx 日志</a>
      <ul>
        <li><a href="#第一步配置-nginx">第一步：配置 Nginx</a></li>
        <li><a href="#第二步拉取-nginx-日志">第二步：拉取 Nginx 日志</a></li>
        <li><a href="#第三步开启-elfka">第三步：开启 ELFKA</a></li>
        <li><a href="#第四步日志探秘">第四步：日志探秘</a></li>
        <li><a href="#第五步扩展思考日志解决方案">第五步：扩展思考，日志解决方案</a></li>
      </ul>
    </li>
    <li><a href="#0x02-任务-2-监控-flask-app-的-apm">0x02 任务 2: 监控 Flask App 的 APM</a>
      <ul>
        <li><a href="#第一步开启-elfka">第一步：开启 ELFKA</a></li>
        <li><a href="#第二步开启-flask-app">第二步：开启 flask app</a></li>
        <li><a href="#第三步apm-探秘">第三步：APM 探秘</a></li>
        <li><a href="#第四步扩展思考">第四步：扩展思考</a></li>
      </ul>
    </li>
    <li><a href="#0xdd-结论">0xDD 结论</a></li>
    <li><a href="#0xee-参考链接">0xEE 参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>本文是《提升你的 Python 项目代码健壮性和性能》系列的第五篇文章。</p>
<p>讲的是日志系统 ELKFA 的搭建</p>
<h2 id="0x00-前言">0x00 前言</h2>
<p>什么是 ELKFA?</p>
<p>这五个字母分别代表着五个开源软件</p>
<ul>
<li><strong>E - ElasticSearch</strong></li>
<li><strong>L - Logstash</strong></li>
<li><strong>K - Kibana</strong></li>
<li><strong>F - FileBeat</strong></li>
<li><strong>A - APM-Server</strong></li>
</ul>
<p>利用这五个软件的组合，我们可以在比较短的时间打造两个系统：</p>
<ol>
<li>日志系统，分析 Nginx 日志，Gunicorn 日志，Flask 日志，Django 日志</li>
<li>APM 系统，解决两个问题
2.1 Metric 分析：Flask 是否正常运行，接口请求信息定期发送到 APMServer 这边，方便我观察服务是否正常，接口和业务逻辑的执行的时间是否在预期范围内。
2.2 Trouble Shooting: 如果程序报了异常，我想把需要报的异常堆栈信息打出。方便我快速的 Trouble Shooting</li>
</ol>
<h2 id="0x01-任务-1-分析-nginx-日志">0x01 任务 1: 分析 Nginx 日志</h2>
<p>Nginx 众所周知，Nginx 日志是个宝库，所以本文选取了 Nginx 作为日志分析的案例。</p>
<p>对于 Nginx 日志，可以采用 FileBeat 上传到 Logstash, 由 Logstash 对文件进行解析，并存储到 ElasticSearch</p>
<p>然后从 Kibana 进行分析。</p>
<h3 id="第一步配置-nginx">第一步：配置 Nginx</h3>
<p>首先，让 Nginx 的配置输出的日志符合某种模式，方便软件进行解析。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
							&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
							&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;

access_log /var/log/nginx/access.log main;
</code></pre></div><p>然后重启 nginx</p>
<h3 id="第二步拉取-nginx-日志">第二步：拉取 Nginx 日志</h3>
<p>一天后，从 Nginx 服务器上拉一下 access.log 放到</p>
<p>elastic-labs/logs/prod/nginx 下</p>
<h3 id="第三步开启-elfka">第三步：开启 ELFKA</h3>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">git clone git@github.com:twocucao/elastic-labs.git
cd elastic-labs
docker-compose up
</code></pre></div><blockquote>
<p>啥、? 不会搭 Docker? 见文末
啥、? 不知道 ElasticSearch 怎么用、? 见文末</p>
</blockquote>
<p>如果运行正常，终端应该是这样的</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg"
        data-srcset="https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg, https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg 1.5x, https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg"
        title="https://pic1.zhimg.com/v2-15a6f7c35277ca34f035a0996ed1d23c_b.jpg" /></p>
<p>打开 kibana 进行观察</p>
<p>http://localhost:5601/</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg"
        data-srcset="https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg, https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg 1.5x, https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg"
        title="https://pic2.zhimg.com/v2-52689881c9e9610d37c0fb88016ed5b5_b.jpg" /></p>
<h3 id="第四步日志探秘">第四步：日志探秘</h3>
<p>默认情况下，每一天的 Nginx 日志会在 ES 里创建一个 Index, 所以，你需要用 Index Pattern 来进行统计</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg"
        data-srcset="https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg, https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg 1.5x, https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg"
        title="https://pic2.zhimg.com/v2-52d45736112286a549e1e216fa0dab95_b.jpg" /></p>
<p>来看看我们可以得到哪些内容</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg"
        data-srcset="https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg, https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg 1.5x, https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg"
        title="https://pic1.zhimg.com/v2-341fb82fdf1615c6180fea381bca8c44_b.jpg" /></p>
<ol>
<li>用户 IP 以及通过 GeoIP 得到的大致地理位置。</li>
<li>OS 的类型 (Win/Mac/Linux/IOS/Android)</li>
<li>客户端的类型，浏览器 / 小程序 / 客户端</li>
<li>访问的接口，类型，频率</li>
<li>访问服务的频率</li>
<li>还有很多其他可以深挖的地方，比如通过用户访问的次序推断用户的使用姿势和思考方式等等</li>
</ol>
<p>对于第六点，有些人可能有些疑惑，这也能？</p>
<blockquote>
<p><strong>当然咯，假设用户在搜索引擎里面，先搜索了『美女』, 然后搜索了『雪白』, 然后又搜索了『白-洁』, 那基本上这个人搜索的三个词就具备一定的关联性，想搜索的这个雪白就不是『雪白』的意思</strong>
<strong>而是你懂的。</strong></p>
</blockquote>
<h3 id="第五步扩展思考日志解决方案">第五步：扩展思考，日志解决方案</h3>
<p>上面四个步骤是为了解决分析 Nginx 日志的问题</p>
<p>一条日志从打印出来，到能在 Kibana 进行分析，需要经过如下的步骤：</p>
<ol>
<li>按照某种日志格式写到文件里，然后被 FileBeat 接收，FB 判断为『 Nginx 模块的日志之后』上传到 Logstash</li>
<li>Logstash 按照一个端口一个类型的方式接受该类型的日志。通过 filters 和插件进行匹配和修改，比如 grok 的 pattern 来匹配每一条日志（类似于正则匹配）, 抽出需要独立成字段的部分。比如通过 geoip 进行地址匹配，比如对字段进行 convert</li>
<li>输出匹配结果到 ElasticSearch</li>
<li>Kibana 通过更加边界的工具来查询 ElasticSearch</li>
</ol>
<p>如果你想要自定义日志获得更加完美的解决方案，那就需要对这几个流程进行进行细化。</p>
<p>比如你想通过 Flask 的日志来达到更好的用户操作定位。这就需要读者自行依照自己的理解来 hack 了</p>
<h2 id="0x02-任务-2-监控-flask-app-的-apm">0x02 任务 2: 监控 Flask App 的 APM</h2>
<h3 id="第一步开启-elfka">第一步：开启 ELFKA</h3>
<p>同任务一的启动方式</p>
<h3 id="第二步开启-flask-app">第二步：开启 flask app</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">pip3 install poetry <span class="c1"># 比 pip / pipenv 更好的依赖管理和构建工具</span>
poetry install -vvv
poetry shell
flask run
</code></pre></div><p>写一个简单的管理和依赖工具</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">from flask import Flask
from elasticapm.contrib.flask import ElasticAPM

<span class="nv">app</span> <span class="o">=</span> Flask<span class="o">(</span>__name__<span class="o">)</span>

app.config<span class="o">[</span><span class="s2">&#34;ELASTIC_APM&#34;</span><span class="o">]</span> <span class="o">=</span> <span class="o">{</span>
    <span class="s2">&#34;SERVICE_NAME&#34;</span>: <span class="s2">&#34;dev-flask&#34;</span>,
    <span class="s1">&#39;SECRET_TOKEN&#39;</span>: <span class="s1">&#39;&#39;</span>,
<span class="o">}</span>
<span class="nv">apm</span> <span class="o">=</span> ElasticAPM<span class="o">(</span>app<span class="o">)</span>

@app.route<span class="o">(</span><span class="s2">&#34;/&#34;</span><span class="o">)</span>
def hello<span class="o">()</span>:
    <span class="k">return</span> <span class="s2">&#34;Hello, World!&#34;</span>

@app.route<span class="o">(</span><span class="s2">&#34;/home&#34;</span><span class="o">)</span>
def home<span class="o">()</span>:
    <span class="k">return</span> <span class="s2">&#34;home!&#34;</span>

@app.route<span class="o">(</span><span class="s2">&#34;/&lt;int:num&gt;&#34;</span><span class="o">)</span>
def hello_num<span class="o">(</span>num<span class="o">)</span>:
    import random
    <span class="k">if</span> random.randint<span class="o">(</span>1, 100<span class="o">)</span> &gt; 95:
        raise Exception<span class="o">(</span>f<span class="s2">&#34;num&#34;</span><span class="o">)</span> <span class="c1"># 有接近 1/5 的概率会故意抛出异常</span>
    <span class="k">return</span> f<span class="s2">&#34;Hello, {num}!&#34;</span>
</code></pre></div><p>随手写一个脚本 20 分钟内持续不断的访问接口</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SECONDS</span><span class="o">=</span><span class="m">0</span>
<span class="k">while</span> <span class="o">[[</span> SECONDS -lt <span class="m">1200</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">do</span>
	<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span> <span class="o">=</span> 0<span class="p">;</span> i &lt; 20<span class="p">;</span> i++ <span class="o">))</span><span class="p">;</span> <span class="k">do</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
		curl <span class="s2">&#34;http://localhost:5000/</span><span class="nv">$i</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
	<span class="k">done</span>
<span class="k">done</span>
</code></pre></div><h3 id="第三步apm-探秘">第三步：APM 探秘</h3>
<p>20 分钟过去了，我们可以获知到什么呢？</p>
<ol>
<li>Metric 分析：Flask 是否正常运行，接口请求信息定期发送到 APMServer 这边，方便我观察服务是否正常，接口和业务逻辑的执行的时间是否在预期范围内。</li>
<li>Trouble Shooting: 如果程序报了异常，我想把需要报的异常堆栈信息打出。方便我快速的 Trouble Shooting</li>
</ol>
<p>先设置时间为最近 30 分钟</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg"
        data-srcset="https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg, https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg 1.5x, https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg"
        title="https://pic4.zhimg.com/v2-8076c883c59df6d2ff0821d82c2b1f7f_b.jpg" /></p>
<p>在这里可以看到接口的访问情况</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg"
        data-srcset="https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg, https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg 1.5x, https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg"
        title="https://pic2.zhimg.com/v2-776f3bf0834fc827edf2264ca76049f1_b.jpg" /></p>
<p>先看 Metric 分析</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg"
        data-srcset="https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg, https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg 1.5x, https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg"
        title="https://pic1.zhimg.com/v2-9352ae0740081699d5692df34df9f724_b.jpg" /></p>
<p>这里可以看到接口的稳定性，服务器的基本负载，以及 Error 的出现频次。</p>
<p>再看 Error</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg"
        data-srcset="https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg, https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg 1.5x, https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg 2x"
        data-sizes="auto"
        alt="https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg"
        title="https://pic2.zhimg.com/v2-1d63b7048a6144cdbf14e8543fb31225_b.jpg" /></p>
<p><strong>看到这里简直泪目 这就是 ELK 版本的 Sentry 啊</strong></p>
<blockquote>
<p><strong>Time Saving &amp;&amp; 防脱发利器</strong></p>
</blockquote>
<h3 id="第四步扩展思考">第四步：扩展思考</h3>
<p>从 App 被监控到能在 Kibana 进行分析，需要经过如下的步骤：</p>
<ol>
<li>在原有的 Flask App 里面进行添加 elastc-apm 的 agent (apm-client)</li>
<li>agent 会定期将收集完毕的性能信息以及异常信息，发到 apm-server</li>
<li>输出结果到 ElasticSearch</li>
<li>Kibana 通过更加边界的工具来查询 ElasticSearch</li>
</ol>
<p>如果你想要自定义日志获得更加完美的解决方案，那就需要对这前两个流程进行进行细化。</p>
<p>比如公司用 Graphql 的接口，那么，在这种情况下，自带的 contrib 下的 flask 包的路由基本就是废掉的，你需要再 Hack 一下。</p>
<h2 id="0xdd-结论">0xDD 结论</h2>
<p>本来这篇文章打算写日志的最佳实践的，结果在查找资料的时候发现了一篇更好的文章</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/27363484" target="_blank" rel="noopener noreffer">https://zhuanlan.zhihu.com/p/27363484</a></li>
</ul>
<p>看完之后打消了这个念头，转而写如何使用 ELK 的系统落实这种日志分析系统</p>
<p>代码见 <a href="https://link.zhihu.com/?target=https%3A//github.com/twocucao/elastic-labs" target="_blank" rel="noopener noreffer">twocucao/elastic-labs</a></p>
<blockquote>
<p><strong>欢迎点赞 / 关注 /star 文明三连</strong></p>
</blockquote>
<h2 id="0xee-参考链接">0xEE 参考链接</h2>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/27363484" target="_blank" rel="noopener noreffer">https://zhuanlan.zhihu.com/p/27363484</a></li>
<li>Photo by<a href="https://link.zhihu.com/?target=https%3A//unsplash.com/photos/rr8DvtQL9X8%3Futm_source%3Dunsplash%26utm_medium%3Dreferral%26utm_content%3DcreditCopyText" target="_blank" rel="noopener noreffer">Tan Kaninthanond</a>on<a href="https://link.zhihu.com/?target=https%3A//unsplash.com/%3Futm_source%3Dunsplash%26utm_medium%3Dreferral%26utm_content%3DcreditCopyText" target="_blank" rel="noopener noreffer">Unsplash</a></li>
<li><strong>关于 elasticsearch 可以参考我以前的文章</strong> <a href="https://zhuanlan.zhihu.com/p/35143409" target="_blank" rel="noopener noreffer">Django 全栈教程系列番外篇 - ElasticSearch CheatSheet</a></li>
<li>关于 <strong>docker 的搭建</strong> 可以参考我以前的文章 <a href="https://zhuanlan.zhihu.com/p/33920401" target="_blank" rel="noopener noreffer">Django 全栈教程系列之一 - YaDjangoBlog 开发环境配置</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/">系列文章</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20190308_pycode_03/" class="prev" rel="prev" title="如何保证 Django 项目的数据一致性"><i class="fas fa-angle-left fa-fw"></i>如何保证 Django 项目的数据一致性</a>
            <a href="/posts/20190216_pycode_02/" class="next" rel="next" title="如何通过测试提升 Python 代码的健壮性">如何通过测试提升 Python 代码的健壮性<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://twocucao.xyz" target="_blank">twocucao</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
