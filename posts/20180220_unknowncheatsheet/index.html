<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Unknown Cheatsheet - 海拉鲁编程客</title><meta name="Description" content="这篇文章展示了基本的 Markdown 语法和格式."><meta property="og:title" content="Unknown Cheatsheet" />
<meta property="og:description" content="这篇文章展示了基本的 Markdown 语法和格式." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://twocucao.xyz/posts/20180220_unknowncheatsheet/" />
<meta property="article:published_time" content="2018-02-20T21:57:40+08:00" />
<meta property="article:modified_time" content="2020-01-01T16:45:40+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Unknown Cheatsheet"/>
<meta name="twitter:description" content="这篇文章展示了基本的 Markdown 语法和格式."/>
<meta name="application-name" content="海拉鲁编程客">
<meta name="apple-mobile-web-app-title" content="海拉鲁编程客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://twocucao.xyz/posts/20180220_unknowncheatsheet/" /><link rel="prev" href="http://twocucao.xyz/posts/20180210_dockercheatsheet/" /><link rel="next" href="http://twocucao.xyz/posts/20180221_fullstackdjangodevops/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Unknown Cheatsheet",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/twocucao.xyz\/posts\/20180220_unknowncheatsheet\/"
        },"genre": "posts","keywords": "Python, Django, YaDjangoBlog","wordcount":  1101 ,
        "url": "http:\/\/twocucao.xyz\/posts\/20180220_unknowncheatsheet\/","datePublished": "2018-02-20T21:57:40+08:00","dateModified": "2020-01-01T16:45:40+08:00","publisher": {
            "@type": "Organization",
            "name": "twocucao"},"author": {
                "@type": "Person",
                "name": "twocucao"
            },"description": "这篇文章展示了基本的 Markdown 语法和格式."
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/posts/"> 存档 </a><a class="menu-item" href="/tags/"> 标签 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="海拉鲁编程客">海拉鲁编程客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/posts/" title="">存档</a><a class="menu-item" href="/tags/" title="">标签</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Unknown Cheatsheet</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://twocucao.xyz" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas"></i>twocucao</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/django/"><i class="far fa-folder fa-fw"></i>Django</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-02-20">2018-02-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1101 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x00-前言">0x00 前言</a></li>
    <li><a href="#0x01-项目介绍">0x01 项目介绍</a>
      <ul>
        <li><a href="#11-项目地址">1.1 项目地址</a></li>
        <li><a href="#12-项目技术栈">1.2 项目技术栈</a></li>
        <li><a href="#13-特别感谢">1.3 特别感谢</a></li>
      </ul>
    </li>
    <li><a href="#0x02-系列教程目录">0x02 系列教程目录</a>
      <ul>
        <li><a href="#21-教程注意项">2.1 教程注意项</a></li>
        <li><a href="#22-教程目录">2.2 教程目录</a></li>
      </ul>
    </li>
    <li><a href="#0x01-前后端分离">0x01 前后端分离</a>
      <ul>
        <li><a href="#11-django-和-他的小伙伴们">1.1 Django 和 他的小伙伴们</a></li>
        <li><a href="#14-django-的奇技淫巧">1.4 Django 的奇技淫巧</a></li>
      </ul>
    </li>
    <li><a href="#0x02-自动化部署">0x02 自动化部署</a>
      <ul>
        <li><a href="#21-使用场景">2.1 使用场景</a></li>
        <li><a href="#22-实施方案">2.2 实施方案</a></li>
        <li><a href="#23-持续交付">2.3. 持续交付</a></li>
        <li><a href="#24-dockerize-application">2.4. Dockerize Application</a></li>
      </ul>
    </li>
    <li><a href="#0x03-数据库相关">0x03 数据库相关</a>
      <ul>
        <li><a href="#1-数据库设计">1. 数据库设计</a></li>
        <li><a href="#2-数据迁移">2. 数据迁移</a></li>
        <li><a href="#13-sequence-问题">1.3 sequence 问题</a></li>
      </ul>
    </li>
    <li><a href="#0x04-webserver">0x04 WebServer</a>
      <ul>
        <li><a href="#unix-socket-和-gunicorn-的-remote_addr-问题">unix socket 和 gunicorn 的 REMOTE_ADDR 问题</a></li>
        <li><a href="#nginx-gzip-压缩">Nginx Gzip 压缩</a></li>
      </ul>
    </li>
    <li><a href="#0x04-其他踩坑相关">0x04. 其他踩坑相关</a>
      <ul>
        <li><a href="#41-奇怪的文件问题">4.1 奇怪的文件问题</a></li>
      </ul>
    </li>
    <li><a href="#0xee-参考链接">0xEE. 参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="0x00-前言">0x00 前言</h2>
<blockquote>
<p>写在前面的话：不好意思，标题难以免俗，起了个很俗气的名字。</p>
</blockquote>
<p>这是我的一个全栈类型 Django 开源项目的系列讲解教程的目录。目的总的来说有两个：</p>
<ol>
<li>一是希望更多的人通过本系列的教程更好的认识 Django 开发技术栈或者说是 Web 开发技术栈，让更多的 Pythonist 更顺畅的进入 Django 开发的世界。</li>
<li>二是希望借由这个持续更新的过程让自己更加深入理解 Django 技术栈 Django / DjangoRestFramework / Docker / Vue.JS / Celery / PostgreSQL / Redis / RabbitMQ</li>
</ol>
<blockquote>
<p>生命苦短，我用 Python</p>
</blockquote>
<p>为什么说这个项目你不容错过？</p>
<ul>
<li>新！新！新！保持最新的软件开发版本，E.G: Django 2.0 + Vue.JS 2.5 + PostgreSQL 10 + Celery 4.1.0</li>
<li>Django 框架：Django 及其 强大的生态圈</li>
<li>后端组件：PostgreSQL RabbitMQ Redis Ngnix</li>
<li>前端技术：单页应用 前后端分离 (VueJS+Webpack+DjangoRestFramework), 自动化部署</li>
<li>Django 社区最佳实践：从配置 / 开发 / 测试 / 部署 <strong>全干</strong>工程师 (Full Stuff Engineer) 的最新的 DevOps 思考成果。</li>
<li>基本覆盖了进阶 Django 开发所需要的各种组件与操作。</li>
<li>只需要适当的调整，本项目就可以成为你新开项目的最佳脚手架。</li>
</ul>
<p>本系列文章的面向读者：</p>
<ul>
<li>目标是 DevOps 的 Pythonist</li>
<li>爱瞎几把折腾的 Pythonist</li>
<li>前后端分离的实践者</li>
</ul>
<blockquote>
<p>生命苦短，赶快上车</p>
</blockquote>
<h2 id="0x01-项目介绍">0x01 项目介绍</h2>
<p>YaDjangoBlog 是另一个关于博客的轮子，但是其野心并不在于仅仅多造一个博客系统，还有通过本项目做 Django 全栈开发的最佳实践。</p>
<h3 id="11-项目地址">1.1 项目地址</h3>
<ul>
<li>前端代码 <a href="https://github.com/twocucao/YaVueBlog">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></li>
</ul>
<h3 id="12-项目技术栈">1.2 项目技术栈</h3>
<ul>
<li>开发与部署环境为 Docker</li>
<li>Python 3.5.2</li>
<li>前端 Vue + Webpack + ES2015 + axios</li>
<li>后端 <a href="https://github.com/django/django" target="_blank" rel="noopener noreffer">Django 2.0</a> + <a href="https://github.com/tomchristie/django-rest-framework/" target="_blank" rel="noopener noreffer">DjangoRestFramework</a> + Celery</li>
<li>自动化部署选用工具 Ansible 以及 Docker</li>
<li>后端组件
<ul>
<li>ElasticSearch 用于搜索和推荐</li>
<li>PostgreSQL 用于数据持久化</li>
<li>Redis 用于 Session / 和缓存</li>
<li>RabbitMQ 分布式队列 / 定时任务</li>
<li>Nginx 用于反向代理</li>
</ul>
</li>
</ul>
<h3 id="13-特别感谢">1.3 特别感谢</h3>
<ul>
<li>ansible django stack: <a href="https://github.com/jcalazan/ansible-django-stack">https://github.com/jcalazan/ansible-django-stack</a></li>
<li>cookiecutter-django: <a href="https://github.com/pydanny/cookiecutter-django">https://github.com/pydanny/cookiecutter-django</a></li>
<li>djangopackages: <a href="https://github.com/djangopackages/djangopackages">https://github.com/djangopackages/djangopackages</a></li>
<li>董伟明 关于 ElasticSearch 的几篇文章 <a href="http://www.dongwm.com/archives/%E7%9F%A5%E4%B9%8ELive%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E4%B9%8B%E4%BD%BF%E7%94%A8Elasticsearch%E6%90%9C%E7%B4%A2/">http://www.dongwm.com/archives/%E7%9F%A5%E4%B9%8ELive%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E4%B9%8B%E4%BD%BF%E7%94%A8Elasticsearch%E6%90%9C%E7%B4%A2/</a></li>
<li>各个组件的开发者们
<ul>
<li>ElasticSearch</li>
<li>PostgreSQL</li>
<li>Redis</li>
<li>RabbitMQ</li>
<li>Nginx</li>
<li>Docker</li>
</ul>
</li>
</ul>
<h2 id="0x02-系列教程目录">0x02 系列教程目录</h2>
<h3 id="21-教程注意项">2.1 教程注意项</h3>
<ol>
<li>本文的开发环境配置仅仅限于 macOS 上，如果读者使用的是 Windows / 可能需要自己搞定环境的配置。不过笔者使用了 Docker 进行环境配置，应该配置环境会省事很多。</li>
<li>在阅读本教程，请读者至少跟着 Django 官方的教程跟着走一遍。不要零基础一通瞎搞。</li>
<li>如果在使用过程中出现问题，请在 ISSUE 提供尽可能多的信息，将问题描述清楚。</li>
</ol>
<blockquote>
<p>本系列教程并不按照一步一步增加代码的方式写教程。我先带着大家搭建好整个项目框架，然后从不同的视角开介绍这个项目，比如：</p>
</blockquote>
<ol>
<li>某个模块的 models 是如何设计的？有哪些卧槽居然可以这么用的方式。</li>
<li>Django User 如何做扩展？同样在 Django 的生态圈里面，哪些场景有哪些值得围观的包，比如 guardian</li>
<li>Rest API 应该如何写，Django 里面的 Rest API 应该如何写？会有哪些生产效率 guangguangguang 提升上去的使用方法？权限怎么做？限流怎么搞？</li>
<li>Py.test TDD 测试驱动开发了解一下？</li>
</ol>
<h3 id="22-教程目录">2.2 教程目录</h3>
<ul>
<li>Django 全栈开发教程 - Python 和 Docker 环境配置</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端组件配置</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的前后端初步设计</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端初步实现</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的前端实现 YaVueBlog</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端组件之 Redis</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端组件之 PostgreSQL</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端组件之 Elasticsearch</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的后端组件之 RabbitMQ</li>
<li>Django 全栈开发教程 - YaDjangoBlog 博客的部署</li>
</ul>
<p>于是，本文的内容就如下：</p>
<ul>
<li>前后端分离</li>
<li>自动化部署</li>
<li>数据库相关</li>
<li>其他踩坑经历</li>
</ul>
<!-- raw HTML omitted -->
<h2 id="0x01-前后端分离">0x01 前后端分离</h2>
<p>前后端分离是提高团队开发的一个重要的开发策略，前后端分离之后，后端和前端交流好 JSON 格式，并行开发，局域网中放置一台服务器，后端写好一个功能，推送代码，由 gitlab 触发 Runner 自动交付到局域网的服务器上。这样的话，前后端可以并行开发，从而摆脱每一次开发过程不可避免，前端编写模板，然后由后端套用模板，出了问题，前端修改模板，后端接着修改模板&hellip; 循环往复，不曾更改的问题，在这种职责分明的情况下也不会出现背锅侠的问题。</p>
<p>在往常的开发过程中，而如果 Ajax 比较多或者前端写的代码质量稍微低一些，那么倒霉的事情就发生了，后端和前端的沟通成本那是相当的高。推锅的事情也会发生。</p>
<p>而新的开发过程中，如果上级有界面上的需求，基本上只需要前端更新一下代码，推送，就可以立即看到效果。
同样的，后端也是如此。</p>
<blockquote>
<p>这就是我选择前后端分离的初衷 &ndash; 将主要的精力放在开发上面。而不是套用模板和编辑 Ajax 过程中带来的沟通问题。</p>
</blockquote>
<p>在前后端配合上：</p>
<ul>
<li>后端选择 Django,Restful 框架选择了 DjangoRestFramework, DRF 的优点在于可以自动生成 API 界面，让前端对照着表单进行请求接口的测试。于是局域网的那一台可以配置为 Debug 模式，生产机器就可以关闭 DEBUG 模式。</li>
<li>前端选择 VueJS, 选择这个小而精美的框架一方面是基于团队的开发水平考虑，如果使用太激进的框架 React, 可能遇到问题无法在短时间内解决。由于选用了 VueJS, 也就选用了 Vue 全家桶，通过 Webpack2 进行配置完成基本的打包任务，通过 config 读取环境变量进行生产环境和发布环境的 apiurl 的分离</li>
<li>代码提交选择 Coding.NET 用于提交代码，在局域网中选择 Gitlab 用于提交代码，配上 Gitlab CI 进行持续集成，每次提交代码直接直接构建本地发布。前后端合作亲密无间。</li>
</ul>
<p>前后端分离有什么缺点呢？</p>
<ol>
<li>必须强行升级 Https</li>
<li>开发时候需要关掉 Django 的同源策略</li>
<li>IE8&ndash; 不兼容</li>
</ol>
<h3 id="11-django-和-他的小伙伴们">1.1 Django 和 他的小伙伴们</h3>
<p>Django 适用于快速开发，对于创业公司来说，是不错的快速开发语言。</p>
<p>不仅仅是因为 Python 表达力比较强，更重要的是 Django 有很多高质量的包可以使用。</p>
<ul>
<li>Django Debug Toolbar</li>
<li>DjangoRestFramework</li>
<li>Django Extensions</li>
</ul>
<h3 id="14-django-的奇技淫巧">1.4 Django 的奇技淫巧</h3>
<h4 id="django-model">Django Model</h4>
<ul>
<li><a href="http://stackoverflow.com/questions/1355150/django-when-saving-how-can-you-check-if-a-field-has-changed" target="_blank" rel="noopener noreffer">Save If Changed</a></li>
</ul>
<h2 id="0x02-自动化部署">0x02 自动化部署</h2>
<p>写程序 一般就是开发测试部署。</p>
<p>话虽然这么时候，但是在具体的实践过程中，还是有很多很多坑需要注意的。</p>
<p>比如，仅仅就开发环节来说，团队协作怎么搞？你说可以用 GIT 作为版本管理工具，代码托管。那我问你，这个 Web 开发过程中前端开发模板，后端套用模板怎么搞？你说，前后端分离，那前后端分离后 Http 请求被劫持怎么办，跨站攻击怎么搞&hellip;&hellip;
甚至如果是一个人开发的话，直接拉一台服务器做做部署，定期更新到网站上就行了。但如果是团队协作呢？前端提交了代码，产品经理过来说，你更新一下服务器，后端提交了代码，前端过来说，你更新一下服务器，过程琐碎而耗时。大量的时间就浪费在了这种枯燥的事情上了。两个后端，一个前端的情况下，每天本地发布（交付）的次数就已经是相当惊人（大概是前后端每天提交 5 次左右），如果以后是 3 个后端，三个前端，那我作为主程，每天就写不了代码了，这种情况是断不能忍的。</p>
<p>这个时候，就需要想着把团队协作开发流程优化好：</p>
<p>在我刚开始进行开发的时候，使用 bash 配合 Ansible 在本地和上线的 Ubuntu 16.04 上面自动化能够自动化的大部分工作，程序员在本地开发的时候，只需要进行开发，然后推送代码到 repo, 剩下的诸如自动化测试集成到系统中，则全部自动化。</p>
<h3 id="21-使用场景">2.1 使用场景</h3>
<p>经过研究，我确定了理想中的使用场景：</p>
<blockquote>
<p>前端与后端提交代码到代码托管上面的时候，直接集成，构建，Stage 到服务器。</p>
</blockquote>
<blockquote>
<p>到上线的时候，由我执行 Ansible 进行上线。</p>
</blockquote>
<h3 id="22-实施方案">2.2 实施方案</h3>
<p>在这个流程中，我需要安装如下的软件：</p>
<ul>
<li>Gitlab Gitlab-CI-Runner : 用于解决代码托管，项目的基本成长，以及持续化集成</li>
<li>PostgreSQL</li>
<li>MongoDB</li>
<li>Redis</li>
<li>RabbitMQ</li>
<li>Nginx</li>
<li>Python 以及 Python 扩展的依赖包</li>
<li>其他</li>
</ul>
<p>配置文件为 3 类：</p>
<ul>
<li>test</li>
<li>stage</li>
<li>production</li>
</ul>
<p>硬件设备 3 台：</p>
<ol>
<li>第一台为 Gitlab 部署的软件</li>
<li>第二台为 Stage 环境 （本地局域网持续交付）的机器</li>
<li>第三台为 Server （阿里云） 机器</li>
</ol>
<blockquote>
<p>注：最初使用 Ubuntu 机器，最终确定使用 Docker 镜像进行构建</p>
</blockquote>
<h3 id="23-持续交付">2.3. 持续交付</h3>
<p>当前端工程师 Push Master 分支到 Repo 上的时候，执行 Job 更新网站
当后端工程师 Push Master 分支到 Repo 上的时候，执行 Job 更新网站</p>
<p>Push Master 分支，这个自然无需多说，问题是怎么执行 Job 呢？</p>
<blockquote>
<p><strong>Gitlab CI Multi Runner</strong></p>
</blockquote>
<p>在一台 stage 的机器上安装 gitlab ci multi runner , 并且在该机器上注册 runner 为 shell , 这意味着 runner 会以 gitlab-runner 用户的权限进行测试 , 你需要 uninstall
然后 install &ndash;user=root 一下，然后重启，即可在 gitlab-ci.yml 上。</p>
<p>修改文件</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">
gitlab-runner register <span class="c1"># 然后填入相关信息</span>
vim /etc/gitlab-runner/config.toml <span class="c1"># 接着进行修改</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">concurrent</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">check_interval</span> <span class="o">=</span> <span class="m">0</span>

<span class="o">[[</span>runners<span class="o">]]</span>
  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;yadjangoweb&#34;</span>
  <span class="nv">url</span> <span class="o">=</span> <span class="s2">&#34;http://192.168.1.139/ci&#34;</span>
  <span class="nv">token</span> <span class="o">=</span> <span class="s2">&#34;325asd65f4e7xa9faasda8da&#34;</span>
  <span class="nv">executor</span> <span class="o">=</span> <span class="s2">&#34;shell&#34;</span>
  <span class="o">[</span>runners.cache<span class="o">]</span>
</code></pre></div><h3 id="24-dockerize-application">2.4. Dockerize Application</h3>
<p>Docker 以其轻量级和类似于版本管理的软件方式吸引了我。于是，准备将所有的 Service 都 Docker 化。</p>
<p>拿 Django 程序来说，首先 Django 程序依赖三个组件 redis / postgresql / rabbitmq , 完成这些组件的安装之后才能进行下一步的操作。</p>
<h2 id="0x03-数据库相关">0x03 数据库相关</h2>
<h3 id="1-数据库设计">1. 数据库设计</h3>
<p>PostgreSQL Array 在爬虫方面可以用来标记一个 Record 的处理状态
PostgreSQL Range 用来判断范围也是一个比较高效的选择（用空间 gist 索引取代两个索引）</p>
<p>GeoDjango 和 PostGIS 非常配</p>
<h3 id="2-数据迁移">2. 数据迁移</h3>
<h4 id="11-第一次数据迁移之-mysql-转-postgresql">1.1. 第一次数据迁移之 MySQL 转 PostgreSQL</h4>
<p>第一次数据迁移的时候基于 PostgreSQL 社区里面有个大杀器，叫做 PostGIS, 通过 PostGIS, 可以很方便的拥有和国内一些地图公司匹敌的算法。抛开算法实现的效率问题，基本上可以满足日常的开发需求，当时数据量不算大，使用 mysqldump 下来也就 500M 左右，而且行数大约 700W 条，于是使用了一个很笨的方法，就是将数据库使用 Django 命令 dump 成 json, 接着修改配置重新导入新数据库。</p>
<p>这种方式的缺点就是效率低而且太吃内存了，当时 16G 的服务器满内存，满交换内存地搞了一个上午。</p>
<h4 id="12-第二次数据迁移之重新-makemigrations">1.2. 第二次数据迁移之重新 makemigrations</h4>
<p>为什么要重新 makemigrations 呢，因为糟糕的事情发生了。</p>
<p>有个需求，需要重新定制用户登录认证系统。用户登录认证系统是最最应该在项目开始的时候编写的，这就是项目的基石，这个需求就恰似在房子盖到第三层的时候突然要把地基给加固。</p>
<p>Django 中如果使用了 auth 模块，则 auth.user 是最先被迁移到数据库中的，而如果你经过权衡继承 AbstractUser 并且 makemigrations 生成个迁移文件 0001_initial.py 后，在正常的情况下不容易将 migration 修改应用到数据库中。</p>
<blockquote>
<p>如果我偏要勉强呢？</p>
</blockquote>
<p>当然是可以勉强的，删掉数据库中已经记录下来的 auth.user migration 的相关记录即可。</p>
<p>那我为什么还是需要重新编写 migration 呢？</p>
<ol>
<li>因为之前对数据库的结构调整比较频繁，多达 138 次，而在 138 次调整数据结构之后，再去撤销第一次数据表的迁移操作的时候，则无异于厨子做菜要把牛排做 8 分熟，但是厨子做到 7 分熟的时候，突然顾客说，我要 5 分熟的牛排。那只能重新来了。</li>
<li>顺手精简掉 138 个文件。</li>
</ol>
<p>如何做呢？</p>
<ol>
<li>数据的迁移在没有表与表之间的关联的时候是很好办的，CSV, 标准 SQL 文件。</li>
<li>有表关联的情况下则需要权衡数据量来进行迁移，假如数据量在 10 来个 G 的时候，读到内存中，按照数据表的依赖关系，自下而上逐层迁移即可。</li>
<li>数据量大的时候，则需要去约束，去索引，然后转 CSV/SQL, 迁移到数据表中。如果表依赖不复杂的话，直接 psql 命令重定向数据也可以。</li>
</ol>
<p>但是呢，由于使用了 Django, 在数据量不大的时候，完全可以使用 Django 的 ORM 来做迁移。</p>
<p>我在 Google 了一下，发现下面一个脚本，于是设置数据库为新数据库 default 和 depressed</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">batch_migrate</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="c1"># remove data from destination db before copying</span>
    <span class="c1"># to avoid primary key conflicts or mismatches</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="c1"># get data form the source database</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;depressed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&#34;pk&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="c1"># process in chunks, to handle models with lots of data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="n">chunk_items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10000</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;已经迁移数据&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">chunk_items</span><span class="p">)</span>

    <span class="c1"># many-to-many fields are NOT handled by bulk create; check for</span>
    <span class="c1"># them and use the existing implicit through models to copy them</span>
    <span class="k">for</span> <span class="n">m2mfield</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">:</span>
        <span class="n">m2m_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">m2mfield</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">through</span>
        <span class="n">batch_migrate</span><span class="p">(</span><span class="n">m2m_model</span><span class="p">)</span>
</code></pre></div><p>按照表与表之间的依赖关系，逐个迁移到数据库中搞定。</p>
<h3 id="13-sequence-问题">1.3 sequence 问题</h3>
<p>在写 Django 的时候发现的时候无论如何都无法保存新的 item.</p>
<p>原来的代码为：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">()</span>
<span class="n">item</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div><p>报错信息是 Integrety, 报 duplicated 错误（下面的代码当然是打了马赛克了）</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span> <span class="n">duplicate</span> <span class="n">key</span> <span class="n">value</span> <span class="n">violates</span> <span class="n">unique</span> <span class="n">constraint</span> <span class="s2">&#34;foo_item_pkey&#34;</span>
<span class="n">DETAIL</span><span class="p">:</span>  <span class="n">Key</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="mi">111111</span><span class="p">)</span> <span class="n">already</span> <span class="n">exists</span><span class="o">.</span>
</code></pre></div><p>那么，问题来了：</p>
<blockquote>
<p><del>挖掘技术哪家强？</del></p>
</blockquote>
<p>啊，不是</p>
<blockquote>
<p>How To Solve This?</p>
</blockquote>
<p>经过猜测，而 get 到已有的 item 设置并且保存的话，并不会出现这个问题。问题主要出在 create 上面。</p>
<p>于是编写代码验证一下是不是猜想正确</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

<span class="c1"># do something</span>

<span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div><p>duplicate 的问题肯定是多次存同样的不能重复的字段。</p>
<p>**但尼玛，我之前做测试的时候考虑过这个逻辑呀？**换而言之，这种问题不应该出现，如果出现了问题，八成是 ORM 用的不对。</p>
<p>印象中这种问题 Google 一下 Integrety Duplicate Django PostgreSQL 一般就能出来了。</p>
<p>最后找到解决方案：http://centoshowtos.org/web-services/django-and-postgres-duplicate-key/</p>
<p>在终端进入 psql 查询 sequence 最新值</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="n">start_value</span><span class="p">,</span> <span class="n">last_value</span><span class="p">,</span> <span class="n">max_value</span> <span class="k">from</span> <span class="n">dt_crawler_item_item_id_seq</span><span class="p">;</span>

 <span class="n">start_value</span> <span class="o">|</span> <span class="n">last_value</span> <span class="o">|</span>      <span class="n">max_value</span>
<span class="c1">-------------|------------|---------------------
</span><span class="c1"></span>           <span class="mi">1</span> <span class="o">|</span>    <span class="mi">111110</span> <span class="o">|</span> <span class="mi">9223372036854775807</span>
</code></pre></div><p>而我们查看一下 item_id 的最大值</p>
<pre><code>select max(item_id) from app_model_item;

   max
---------
 111111
</code></pre><p>重置 sequence last_value 值到最新即可。</p>
<pre><code>alter sequence app_model_item_item_id_seq restart with 111111;
</code></pre><blockquote>
<p>当数据库每次插入一条非指定主键的记录，则获取 last_value(111110), 加 1 得到当前的主键接着插入。但这个过程无异于数据库中已经有了一个 pk 为 111111 的记录，再插入一条。于是报错。</p>
</blockquote>
<p>回顾这个问题，该问题是由于 PostGres 的 sequence 造成 pkey 相等，换而言之，postgres 应该在有一个 pk 值为 111111 的时候，插入一个无主键的记录，PostgreSQL 获取 sequence+1(111110 + 1) 得到它认为当前的主键值，接着再一次插入了主键为 111111 的这个值。</p>
<p>这个过程相当于依次插入两个条 ID 相同的记录。</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="err">…</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">111111</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="err">…</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="err">…</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">111111</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="err">…</span><span class="p">);</span>
</code></pre></div><blockquote>
<p>sequence 避免了每一次 max 查找带来的性能损失，一方面带来了方便，也带来了隐藏的坑。</p>
</blockquote>
<p>如果以后这个问题比较多的话，参考下面的源码对文本进行修改。</p>
<p><a href="https://github.com/ASKBOT/django-postgresql-fix-sequences/blob/master/postgresql_sequence_utils/utils.py">https://github.com/ASKBOT/django-postgresql-fix-sequences/blob/master/postgresql_sequence_utils/utils.py</a></p>
<h2 id="0x04-webserver">0x04 WebServer</h2>
<p>目前使用的 WebServer 是用 Nginx 做反向代理，将请求通过 unix socket 转发到 gunicorn，gunicorn 作为 django 实际上的 webserver。</p>
<h3 id="unix-socket-和-gunicorn-的-remote_addr-问题">unix socket 和 gunicorn 的 REMOTE_ADDR 问题</h3>
<p>Django Admin 模块在访问 某个页面的时候特别特别慢，而在我的机器上一切正常，我怀疑的是数据库的问题，于是，那么首先要知道数据库的查询语句，于是想借用 django debug toolbar 来 profiling, 于是问题来了，我在局域网模拟真机环境，结果无论如何都无法呈现 Django Debug Toolbar,</p>
<p>问题八成出现在 Django 配置环境 或者 Nginx 上面（当然，最后发现是 Gunicorn 的锅）. 在</p>
<p>经过一段时间的排查，认为是 Nginx 的问题，在相关配置添加下面设置 Header,</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
</code></pre></div><p>结果依旧无法获取 request.Meta[&ldquo;REMOTE-ADDR&rdquo;]</p>
<p>经过搜索发现不止我一个人的问题：https://github.com/benoitc/gunicorn/issues/797</p>
<p>最后发现是 Http 请求从 nginx 这儿经过 unix socket 转发到 gunicorn.sock 下默认是没有赋值 REMOTE-ADDR 的，</p>
<p>那么，这个在 HTTP Header 层次的东西，没有在 gunicorn 层次解决，那就只能在 django 层次解决。</p>
<p>给 Django 添加中间件如下，放在 djangodebugtools 的前面。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">XForwardedForMiddleware</span><span class="p">(</span><span class="n">MiddlewareMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;HTTP_X_FORWARDED_FOR&#34;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&#34;HTTP_X_PROXY_REMOTE_ADDR&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&#34;REMOTE_ADDR&#34;</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&#34;HTTP_X_FORWARDED_FOR&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&#34;REMOTE_ADDR&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div><p>解决。</p>
<h3 id="nginx-gzip-压缩">Nginx Gzip 压缩</h3>
<p>当 json 数据量比较大的时候，则必须要考虑开启压缩。一般情况下，虽然这个可以在 Django 层次完成，但是这么做还不如在 nginx 层次完成。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>
    <span class="n">gzip_disable</span> <span class="s2">&#34;msie6&#34;</span><span class="p">;</span>
    <span class="n">gzip_vary</span> <span class="n">on</span><span class="p">;</span>
    <span class="n">gzip_proxied</span> <span class="nb">any</span><span class="p">;</span>
    <span class="n">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">gzip_buffers</span> <span class="mi">16</span> <span class="mi">8</span><span class="n">k</span><span class="p">;</span>
    <span class="n">gzip_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
    <span class="n">gzip_types</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span> <span class="n">text</span><span class="o">/</span><span class="n">css</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span> <span class="n">text</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">+</span><span class="n">rss</span> <span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">;</span>
</code></pre></div><p>开启之后，我这边的 一个 220k 的数据缩减到 54k</p>
<h2 id="0x04-其他踩坑相关">0x04. 其他踩坑相关</h2>
<h3 id="41-奇怪的文件问题">4.1 奇怪的文件问题</h3>
<p>在某一天遇到了一个问题 往常的时候，当文件上传到 Django 中的时候，都可以正常的解析，但是这两天居然不能用了。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 问题代码出现在</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
<span class="c1"># 报这个问题 google 几乎没有什么解决方案</span>
<span class="n">Invalid</span> <span class="nb">file</span> <span class="n">path</span> <span class="ow">or</span> <span class="nb">buffer</span> <span class="nb">object</span> <span class="nb">type</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uploadedfile</span><span class="o">.</span><span class="n">InMemoryUploadedFile</span><span class="s1">&#39;&gt;</span>
</code></pre></div><p>更加糟糕的问题出现了，我本人的开发环境和服务器的开发环境基本一致，但，但，但为什么不能用呢？</p>
<p>分别回滚代码，Nginx 设置，在线上打 Log, 最终确定了是 Pandas 从 0.19 升级到了 0.20 之后出现的一个小问题。最终还原线上 python 安装环境，搞定。</p>
<h2 id="0xee-参考链接">0xEE. 参考链接</h2>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-21</strong> 重修文字</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-01-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/django/">Django</a>,&nbsp;<a href="/tags/yadjangoblog/">YaDjangoBlog</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20180210_dockercheatsheet/" class="prev" rel="prev" title="Docker CheatSheet"><i class="fas fa-angle-left fa-fw"></i>Docker CheatSheet</a>
            <a href="/posts/20180221_fullstackdjangodevops/" class="next" rel="next" title="2018 年不容错过的 Django 全栈项目">2018 年不容错过的 Django 全栈项目<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://twocucao.xyz" target="_blank">twocucao</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
