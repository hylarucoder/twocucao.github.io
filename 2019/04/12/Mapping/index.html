<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"twocucao.xyz","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="0x00 前言Python 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee  SQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现 Django ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的">
<meta property="og:type" content="article">
<meta property="og:title" content="一文解决你的 Python ORM 选择困难症">
<meta property="og:url" content="http://twocucao.xyz/2019/04/12/Mapping/index.html">
<meta property="og:site_name" content="MG的编程小屋">
<meta property="og:description" content="0x00 前言Python 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee  SQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现 Django ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的">
<meta property="og:locale">
<meta property="article:published_time" content="2019-04-12T13:05:00.000Z">
<meta property="article:modified_time" content="2019-04-12T09:19:48.000Z">
<meta property="article:author" content="Micheal Gardner">
<meta property="article:tag" content="VueJS">
<meta property="article:tag" content="全栈开发">
<meta property="article:tag" content="RestAPI">
<meta property="article:tag" content="Flask">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://twocucao.xyz/2019/04/12/Mapping/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>一文解决你的 Python ORM 选择困难症 | MG的编程小屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="MG的编程小屋" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MG的编程小屋</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Get Busy Living, Or Get Busy Dying</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2019/04/12/Mapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          一文解决你的 Python ORM 选择困难症
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-04-12 21:05:00 / Modified: 17:19:48" itemprop="dateCreated datePublished" datetime="2019-04-12T21:05:00+08:00">2019-04-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Python 圈内三大 ORM SQLAlchemy VS Django ORM VS Peewee</p>
<ol>
<li>SQLAlchemy 复杂程度最高，同时，这也意味着 SQLAlchemy 可以做更多的事情。使用 DataMapper 方式实现</li>
<li>Django ORM 个人最喜欢，使用 ActiveRecord 实现 如果不是因为现在 Flask 项目已经是用了 SQLAlchemy , 否则的话我甚至会考虑将 Django ORM 配置到 Flask 项目中。当然，也有蛋疼的 SqlAlchemy 使用者已经移植给 django 配置了 SQLAlchemy 的库。</li>
<li>Peewee 没用过，不好评论。以后有机会试试。</li>
</ol>
<h2 id="0x01-如何访问数据库"><a href="#0x01-如何访问数据库" class="headerlink" title="0x01 如何访问数据库"></a>0x01 如何访问数据库</h2><p>那，既然已经可以访问数据库，本着『如无必要，勿增实体』的原则，为什么要不辞劳苦的用个库呢？</p>
<h2 id="0x02-数据库抽象的两种理论"><a href="#0x02-数据库抽象的两种理论" class="headerlink" title="0x02 数据库抽象的两种理论"></a>0x02 数据库抽象的两种理论</h2><h3 id="理论一：Active-Record"><a href="#理论一：Active-Record" class="headerlink" title="理论一：Active Record"></a>理论一：Active Record</h3><h3 id="理论二：Data-Mapper"><a href="#理论二：Data-Mapper" class="headerlink" title="理论二：Data Mapper"></a>理论二：Data Mapper</h3><h2 id="0x03-数据库抽象的两种实现"><a href="#0x03-数据库抽象的两种实现" class="headerlink" title="0x03 数据库抽象的两种实现"></a>0x03 数据库抽象的两种实现</h2><h3 id="实现一：Django-ORM"><a href="#实现一：Django-ORM" class="headerlink" title="实现一：Django ORM"></a>实现一：Django ORM</h3><h3 id="实现二：Sqlalchemy"><a href="#实现二：Sqlalchemy" class="headerlink" title="实现二：Sqlalchemy"></a>实现二：Sqlalchemy</h3><h2 id="0x04-工具的强弱"><a href="#0x04-工具的强弱" class="headerlink" title="0x04 工具的强弱"></a>0x04 工具的强弱</h2><p><a target="_blank" rel="noopener" href="https://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/">https://www.thoughtfulcode.com/orm-active-record-vs-data-mapper/</a></p>
<h3 id="2-0-SQLAlchemy-VS-DjangoORM"><a href="#2-0-SQLAlchemy-VS-DjangoORM" class="headerlink" title="2.0 SQLAlchemy VS DjangoORM"></a>2.0 SQLAlchemy VS DjangoORM</h3><p>ORM 通常有 DataMapper 实现和 ActiveRecord 实现两种。</p>
<p>依照我的经验，ActiveRecord 使用起来的更接近对象 (Object) 的操作，DataMapper 使用起来更接近 (Table) 的操作。</p>
<blockquote>
<p>SQLAlchemy 是 DataMapper 模式的实现，在该模式下，session 会暴露出来，即 Model 与 session 并不耦合。</p>
</blockquote>
<blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，session 并不暴露出来，即 Model 与 session 耦合。</p>
</blockquote>
<p>使用 Django ORM 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b &#x3D; Blog(**data)</span><br><span class="line">b.save()</span><br></pre></td></tr></table></figure>

<p>使用 SQLAlchemy 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b &#x3D; Blog(**data)</span><br><span class="line">session.add(b)</span><br><span class="line">session.session(b)</span><br></pre></td></tr></table></figure>

<p>由于 Django 帮你屏蔽了 session 的操作。</p>
<p>在通常情况下，</p>
<ol>
<li>DjangoORM 使用起来更加接近 Object 的操作。</li>
<li>SQLAlchemy 使用起来更加接近 Table 的操作。</li>
</ol>
<p>举个例子，</p>
<p>一对多，Father 添加两个小孩（其中一个小孩是已经存在的）</p>
<p>在 DjangoORM 里面， 这里更像是一个 Set 的 add 操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">father.children.add(new_child,exsit_child)</span><br></pre></td></tr></table></figure>

<p>在 SQLAlchemy 里面，这里更像是一个 table 的 insert 操作。（麻蛋，你要说是一个 list 的 append 操作也行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for child in (new_child,exsit_child):</span><br><span class="line">    if child in father.children:</span><br><span class="line">        father.children.append(child)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写 SQLAlchemy 更接近操作放在数据库里面的数据记录，而 DjangoORM 更接近操作一批放在数据库里面的对象。</p>
</blockquote>
<p>由于 session 的使用姿势不同，所以往往会有很多使用上面的区别。</p>
<p>至于孰优孰劣，难以评判。</p>
<ul>
<li><p>技术老大 (Flask 和 React 大神）倾向于使用 SQLAlchemy, 他认为</p>
<ul>
<li>对于一个技术『知其然，知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据库，操作最好要落实在成 SQL</li>
<li>如果有可能的话，每一个 SQL 语句都要经过推敲，而且写这个 SQL 和 ORM 过程要反复练习</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>Alembic 这个迁移工具是为了省事用的，甚至在某些情况下没必要用。完全可以写 SQL 代替</li>
</ul>
</li>
</ul>
</li>
<li><p>我 (Django 和 Vue 弱鸡）倾向于使用 DjangoORM, 我认为</p>
<ul>
<li>对于一个技术『先知其大致然，需要深入的时候知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据，最好抽象为对对象的操作。</li>
<li>测试到位的情况下，快糙狠先出东西。到需要优化的时候该怎么 Profile 怎么 Profile</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>用起来啊，能操作对象为什么还要强行到数据库操作？</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Active Record, properly defined, is a design pattern where an object is represented as a record on a table in a relational database.</span><br></pre></td></tr></table></figure>

<h3 id="2-1-模型定义"><a href="#2-1-模型定义" class="headerlink" title="2.1 模型定义"></a>2.1 模型定义</h3><p>先看一组模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line">Base = declarative_base() <span class="comment"># 模型基类</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>) <span class="comment"># 主键</span></span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&lt;User(name=&#x27;%s&#x27;, fullname=&#x27;%s&#x27;, password=&#x27;%s&#x27;)&gt;&quot;</span> % (</span><br><span class="line">                            self.name, self.fullname, self.password)</span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="Models-与-Meta"><a href="#Models-与-Meta" class="headerlink" title="Models 与 Meta"></a>Models 与 Meta</h4><p><a target="_blank" rel="noopener" href="https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685">https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685</a></p>
<h4 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h4><h5 id="One-To-Many"><a href="#One-To-Many" class="headerlink" title="One To Many"></a>One To Many</h5><p>母亲有若干个孩子，外键在孩子上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Parent(Base):</span><br><span class="line">    #...</span><br><span class="line">    children &#x3D; relationship(&quot;Child&quot;, backref&#x3D;&quot;parent&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    #...</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;parent.id&#39;))</span><br></pre></td></tr></table></figure>

<h5 id="Many-To-One"><a href="#Many-To-One" class="headerlink" title="Many To One"></a>Many To One</h5><p>多个母亲共享一个孩子，外键在母亲上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Parent(Base):</span><br><span class="line">    child_id &#x3D; Column(Integer, ForeignKey(&#39;child.id&#39;))</span><br><span class="line">    child &#x3D; relationship(&quot;Child&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>

<h5 id="One-To-One"><a href="#One-To-One" class="headerlink" title="One To One"></a>One To One</h5><p>One to One 是 One to Many 或者是 Many to One 的简化版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Many To One</span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line">    child_id &#x3D; Column(Integer, ForeignKey(&#39;child.id&#39;))</span><br><span class="line">    child &#x3D; relationship(&quot;Child&quot;, backref&#x3D;backref(&quot;parent&quot;, uselist&#x3D;False))</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br><span class="line"></span><br><span class="line"># One To Many 改 One To One</span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;parent.id&#39;))</span><br><span class="line">    parent &#x3D; relationship(&quot;Parent&quot;, backref&#x3D;backref(&quot;child&quot;, uselist&#x3D;False))</span><br></pre></td></tr></table></figure>

<h5 id="Many-To-Many"><a href="#Many-To-Many" class="headerlink" title="Many To Many"></a>Many To Many</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">association_table &#x3D; Table(&#39;association&#39;, Base.metadata,</span><br><span class="line">    Column(&#39;left_id&#39;, Integer, ForeignKey(&#39;left.id&#39;)),</span><br><span class="line">    Column(&#39;right_id&#39;, Integer, ForeignKey(&#39;right.id&#39;))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line">    children &#x3D; relationship(&quot;Child&quot;,</span><br><span class="line">                    secondary&#x3D;association_table,</span><br><span class="line">                    backref&#x3D;&quot;parents&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>

<p>注意事项</p>
<p>执行删除 mapping 表的时候尽量这样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myparent.children.remove(somechild)</span><br></pre></td></tr></table></figure>

<p>当你想干掉 somechild 的时候，会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.delete(somechild)</span><br></pre></td></tr></table></figure>

<ol>
<li>假如 Child 没有 ref Parent 的话，Secondary Table 无删除，则无法删除。</li>
<li>假如 ref 了的话，则删除 secondary 里面的记录。</li>
<li>TODO</li>
</ol>
<h5 id="邻接列表关系"><a href="#邻接列表关系" class="headerlink" title="邻接列表关系"></a>邻接列表关系</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Node(Base):</span><br><span class="line">    __tablename__ &#x3D; &#39;node&#39;</span><br><span class="line">    id &#x3D; Column(Integer, primary_key&#x3D;True)</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;node.id&#39;))</span><br><span class="line">    data &#x3D; Column(String(50))</span><br><span class="line">    children &#x3D; relationship(&quot;Node&quot;,</span><br><span class="line">                backref&#x3D;backref(&#39;parent&#39;, remote_side&#x3D;[id])</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="relationship-详解"><a href="#relationship-详解" class="headerlink" title="relationship 详解"></a>relationship 详解</h5><h3 id="2-1-Query"><a href="#2-1-Query" class="headerlink" title="2.1 Query"></a>2.1 Query</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c1 &#x3D; Child(name&#x3D;&quot;苏轼&quot;)</span><br><span class="line">session.add(c1)</span><br><span class="line">session.flush()</span><br><span class="line">p &#x3D; Parent(name&#x3D;&quot;苏辙&quot;)</span><br><span class="line">p.best_child &#x3D; c1</span><br><span class="line">for c in [c1,c2,c3,c4]:</span><br><span class="line">    p.children.append(c)</span><br><span class="line">session.add(c1)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h4 id="Retrieve"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve</h4><p>过滤</p>
<p>filter(**kwargs)<br>filter(Singer.name == “周杰伦”)<br>filter(Singer.name =! “周杰棍”)</p>
<h5 id="跨关系（跨表）查询"><a href="#跨关系（跨表）查询" class="headerlink" title="跨关系（跨表）查询"></a>跨关系（跨表）查询</h5><p>session.query(Entry).join(Blog,Blog.entry_id == Entry.id).filter(Blog.name = “SqlAlchemy CheatSheet”)</p>
<h5 id="Limit-Offset-分页"><a href="#Limit-Offset-分页" class="headerlink" title="Limit / Offset / 分页"></a>Limit / Offset / 分页</h5><ul>
<li>limit()</li>
<li>offset()</li>
</ul>
<h5 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query &#x3D; session.query(Order) # query &#x3D; session.query(Order)</span><br><span class="line">query &#x3D; query.filter(Order.name.like(f&quot;%name%&quot;))</span><br></pre></td></tr></table></figure>

<h5 id="二进制表达式"><a href="#二进制表达式" class="headerlink" title="二进制表达式"></a>二进制表达式</h5><p>我们先 type 一下表达式，找到 eq 的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(model.column_name == <span class="string">&#x27;asdf&#x27;</span>) → sqlalchemy.sql.elements.BinaryExpression</span><br></pre></td></tr></table></figure>

<p>是一个二进制表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等于</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>)</span><br><span class="line"><span class="comment"># 不等于</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name != <span class="string">&#x27;ed&#x27;</span>)</span><br><span class="line"><span class="comment"># Like（有的数据库不区分大小写）</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.like(<span class="string">&#x27;%ed%&#x27;</span>))</span><br><span class="line"><span class="comment"># ILIKE (case-insensitive LIKE)</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.ilike(<span class="string">&#x27;%ed%&#x27;</span>))</span><br><span class="line"><span class="comment"># IN</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.in_([<span class="string">&#x27;ed&#x27;</span>, <span class="string">&#x27;wendy&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>]))</span><br><span class="line"><span class="comment"># Not in</span></span><br><span class="line">query.<span class="built_in">filter</span>(~User.name.in_([<span class="string">&#x27;ed&#x27;</span>, <span class="string">&#x27;wendy&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>]))</span><br><span class="line"><span class="comment"># IS NULL</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="literal">None</span>)</span><br><span class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.is_(<span class="literal">None</span>))</span><br><span class="line"><span class="comment"># IS NOT NULL:</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name != <span class="literal">None</span>)</span><br><span class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.isnot(<span class="literal">None</span>))</span><br><span class="line"><span class="comment"># AND</span></span><br><span class="line"><span class="comment">## use and_()</span></span><br><span class="line">query.<span class="built_in">filter</span>(and_(User.name == <span class="string">&#x27;ed&#x27;</span>, User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>))</span><br><span class="line"><span class="comment">## or send multiple expressions to .filter()</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>, User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>)</span><br><span class="line"><span class="comment">## or chain multiple filter()/filter_by() calls</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>).<span class="built_in">filter</span>(User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>)</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">query.<span class="built_in">filter</span>(or_(User.name == <span class="string">&#x27;ed&#x27;</span>, User.name == <span class="string">&#x27;wendy&#x27;</span>))</span><br><span class="line"><span class="comment"># MATCH</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.match(<span class="string">&#x27;wendy&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">all()</span><br><span class="line">first()</span><br><span class="line">one()</span><br><span class="line">one_or_none()</span><br><span class="line">scalar()</span><br></pre></td></tr></table></figure>

<p>YourModel.query.get((pk1, pk2))</p>
<h5 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h5><blockquote>
<p>同一个 Session 下面，取到的某一条数据对应的 objects 应该是一样的？</p>
</blockquote>
<h5 id="复制-实例"><a href="#复制-实例" class="headerlink" title="复制 实例"></a>复制 实例</h5><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查询的是 SomeModel 里面所有的字段 即 select *</span><br><span class="line">query &#x3D; session.query(SomeModel)</span><br><span class="line"># 查询的是 SomeModel 里面部分的字段 即 select acol, bcol</span><br><span class="line">query &#x3D; session.query(SomeModel.acol,SomeModel.bcol)</span><br><span class="line"># 即 select acol , bcol</span><br><span class="line"># alias</span><br><span class="line">user_alias &#x3D; aliased(User, name&#x3D;&#39;user_alias&#39;)</span><br><span class="line">for row in session.query(user_alias, user_alias.name).all():</span><br><span class="line">    # 即相当于 select name as name_label</span><br><span class="line">    print(row.user_alias)</span><br><span class="line"></span><br><span class="line"># limit 和 offset</span><br><span class="line">for u in session.query(User).order_by(User.id)[1:3]:</span><br><span class="line">    print(u)</span><br><span class="line"></span><br><span class="line"># distinct</span><br><span class="line">session.query(model.Name).distinct(model.Name.value).order_by(model.Name.value)</span><br><span class="line"># order_by</span><br><span class="line">User.query.order_by(User.popularity.desc(),User.date_created.desc()).limit(10).all()</span><br></pre></td></tr></table></figure>

<h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><p>单个 object 更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blog.title &#x3D; &quot;大宝天天见&quot;</span><br><span class="line">session.add(blog)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<p>批量更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.query.filter(Blog.content.like(&quot;% 敏感词 %&quot;)).update(&#123;</span><br><span class="line">    Blog.content: &quot;依照相关 XX 无法查看&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>一对多的更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append</span><br></pre></td></tr></table></figure>

<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><p>query.delete()</p>
<h4 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h4><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query">https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query</a></p>
<h5 id="两表-InnerJoin"><a href="#两表-InnerJoin" class="headerlink" title="两表 InnerJoin"></a>两表 InnerJoin</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> u, a <span class="keyword">in</span> session.query(User, Address).\</span><br><span class="line">                    <span class="built_in">filter</span>(User.<span class="built_in">id</span>==Address.user_id).\</span><br><span class="line">                    <span class="built_in">filter</span>(Address.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>).\</span><br><span class="line">                    <span class="built_in">all</span>():</span><br><span class="line">    print(u)</span><br><span class="line">    print(a)</span><br><span class="line"><span class="comment"># &lt;User(name=&#x27;jack&#x27;, fullname=&#x27;Jack Bean&#x27;, password=&#x27;gjffdd&#x27;)&gt;</span></span><br><span class="line"><span class="comment"># &lt;Address(email_address=&#x27;jack@google.com&#x27;)&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="多表-InnerJoin-LeftJoin"><a href="#多表-InnerJoin-LeftJoin" class="headerlink" title="多表 InnerJoin + LeftJoin"></a>多表 InnerJoin + LeftJoin</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.outerjoin(User.addresses)   # LEFT OUTER JOIN</span><br></pre></td></tr></table></figure>

<h4 id="聚集查询"><a href="#聚集查询" class="headerlink" title="聚集查询"></a>聚集查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).filter(User.name.like(&#39;%ed&#39;)).count()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy import func</span><br><span class="line">session.query(Table.column, func.count(Table.column)).group_by(Table.column).all()</span><br><span class="line"></span><br><span class="line">self.session.query(func.count(Table.column1),Table.column1, Table.column2).group_by(Table.column1, Table.column2).all()</span><br><span class="line"></span><br><span class="line">from sqlalchemy.sql import func</span><br><span class="line">session.query(func.avg(Rating.field2).label(&#39;average&#39;)).filter(Rating.url&#x3D;&#x3D;url_string.netloc)</span><br></pre></td></tr></table></figure>

<h4 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h4><p>Query 对象，下文中，我会聊到这个 Query 对象。这里先跳过。</p>
<h3 id="2-2-原生查询"><a href="#2-2-原生查询" class="headerlink" title="2.2 原生查询"></a>2.2 原生查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy import text</span><br><span class="line"></span><br><span class="line">sql &#x3D; text(&#39;select name from penguins&#39;)</span><br><span class="line">result &#x3D; db.engine.execute(sql)</span><br><span class="line">names &#x3D; []</span><br><span class="line">for row in result:</span><br><span class="line">    names.append(row[0])</span><br><span class="line"></span><br><span class="line">print names</span><br><span class="line"></span><br><span class="line">from collections import namedtuple</span><br><span class="line"></span><br><span class="line">Record &#x3D; namedtuple(&#39;Record&#39;, result.keys())</span><br><span class="line">records &#x3D; [Record(*r) for r in result.fetchall()]</span><br><span class="line">for r in records:</span><br><span class="line">    print(r)</span><br><span class="line"></span><br><span class="line">from sqlalchemy.sql import text</span><br><span class="line"></span><br><span class="line">connection &#x3D; engine.connect()</span><br><span class="line"></span><br><span class="line"># recommended</span><br><span class="line">cmd &#x3D; &#39;select * from Employees where EmployeeGroup &#x3D;&#x3D; :group&#39;</span><br><span class="line">employeeGroup &#x3D; &#39;Staff&#39;</span><br><span class="line">employees &#x3D; connection.execute(text(cmd), group &#x3D; employeeGroup)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>get_or_create</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_or_create(session, model, defaults&#x3D;None, **kwargs):</span><br><span class="line">    instance &#x3D; session.query(model).filter_by(**kwargs).first()</span><br><span class="line">    if instance:</span><br><span class="line">        return instance, False</span><br><span class="line">    else:</span><br><span class="line">        params &#x3D; dict((k, v) for k, v in kwargs.iteritems() if not isinstance(v, ClauseElement))</span><br><span class="line">        params.update(defaults or &#123;&#125;)</span><br><span class="line">        instance &#x3D; model(**params)</span><br><span class="line">        session.add(instance)</span><br><span class="line">        return instance, True</span><br></pre></td></tr></table></figure>

<h3 id="2-3-更新查询"><a href="#2-3-更新查询" class="headerlink" title="2.3 更新查询"></a>2.3 更新查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(Stuff).update(&#123;Stuff.foo: Stuff.foo + 1&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1) for c in session.query(Stuff).all():</span><br><span class="line">       c.foo +&#x3D; 1</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">2) session.query().\</span><br><span class="line">       update(&#123;&quot;foo&quot;: (Stuff.foo + 1)&#125;)</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">3) conn &#x3D; engine.connect()</span><br><span class="line">   stmt &#x3D; Stuff.update().\</span><br><span class="line">       values(Stuff.foo &#x3D; (Stuff.foo + 1))</span><br><span class="line">   conn.execute(stmt)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1) user.no_of_logins +&#x3D; 1</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">2) session.query().\</span><br><span class="line">       filter(User.username &#x3D;&#x3D; form.username.data).\</span><br><span class="line">       update(&#123;&quot;no_of_logins&quot;: (User.no_of_logins +1)&#125;)</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">3) conn &#x3D; engine.connect()</span><br><span class="line">   stmt &#x3D; User.update().\</span><br><span class="line">       values(no_of_logins&#x3D;(User.no_of_logins + 1)).\</span><br><span class="line">       where(User.username &#x3D;&#x3D; form.username.data)</span><br><span class="line">   conn.execute(stmt)</span><br><span class="line"></span><br><span class="line">4) setattr(user, &#39;no_of_logins&#39;, user.no_of_logins+1)</span><br><span class="line">   session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="2-4-删除"><a href="#2-4-删除" class="headerlink" title="2.4 删除"></a>2.4 删除</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete">https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete</a></p>
<h4 id="OnDelete"><a href="#OnDelete" class="headerlink" title="OnDelete"></a>OnDelete</h4><p>ondelete=’CASCADE’))</p>
<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><p>models.User.query.delete()</p>
<h3 id="如何从-Object-到一个-ORM"><a href="#如何从-Object-到一个-ORM" class="headerlink" title="如何从 Object 到一个 ORM"></a>如何从 Object 到一个 ORM</h3><p>如何追踪 Object 的变化？</p>
<h2 id="0x03-SQLAlchemy-的高级特性"><a href="#0x03-SQLAlchemy-的高级特性" class="headerlink" title="0x03 SQLAlchemy 的高级特性"></a>0x03 SQLAlchemy 的高级特性</h2><h3 id="表继承"><a href="#表继承" class="headerlink" title="表继承"></a>表继承</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance">https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance</a></p>
<h3 id="啥玩意"><a href="#啥玩意" class="headerlink" title="啥玩意"></a>啥玩意</h3><p>Flush 和 commit</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit">https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x &#x3D; Foo(bar&#x3D;1)</span><br><span class="line">print x.id</span><br><span class="line"># None</span><br><span class="line">session.add(x)</span><br><span class="line">session.flush()</span><br><span class="line"># BEGIN</span><br><span class="line"># INSERT INTO foo (bar) VALUES(1)</span><br><span class="line"># COMMIT</span><br><span class="line">print x.id</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qry &#x3D; DBSession.query(User).filter(</span><br><span class="line">        and_(User.birthday &lt;&#x3D; &#39;1988-01-17&#39;, User.birthday &gt;&#x3D; &#39;1985-01-17&#39;))</span><br></pre></td></tr></table></figure>

<h2 id="0x04-SQLAlchemy-的基础特性-Under-The-Hood"><a href="#0x04-SQLAlchemy-的基础特性-Under-The-Hood" class="headerlink" title="0x04 SQLAlchemy 的基础特性 Under The Hood"></a>0x04 SQLAlchemy 的基础特性 Under The Hood</h2><h3 id="Loading-策略"><a href="#Loading-策略" class="headerlink" title="Loading 策略"></a>Loading 策略</h3><h4 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h4><h4 id="Eager-Loading"><a href="#Eager-Loading" class="headerlink" title="Eager Loading"></a>Eager Loading</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from sqlalchemy.dialects import postgresql</span><br><span class="line">&gt;&gt;&gt; print str(q.statement.compile(dialect&#x3D;postgresql.dialect()))</span><br><span class="line">Where q is defined as:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x05-SQLAlchemy-的高级特性-Under-The-Hood"><a href="#0x05-SQLAlchemy-的高级特性-Under-The-Hood" class="headerlink" title="0x05 SQLAlchemy 的高级特性 Under The Hood"></a>0x05 SQLAlchemy 的高级特性 Under The Hood</h2><h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy">https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications">https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;34322471&#x2F;sqlalchemy-engine-connection-and-session-difference</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;11769366&#x2F;why-is-sqlalchemy-insert-with-sqlite-25-times-slower-than-using-sqlite3-directly</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;12223335&#x2F;sqlalchemy-creating-vs-reusing-a-session</span><br><span class="line">session 是个容器</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;18199053&#x2F;example-of-what-sqlalchemy-can-do-and-django-orm-cannot</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;7389759&#x2F;memory-efficient-built-in-sqlalchemy-iterator-generator</span><br><span class="line"></span><br><span class="line"># 日志</span><br><span class="line">import logging</span><br><span class="line">logging.basicConfig()</span><br><span class="line">logging.getLogger(&#39;sqlalchemy.engine&#39;).setLevel(logging.INFO)</span><br></pre></td></tr></table></figure>

<h2 id="0x06-DEBUG-和-Profile-技巧"><a href="#0x06-DEBUG-和-Profile-技巧" class="headerlink" title="0x06 DEBUG 和 Profile 技巧"></a>0x06 DEBUG 和 Profile 技巧</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS &#x3D; False</span><br></pre></td></tr></table></figure>

<h3 id="6-1-查看技巧"><a href="#6-1-查看技巧" class="headerlink" title="6.1 查看技巧"></a>6.1 查看技巧</h3><p>dict(u)<br>u.<strong>dict</strong></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application">https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application</a></p>
<p>如果用上 Flask+SQLAlchemy 一般也要带上，Flask-Migration 与 Flask-SQLAlchemy, 这两个库也是对 Alembic 和 SQLAlchemy 的浅封装。</p>
<p>那么，对于这个 ORM 库还有那些通用性的知识需要了解？</p>
<p>嗯，是时候了解本质了。</p>
<p><a target="_blank" rel="noopener" href="http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/">http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/</a></p>
<h2 id="0x07-ORM-的本质"><a href="#0x07-ORM-的本质" class="headerlink" title="0x07 ORM 的本质"></a>0x07 ORM 的本质</h2><p>ORM 的本质是 Data Access Layer 上的一层封装。如果你写原生 SQL, 即手写 DAL 的话，开发效率可能会大打折扣。</p>
<h3 id="ORM-的两种类型-Active-Record-与-Data-Mappers"><a href="#ORM-的两种类型-Active-Record-与-Data-Mappers" class="headerlink" title="ORM 的两种类型 Active Record 与 Data Mappers"></a>ORM 的两种类型 Active Record 与 Data Mappers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># ActiveRecord 风格写起来类似于 Django ORM, 大致是这样的</span><br><span class="line"></span><br><span class="line">## AR 的模型定义</span><br><span class="line"></span><br><span class="line">class User(db.models):</span><br><span class="line">    name &#x3D; db.StringField(verbose&#x3D;&quot;xyz&quot;)</span><br><span class="line"></span><br><span class="line">## AR 的新增</span><br><span class="line">user &#x3D; User()</span><br><span class="line">user.name &#x3D; &quot;123456&quot;</span><br><span class="line">user.save() ## 正好对应数据库中的一行</span><br><span class="line"></span><br><span class="line">## AR 的查询</span><br><span class="line"></span><br><span class="line">users &#x3D; User.objects.filter(Q(name&#x3D;&quot;黄老板的小姨子&quot;)).all()</span><br><span class="line"></span><br><span class="line"># Data Mappers 风格写起来类似于 SQLAlchemy ORM, 大致是这样的</span><br><span class="line"></span><br><span class="line">## SA 的定义</span><br><span class="line"></span><br><span class="line">from sqlalchemy.ext.declarative import declarative_base</span><br><span class="line"></span><br><span class="line">Base &#x3D; declarative_base()</span><br><span class="line"></span><br><span class="line">from sqlalchemy import Column, Integer, String</span><br><span class="line">class User(Base):</span><br><span class="line">    __tablename__ &#x3D; &#39;users&#39;</span><br><span class="line"></span><br><span class="line">    id &#x3D; Column(Integer, primary_key&#x3D;True)</span><br><span class="line">    name &#x3D; Column(String)</span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line">## SA 的新增</span><br><span class="line"></span><br><span class="line">user &#x3D; User()</span><br><span class="line">user.name &#x3D; &quot;123456&quot;</span><br><span class="line">session.add(user)</span><br><span class="line">sessoon.commit() ## 嗯？其实也是对应数据库中的一行。</span><br><span class="line"></span><br><span class="line">## SA 的查询</span><br><span class="line"></span><br><span class="line">session.query(User).filter(User.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题来了，这两者到底是什么，看起来似乎相差不大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Person:</span><br><span class="line"></span><br><span class="line">    lastname</span><br><span class="line">    firstname</span><br><span class="line">    children</span><br><span class="line"></span><br><span class="line">    # 数据操作</span><br><span class="line">    def findone(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def insert(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def update(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def delete(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    # 业务逻辑</span><br><span class="line">    def getChildrenTax(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lastName firstName numberOfDependents</p>
<p>insert update delete</p>
<p>getExemption isFlaggedForAudit getTaxableEarnings</p>
<p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p>
<p>The essence of an Active Record is a Domain Model (116) in which the classes match very closely the record structure of an underlying database. Each Active Record is responsible for saving and loading to the database and also for any domain logic that acts on the data. This may be all the domain logic in the application, or you may ﬁnd that some domain logic is held in Transaction Scripts (110) with common and data-oriented code in the Active Record.</p>
<p>The data structure of the Active Record should exactly match that of the database: one ﬁeld in the class for each column in the table. Type the ﬁelds the way the SQL interface gives you the data—don’t do any conversion at this stage. You may consider Foreign Key Mapping (236), but you may also leave the foreign keys as they are. You can use views or tables with Active Record, although updates through views are obviously harder. Views are particularly useful for reporting purposes.</p>
<p>objects correspond directly to the database tables: an isomorphic schema. If your business logic is complex, you’ll soon want to use your object’s direct relationships, collections, inheritance, and so forth. These don’t map easily onto Active Record, and adding them piecemeal gets very messy. That’s what will lead you to use Data Mapper (165) instead.</p>
<p>Another argument against Active Record is the fact that it couples the object design to the database design. This makes it more difﬁcult to refactor either design as a project goes forward.</p>
<p>Active Record is a good pattern to consider if you’re using Transaction Script (110) and are beginning to feel the pain of code duplication and the difﬁculty in updating scripts and tables that Transaction Script (110) often brings. In this case you can gradually start creating Active Records and then slowly refactor behavior into them. It often helps to wrap the tables as a Gateway (466) ﬁrst, and then start moving behavior so that the tables evolve to a Active Record.</p>
<p>其实为什么不选择设计成 ActiveRecord , 而是选择设计成 Data Mapper, 其实就可以回答这个问题：</p>
<blockquote>
<p>虽然要设计成 ORM, 考虑到数量和性能因素，SQL 数据库（多个表）并不应该是表现像 Object 集合那样（换言之，也就是 AR 表现的像 Object 的集合一样）。<br>同时，出于更好的抽象，object 集合也应该表现的像表以及行</p>
</blockquote>
<p>于是我们可以得出结论，可以在 SQLAlchemy 上面进行一定的封装，使得最后用起来非常的 Django ORM like，其实 SQLAlchemy 稍加定制还是可以很 Django ORM-like 的。</p>
<p>:TODO: 有机会看看那本书再修改一下本小节</p>
<p>这不，果然有人就这么搞了 <a target="_blank" rel="noopener" href="https://github.com/absent1706/sqlalchemy-mixins">https://github.com/absent1706/sqlalchemy-mixins</a></p>
<h2 id="0x09-踩坑集"><a href="#0x09-踩坑集" class="headerlink" title="0x09 踩坑集"></a>0x09 踩坑集</h2><h3 id="关系持久化坑"><a href="#关系持久化坑" class="headerlink" title="关系持久化坑"></a>关系持久化坑</h3><ol>
<li>Rows that point to themselves : 比如一个 insert 一个推荐自己的用户，则需要保存 id / ref_id , 但是在这个 user 插入之前，并不存在 id. 所以，一般情况下是先 insert, 然后保存 ref_id</li>
<li>Mutually Dependent Rows</li>
</ol>
<h3 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h3><p>session.query(MyClass).filter(“foo={}”.format(getArgs[‘val’]))</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/">https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create">https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create</a></p>
</li>
<li><p>除了文档本身，作者在 Stack Overflow 上的回答都是非常值得阅读的。<a target="_blank" rel="noopener" href="https://stackoverflow.com/users/34549/zzzeek">https://stackoverflow.com/users/34549/zzzeek</a></p>
</li>
<li><p>Patterns of Enterprise Application Architecture - Martin Fowler</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://aosabook.org/en/sqlalchemy.html">http://aosabook.org/en/sqlalchemy.html</a></p>
<p>  <a target="_blank" rel="noopener" href="http://techspot.zzzeek.org/">http://techspot.zzzeek.org/</a></p>
</li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/VueJS/" rel="tag"># VueJS</a>
              <a href="/tags/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/" rel="tag"># 全栈开发</a>
              <a href="/tags/RestAPI/" rel="tag"># RestAPI</a>
              <a href="/tags/Flask/" rel="tag"># Flask</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/02/10/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9/" rel="prev" title="秒杀系统的一些注意点">
      <i class="fa fa-chevron-left"></i> 秒杀系统的一些注意点
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/04/13/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E4%BD%BF%E7%94%A8Windows10/" rel="next" title="如何优雅的使用 Windows 10">
      如何优雅的使用 Windows 10 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">2.</span> <span class="nav-text">0x01 如何访问数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%90%86%E8%AE%BA"><span class="nav-number">3.</span> <span class="nav-text">0x02 数据库抽象的两种理论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%90%86%E8%AE%BA%E4%B8%80%EF%BC%9AActive-Record"><span class="nav-number">3.1.</span> <span class="nav-text">理论一：Active Record</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%90%86%E8%AE%BA%E4%BA%8C%EF%BC%9AData-Mapper"><span class="nav-number">3.2.</span> <span class="nav-text">理论二：Data Mapper</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%BD%E8%B1%A1%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">0x03 数据库抽象的两种实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%EF%BC%9ADjango-ORM"><span class="nav-number">4.1.</span> <span class="nav-text">实现一：Django ORM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8C%EF%BC%9ASqlalchemy"><span class="nav-number">4.2.</span> <span class="nav-text">实现二：Sqlalchemy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%BA%E5%BC%B1"><span class="nav-number">5.</span> <span class="nav-text">0x04 工具的强弱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0-SQLAlchemy-VS-DjangoORM"><span class="nav-number">5.1.</span> <span class="nav-text">2.0 SQLAlchemy VS DjangoORM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="nav-number">5.2.</span> <span class="nav-text">2.1 模型定义</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Models-%E4%B8%8E-Meta"><span class="nav-number">5.2.1.</span> <span class="nav-text">Models 与 Meta</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB"><span class="nav-number">5.2.2.</span> <span class="nav-text">关系</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#One-To-Many"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">One To Many</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Many-To-One"><span class="nav-number">5.2.2.2.</span> <span class="nav-text">Many To One</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#One-To-One"><span class="nav-number">5.2.2.3.</span> <span class="nav-text">One To One</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Many-To-Many"><span class="nav-number">5.2.2.4.</span> <span class="nav-text">Many To Many</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%82%BB%E6%8E%A5%E5%88%97%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="nav-number">5.2.2.5.</span> <span class="nav-text">邻接列表关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#relationship-%E8%AF%A6%E8%A7%A3"><span class="nav-number">5.2.2.6.</span> <span class="nav-text">relationship 详解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Query"><span class="nav-number">5.3.</span> <span class="nav-text">2.1 Query</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Create"><span class="nav-number">5.3.1.</span> <span class="nav-text">Create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Retrieve"><span class="nav-number">5.3.2.</span> <span class="nav-text">Retrieve</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%A8%E5%85%B3%E7%B3%BB%EF%BC%88%E8%B7%A8%E8%A1%A8%EF%BC%89%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.3.2.1.</span> <span class="nav-text">跨关系（跨表）查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Limit-Offset-%E5%88%86%E9%A1%B5"><span class="nav-number">5.3.2.2.</span> <span class="nav-text">Limit &#x2F; Offset &#x2F; 分页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-number">5.3.2.3.</span> <span class="nav-text">链式调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">5.3.2.4.</span> <span class="nav-text">二进制表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.3.2.5.</span> <span class="nav-text">执行查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AF%94%E8%BE%83"><span class="nav-number">5.3.2.6.</span> <span class="nav-text">比较</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6-%E5%AE%9E%E4%BE%8B"><span class="nav-number">5.3.2.7.</span> <span class="nav-text">复制 实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.3.2.8.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Update"><span class="nav-number">5.3.3.</span> <span class="nav-text">Update</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Delete"><span class="nav-number">5.3.4.</span> <span class="nav-text">Delete</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JOIN"><span class="nav-number">5.3.5.</span> <span class="nav-text">JOIN</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E8%A1%A8-InnerJoin"><span class="nav-number">5.3.5.1.</span> <span class="nav-text">两表 InnerJoin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E8%A1%A8-InnerJoin-LeftJoin"><span class="nav-number">5.3.5.2.</span> <span class="nav-text">多表 InnerJoin + LeftJoin</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E9%9B%86%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.3.6.</span> <span class="nav-text">聚集查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-number">5.3.7.</span> <span class="nav-text">缓存机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.4.</span> <span class="nav-text">2.2 原生查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%9B%B4%E6%96%B0%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.5.</span> <span class="nav-text">2.3 更新查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%88%A0%E9%99%A4"><span class="nav-number">5.6.</span> <span class="nav-text">2.4 删除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OnDelete"><span class="nav-number">5.6.1.</span> <span class="nav-text">OnDelete</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-number">5.6.2.</span> <span class="nav-text">批量操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BB%8E-Object-%E5%88%B0%E4%B8%80%E4%B8%AA-ORM"><span class="nav-number">5.7.</span> <span class="nav-text">如何从 Object 到一个 ORM</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-SQLAlchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-number">6.</span> <span class="nav-text">0x03 SQLAlchemy 的高级特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E7%BB%A7%E6%89%BF"><span class="nav-number">6.1.</span> <span class="nav-text">表继承</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%A5%E7%8E%A9%E6%84%8F"><span class="nav-number">6.2.</span> <span class="nav-text">啥玩意</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-SQLAlchemy-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7-Under-The-Hood"><span class="nav-number">7.</span> <span class="nav-text">0x04 SQLAlchemy 的基础特性 Under The Hood</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Loading-%E7%AD%96%E7%95%A5"><span class="nav-number">7.1.</span> <span class="nav-text">Loading 策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lazy-Loading"><span class="nav-number">7.1.1.</span> <span class="nav-text">Lazy Loading</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eager-Loading"><span class="nav-number">7.1.2.</span> <span class="nav-text">Eager Loading</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-SQLAlchemy-%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7-Under-The-Hood"><span class="nav-number">8.</span> <span class="nav-text">0x05 SQLAlchemy 的高级特性 Under The Hood</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="nav-number">8.1.</span> <span class="nav-text">多线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-DEBUG-%E5%92%8C-Profile-%E6%8A%80%E5%B7%A7"><span class="nav-number">9.</span> <span class="nav-text">0x06 DEBUG 和 Profile 技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%9F%A5%E7%9C%8B%E6%8A%80%E5%B7%A7"><span class="nav-number">9.1.</span> <span class="nav-text">6.1 查看技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-ORM-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-number">10.</span> <span class="nav-text">0x07 ORM 的本质</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ORM-%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B-Active-Record-%E4%B8%8E-Data-Mappers"><span class="nav-number">10.1.</span> <span class="nav-text">ORM 的两种类型 Active Record 与 Data Mappers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-%E8%B8%A9%E5%9D%91%E9%9B%86"><span class="nav-number">11.</span> <span class="nav-text">0x09 踩坑集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB%E6%8C%81%E4%B9%85%E5%8C%96%E5%9D%91"><span class="nav-number">11.1.</span> <span class="nav-text">关系持久化坑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL-%E6%B3%A8%E5%85%A5"><span class="nav-number">11.2.</span> <span class="nav-text">SQL 注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xEE-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">12.</span> <span class="nav-text">0xEE 参考链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Micheal Gardner</p>
  <div class="site-description" itemprop="description">Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">96</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Micheal Gardner</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




  















  

  

</body>
</html>
