<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"twocucao.xyz","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
<meta property="og:type" content="website">
<meta property="og:title" content="MG的编程小屋">
<meta property="og:url" content="http://twocucao.xyz/page/3/index.html">
<meta property="og:site_name" content="MG的编程小屋">
<meta property="og:description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
<meta property="og:locale">
<meta property="article:author" content="Micheal Gardner">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://twocucao.xyz/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>MG的编程小屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="MG的编程小屋" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MG的编程小屋</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Get Busy Living, Or Get Busy Dying</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/05/22/PipEnv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/22/PipEnv/" class="post-title-link" itemprop="url">PyCon 2018 之 pipenv -- 未来的 Python 依赖管理工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-22 21:11:03" itemprop="dateCreated datePublished" datetime="2018-05-22T21:11:03+08:00">2018-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-13 10:23:01" itemprop="dateModified" datetime="2018-11-13T10:23:01+08:00">2018-11-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>PyCon 2018 有很多精彩的演讲，今天的文章里，介绍一下 K 神的演讲 『Python 未来的包管理工具 pipenv』</p>
<p>Kenneth Reitz 出品，必属精品。</p>
<h3 id="Python-打包历史"><a href="#Python-打包历史" class="headerlink" title="Python 打包历史"></a>Python 打包历史</h3><p>刚开始的时候，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;pypi.python.org&#x2F;packages&#x2F;alsdasdl&#x2F;requests.tar.gz | tar zxf</span><br><span class="line">cd requests&#x2F;</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>这个问题初看起来不是问题，但是随着你安装程序的增多就知道有多么痛苦了。</p>
<ol>
<li>有的依赖库依赖别的库你怎么解决？比如 pandas 需要安装 numpy</li>
<li>有的依赖库依赖 c 库怎么办？比如 LXML</li>
<li>在 python2.6.5 下，如果我需要安装两个不同版本的 Django 开发不同的软件怎么办？难道只能动态复制文件到 site-packages 里面？</li>
</ol>
<p>后来，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">easy_install requests</span><br></pre></td></tr></table></figure>

<p>我们可以直接从 pypi 进行安装了。但尼玛，为什么 easy_install 安装很 easy, 但是没有 easy_uninstall?</p>
<p>好，2010 年后，我们继续前进：</p>
<ul>
<li>可以通过 pip 替代 easy_install 了。</li>
<li>可以通过 virtualenv 管理项目的依赖库了。虽然说，还是不能像 ruby gem 一样同时把多个版本的的软件装在同一个系统里。</li>
<li>可以通过 requirements 锁依赖了。</li>
</ul>
<p>但，同期的其他编程语言社区分别出现了如下的包管理工具：</p>
<ul>
<li>node -&gt; yarn &amp;&amp; npm , 有 lockfile</li>
<li>php -&gt; composer , 有 lockfile</li>
<li>rust -&gt; cargo , 有 lockfile</li>
<li>ruby -&gt; bundler , 有 lockfile</li>
</ul>
<p>而我大 Python 居然没跟上潮流</p>
<ul>
<li>python -&gt; pip &amp;&amp; virtualenv/venv , 无 lockfile</li>
</ul>
<blockquote>
<p>PS: Python3.3 之后，默认可以直接使用 venv 模块，不需要再安装 virtualenv 了。但还是需要手动，并且用起来比较反直觉。</p>
</blockquote>
<p>关于 requirements.txt</p>
<ul>
<li>如果你使用 pip freeze 来形成这个文件，则不直观，完全看不出来哪个依赖库依赖哪个依赖。</li>
<li>如果你直接手动指定你所需要的库，比如 flask 的话，似乎又有些太直观了。</li>
</ul>
<p>如果能有一个东西，既可以表示 freeze 的结果 (what you want)，又可以表示你需要的库 (what you need). 就好了。</p>
<blockquote>
<p>这当然可以考虑用两份 requirements 来解决。先安装 what you need 用来开发，然后 freeze 为 what you want 去部署。</p>
</blockquote>
<p>当然，铺垫了这么多 K 神肯定是来介绍他的 pipenv 的。</p>
<p>比如说，我想查看，本项目的依赖库，直接 pipenv graph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">coverage&#x3D;&#x3D;4.5.1</span><br><span class="line">fabric&#x3D;&#x3D;2.0.1</span><br><span class="line">  - cryptography [required: &gt;&#x3D;1.1, installed: 2.2.2]</span><br><span class="line">    - asn1crypto [required: &gt;&#x3D;0.21.0, installed: 0.24.0]</span><br><span class="line">    - cffi [required: &gt;&#x3D;1.7, installed: 1.11.5]</span><br><span class="line">      - pycparser [required: Any, installed: 2.18]</span><br><span class="line">    - idna [required: &gt;&#x3D;2.1, installed: 2.6]</span><br><span class="line">    - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">  - invoke [required: &lt;2.0,&gt;&#x3D;1.0, installed: 1.0.0]</span><br><span class="line">  - paramiko [required: &gt;&#x3D;2.4, installed: 2.4.1]</span><br><span class="line">    - bcrypt [required: &gt;&#x3D;3.1.3, installed: 3.1.4]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.1, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">    - cryptography [required: &gt;&#x3D;1.5, installed: 2.2.2]</span><br><span class="line">      - asn1crypto [required: &gt;&#x3D;0.21.0, installed: 0.24.0]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.7, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - idna [required: &gt;&#x3D;2.1, installed: 2.6]</span><br><span class="line">      - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">    - pyasn1 [required: &gt;&#x3D;0.1.7, installed: 0.4.2]</span><br><span class="line">    - pynacl [required: &gt;&#x3D;1.0.1, installed: 1.2.1]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.4.1, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - six [required: Any, installed: 1.11.0]</span><br><span class="line">flake8&#x3D;&#x3D;3.5.0</span><br><span class="line">  - mccabe [required: &gt;&#x3D;0.6.0,&lt;0.7.0, installed: 0.6.1]</span><br><span class="line">  - pycodestyle [required: &lt;2.4.0,&gt;&#x3D;2.0.0, installed: 2.3.1]</span><br><span class="line">  - pyflakes [required: &gt;&#x3D;1.5.0,&lt;1.7.0, installed: 1.6.0]</span><br><span class="line"># 其他省略</span><br></pre></td></tr></table></figure>

<p>如何尝鲜？我最近更新到了之前写的一个库（代码写的惨不忍赌，最近准备重构，勿喷）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:twocucao&#x2F;YaPyLib.git</span><br><span class="line">cd YaPyLib&#x2F;</span><br><span class="line">brew install pipenv</span><br><span class="line">pipenv --three</span><br><span class="line">pipenv install --dev</span><br><span class="line">pipenv shell</span><br></pre></td></tr></table></figure>

<p>记住几个命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pipenv --venv # 查看 venv 位置</span><br><span class="line">pipenv --python 3.6.5</span><br><span class="line">exit 退出 pipenv shell</span><br></pre></td></tr></table></figure>

<p>至于其他的功能，参考官网自己摸索吧。</p>
<h3 id="FAQ-环节"><a href="#FAQ-环节" class="headerlink" title="FAQ 环节"></a>FAQ 环节</h3><p>FAQ 环节有一个问题非常有趣，应该把 lockfile 放在 git 仓库里面吗？</p>
<p>k 神是这么回答的 yes。 这个问题很久之前就在 issue 上回答过了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pypa/pipenv/issues/598">https://github.com/pypa/pipenv/issues/598</a></p>
<p>我刚开始觉得不提交会好一些，后来觉得 track 一下也无妨。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><blockquote>
<p>在用 npm 和 yarn 的时候，我有这么一个想法，希望 python 圈子里面能出一个类似于包管理工具。今年 2 月份的时候把自己的项目迁移过来，发现 pipenv 用起来很挺舒服的。</p>
</blockquote>
<blockquote>
<p>pipenv 是未来。火速用上吧。</p>
</blockquote>
<blockquote>
<p>觉得有趣就点个赞或者关注下呗。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/05/16/PyConDjango/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/16/PyConDjango/" class="post-title-link" itemprop="url">PyCon 2018 之 Django 专题与 未来的包管理工具 pipenv</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-16 19:18:35" itemprop="dateCreated datePublished" datetime="2018-05-16T19:18:35+08:00">2018-05-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-05-22 21:10:03" itemprop="dateModified" datetime="2018-05-22T21:10:03+08:00">2018-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>PyCon 2018 有很多精彩的演讲，今天的文章里，挑出 Django 的几篇演讲大致讲讲。</p>
<blockquote>
<p>注意：为什么是大致讲讲呢？因为即便是你看了我的这篇文章，依然需要多下点功夫自己去看演讲，自己去查资料，自己去消化。我的这篇文章只不过是我看演讲查资料慢慢消化过程中的产物而已。</p>
</blockquote>
<h2 id="0x01-演讲-1-Taking-Django-Async"><a href="#0x01-演讲-1-Taking-Django-Async" class="headerlink" title="0x01 演讲 1 - Taking Django Async"></a>0x01 演讲 1 - Taking Django Async</h2><p>本演讲其实就是为了推广 Django 的新库。django-channels</p>
<p>这个库从 2015 年首发，现在已经经过了三年的进程。应该算是相对成熟了。</p>
<p>这个库有什么不走寻常路的地方吗？答案是有的：</p>
<ol>
<li>使得 Django 增加了异步协议，比如说 WebSocket 协议</li>
<li>使得 Django 可运行后台任务。</li>
</ol>
<p>作为 v2 版本的核心开发，作者必然是要吐槽一下 v1 版本，然后推荐一下 v2 版本。</p>
<p>v1 版本的架构设计是这样的。</p>
<p>核心开发给出了这样的评价：</p>
<ol>
<li>在 Python2.7 的时候，就只能这么搞了。</li>
<li>需要维护的东西太多</li>
<li>没有 asyncio support</li>
<li>搬砖时候一不小心容易砸到脚</li>
</ol>
<blockquote>
<p>TODO : 补充一些其他的缺点</p>
</blockquote>
<p>异步与同步接口耦合</p>
<p>作者认为此并非长久之计。</p>
<p>v2 时候，</p>
<p>重写 75% 的代码</p>
<p>异步与同步接口分离</p>
<p>这么设计的话，需要解决接下来的一个问题，同步转异步，异步转同步。</p>
<p>比如，我访问 view, 实际上是 async 转 sync, 然后才能调用 django 相关的方法，接着返回响应内容的时候，我还需要 sync 转 async.<br>再比如，我使用 websocket, 访问一条数据，但 ORM 是 sync 的方法，我还是要 async 转 sync 再转 async</p>
<p>这个 async 和 sync 的相互转换应该怎么做呢？</p>
<p>于是，两个适配方法就诞生了：</p>
<ul>
<li>sync_to_async : 接收一个 async 的 function, 使之 awaitable, 然后使之在后台线程里运行。</li>
<li>async_to_sync : 接收一个 awaitable 的 coroutine , 使之转化成一个同步的 function, 该 function 暂停你调用的当前的线程，跳转到包含 eventloop 的主线程执行完毕，然后跳转回来。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.aeracode.org/2018/02/19/python-async-simplified/">https://www.aeracode.org/2018/02/19/python-async-simplified/</a></p>
<h3 id="WSGI-如何运行-async"><a href="#WSGI-如何运行-async" class="headerlink" title="WSGI 如何运行 async"></a>WSGI 如何运行 async</h3><h3 id="ASGI-如何运行-A"><a href="#ASGI-如何运行-A" class="headerlink" title="ASGI 如何运行 A"></a>ASGI 如何运行 A</h3><h3 id="这对-Django-意味着什么？"><a href="#这对-Django-意味着什么？" class="headerlink" title="这对 Django 意味着什么？"></a>这对 Django 意味着什么？</h3><h3 id="如何保持兼容性"><a href="#如何保持兼容性" class="headerlink" title="如何保持兼容性"></a>如何保持兼容性</h3><h2 id="0x02-演讲-2-Beyond-Django-Basic"><a href="#0x02-演讲-2-Beyond-Django-Basic" class="headerlink" title="0x02 演讲 2 - Beyond Django Basic"></a>0x02 演讲 2 - Beyond Django Basic</h2><p>作为一名有一定经验的 Django 开发者，用快进的方式看完了这个演讲。毕竟，我已经不是 Django 新手了。</p>
<blockquote>
<p>毕竟这篇演讲只是给那些学完 tutorial 的人</p>
</blockquote>
<p>想深入了解 Django, 多刷几遍文档比什么都好。</p>
<p>嗯，就不介绍了。</p>
<h2 id="0x03-演讲-3-Introduction-to-TDD-with-Django-amp-amp-Intermediate-testing-with-Django"><a href="#0x03-演讲-3-Introduction-to-TDD-with-Django-amp-amp-Intermediate-testing-with-Django" class="headerlink" title="0x03 演讲 3 - Introduction to TDD with Django &amp;&amp; Intermediate testing with Django"></a>0x03 演讲 3 - Introduction to TDD with Django &amp;&amp; Intermediate testing with Django</h2><p>本演讲主要内容是 TDD 测试和 Mock 的技巧。</p>
<p>建议熟手直接看演讲者的书吧，本视频本人仅仅匆匆倍速看了一遍，估计并没有超出他的书的范围。</p>
<p>简单介绍了以下内容</p>
<ul>
<li>单元测试和功能性测试</li>
<li>通过 Selenium browser 进行自动化测试</li>
<li>unittest 标准库</li>
<li>Django models, views and templates</li>
<li>测试前后端代码</li>
<li>基于测试的重构</li>
<li>TDD workflow</li>
</ul>
<p>地址如下</p>
<p><a target="_blank" rel="noopener" href="https://www.obeythetestinggoat.com/book/praise.harry.html">https://www.obeythetestinggoat.com/book/praise.harry.html</a></p>
<p>说说个人对测试和 TDD 测试的基本态度，我觉得测试是好事，适当的测试是可以提升代码质量和程序稳定性的。</p>
<p>说测试会降低开发速度的，八成是没有善用测试。如果测试拖慢了你的开发速度，只能说明没有进行合适的测试，比如对一些无关紧要的功能进行测试。</p>
<p>但，这篇演讲和配套资料很好，不过有些美中不足。 这里基本上都还在用 Django 的 MTV 这一套。</p>
<blockquote>
<p>我反正是不用这一套了。这个年头流行 SPA 呀。</p>
</blockquote>
<p>所以，我们这篇演讲指的关注的内容就变成如下内容了。</p>
<ul>
<li>单元测试和功能性测试</li>
<li>unittest 标准库</li>
<li>Django models</li>
<li>基于测试的重构</li>
<li>TDD workflow</li>
</ul>
<p>而且，对于 API 的测试，现在基本上流行 POSTMAN</p>
<p>用 POSTMAN 的优点就在于可以把参数缓存下来下次接着用。有个小技巧就是从 chrome 拷贝一下 curl 到 postman 中。非常好用。</p>
<p>既然流行 SPA, 那么本次有没有介绍开 API 的利器呢？</p>
<h2 id="0x04-演讲-4-API-Driven-Django"><a href="#0x04-演讲-4-API-Driven-Django" class="headerlink" title="0x04 演讲 4 - API-Driven Django"></a>0x04 演讲 4 - API-Driven Django</h2><p>嗯，Django + django-rest-framework 实在是开 WebAPI 的神器。</p>
<p>这篇演讲，算是普及了一下常识。并没有想象当中的深入。</p>
<p>想用 Django 和 DjangoRestFramework 搞事情的，可以过来看我这篇文章。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33903527">https://zhuanlan.zhihu.com/p/33903527</a></p>
<blockquote>
<p>需要注意的是，本次 PyCon 中有很多人已经用上了 pipenv 了。</p>
</blockquote>
<h2 id="0x05-演讲-5-pipenv-未来的-Python-包管理工具"><a href="#0x05-演讲-5-pipenv-未来的-Python-包管理工具" class="headerlink" title="0x05 演讲 5 - pipenv 未来的 Python 包管理工具"></a>0x05 演讲 5 - pipenv 未来的 Python 包管理工具</h2><p>Kenneth Reitz 出品，必属精品。</p>
<h3 id="Python-打包历史"><a href="#Python-打包历史" class="headerlink" title="Python 打包历史"></a>Python 打包历史</h3><p>刚开始，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;pypi.python.org&#x2F;packages&#x2F;alsdasdl&#x2F;requests.tar.gz | tar zxf</span><br><span class="line">cd requests&#x2F;</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>这个问题初看起来不是问题，但是随着你安装程序的增多就知道有多么痛苦了。</p>
<ol>
<li>有的依赖库依赖别的库你怎么解决？比如 pandas 需要安装 numpy</li>
<li>有的依赖库依赖 c 库怎么办？比如 LXML</li>
<li>在 python2.6.5 下，如果我需要安装两个不同版本的 Django 开发不同的软件怎么办？难道只能动态复制文件到 site-packages 里面？</li>
</ol>
<p>后来，我们是这样安装包的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">easy_install requests</span><br></pre></td></tr></table></figure>

<p>我们可以直接从 pypi 进行安装了。但尼玛，为什么 easy_install 安装很 easy, 但是没有 easy_uninstall?</p>
<p>好，2010 年后，我们继续前进：</p>
<ul>
<li>可以通过 pip 替代 easy_install 了。</li>
<li>可以通过 virtualenv 管理项目的依赖库了。虽然说，还是不能像 ruby gem 一样同时把多个版本的的软件装在同一个系统里。</li>
<li>可以通过 requirements 锁依赖了。</li>
</ul>
<p>但，其他编程语言社区分别出现了如下的包管理工具：</p>
<ul>
<li>node -&gt; yarn &amp;&amp; npm , 有 lockfile</li>
<li>php -&gt; composer , 有 lockfile</li>
<li>rust -&gt; cargo , 有 lockfile</li>
<li>ruby -&gt; bundler , 有 lockfile</li>
</ul>
<p>而生命苦短一方居然</p>
<ul>
<li>python -&gt; pip &amp;&amp; virtualenv/venv , 无 lockfile</li>
</ul>
<blockquote>
<p>PS: Python3.3 之后，默认可以直接使用 venv 模块，不需要再安装 virtualenv 了。但还是需要手动，并且用起来比较反直觉。</p>
</blockquote>
<p>关于 requirements.txt</p>
<ul>
<li>如果你使用 pip freeze 来形成这个文件，则不直观，完全看不出来哪个依赖库依赖哪个依赖。</li>
<li>如果你直接手动指定你所需要的库，比如 flask 的话，似乎又有些太直观了。</li>
</ul>
<p>如果能有一个东西，既可以表示 freeze 的结果 (what you want)，又可以表示你需要的库 (what you need). 就好了。</p>
<blockquote>
<p>这当然可以考虑用两份 requirements 来解决。先安装 what you need 用来开发，然后 freeze 为 what you want 去部署。</p>
</blockquote>
<p>当然，铺垫了这么多 K 神肯定是来介绍他的 pipenv 的。</p>
<p>比如说，我想查看，本项目的依赖库，直接 pipenv graph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">coverage&#x3D;&#x3D;4.5.1</span><br><span class="line">fabric&#x3D;&#x3D;2.0.1</span><br><span class="line">  - cryptography [required: &gt;&#x3D;1.1, installed: 2.2.2]</span><br><span class="line">    - asn1crypto [required: &gt;&#x3D;0.21.0, installed: 0.24.0]</span><br><span class="line">    - cffi [required: &gt;&#x3D;1.7, installed: 1.11.5]</span><br><span class="line">      - pycparser [required: Any, installed: 2.18]</span><br><span class="line">    - idna [required: &gt;&#x3D;2.1, installed: 2.6]</span><br><span class="line">    - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">  - invoke [required: &lt;2.0,&gt;&#x3D;1.0, installed: 1.0.0]</span><br><span class="line">  - paramiko [required: &gt;&#x3D;2.4, installed: 2.4.1]</span><br><span class="line">    - bcrypt [required: &gt;&#x3D;3.1.3, installed: 3.1.4]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.1, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">    - cryptography [required: &gt;&#x3D;1.5, installed: 2.2.2]</span><br><span class="line">      - asn1crypto [required: &gt;&#x3D;0.21.0, installed: 0.24.0]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.7, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - idna [required: &gt;&#x3D;2.1, installed: 2.6]</span><br><span class="line">      - six [required: &gt;&#x3D;1.4.1, installed: 1.11.0]</span><br><span class="line">    - pyasn1 [required: &gt;&#x3D;0.1.7, installed: 0.4.2]</span><br><span class="line">    - pynacl [required: &gt;&#x3D;1.0.1, installed: 1.2.1]</span><br><span class="line">      - cffi [required: &gt;&#x3D;1.4.1, installed: 1.11.5]</span><br><span class="line">        - pycparser [required: Any, installed: 2.18]</span><br><span class="line">      - six [required: Any, installed: 1.11.0]</span><br><span class="line">flake8&#x3D;&#x3D;3.5.0</span><br><span class="line">  - mccabe [required: &gt;&#x3D;0.6.0,&lt;0.7.0, installed: 0.6.1]</span><br><span class="line">  - pycodestyle [required: &lt;2.4.0,&gt;&#x3D;2.0.0, installed: 2.3.1]</span><br><span class="line">  - pyflakes [required: &gt;&#x3D;1.5.0,&lt;1.7.0, installed: 1.6.0]</span><br><span class="line"># 其他省略</span><br></pre></td></tr></table></figure>

<p>如何尝鲜？我最近更新到了之前写的一个库（代码写的惨不忍赌，最近准备重构）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:twocucao&#x2F;YaPyLib.git</span><br><span class="line">cd YaPyLib&#x2F;</span><br><span class="line">brew install pipenv</span><br><span class="line">pipenv --three</span><br><span class="line">pipenv install --dev</span><br><span class="line">pipenv shell</span><br></pre></td></tr></table></figure>

<p>至于其他的功能，参考官网自己摸索吧。</p>
<blockquote>
<p>在用 npm 和 yarn 的时候，我有这么一个想法，希望 python 圈子里面能出一个类似于包管理工具。今年 2 月份的时候把自己的项目迁移过来，发现 pipenv 用起来很挺舒服的。</p>
</blockquote>
<blockquote>
<p>pipenv 是未来。火速用上吧。</p>
</blockquote>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/04/28/DjangoORMCheatSheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/28/DjangoORMCheatSheet/" class="post-title-link" itemprop="url">DjangoORMCheatSheet</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-28 18:29:58" itemprop="dateCreated datePublished" datetime="2018-04-28T18:29:58+08:00">2018-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-05-02 10:13:03" itemprop="dateModified" datetime="2019-05-02T10:13:03+08:00">2019-05-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是《Python ORM 三部曲的第二部 - Django ORM 的用法 / 原理 / 优化》</p>
<p>上一部的地址为《Python ORM 三部曲的第一部 - Python ORM 的三种实现模式》</p>
<p>本文基于最新 Django 版本</p>
<ol>
<li>模型定义</li>
<li>Create/Update/Delete</li>
<li>各种查询 / 链式调用 / F 表达式 / Window 函数 /Lazy Loading / Eager Loading</li>
<li>Join</li>
<li>DEBUG 和 Profile 技巧</li>
</ol>
<p>本文是《Python ORM 三部曲的第一部 - Python 的三种数据源架构模式》</p>
<p>本文适用于：</p>
<ol>
<li>好奇 or 喜欢折腾的程序员</li>
<li>想深入了解 ORM 的程序员</li>
</ol>
<p>本文将解决你以下的疑惑：</p>
<ol>
<li>能不能不用 ORM?</li>
<li>ORM 为什么在某些场景下会胜于写 SQL</li>
<li>不同的 ORM 实现机制会带来什么差异？</li>
</ol>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>新工作的技术栈是以 Flask 为主，SQLAlchemy 是 许多玩 Flask 的人的标配。好，文档读起来，笔记搞起来。</p>
<blockquote>
<p>所以，本文记录的是 Django ORM</p>
</blockquote>
<p>逃。</p>
<p>这篇文章也是我对比 SqlAlchemy 以及 DjangoORM 的产物</p>
<h2 id="0x01-如何快速上手"><a href="#0x01-如何快速上手" class="headerlink" title="0x01 如何快速上手"></a>0x01 如何快速上手</h2><p>Django 世界里面，Django 的文档每次刷都会有新的发现。</p>
<h2 id="0x02-DjangoORM-的基本功能"><a href="#0x02-DjangoORM-的基本功能" class="headerlink" title="0x02 DjangoORM 的基本功能"></a>0x02 DjangoORM 的基本功能</h2><h3 id="2-1-模型定义-Model"><a href="#2-1-模型定义-Model" class="headerlink" title="2.1 模型定义 Model"></a>2.1 模型定义 Model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line">class Musician(models.Model):</span><br><span class="line">    first_name &#x3D; models.CharField(max_length&#x3D;50) # Field</span><br><span class="line">    last_name &#x3D; models.CharField(max_length&#x3D;50)</span><br><span class="line">    instrument &#x3D; models.CharField(max_length&#x3D;100)</span><br><span class="line"></span><br><span class="line">class Album(models.Model):</span><br><span class="line">    artist &#x3D; models.ForeignKey(Musician, on_delete&#x3D;models.CASCADE)</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;100)</span><br><span class="line">    release_date &#x3D; models.DateField()</span><br><span class="line">    num_stars &#x3D; models.IntegerField()</span><br><span class="line"></span><br><span class="line">    class Meta: # Model Meta</span><br><span class="line">        order_with_respect_to &#x3D; &#39;question&#39;</span><br></pre></td></tr></table></figure>

<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="Models-与-Meta"><a href="#Models-与-Meta" class="headerlink" title="Models 与 Meta"></a>Models 与 Meta</h4><blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，Model 与 session 耦合。</p>
</blockquote>
<h4 id="Field-与-Field-Options"><a href="#Field-与-Field-Options" class="headerlink" title="Field 与 Field Options"></a>Field 与 Field Options</h4><h5 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h5><ul>
<li>AutoField</li>
<li>BigAutoField</li>
<li>BigIntegerField</li>
<li>BinaryField</li>
<li>BooleanField</li>
<li>CharField</li>
<li>DateField</li>
<li>DateTimeField</li>
<li>DecimalField</li>
<li>DurationField</li>
<li>EmailField</li>
<li>FileField</li>
<li>FileField and FieldFile</li>
<li>FilePathField</li>
<li>FloatField</li>
<li>ImageField</li>
<li>IntegerField</li>
<li>GenericIPAddressField</li>
<li>NullBooleanField</li>
<li>PositiveIntegerField</li>
<li>PositiveSmallIntegerField</li>
<li>SlugField</li>
<li>SmallIntegerField</li>
<li>TextField</li>
<li>TimeField</li>
<li>URLField</li>
<li>UUIDField</li>
</ul>
<p>虽然有这么多东东，其实常用的如下</p>
<ul>
<li>BigIntegerField</li>
<li>BooleanField</li>
<li>CharField</li>
<li>DateField</li>
<li>DateTimeField</li>
<li>DecimalField</li>
<li>IntegerField</li>
<li>TextField</li>
<li>TimeField</li>
</ul>
<p>有的字段属于那种，有也可以，没有也可以的。</p>
<p>FileField 之类的 往往现在都被 CDN 取代</p>
<h5 id="Field-Options"><a href="#Field-Options" class="headerlink" title="Field Options"></a>Field Options</h5><ul>
<li>null</li>
<li>blank</li>
<li>choices<ul>
<li>p.shirt_size</li>
<li>p.get_shirt_size_display()</li>
</ul>
</li>
<li>db_column</li>
<li>db_index</li>
<li>db_tablespace</li>
<li>default</li>
<li>editable</li>
<li>error_messages</li>
<li>help_text</li>
<li>primary_key</li>
<li>unique</li>
<li>unique_for_date</li>
<li>unique_for_month</li>
<li>unique_for_year</li>
<li>verbose_name</li>
<li>validators</li>
</ul>
<p>如此可见，Django 的 ORM 比起 SQLAlchemy 做了不少应用层的校验，一些 help_text</p>
<h4 id="Relationship"><a href="#Relationship" class="headerlink" title="Relationship"></a>Relationship</h4><p>表和表之间的关系</p>
<ol>
<li>A 表和 B 表 一对多 / 多对一</li>
<li>A 表和 B 表 一对一 （特殊的一对多）</li>
<li>A 表和 B 表 简单多对多 （借助中间的 Mapping 表进行映射）</li>
<li>A 表和 B 表 复杂多对多</li>
<li>A 表和 B 表 一对多</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line">class Manufacturer(models.Model):</span><br><span class="line">    # ...</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">class Car(models.Model):</span><br><span class="line">    manufacturer &#x3D; models.ForeignKey(Manufacturer, on_delete&#x3D;models.CASCADE)</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line">class Topping(models.Model):</span><br><span class="line">    # ...</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">class Pizza(models.Model):</span><br><span class="line">    # ...</span><br><span class="line">    toppings &#x3D; models.ManyToManyField(Topping)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line">class Person(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;128)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.name</span><br><span class="line"></span><br><span class="line">class Group(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;128)</span><br><span class="line">    members &#x3D; models.ManyToManyField(Person, through&#x3D;&#39;Membership&#39;)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.name</span><br><span class="line"></span><br><span class="line">class Membership(models.Model):</span><br><span class="line">    person &#x3D; models.ForeignKey(Person, on_delete&#x3D;models.CASCADE)</span><br><span class="line">    group &#x3D; models.ForeignKey(Group, on_delete&#x3D;models.CASCADE)</span><br><span class="line">    date_joined &#x3D; models.DateField()</span><br><span class="line">    invite_reason &#x3D; models.CharField(max_length&#x3D;64)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Models across files</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objects</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Models 重写方法</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Models 继承</span><br><span class="line">https:&#x2F;&#x2F;docs.djangoproject.com&#x2F;en&#x2F;2.0&#x2F;topics&#x2F;db&#x2F;models&#x2F;#model-inheritance</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">组织代码 - 以及应对循环引用</span><br></pre></td></tr></table></figure>

<h3 id="2-2-QuerySet"><a href="#2-2-QuerySet" class="headerlink" title="2.2 QuerySet"></a>2.2 QuerySet</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c &#x3D; Child(name&#x3D;&quot;苏轼&quot;)</span><br><span class="line">c.save()</span><br><span class="line">p &#x3D; Parent(name&#x3D;&quot;苏辙&quot;)</span><br><span class="line">p.best_child &#x3D; c</span><br><span class="line">p.children.add([c,c2,c3,c4])</span><br><span class="line">p.save()</span><br></pre></td></tr></table></figure>

<h4 id="Retrieve"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve</h4><p>过滤</p>
<p>filter(**kwargs)<br>exclude(**kwargs)<br>.all()</p>
<h5 id="跨关系（跨表）查询"><a href="#跨关系（跨表）查询" class="headerlink" title="跨关系（跨表）查询"></a>跨关系（跨表）查询</h5><p>Blog.objects.filter(entry__headline__contains=’Lennon’)</p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships">https://docs.djangoproject.com/en/2.0/topics/db/queries/#lookups-that-span-relationships</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships">https://docs.djangoproject.com/en/2.0/topics/db/queries/#spanning-multi-valued-relationships</a></p>
<h5 id="prefetch-related-amp-amp-select-related"><a href="#prefetch-related-amp-amp-select-related" class="headerlink" title="prefetch_related &amp;&amp; select_related"></a>prefetch_related &amp;&amp; select_related</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select_related</span><br><span class="line"></span><br><span class="line">生成 join 的 SQL, 可以用来减少 N+1 , 不过仅仅支持一对多，和一对一</span><br><span class="line"></span><br><span class="line">prefetch_related</span><br></pre></td></tr></table></figure>

<h5 id="Limit-Offset-分页"><a href="#Limit-Offset-分页" class="headerlink" title="Limit / Offset / 分页"></a>Limit / Offset / 分页</h5><p>Blog.objects.filter(entry__headline__contains=’Lennon’)[30:20]</p>
<h5 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h5><p>query = query.filter(**kwargs)<br>query = query.exclude(**kwargs)</p>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>Django 里面最强大的就是其 Q 表达式了</p>
<p>Q(question__startswith=’Who’) | Q(question__startswith=’What’)</p>
<p>Poll.objects.get(<br>    Q(question__startswith=’Who’),<br>    Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))<br>)</p>
<p>这个表达式甚至可以嵌套超级深从而完成一个比较深的跨表查询。</p>
<blockquote>
<p>并且，这种 API 查询反而在写前端 API 的时候，可以传入 question__startswith 这类参数，从而直接完成一组搜索。</p>
</blockquote>
<p>Q / F</p>
<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><p>需要注意的的是，SQLAlchemy 必须显式执行查询，而 Django 不一定。</p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated">https://docs.djangoproject.com/en/2.0/ref/models/querysets/#when-querysets-are-evaluated</a></p>
<p>在 Django 内部实现的时候，一个 queryset 创建 / 过滤 / 切片 / 传送，<strong>除非这个 queryset 被 evaluated 了</strong>, 否则不会做数据库的操作。</p>
<ul>
<li>iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>repr</li>
<li>len</li>
<li>list</li>
<li>bool</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">all()</span><br><span class="line">first()</span><br><span class="line">last()</span><br><span class="line">exist()</span><br></pre></td></tr></table></figure>

<h5 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h5><ul>
<li>pk</li>
<li>model</li>
</ul>
<h5 id="复制-实例"><a href="#复制-实例" class="headerlink" title="复制 实例"></a>复制 实例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">blog &#x3D; Blog(name&#x3D;&#39;My blog&#39;, tagline&#x3D;&#39;Blogging is easy&#39;)</span><br><span class="line">blog.save() # blog.pk &#x3D;&#x3D; 1</span><br><span class="line"></span><br><span class="line">blog.pk &#x3D; None</span><br><span class="line">blog.save() # blog.pk &#x3D;&#x3D; 2</span><br><span class="line"></span><br><span class="line"># 但这个并不拷贝外键？???</span><br><span class="line">https:&#x2F;&#x2F;docs.djangoproject.com&#x2F;en&#x2F;2.0&#x2F;topics&#x2F;db&#x2F;queries&#x2F;#copying-model-instances</span><br></pre></td></tr></table></figure>

<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 默认查询的是所有字段，但我希望查询部分字段</span><br><span class="line"># TODO: 阿萨德</span><br><span class="line"># Distinct</span><br><span class="line"># OrderBy</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h5><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets">https://docs.djangoproject.com/en/2.0/topics/db/queries/#caching-and-querysets</a></p>
<h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><p>单个 object 更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blog.title &#x3D; &quot;大宝天天见&quot;</span><br><span class="line">blog.save()</span><br></pre></td></tr></table></figure>

<p>批量更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.update(headline&#x3D;F(&#39;blog__name&#39;))</span><br></pre></td></tr></table></figure>

<p>一对多的更新（类似于 Set 操作）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(obj1, obj2, ...)</span><br><span class="line">create(**kwargs)</span><br><span class="line">remove(obj1, obj2, ...)</span><br><span class="line">clear()</span><br><span class="line">set(objs)</span><br></pre></td></tr></table></figure>

<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><h5 id="ForeignKey"><a href="#ForeignKey" class="headerlink" title="ForeignKey"></a>ForeignKey</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Car(models.Model):</span><br><span class="line">    manufacturer &#x3D; models.ForeignKey(</span><br><span class="line">        &#39;production.Manufacturer&#39;, # 用来解决循环 circular import</span><br><span class="line">        on_delete&#x3D;models.CASCADE,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>on_delete 的情况</p>
<ul>
<li>PROTECT 阻止</li>
<li>CASCADE 应用层的级联删除</li>
<li>SET_NULL 应用层的级联 SET_NULL</li>
<li>SET_DEFAULT</li>
<li>DO_NOTHING</li>
<li>SET() 一个 callback</li>
</ul>
<h4 id="聚集查询"><a href="#聚集查询" class="headerlink" title="聚集查询"></a>聚集查询</h4><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/aggregation/">https://docs.djangoproject.com/en/2.0/topics/db/aggregation/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Book.objects.all().aggregate(Max(&#39;price&#39;))</span><br><span class="line">Book.objects.aggregate(price_diff&#x3D;Max(&#39;price&#39;, output_field&#x3D;FloatField()) - Avg(&#39;price&#39;))</span><br><span class="line">Book.objects.annotate(num_authors&#x3D;Count(&#39;authors&#39;))</span><br><span class="line">Book.objects.annotate(num_authors&#x3D;Count(&#39;authors&#39;)).aggregate(Avg(&#39;num_authors&#39;)) # &#123;&#39;num_authors__avg&#39;: 1.66&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h4><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/search/">https://docs.djangoproject.com/en/2.0/topics/db/search/</a></p>
<h4 id="Window-Function"><a href="#Window-Function" class="headerlink" title="Window Function"></a>Window Function</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Option.objects.annotate(</span><br><span class="line">		rank_num&#x3D;Window(</span><br><span class="line">				expression&#x3D;Rank(),</span><br><span class="line">				partition_by&#x3D;F(&quot;vote_id&quot;),</span><br><span class="line">				order_by&#x3D;[F(&quot;current_vote_count&quot;).desc(), F(&quot;id&quot;).desc()],</span><br><span class="line">		),</span><br><span class="line">		lag_vote_num&#x3D;Window(</span><br><span class="line">				expression&#x3D;Lag(&quot;current_vote_count&quot;),</span><br><span class="line">				partition_by&#x3D;F(&quot;vote_id&quot;),</span><br><span class="line">				order_by&#x3D;[F(&quot;current_vote_count&quot;).desc(), F(&quot;id&quot;).desc()],</span><br><span class="line">		),</span><br><span class="line">)</span><br><span class="line">.filter(vote&#x3D;obj.vote)</span><br><span class="line">.order_by(&quot;-current_vote_count&quot;, &quot;id&quot;)</span><br><span class="line">.values(&quot;id&quot;, &quot;rank_num&quot;, &quot;current_vote_count&quot;, &quot;lag_vote_num&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Model-Instances"><a href="#2-2-Model-Instances" class="headerlink" title="2.2 Model Instances"></a>2.2 Model Instances</h3><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/ref/models/instances/">https://docs.djangoproject.com/en/2.0/ref/models/instances/</a></p>
<h3 id="2-3-模型实例"><a href="#2-3-模型实例" class="headerlink" title="2.3 模型实例"></a>2.3 模型实例</h3><h3 id="2-4-迁移机制"><a href="#2-4-迁移机制" class="headerlink" title="2.4 迁移机制"></a>2.4 迁移机制</h3><ol>
<li>加 INSTALLED_APPS</li>
</ol>
<h2 id="0x03-Django-ORM-的高级功能"><a href="#0x03-Django-ORM-的高级功能" class="headerlink" title="0x03 Django ORM 的高级功能"></a>0x03 Django ORM 的高级功能</h2><h3 id="maneger"><a href="#maneger" class="headerlink" title="maneger"></a>maneger</h3><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/managers/">https://docs.djangoproject.com/en/2.0/topics/db/managers/</a></p>
<h3 id="raw-sql"><a href="#raw-sql" class="headerlink" title="raw sql"></a>raw sql</h3><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/db/sql/">https://docs.djangoproject.com/en/2.0/topics/db/sql/</a></p>
<h4 id="database-fuction"><a href="#database-fuction" class="headerlink" title="database-fuction"></a>database-fuction</h4><p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/ref/models/database-functions/">https://docs.djangoproject.com/en/2.0/ref/models/database-functions/</a></p>
<h2 id="0x04-Database-Access-Optimization"><a href="#0x04-Database-Access-Optimization" class="headerlink" title="0x04 Database Access Optimization"></a>0x04 Database Access Optimization</h2><h3 id="4-1-使用连接池"><a href="#4-1-使用连接池" class="headerlink" title="4.1 使用连接池"></a>4.1 使用连接池</h3><p>连接池是一种永远在线模型的实现</p>
<p>连接池：驱动程序类型</p>
<p>连接池：代理类型</p>
<h3 id="4-2-减少对-MySQL-的访问"><a href="#4-2-减少对-MySQL-的访问" class="headerlink" title="4.2 减少对 MySQL 的访问"></a>4.2 减少对 MySQL 的访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() and usename &#x3D; current_user;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() and usename &#x3D; current_user;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Profile-First"><a href="#Profile-First" class="headerlink" title="Profile First"></a>Profile First</h3><ol>
<li>django-extentions</li>
<li>django-debug-toolbar</li>
</ol>
<p>手动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">queryset.explain</span><br><span class="line"></span><br><span class="line">from django.db import connection</span><br><span class="line">connection.queries</span><br><span class="line"></span><br><span class="line">from django.db import reset_queries</span><br><span class="line">reset_queries()</span><br></pre></td></tr></table></figure>

<h2 id="0x05-Django-ORM-Under-The-Hood"><a href="#0x05-Django-ORM-Under-The-Hood" class="headerlink" title="0x05 Django ORM Under The Hood"></a>0x05 Django ORM Under The Hood</h2><h3 id="理解-QuerySet"><a href="#理解-QuerySet" class="headerlink" title="理解 QuerySet"></a>理解 QuerySet</h3><ul>
<li>querysets-are-lazy when-querysets-are-evaluated<ul>
<li>Iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>len</li>
<li>repr</li>
<li>list</li>
<li>bool</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj &#x3D;&#x3D; nobj # obj.id &#x3D;&#x3D; nobj.id</span><br></pre></td></tr></table></figure>

<ul>
<li>caching-and-querysets</li>
</ul>
<h3 id="理解-cached-attributes"><a href="#理解-cached-attributes" class="headerlink" title="理解 cached attributes"></a>理解 cached attributes</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; entry &#x3D; Entry.objects.get(id&#x3D;1)</span><br><span class="line">&gt;&gt;&gt; entry.blog   # Blog object is retrieved at this point</span><br><span class="line">&gt;&gt;&gt; entry.blog   # cached version, no DB access</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; entry &#x3D; Entry.objects.get(id&#x3D;1)</span><br><span class="line">&gt;&gt;&gt; entry.authors.all()   # query performed</span><br><span class="line">&gt;&gt;&gt; entry.authors.all()   # query performed again</span><br></pre></td></tr></table></figure>

<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/31/SQLAlchemyCheatSheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/31/SQLAlchemyCheatSheet/" class="post-title-link" itemprop="url">SQLAlchemyCheatSheet</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-31 17:16:35" itemprop="dateCreated datePublished" datetime="2018-03-31T17:16:35+08:00">2018-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-05-01 10:34:04" itemprop="dateModified" datetime="2019-05-01T10:34:04+08:00">2019-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SQLAlchemy 入门，看本文就好了</p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>大约一年前，工作从 Django 开发切到 Flask 开发，ORM 选用的是 SQLAlchemy, 用了大半年后，借着这个机会重新回顾一下 SQLAchemy 和 Django ORM, 补充一下文档。</p>
<p>这篇文章算是笔记吧</p>
<p>Python 圈内有两大 ORM 框架</p>
<ul>
<li>SQLAlchemy</li>
<li>Django ORM</li>
</ul>
<p>当然，也有 peewee 之类的其他 ORM。</p>
<h2 id="0x01-ORM-解决了什么问题？"><a href="#0x01-ORM-解决了什么问题？" class="headerlink" title="0x01 ORM 解决了什么问题？"></a>0x01 ORM 解决了什么问题？</h2><p>了解一个框架，最好是从下面几处入手：</p>
<ul>
<li>官方 Tuorial</li>
<li>官方 Example</li>
<li>官方 Guide</li>
<li>官方 APIDocument</li>
<li>源码</li>
</ul>
<p>对框架掌握越深，就越需要使用者多多从上开始逐渐向下了解。</p>
<p>其实还有一些途径：</p>
<ul>
<li>Github 上面的 issue</li>
<li>Stack Overflow 的高 vote 常见问题</li>
<li><strong>如果作者有一些活跃的社区的话，可以火速前往</strong></li>
</ul>
<p>鉴于我们的目标在于入手，所以可以火速过一下：</p>
<ul>
<li>官方 Tuorial</li>
<li>官方 Example</li>
<li>官方 Guide</li>
<li>Github 上面的 issue</li>
<li>Stack Overflow 的高 vote 常见问题</li>
<li><strong>如果作者有一些活跃的社区的话，可以火速前往</strong></li>
</ul>
<h2 id="0x02-SQLAlchemy-的基本功能"><a href="#0x02-SQLAlchemy-的基本功能" class="headerlink" title="0x02 SQLAlchemy 的基本功能"></a>0x02 SQLAlchemy 的基本功能</h2><h3 id="2-0-SQLAlchemy-VS-DjangoORM"><a href="#2-0-SQLAlchemy-VS-DjangoORM" class="headerlink" title="2.0 SQLAlchemy VS DjangoORM"></a>2.0 SQLAlchemy VS DjangoORM</h3><p>ORM 通常有 DataMapper 实现和 ActiveRecord 实现两种。</p>
<p>依照我的经验，ActiveRecord 使用起来的更接近对象 (Object) 的操作，DataMapper 使用起来更接近 (Table) 的操作。</p>
<blockquote>
<p>SQLAlchemy 是 DataMapper 模式的实现，在该模式下，session 会暴露出来，即 Model 与 session 并不耦合。</p>
</blockquote>
<blockquote>
<p>DjangoORM 是 ActivityRecord 模式的一种实现，在该模式下，session 并不暴露出来，即 Model 与 session 耦合。</p>
</blockquote>
<p>使用 Django ORM 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b &#x3D; Blog(**data)</span><br><span class="line">b.save()</span><br></pre></td></tr></table></figure>

<p>使用 SQLAlchemy 的时候，往往是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b &#x3D; Blog(**data)</span><br><span class="line">session.add(b)</span><br><span class="line">session.session(b)</span><br></pre></td></tr></table></figure>

<p>由于 Django 帮你屏蔽了 session 的操作。</p>
<p>在通常情况下，</p>
<ol>
<li>DjangoORM 使用起来更加接近 Object 的操作。</li>
<li>SQLAlchemy 使用起来更加接近 Table 的操作。</li>
</ol>
<p>举个例子，</p>
<p>一对多，Father 添加两个小孩（其中一个小孩是已经存在的）</p>
<p>在 DjangoORM 里面， 这里更像是一个 Set 的 add 操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">father.children.add(new_child,exsit_child)</span><br></pre></td></tr></table></figure>

<p>在 SQLAlchemy 里面，这里更像是一个 table 的 insert 操作。（麻蛋，你要说是一个 list 的 append 操作也行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for child in (new_child,exsit_child):</span><br><span class="line">    if child in father.children:</span><br><span class="line">        father.children.append(child)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写 SQLAlchemy 更接近操作放在数据库里面的数据记录，而 DjangoORM 更接近操作一批放在数据库里面的对象。</p>
</blockquote>
<p>由于 session 的使用姿势不同，所以往往会有很多使用上面的区别。</p>
<p>至于孰优孰劣，难以评判。</p>
<ul>
<li><p>技术老大 (Flask 和 React 大神）倾向于使用 SQLAlchemy, 他认为</p>
<ul>
<li>对于一个技术『知其然，知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据库，操作最好要落实在成 SQL</li>
<li>如果有可能的话，每一个 SQL 语句都要经过推敲，而且写这个 SQL 和 ORM 过程要反复练习</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>Alembic 这个迁移工具是为了省事用的，甚至在某些情况下没必要用。完全可以写 SQL 代替</li>
</ul>
</li>
</ul>
</li>
<li><p>我 (Django 和 Vue 弱鸡）倾向于使用 DjangoORM, 我认为</p>
<ul>
<li>对于一个技术『先知其大致然，需要深入的时候知其所以然』</li>
<li>对于 ORM<ul>
<li>操作数据，最好抽象为对对象的操作。</li>
<li>测试到位的情况下，快糙狠先出东西。到需要优化的时候该怎么 Profile 怎么 Profile</li>
</ul>
</li>
<li>对于 Migration 机制<ul>
<li>用起来啊，能操作对象为什么还要强行到数据库操作？</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-1-模型定义"><a href="#2-1-模型定义" class="headerlink" title="2.1 模型定义"></a>2.1 模型定义</h3><p>先看一组模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line">Base = declarative_base() <span class="comment"># 模型基类</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>) <span class="comment"># 主键</span></span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&lt;User(name=&#x27;%s&#x27;, fullname=&#x27;%s&#x27;, password=&#x27;%s&#x27;)&gt;&quot;</span> % (</span><br><span class="line">                            self.name, self.fullname, self.password)</span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<p>可以看出，包含如下的部分：</p>
<ol>
<li>Model 与 Model 内部的 Meta</li>
<li>Field 与 Field 内部的 Options</li>
<li>Model 与 Model 之间的关系</li>
<li>其他，比如索引</li>
</ol>
<h4 id="Models-与-Meta"><a href="#Models-与-Meta" class="headerlink" title="Models 与 Meta"></a>Models 与 Meta</h4><p><a target="_blank" rel="noopener" href="https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685">https://github.com/zzzeek/sqlalchemy/blob/master/lib/sqlalchemy/sql/schema.py#L3685</a></p>
<h4 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h4><h5 id="One-To-Many"><a href="#One-To-Many" class="headerlink" title="One To Many"></a>One To Many</h5><p>母亲有若干个孩子，外键在孩子上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Parent(Base):</span><br><span class="line">    #...</span><br><span class="line">    children &#x3D; relationship(&quot;Child&quot;, backref&#x3D;&quot;parent&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    #...</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;parent.id&#39;))</span><br></pre></td></tr></table></figure>

<h5 id="Many-To-One"><a href="#Many-To-One" class="headerlink" title="Many To One"></a>Many To One</h5><p>多个母亲共享一个孩子，外键在母亲上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Parent(Base):</span><br><span class="line">    child_id &#x3D; Column(Integer, ForeignKey(&#39;child.id&#39;))</span><br><span class="line">    child &#x3D; relationship(&quot;Child&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>

<h5 id="One-To-One"><a href="#One-To-One" class="headerlink" title="One To One"></a>One To One</h5><p>One to One 是 One to Many 或者是 Many to One 的简化版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Many To One</span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line">    child_id &#x3D; Column(Integer, ForeignKey(&#39;child.id&#39;))</span><br><span class="line">    child &#x3D; relationship(&quot;Child&quot;, backref&#x3D;backref(&quot;parent&quot;, uselist&#x3D;False))</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br><span class="line"></span><br><span class="line"># One To Many 改 One To One</span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;parent.id&#39;))</span><br><span class="line">    parent &#x3D; relationship(&quot;Parent&quot;, backref&#x3D;backref(&quot;child&quot;, uselist&#x3D;False))</span><br></pre></td></tr></table></figure>

<h5 id="Many-To-Many"><a href="#Many-To-Many" class="headerlink" title="Many To Many"></a>Many To Many</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">association_table &#x3D; Table(&#39;association&#39;, Base.metadata,</span><br><span class="line">    Column(&#39;left_id&#39;, Integer, ForeignKey(&#39;left.id&#39;)),</span><br><span class="line">    Column(&#39;right_id&#39;, Integer, ForeignKey(&#39;right.id&#39;))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">class Parent(Base):</span><br><span class="line">    # ...</span><br><span class="line">    children &#x3D; relationship(&quot;Child&quot;,</span><br><span class="line">                    secondary&#x3D;association_table,</span><br><span class="line">                    backref&#x3D;&quot;parents&quot;)</span><br><span class="line"></span><br><span class="line">class Child(Base):</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>

<p>注意事项</p>
<p>执行删除 mapping 表的时候尽量这样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myparent.children.remove(somechild)</span><br></pre></td></tr></table></figure>

<p>当你想干掉 somechild 的时候，会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.delete(somechild)</span><br></pre></td></tr></table></figure>

<ol>
<li>假如 Child 没有 ref Parent 的话，Secondary Table 无删除，则无法删除。</li>
<li>假如 ref 了的话，则删除 secondary 里面的记录。</li>
<li>TODO</li>
</ol>
<h5 id="邻接列表关系"><a href="#邻接列表关系" class="headerlink" title="邻接列表关系"></a>邻接列表关系</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Node(Base):</span><br><span class="line">    __tablename__ &#x3D; &#39;node&#39;</span><br><span class="line">    id &#x3D; Column(Integer, primary_key&#x3D;True)</span><br><span class="line">    parent_id &#x3D; Column(Integer, ForeignKey(&#39;node.id&#39;))</span><br><span class="line">    data &#x3D; Column(String(50))</span><br><span class="line">    children &#x3D; relationship(&quot;Node&quot;,</span><br><span class="line">                backref&#x3D;backref(&#39;parent&#39;, remote_side&#x3D;[id])</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="relationship-详解"><a href="#relationship-详解" class="headerlink" title="relationship 详解"></a>relationship 详解</h5><h3 id="2-1-Query"><a href="#2-1-Query" class="headerlink" title="2.1 Query"></a>2.1 Query</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c1 &#x3D; Child(name&#x3D;&quot;苏轼&quot;)</span><br><span class="line">session.add(c1)</span><br><span class="line">session.flush()</span><br><span class="line">p &#x3D; Parent(name&#x3D;&quot;苏辙&quot;)</span><br><span class="line">p.best_child &#x3D; c1</span><br><span class="line">for c in [c1,c2,c3,c4]:</span><br><span class="line">    p.children.append(c)</span><br><span class="line">session.add(c1)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h4 id="Retrieve"><a href="#Retrieve" class="headerlink" title="Retrieve"></a>Retrieve</h4><p>过滤</p>
<p>filter(**kwargs)<br>filter(Singer.name == “周杰伦”)<br>filter(Singer.name =! “周杰棍”)</p>
<h5 id="跨关系（跨表）查询"><a href="#跨关系（跨表）查询" class="headerlink" title="跨关系（跨表）查询"></a>跨关系（跨表）查询</h5><p>session.query(Entry).join(Blog,Blog.entry_id == Entry.id).filter(Blog.name = “SqlAlchemy CheatSheet”)</p>
<h5 id="Limit-Offset-分页"><a href="#Limit-Offset-分页" class="headerlink" title="Limit / Offset / 分页"></a>Limit / Offset / 分页</h5><ul>
<li>limit()</li>
<li>offset()</li>
</ul>
<h5 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query &#x3D; session.query(Order) # query &#x3D; session.query(Order)</span><br><span class="line">query &#x3D; query.filter(Order.name.like(f&quot;%name%&quot;))</span><br></pre></td></tr></table></figure>

<h5 id="二进制表达式"><a href="#二进制表达式" class="headerlink" title="二进制表达式"></a>二进制表达式</h5><p>我们先 type 一下表达式，找到 eq 的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(model.column_name == <span class="string">&#x27;asdf&#x27;</span>) → sqlalchemy.sql.elements.BinaryExpression</span><br></pre></td></tr></table></figure>

<p>是一个二进制表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等于</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>)</span><br><span class="line"><span class="comment"># 不等于</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name != <span class="string">&#x27;ed&#x27;</span>)</span><br><span class="line"><span class="comment"># Like（有的数据库不区分大小写）</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.like(<span class="string">&#x27;%ed%&#x27;</span>))</span><br><span class="line"><span class="comment"># ILIKE (case-insensitive LIKE)</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.ilike(<span class="string">&#x27;%ed%&#x27;</span>))</span><br><span class="line"><span class="comment"># IN</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.in_([<span class="string">&#x27;ed&#x27;</span>, <span class="string">&#x27;wendy&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>]))</span><br><span class="line"><span class="comment"># Not in</span></span><br><span class="line">query.<span class="built_in">filter</span>(~User.name.in_([<span class="string">&#x27;ed&#x27;</span>, <span class="string">&#x27;wendy&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>]))</span><br><span class="line"><span class="comment"># IS NULL</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="literal">None</span>)</span><br><span class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.is_(<span class="literal">None</span>))</span><br><span class="line"><span class="comment"># IS NOT NULL:</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name != <span class="literal">None</span>)</span><br><span class="line"><span class="comment">## 如果你用了 pep8/linter 的话</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.isnot(<span class="literal">None</span>))</span><br><span class="line"><span class="comment"># AND</span></span><br><span class="line"><span class="comment">## use and_()</span></span><br><span class="line">query.<span class="built_in">filter</span>(and_(User.name == <span class="string">&#x27;ed&#x27;</span>, User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>))</span><br><span class="line"><span class="comment">## or send multiple expressions to .filter()</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>, User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>)</span><br><span class="line"><span class="comment">## or chain multiple filter()/filter_by() calls</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;ed&#x27;</span>).<span class="built_in">filter</span>(User.fullname == <span class="string">&#x27;Ed Jones&#x27;</span>)</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">query.<span class="built_in">filter</span>(or_(User.name == <span class="string">&#x27;ed&#x27;</span>, User.name == <span class="string">&#x27;wendy&#x27;</span>))</span><br><span class="line"><span class="comment"># MATCH</span></span><br><span class="line">query.<span class="built_in">filter</span>(User.name.match(<span class="string">&#x27;wendy&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">all()</span><br><span class="line">first()</span><br><span class="line">one()</span><br><span class="line">one_or_none()</span><br><span class="line">scalar()</span><br></pre></td></tr></table></figure>

<p>YourModel.query.get((pk1, pk2))</p>
<h5 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h5><blockquote>
<p>同一个 Session 下面，取到的某一条数据对应的 objects 应该是一样的？</p>
</blockquote>
<h5 id="复制-实例"><a href="#复制-实例" class="headerlink" title="复制 实例"></a>复制 实例</h5><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查询的是 SomeModel 里面所有的字段 即 select *</span><br><span class="line">query &#x3D; session.query(SomeModel)</span><br><span class="line"># 查询的是 SomeModel 里面部分的字段 即 select acol, bcol</span><br><span class="line">query &#x3D; session.query(SomeModel.acol,SomeModel.bcol)</span><br><span class="line"># 即 select acol , bcol</span><br><span class="line"># alias</span><br><span class="line">user_alias &#x3D; aliased(User, name&#x3D;&#39;user_alias&#39;)</span><br><span class="line">for row in session.query(user_alias, user_alias.name).all():</span><br><span class="line">    # 即相当于 select name as name_label</span><br><span class="line">    print(row.user_alias)</span><br><span class="line"></span><br><span class="line"># limit 和 offset</span><br><span class="line">for u in session.query(User).order_by(User.id)[1:3]:</span><br><span class="line">    print(u)</span><br><span class="line"></span><br><span class="line"># distinct</span><br><span class="line">session.query(model.Name).distinct(model.Name.value).order_by(model.Name.value)</span><br><span class="line"># order_by</span><br><span class="line">User.query.order_by(User.popularity.desc(),User.date_created.desc()).limit(10).all()</span><br></pre></td></tr></table></figure>

<h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><p>单个 object 更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blog.title &#x3D; &quot;大宝天天见&quot;</span><br><span class="line">session.add(blog)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<p>批量更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.query.filter(Blog.content.like(&quot;% 敏感词 %&quot;)).update(&#123;</span><br><span class="line">    Blog.content: &quot;依照相关 XX 无法查看&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>一对多的更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append</span><br></pre></td></tr></table></figure>

<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><p>query.delete()</p>
<h4 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h4><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query">https://stackoverflow.com/questions/6044309/sqlalchemy-how-to-join-several-tables-by-one-query</a></p>
<h5 id="两表-InnerJoin"><a href="#两表-InnerJoin" class="headerlink" title="两表 InnerJoin"></a>两表 InnerJoin</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> u, a <span class="keyword">in</span> session.query(User, Address).\</span><br><span class="line">                    <span class="built_in">filter</span>(User.<span class="built_in">id</span>==Address.user_id).\</span><br><span class="line">                    <span class="built_in">filter</span>(Address.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>).\</span><br><span class="line">                    <span class="built_in">all</span>():</span><br><span class="line">    print(u)</span><br><span class="line">    print(a)</span><br><span class="line"><span class="comment"># &lt;User(name=&#x27;jack&#x27;, fullname=&#x27;Jack Bean&#x27;, password=&#x27;gjffdd&#x27;)&gt;</span></span><br><span class="line"><span class="comment"># &lt;Address(email_address=&#x27;jack@google.com&#x27;)&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="多表-InnerJoin-LeftJoin"><a href="#多表-InnerJoin-LeftJoin" class="headerlink" title="多表 InnerJoin + LeftJoin"></a>多表 InnerJoin + LeftJoin</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.outerjoin(User.addresses)   # LEFT OUTER JOIN</span><br></pre></td></tr></table></figure>

<h4 id="聚集查询"><a href="#聚集查询" class="headerlink" title="聚集查询"></a>聚集查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).filter(User.name.like(&#39;%ed&#39;)).count()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy import func</span><br><span class="line">session.query(Table.column, func.count(Table.column)).group_by(Table.column).all()</span><br><span class="line"></span><br><span class="line">self.session.query(func.count(Table.column1),Table.column1, Table.column2).group_by(Table.column1, Table.column2).all()</span><br><span class="line"></span><br><span class="line">from sqlalchemy.sql import func</span><br><span class="line">session.query(func.avg(Rating.field2).label(&#39;average&#39;)).filter(Rating.url&#x3D;&#x3D;url_string.netloc)</span><br></pre></td></tr></table></figure>

<h4 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h4><p>Query 对象，下文中，我会聊到这个 Query 对象。这里先跳过。</p>
<h3 id="2-2-原生查询"><a href="#2-2-原生查询" class="headerlink" title="2.2 原生查询"></a>2.2 原生查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy import text</span><br><span class="line"></span><br><span class="line">sql &#x3D; text(&#39;select name from penguins&#39;)</span><br><span class="line">result &#x3D; db.engine.execute(sql)</span><br><span class="line">names &#x3D; []</span><br><span class="line">for row in result:</span><br><span class="line">    names.append(row[0])</span><br><span class="line"></span><br><span class="line">print names</span><br><span class="line"></span><br><span class="line">from collections import namedtuple</span><br><span class="line"></span><br><span class="line">Record &#x3D; namedtuple(&#39;Record&#39;, result.keys())</span><br><span class="line">records &#x3D; [Record(*r) for r in result.fetchall()]</span><br><span class="line">for r in records:</span><br><span class="line">    print(r)</span><br><span class="line"></span><br><span class="line">from sqlalchemy.sql import text</span><br><span class="line"></span><br><span class="line">connection &#x3D; engine.connect()</span><br><span class="line"></span><br><span class="line"># recommended</span><br><span class="line">cmd &#x3D; &#39;select * from Employees where EmployeeGroup &#x3D;&#x3D; :group&#39;</span><br><span class="line">employeeGroup &#x3D; &#39;Staff&#39;</span><br><span class="line">employees &#x3D; connection.execute(text(cmd), group &#x3D; employeeGroup)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>get_or_create</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_or_create(session, model, defaults&#x3D;None, **kwargs):</span><br><span class="line">    instance &#x3D; session.query(model).filter_by(**kwargs).first()</span><br><span class="line">    if instance:</span><br><span class="line">        return instance, False</span><br><span class="line">    else:</span><br><span class="line">        params &#x3D; dict((k, v) for k, v in kwargs.iteritems() if not isinstance(v, ClauseElement))</span><br><span class="line">        params.update(defaults or &#123;&#125;)</span><br><span class="line">        instance &#x3D; model(**params)</span><br><span class="line">        session.add(instance)</span><br><span class="line">        return instance, True</span><br></pre></td></tr></table></figure>

<h3 id="2-3-更新查询"><a href="#2-3-更新查询" class="headerlink" title="2.3 更新查询"></a>2.3 更新查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(Stuff).update(&#123;Stuff.foo: Stuff.foo + 1&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1) for c in session.query(Stuff).all():</span><br><span class="line">       c.foo +&#x3D; 1</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">2) session.query().\</span><br><span class="line">       update(&#123;&quot;foo&quot;: (Stuff.foo + 1)&#125;)</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">3) conn &#x3D; engine.connect()</span><br><span class="line">   stmt &#x3D; Stuff.update().\</span><br><span class="line">       values(Stuff.foo &#x3D; (Stuff.foo + 1))</span><br><span class="line">   conn.execute(stmt)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1) user.no_of_logins +&#x3D; 1</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">2) session.query().\</span><br><span class="line">       filter(User.username &#x3D;&#x3D; form.username.data).\</span><br><span class="line">       update(&#123;&quot;no_of_logins&quot;: (User.no_of_logins +1)&#125;)</span><br><span class="line">   session.commit()</span><br><span class="line"></span><br><span class="line">3) conn &#x3D; engine.connect()</span><br><span class="line">   stmt &#x3D; User.update().\</span><br><span class="line">       values(no_of_logins&#x3D;(User.no_of_logins + 1)).\</span><br><span class="line">       where(User.username &#x3D;&#x3D; form.username.data)</span><br><span class="line">   conn.execute(stmt)</span><br><span class="line"></span><br><span class="line">4) setattr(user, &#39;no_of_logins&#39;, user.no_of_logins+1)</span><br><span class="line">   session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="2-4-删除"><a href="#2-4-删除" class="headerlink" title="2.4 删除"></a>2.4 删除</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete">https://stackoverflow.com/questions/5033547/sqlalchemy-cascade-delete</a></p>
<h4 id="OnDelete"><a href="#OnDelete" class="headerlink" title="OnDelete"></a>OnDelete</h4><p>ondelete=’CASCADE’))</p>
<h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><p>models.User.query.delete()</p>
<h3 id="如何从-Object-到一个-ORM"><a href="#如何从-Object-到一个-ORM" class="headerlink" title="如何从 Object 到一个 ORM"></a>如何从 Object 到一个 ORM</h3><p>如何追踪 Object 的变化？</p>
<h2 id="0x03-SQLAlchemy-的高级特性"><a href="#0x03-SQLAlchemy-的高级特性" class="headerlink" title="0x03 SQLAlchemy 的高级特性"></a>0x03 SQLAlchemy 的高级特性</h2><h3 id="表继承"><a href="#表继承" class="headerlink" title="表继承"></a>表继承</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance">https://stackoverflow.com/questions/1337095/sqlalchemy-inheritance</a></p>
<h3 id="啥玩意"><a href="#啥玩意" class="headerlink" title="啥玩意"></a>啥玩意</h3><p>Flush 和 commit</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit">https://stackoverflow.com/questions/4201455/sqlalchemy-whats-the-difference-between-flush-and-commit</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x &#x3D; Foo(bar&#x3D;1)</span><br><span class="line">print x.id</span><br><span class="line"># None</span><br><span class="line">session.add(x)</span><br><span class="line">session.flush()</span><br><span class="line"># BEGIN</span><br><span class="line"># INSERT INTO foo (bar) VALUES(1)</span><br><span class="line"># COMMIT</span><br><span class="line">print x.id</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qry &#x3D; DBSession.query(User).filter(</span><br><span class="line">        and_(User.birthday &lt;&#x3D; &#39;1988-01-17&#39;, User.birthday &gt;&#x3D; &#39;1985-01-17&#39;))</span><br></pre></td></tr></table></figure>

<h2 id="0x04-SQLAlchemy-的基础特性-Under-The-Hood"><a href="#0x04-SQLAlchemy-的基础特性-Under-The-Hood" class="headerlink" title="0x04 SQLAlchemy 的基础特性 Under The Hood"></a>0x04 SQLAlchemy 的基础特性 Under The Hood</h2><h3 id="Loading-策略"><a href="#Loading-策略" class="headerlink" title="Loading 策略"></a>Loading 策略</h3><h4 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h4><h4 id="Eager-Loading"><a href="#Eager-Loading" class="headerlink" title="Eager Loading"></a>Eager Loading</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from sqlalchemy.dialects import postgresql</span><br><span class="line">&gt;&gt;&gt; print str(q.statement.compile(dialect&#x3D;postgresql.dialect()))</span><br><span class="line">Where q is defined as:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x05-SQLAlchemy-的高级特性-Under-The-Hood"><a href="#0x05-SQLAlchemy-的高级特性-Under-The-Hood" class="headerlink" title="0x05 SQLAlchemy 的高级特性 Under The Hood"></a>0x05 SQLAlchemy 的高级特性 Under The Hood</h2><h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy">https://stackoverflow.com/questions/6297404/multi-threaded-use-of-sqlalchemy</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications">https://stackoverflow.com/questions/9619789/sqlalchemy-proper-session-handling-in-multi-thread-applications</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;34322471&#x2F;sqlalchemy-engine-connection-and-session-difference</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;11769366&#x2F;why-is-sqlalchemy-insert-with-sqlite-25-times-slower-than-using-sqlite3-directly</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;12223335&#x2F;sqlalchemy-creating-vs-reusing-a-session</span><br><span class="line">session 是个容器</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;18199053&#x2F;example-of-what-sqlalchemy-can-do-and-django-orm-cannot</span><br><span class="line">https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;7389759&#x2F;memory-efficient-built-in-sqlalchemy-iterator-generator</span><br><span class="line"></span><br><span class="line"># 日志</span><br><span class="line">import logging</span><br><span class="line">logging.basicConfig()</span><br><span class="line">logging.getLogger(&#39;sqlalchemy.engine&#39;).setLevel(logging.INFO)</span><br></pre></td></tr></table></figure>

<h2 id="0x06-DEBUG-和-Profile-技巧"><a href="#0x06-DEBUG-和-Profile-技巧" class="headerlink" title="0x06 DEBUG 和 Profile 技巧"></a>0x06 DEBUG 和 Profile 技巧</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS &#x3D; False</span><br></pre></td></tr></table></figure>

<h3 id="6-1-查看技巧"><a href="#6-1-查看技巧" class="headerlink" title="6.1 查看技巧"></a>6.1 查看技巧</h3><p>dict(u)<br>u.<strong>dict</strong></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application">https://stackoverflow.com/questions/1171166/how-can-i-profile-a-sqlalchemy-powered-application</a></p>
<p>如果用上 Flask+SQLAlchemy 一般也要带上，Flask-Migration 与 Flask-SQLAlchemy, 这两个库也是对 Alembic 和 SQLAlchemy 的浅封装。</p>
<p>那么，对于这个 ORM 库还有那些通用性的知识需要了解？</p>
<p>嗯，是时候了解本质了。</p>
<p><a target="_blank" rel="noopener" href="http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/">http://derrickgilland.com/posts/demystifying-flask-sqlalchemy/</a></p>
<h2 id="0x07-ORM-的本质"><a href="#0x07-ORM-的本质" class="headerlink" title="0x07 ORM 的本质"></a>0x07 ORM 的本质</h2><p>ORM 的本质是 Data Access Layer 上的一层封装。如果你写原生 SQL, 即手写 DAL 的话，开发效率可能会大打折扣。</p>
<h3 id="ORM-的两种类型-Active-Record-与-Data-Mappers"><a href="#ORM-的两种类型-Active-Record-与-Data-Mappers" class="headerlink" title="ORM 的两种类型 Active Record 与 Data Mappers"></a>ORM 的两种类型 Active Record 与 Data Mappers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># ActiveRecord 风格写起来类似于 Django ORM, 大致是这样的</span><br><span class="line"></span><br><span class="line">## AR 的模型定义</span><br><span class="line"></span><br><span class="line">class User(db.models):</span><br><span class="line">    name &#x3D; db.StringField(verbose&#x3D;&quot;xyz&quot;)</span><br><span class="line"></span><br><span class="line">## AR 的新增</span><br><span class="line">user &#x3D; User()</span><br><span class="line">user.name &#x3D; &quot;123456&quot;</span><br><span class="line">user.save() ## 正好对应数据库中的一行</span><br><span class="line"></span><br><span class="line">## AR 的查询</span><br><span class="line"></span><br><span class="line">users &#x3D; User.objects.filter(Q(name&#x3D;&quot;黄老板的小姨子&quot;)).all()</span><br><span class="line"></span><br><span class="line"># Data Mappers 风格写起来类似于 SQLAlchemy ORM, 大致是这样的</span><br><span class="line"></span><br><span class="line">## SA 的定义</span><br><span class="line"></span><br><span class="line">from sqlalchemy.ext.declarative import declarative_base</span><br><span class="line"></span><br><span class="line">Base &#x3D; declarative_base()</span><br><span class="line"></span><br><span class="line">from sqlalchemy import Column, Integer, String</span><br><span class="line">class User(Base):</span><br><span class="line">    __tablename__ &#x3D; &#39;users&#39;</span><br><span class="line"></span><br><span class="line">    id &#x3D; Column(Integer, primary_key&#x3D;True)</span><br><span class="line">    name &#x3D; Column(String)</span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line">## SA 的新增</span><br><span class="line"></span><br><span class="line">user &#x3D; User()</span><br><span class="line">user.name &#x3D; &quot;123456&quot;</span><br><span class="line">session.add(user)</span><br><span class="line">sessoon.commit() ## 嗯？其实也是对应数据库中的一行。</span><br><span class="line"></span><br><span class="line">## SA 的查询</span><br><span class="line"></span><br><span class="line">session.query(User).filter(User.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题来了，这两者到底是什么，看起来似乎相差不大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Person:</span><br><span class="line"></span><br><span class="line">    lastname</span><br><span class="line">    firstname</span><br><span class="line">    children</span><br><span class="line"></span><br><span class="line">    # 数据操作</span><br><span class="line">    def findone(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def insert(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def update(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def delete(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    # 业务逻辑</span><br><span class="line">    def getChildrenTax(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lastName firstName numberOfDependents</p>
<p>insert update delete</p>
<p>getExemption isFlaggedForAudit getTaxableEarnings</p>
<p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p>
<p>The essence of an Active Record is a Domain Model (116) in which the classes match very closely the record structure of an underlying database. Each Active Record is responsible for saving and loading to the database and also for any domain logic that acts on the data. This may be all the domain logic in the application, or you may ﬁnd that some domain logic is held in Transaction Scripts (110) with common and data-oriented code in the Active Record.</p>
<p>The data structure of the Active Record should exactly match that of the database: one ﬁeld in the class for each column in the table. Type the ﬁelds the way the SQL interface gives you the data—don’t do any conversion at this stage. You may consider Foreign Key Mapping (236), but you may also leave the foreign keys as they are. You can use views or tables with Active Record, although updates through views are obviously harder. Views are particularly useful for reporting purposes.</p>
<p>objects correspond directly to the database tables: an isomorphic schema. If your business logic is complex, you’ll soon want to use your object’s direct relationships, collections, inheritance, and so forth. These don’t map easily onto Active Record, and adding them piecemeal gets very messy. That’s what will lead you to use Data Mapper (165) instead.</p>
<p>Another argument against Active Record is the fact that it couples the object design to the database design. This makes it more difﬁcult to refactor either design as a project goes forward.</p>
<p>Active Record is a good pattern to consider if you’re using Transaction Script (110) and are beginning to feel the pain of code duplication and the difﬁculty in updating scripts and tables that Transaction Script (110) often brings. In this case you can gradually start creating Active Records and then slowly refactor behavior into them. It often helps to wrap the tables as a Gateway (466) ﬁrst, and then start moving behavior so that the tables evolve to a Active Record.</p>
<p>其实为什么不选择设计成 ActiveRecord , 而是选择设计成 Data Mapper, 其实就可以回答这个问题：</p>
<blockquote>
<p>虽然要设计成 ORM, 考虑到数量和性能因素，SQL 数据库（多个表）并不应该是表现像 Object 集合那样（换言之，也就是 AR 表现的像 Object 的集合一样）。<br>同时，出于更好的抽象，object 集合也应该表现的像表以及行</p>
</blockquote>
<p>于是我们可以得出结论，可以在 SQLAlchemy 上面进行一定的封装，使得最后用起来非常的 Django ORM like，其实 SQLAlchemy 稍加定制还是可以很 Django ORM-like 的。</p>
<p>:TODO: 有机会看看那本书再修改一下本小节</p>
<p>这不，果然有人就这么搞了 <a target="_blank" rel="noopener" href="https://github.com/absent1706/sqlalchemy-mixins">https://github.com/absent1706/sqlalchemy-mixins</a></p>
<h2 id="0x09-踩坑集"><a href="#0x09-踩坑集" class="headerlink" title="0x09 踩坑集"></a>0x09 踩坑集</h2><h3 id="关系持久化坑"><a href="#关系持久化坑" class="headerlink" title="关系持久化坑"></a>关系持久化坑</h3><ol>
<li>Rows that point to themselves : 比如一个 insert 一个推荐自己的用户，则需要保存 id / ref_id , 但是在这个 user 插入之前，并不存在 id. 所以，一般情况下是先 insert, 然后保存 ref_id</li>
<li>Mutually Dependent Rows</li>
</ol>
<h3 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h3><p>session.query(MyClass).filter(“foo={}”.format(getArgs[‘val’]))</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE 参考链接"></a>0xEE 参考链接</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/">https://www.eversql.com/django-vs-sqlalchemy-which-python-orm-is-better/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create">https://stackoverflow.com/questions/2546207/does-sqlalchemy-have-an-equivalent-of-djangos-get-or-create</a></p>
</li>
<li><p>除了文档本身，作者在 Stack Overflow 上的回答都是非常值得阅读的。<a target="_blank" rel="noopener" href="https://stackoverflow.com/users/34549/zzzeek">https://stackoverflow.com/users/34549/zzzeek</a></p>
</li>
<li><p>Patterns of Enterprise Application Architecture - Martin Fowler</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://aosabook.org/en/sqlalchemy.html">http://aosabook.org/en/sqlalchemy.html</a></p>
<p>  <a target="_blank" rel="noopener" href="http://techspot.zzzeek.org/">http://techspot.zzzeek.org/</a></p>
</li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/09/Flask%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/09/Flask%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Flask 文档阅读笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-09 16:27:03" itemprop="dateCreated datePublished" datetime="2018-03-09T16:27:03+08:00">2018-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-03-18 14:47:22" itemprop="dateModified" datetime="2018-03-18T14:47:22+08:00">2018-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>因为最近需要新增一个 Flask 技术栈，所以准备趁这休息的时候更新关于 Flask 的两篇文章。</p>
<p>前者是文档阅读笔记，后者是源码初步解析。</p>
<blockquote>
<p>嗯，其实这篇就是做了一些搬运的活。</p>
</blockquote>
<h2 id="0x01-文档"><a href="#0x01-文档" class="headerlink" title="0x01 文档"></a>0x01 文档</h2><p>由于 Flask 还依赖 Jinja2 与 Werkzeug, 并且往往大家在使用 Flask 的时候还是会使用 itsdangerous. 所以，当大家说 Flask 代码少的时候，我还是不服的。但如果你说，Flask 本身实现确实是简洁，扩展性强，我还是服气的。</p>
<p>Flask 的文档有三种类型（其他框架类文档也是如此）：</p>
<ul>
<li>Tutorial 类，即教程类</li>
<li>Guide 类，即指南类</li>
<li>API 类，即接口级别的文档</li>
</ul>
<p>当你是一个老手，还想快速上手一个框架的时候，认真读一读前两者，然后挑选一个项目多看几遍即可。</p>
<p>但是当你深入到框架里面的设计与实现的时候，则必须要多读读 API Document , 由于通常情况下 API Document 的内容往往是代码中的注释，加上 Flask 代码量本来就不多。所以，有的时候阅读 Flask 代码代码也会比 API 好很多。</p>
<h2 id="0x02-Guide"><a href="#0x02-Guide" class="headerlink" title="0x02 Guide"></a>0x02 Guide</h2><h3 id="2-1-Templates"><a href="#2-1-Templates" class="headerlink" title="2.1 Templates"></a>2.1 Templates</h3><p>快速 Get 模板语言无非就是掌握：</p>
<ol>
<li>上下文变量</li>
<li>条件语法</li>
<li>列表语法</li>
<li>模板的继承 (extend 语法）与组合 (include)</li>
<li>额外的一些语法糖，比如 filter 的使用 / 组成</li>
</ol>
<h3 id="2-2-Testing-Flask-Applications"><a href="#2-2-Testing-Flask-Applications" class="headerlink" title="2.2 Testing Flask Applications"></a>2.2 Testing Flask Applications</h3><blockquote>
<p>Something that is untested is broken.</p>
</blockquote>
<p>这里的测试，有哪些测试呢？</p>
<ol>
<li>非 flask 相关逻辑的测试。比如，我对一小段无关于 View 层的纯粹的逻辑进行测试，我比较喜欢使用 pytest 进行测试。</li>
<li>Flask 相关</li>
</ol>
<ul>
<li>Setup</li>
<li>TearDown</li>
<li>登录前 / 登陆后</li>
</ul>
<h3 id="2-3-Application-Errors"><a href="#2-3-Application-Errors" class="headerlink" title="2.3 Application Errors"></a>2.3 Application Errors</h3><p>比如测试请求与响应结果。比如测试路由。测试某个与 View 层绑定的数据操作是否执行成功。</p>
<p>首先，大致扫一眼 tutorial ，知道了 Flask 的教程讲了如下的东西：</p>
<ol>
<li>路由</li>
<li>静态文件</li>
<li>模板渲染</li>
<li>接触请求数据</li>
<li>重定向和错误</li>
<li>响应</li>
<li>Session</li>
<li>Message Flash</li>
<li>日志</li>
<li>扩展</li>
</ol>
<p>当然，我们都是老手了，肯定是挑重点来看了。</p>
<p>Routing, 发现现在的问题在于</p>
<p>Flask 有两个主要依赖：</p>
<ul>
<li>路由、调试、WSGI</li>
<li>模板</li>
</ul>
<h2 id="0x02-社区支持"><a href="#0x02-社区支持" class="headerlink" title="0x02 社区支持"></a>0x02 社区支持</h2><h2 id="0x04-读文档产生的疑问"><a href="#0x04-读文档产生的疑问" class="headerlink" title="0x04 读文档产生的疑问"></a>0x04 读文档产生的疑问</h2><p>1.</p>
<p>For web applications it’s crucial to react to the data a client sends to the server. In Flask this information is provided by the global request object. If you have some experience with Python you might be wondering how that object can be global and how Flask manages to still be threadsafe. The answer is context locals:</p>
<p>Context Locals<br>Insider Information<br>If you want to understand how that works and how you can implement tests with context locals, read this section, otherwise just skip it.</p>
<p>Certain objects in Flask are global objects, but not of the usual kind. These objects are actually proxies to objects that are local to a specific context. What a mouthful. But that is actually quite easy to understand.</p>
<p>Imagine the context being the handling thread. A request comes in and the web server decides to spawn a new thread (or something else, the underlying object is capable of dealing with concurrency systems other than threads). When Flask starts its internal request handling it figures out that the current thread is the active context and binds the current application and the WSGI environments to that context (thread). It does that in an intelligent way so that one application can invoke another application without breaking.</p>
<p>So what does this mean to you? Basically you can completely ignore that this is the case unless you are doing something like unit testing. You will notice that code which depends on a request object will suddenly break because there is no request object. The solution is creating a request object yourself and binding it to the context. The easiest solution for unit testing is to use the test_request_context() context manager. In combination with the with statement it will bind a test request so that you can interact with it. Here is an example:</p>
<h3 id="Thread-Local"><a href="#Thread-Local" class="headerlink" title="Thread Local"></a>Thread Local</h3><p>One of the design decisions in Flask was that simple tasks should be simple; they should not take a lot of code and yet they should not limit you. Because of that, Flask has a few design choices that some people might find surprising or unorthodox. For example, Flask uses thread-local objects internally so that you don’t have to pass objects around from function to function within a request in order to stay threadsafe. This approach is convenient, but requires a valid request context for dependency injection or when attempting to reuse code which uses a value pegged to the request. The Flask project is honest about thread-locals, does not hide them, and calls out in the code and documentation where they are used.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/09/Flask%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/09/Flask%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Flask 源码初步解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-09 16:27:03" itemprop="dateCreated datePublished" datetime="2018-03-09T16:27:03+08:00">2018-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-04-15 19:43:33" itemprop="dateModified" datetime="2018-04-15T19:43:33+08:00">2018-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>系列文章先暂时停更一下。今天换换口味。</p>
<p>久闻 Flask 是众多 Pythonist 喜欢的框架。这次借着换工作的机会熟悉一下 Flask</p>
<ol>
<li>本文先分享我阅读代码的一些小经验</li>
<li>接着通过最简单的一个 WSGI APP 开始，带着<strong>如何设计一个 Web 框架</strong>这个问题，先头脑风暴，从而脑补（而不是实现）出一个 Web 框架的基本要素。</li>
<li>从源码角度理解，Flask 从启动到接受第一个请求、返回第一个响应期间都发生了什么。</li>
<li>最后交代一些自己在这个过程中的一些突发的想法。</li>
</ol>
<blockquote>
<p>将解读 Flask 的源码放在一篇文章里，势必会造成广度有余而深度不足。所以本想定位于 Flask 源码初步解读。</p>
</blockquote>
<h2 id="0x01-阅读-Flask-代码的一种较好的姿势"><a href="#0x01-阅读-Flask-代码的一种较好的姿势" class="headerlink" title="0x01 阅读 Flask 代码的一种较好的姿势"></a>0x01 阅读 Flask 代码的一种较好的姿势</h2><p>之前在 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/28509408/answer/299763091">https://www.zhihu.com/question/28509408/answer/299763091</a> 分享过自己一点阅读代码的粗浅的经验，是以阅读一个 Django 的应用为案例的。这里借着读 Flask 本身分享一下我的看法。</p>
<p>读源码，是一个技术活。一是忌讳要想读懂全部，另一个忌讳是以为自己能一下子毫无障碍的读懂全部代码。</p>
<ol start="0">
<li>建议 0 : 看源码的时候，<strong>务必务必带着问题去读</strong>。每一次阅读其实都是在尝试回答或小或大的问题（当然，读书看文章莫不如是）。</li>
<li>建议 1 : 先读现成的文档，不要上来就对着代码一通瞎看。</li>
<li>建议 2 : 所谓『横看成岭侧成峰，远近高低都不同』 你需要从不同的角度来读源码。</li>
<li>建议 3 : 抓大放小，该略读就略读（比如知道 Nginx 的大致作用就好，做优化请求响应的时候再翻看文档），该精读则精读（具体一个关键的功能）。</li>
</ol>
<blockquote>
<p>好，坐好，预备，开车。</p>
</blockquote>
<h2 id="0x02-问题-1-如何设计一个-Web-框架"><a href="#0x02-问题-1-如何设计一个-Web-框架" class="headerlink" title="0x02 问题 1: 如何设计一个 Web 框架"></a>0x02 问题 1: 如何设计一个 Web 框架</h2><h3 id="头脑风暴"><a href="#头脑风暴" class="headerlink" title="头脑风暴"></a>头脑风暴</h3><p>Flask 是一个微 Web 框架，换而言之，代码量少的 Web 框架。当然，其实 Flask 框架是一个微框架，但『常规的 Flask 应用』本身的代码加起来一点都不比『Django 应用』少。这个地方我们后面会讲到。</p>
<p>在阅读 Flask 相关代码的之前，先头脑风暴一下：</p>
<blockquote>
<p>如何设计一个 Web 框架？</p>
</blockquote>
<p>当心中对这个问题有一定的了解之后，读 Flask 代码会更好。</p>
<p>首先，Web 框架是为了提升 Web 开发的。(XX 框架是为了提升 XX 开发的）, 这种提升可能会是 开发体验 / 性能。</p>
<p>我们来看看那个 Python 世界最基础的 wsgi app 相关代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span>(<span class="params">environ, start_response</span>):</span></span><br><span class="line">    start_response(<span class="string">&#x27;200 OK&#x27;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;Hello World!&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>在之前的文章，我也借 Django 的 DRF 提到过这个极简的代码。</p>
<p>但这个简单的 webapp，显然是啥玩意都不够用的。比如说：</p>
<ul>
<li>没有路由，我访问啥玩意都是 hello world。</li>
<li>单线程 IO 阻塞模型基本上啥都不能干。你比如说，启动这个 webapp 的时候在 return 数据之前直接 sleep 十秒，然后请求都进不来。</li>
<li>没有数据存取，连个数据库链接 CURDE 啥玩意都没有</li>
<li>environ 太过于底层，如果是判断 headers 啥的太麻烦，要是像 django 里面一样能拿到一个 request 对象返回一个 response 对象就好了。</li>
<li>没有模板语言</li>
<li>还有其他能够提升开发体验的东西，比如自带 http server 代码热加载之类。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span>(<span class="params">environ, start_response</span>):</span></span><br><span class="line">    <span class="comment"># 直接 thread local 支持多个请求。</span></span><br><span class="line">    <span class="comment"># 依据 environ 判断路由</span></span><br><span class="line">    <span class="comment"># 依据 路由 执行相关 view 层方法</span></span><br><span class="line">    <span class="comment"># 在相关 view 层方法内执行相关逻辑</span></span><br><span class="line">    start_response(<span class="string">&#x27;200 OK&#x27;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)])</span><br><span class="line">    <span class="comment"># 返回对应响应</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>当然，思路是这么个思路，这个思路也确实非常的命令式，非常的面向过程。</p>
<p>至于我们如何把这个面向过程的思路变成面向对象的设计与实现，则需要更加细致的思考这些问题。</p>
<ol>
<li>能不能把 request 和 response 封装一下？方便在 view 里面处理？</li>
<li>能不能有个 URLDisparch 之类的东西，帮你解决 url 和 view 的 mapping 问题。或者路由能不能直接搞成 装饰器类型的比如 @router(“/“) 直接放在 view 层的 function 上。</li>
<li>能不能有个方便对数据库进行 CURDE 的东西？比如 ORM/ODM</li>
<li>这玩意会不会线程不安全，假如我想每一个请求都有单独的变量集合的话，线程怎么管理？</li>
<li>……</li>
</ol>
<h3 id="设计-Web-框架"><a href="#设计-Web-框架" class="headerlink" title="设计 Web 框架"></a>设计 Web 框架</h3><p>利用 Flask 作者的另一个库 werkzeug 的案例中有这么一个东西。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pallets/werkzeug/blob/master/examples/shortly/shortly.py">https://github.com/pallets/werkzeug/blob/master/examples/shortly/shortly.py</a></p>
<p>几百行代码就不贴在这里了。仔细看看还是挺有趣的。 这个可以算作另一个超简的 Webapp 了。</p>
<p>Flask 算作在这个基础上进行一定的扩展而成。</p>
<p>看完上面这个就可以出去吹牛逼可以自己写一个极简 Web 框架了。</p>
<p>那么，你可能有疑问，为何有了 Flask 之后，是否需要看这个更底层的 Werkzeug 的库，当然，有必要咯，Python 世界除了老牌的比较流行的 Django/Flask, 还有一个新星，叫做 APIStar</p>
<p><a target="_blank" rel="noopener" href="https://github.com/encode/apistar">https://github.com/encode/apistar</a></p>
<h2 id="0x02-问题-2-请求流程是怎么样的"><a href="#0x02-问题-2-请求流程是怎么样的" class="headerlink" title="0x02 问题 2: 请求流程是怎么样的"></a>0x02 问题 2: 请求流程是怎么样的</h2><p>我们就拿这个 flask 的极简案例，进行<strong>首次</strong>阅读 Flask 代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hello.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line">$ FLASK_APP=hello.py flask run</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从请求到响应的整个流程，Flask 的是怎么处理请求的？</p>
</blockquote>
<h3 id="2-1-服务器是怎么起来的"><a href="#2-1-服务器是怎么起来的" class="headerlink" title="2.1 服务器是怎么起来的"></a>2.1 服务器是怎么起来的</h3><p>首先 flask run 之后，发生了什么？</p>
<p>先初始化环境变量，然后导入 dotenv 文件，然后执行 run_command 方法，找到 hello.py 然后导入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cli.py#run_command 方法</span></span><br><span class="line">app = DispatchingApp(info.load_app, use_eager_loading=eager_loading)</span><br><span class="line"><span class="comment"># 上一行代表着其实我们每次在本地 flask run 的时候，起的服务并不是 flask_app, 而是被 DispatchingApp 包装了一层的 flask app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line">run_simple(host, port, app, use_reloader=reload, use_debugger=debugger,</span><br><span class="line">            threaded=with_threads, ssl_context=cert)</span><br></pre></td></tr></table></figure>

<p>进行这层包装之后，就可以显示 WERKZEUG 的所谓在浏览器中的 报错信息了。</p>
<p>通常开发时这里的 run_simple 最后会调用 run_with_reloader , 每当程序退出的时候，reloader 就依照策略重新跑一次 reload 一次。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_reloader</span>(<span class="params">main_func, extra_files=<span class="literal">None</span>, interval=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      reloader_type=<span class="string">&#x27;auto&#x27;</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run the given function in an independent python interpreter.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> signal</span><br><span class="line">    reloader = reloader_loops[reloader_type](extra_files, interval)</span><br><span class="line">    signal.signal(signal.SIGTERM, <span class="keyword">lambda</span> *args: sys.exit(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.environ.get(<span class="string">&#x27;WERKZEUG_RUN_MAIN&#x27;</span>) == <span class="string">&#x27;true&#x27;</span>:</span><br><span class="line">            t = threading.Thread(target=main_func, args=())</span><br><span class="line">            t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">            t.start()</span><br><span class="line">            reloader.run()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.exit(reloader.restart_with_reloader())</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>好，服务起来了。</p>
<h3 id="2-2-请求-响应的流程"><a href="#2-2-请求-响应的流程" class="headerlink" title="2.2 请求-响应的流程"></a>2.2 请求-响应的流程</h3><p>我们先看 Flask 类里面的比较关键的两个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span>(<span class="params">_PackageBoundObject</span>):</span></span><br><span class="line">    <span class="comment"># 一些方法 ......</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 主要是执行一些方法，最后返回响应</span></span><br><span class="line">        self.try_trigger_before_first_request_functions()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request_started.send(self)</span><br><span class="line">            rv = self.preprocess_request()</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                rv = self.dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            rv = self.handle_user_exception(e)</span><br><span class="line">        <span class="comment"># ??? TODO</span></span><br><span class="line">        <span class="keyword">return</span> self.finalize_request(rv)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里是我们熟悉的 environ, 和 start_response</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param environ: a WSGI environment</span></span><br><span class="line"><span class="string">        :param start_response: a callable accepting a status code,</span></span><br><span class="line"><span class="string">                               a list of headers and an optional</span></span><br><span class="line"><span class="string">                               exception context to start the response</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 在这里对 environ 进行封装，创建请求上下文</span></span><br><span class="line">        ctx = self.request_context(environ)</span><br><span class="line">        error = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 这里将请求上下文压入 _request_ctx_stack</span></span><br><span class="line">                ctx.push()</span><br><span class="line">                response = self.full_dispatch_request()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                error = e</span><br><span class="line">                response = self.handle_exception(e)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">                error = <span class="literal">None</span></span><br><span class="line">            <span class="comment"># 这里将创建的请求上下文从中 _request_ctx_stack pop 出来</span></span><br><span class="line">            ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>

<p>从 wsgi_app 泪看，就可以看到我们之前在当时在开脑洞时候看到的。</p>
<ol>
<li>把 request 和 response 封装一下？方便在 view 里面处理？</li>
<li>有个 URLDisparch 之类的东西，帮你解决 url 和 view 的 mapping 问题。</li>
</ol>
<p>话说回来？</p>
<blockquote>
<p>这个 ctx 是啥？<br>当然，flask 不带 ORM, 这我们也就不研究了。</p>
</blockquote>
<p>– TODO: 在这里需要重构一下</p>
<p>不过话说回来 请求上下文的容器 request_ctx_stack 到底是啥？</p>
<blockquote>
<p>另一种本地数据存储方式。</p>
</blockquote>
<p>在多线程的情况下，每一个请求都会创建一个线程，从这个请求被发起到销毁，我想拥有单独的变量（修改这个变量不会影响到其他变量），比如 sessions 之类。</p>
<p>显然，在多线程的情况下，以上的需求完全可以通过 threadlocal 来实现。</p>
<p>翻了 werkzeug 的文档，找到了原因：</p>
<blockquote>
<p>因为 python 里面的并发模型并不只有多线程一种。比如 greenlets, 每一个请求，都在一个线程里面。</p>
</blockquote>
<h2 id="0x02-问题-2-Flask-中-Context-机制"><a href="#0x02-问题-2-Flask-中-Context-机制" class="headerlink" title="0x02 问题 2: Flask 中 Context 机制"></a>0x02 问题 2: Flask 中 Context 机制</h2><p>在 Django 完成一个 View 层的逻辑是这样的，Django 封装好了请求，请求经过 middleware 的处理，最后调用 login 函数，并且传入 request 方便 view 函数进行处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        error = someerror</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, error=error)</span><br></pre></td></tr></table></figure>

<p>在 Flask 完成一个 View 层的逻辑是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        error = someerror</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, error=error)</span><br></pre></td></tr></table></figure>

<p>假如我是一个爱问问题的年轻人，这里肯定会有疑惑：</p>
<blockquote>
<p>从外部 import 过来，那就是利用了 python 自带的 import 单例模式。 那么线程和线程之间拿到的肯定是同一个 request 呀。但 Django 里面每个 request 都是不一样的，否则一些很基础功能的比如已经认证的用户就无法拿到了。</p>
</blockquote>
<p>我已经不是那个爱问问题的年轻人，因为年纪已经不小了。逃…</p>
<p>显然，每一次在 view 层引用的 request 肯定不是同一个 request , 那么，这是如何做到的呢？比如用 ThreadLocal , ThreadLocal 通过每个线程不同的 ID 拿到的本地变量，于是我们查看一下对应的实现。 这个 request 来自于 global.py , 使用了一个 werkzeug.local 里面的 LocalProxy</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalStack, LocalProxy</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span>(<span class="params">name</span>):</span></span><br><span class="line">    top = _request_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(top, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span>(<span class="params">name</span>):</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(top, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span>():</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> top.app</span><br><span class="line"></span><br><span class="line"><span class="comment"># context locals</span></span><br><span class="line">_request_ctx_stack = LocalStack()</span><br><span class="line">_app_ctx_stack = LocalStack()</span><br><span class="line">current_app = LocalProxy(_find_app)</span><br><span class="line"><span class="comment"># 这就是我们需要的注意的地方，LocalProxy</span></span><br><span class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">&#x27;request&#x27;</span>))</span><br><span class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">&#x27;session&#x27;</span>))</span><br><span class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">&#x27;g&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>看到这里一阵蛋疼，貌似没有 threadlocal ？再次查看相关实现最后还是定位到了如何区分不同的 request 的核心代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># since each thread has its own greenlet we can just use those as identifiers</span></span><br><span class="line"><span class="comment"># for the context.  If greenlets are not available we fall back to the</span></span><br><span class="line"><span class="comment"># current thread ident depending on where it is.</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</span><br><span class="line">    <span class="comment"># greenlet 的代码是 C, 时间长没看 C 代码了，看了半天没看明白</span></span><br><span class="line">    <span class="comment"># 翻了文档返回当前的 greenlet, 也就是返回调用此函数的 greenlet</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;__storage__&#x27;</span>, <span class="string">&#x27;__ident_func__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__storage__&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="comment"># 这里传递的 ident 就可以直接</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__ident_func__&#x27;</span>, get_ident)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span>:</span></span><br><span class="line">    <span class="comment"># 用 local 实现的栈</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span>:</span></span><br><span class="line">    <span class="comment"># 一个 local 的代理器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&#x27;__members__&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dir</span>(self._get_current_object())</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(self._get_current_object(), name)</span><br></pre></td></tr></table></figure>

<p>即：</p>
<ol>
<li>当 Flask 以多线程模型运行的时候，则使用的是 threadlocal 方式</li>
<li>当 Flask 以 greenlet 的模型运行的时候，则使用的是 greenlet 区分不同</li>
</ol>
<p>接下来回头看一下处理 request 的逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="comment"># 这个 request 哪里来？</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        error = someerror</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, error=error)</span><br></pre></td></tr></table></figure>

<p>于是，我们就知道了，当引用 request 这个 LocalProxy 的时候，引用的确实是同一个名称为 request 变量，并且这个变量也确实是 LocalProxy 的实例</p>
<blockquote>
<p>但是当使用 request.method 的时候，LocalProxy 重载了 取到的则是另一个『请求对象』的 method.</p>
</blockquote>
<p>于是拿到当前请求的信息。</p>
<p>当然，其实我们也可以依据利用这个技巧写一个 currentuser 的 ProxyLocal, 然后在每个 view 层里面使用 user.has_something 进行操作。</p>
<h2 id="0x03-问题-3-Flask-中官方的机制"><a href="#0x03-问题-3-Flask-中官方的机制" class="headerlink" title="0x03 问题 3: Flask 中官方的机制"></a>0x03 问题 3: Flask 中官方的机制</h2><h2 id="0x04-问题-3-Flask-中是如何做到优雅扩展的"><a href="#0x04-问题-3-Flask-中是如何做到优雅扩展的" class="headerlink" title="0x04 问题 3: Flask 中是如何做到优雅扩展的"></a>0x04 问题 3: Flask 中是如何做到优雅扩展的</h2><h2 id="0x05-其他问题"><a href="#0x05-其他问题" class="headerlink" title="0x05 其他问题"></a>0x05 其他问题</h2><h3 id="Flask-应用"><a href="#Flask-应用" class="headerlink" title="Flask 应用"></a>Flask 应用</h3><hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-09</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/03/04/YaDjangoBlog%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/04/YaDjangoBlog%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E7%AF%87/" class="post-title-link" itemprop="url">YaDjangoBlog 之前后端分离篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2018-03-04 08:38:47 / Modified: 22:57:22" itemprop="dateCreated datePublished" datetime="2018-03-04T08:38:47+08:00">2018-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>本文是 Django 全栈开发教程的第三篇 YaDjangoBlog 之前后端分离</p>
<p>目录在这里，已经更新的文章如下</p>
<ul>
<li>Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的开发环境配置</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的前后端设计</li>
</ul>
<p><strong>本文需要成四件事情：</strong></p>
<ul>
<li>第一件事情，解读 DjangoRestFramework, 通过简单的例子来引入用 DRF 的必要性，并且简单介绍 DRF 的 CBV 实现。</li>
<li>第二件事情，简单介绍 DRF 在本项目 YaDjangoBlog 中的使用</li>
<li>第三件事情，简单聊聊 RESTFULAPI 规范，并给出最佳实践参考。</li>
<li>第四件事情，简单解读一下 Django 处理请求流程代码。</li>
</ul>
<p>PS: 为了打字方便，下面的：</p>
<ul>
<li>DRF 指的是 DjangoRestFramework</li>
<li>CBV 指的是 Class Based View</li>
<li>FBV 指的是 Function Based View</li>
</ul>
<blockquote>
<p>坐稳了，开车了。</p>
</blockquote>
<h2 id="0x01-DjangorestFramework-解读"><a href="#0x01-DjangorestFramework-解读" class="headerlink" title="0x01 DjangorestFramework 解读"></a>0x01 DjangorestFramework 解读</h2><h3 id="为什么要用-DRF-呢？"><a href="#为什么要用-DRF-呢？" class="headerlink" title="为什么要用 DRF 呢？"></a>为什么要用 DRF 呢？</h3><p>使用一个库的原因，无非就是为了：</p>
<ol>
<li>节省开发者自己造轮子的时间。</li>
<li>有利于代码的可维护性 / 或者程序的健壮性。</li>
</ol>
<p>具体落实到 DRF, 有哪些具体的优点呢？</p>
<ol>
<li>可直接浏览调试的界面。让前端调试起来欲罢不能的功能。</li>
<li>用 DRF 的方式快速批量开接口</li>
<li>分页、序列化、校验、登录、权限、Web 附加文档、限流，高度的可扩展性。哪里不爽扩展哪里，so easy</li>
<li>算的上是 Django 社区最好的 RESTFUL 框架的轮子了。</li>
<li>完善的社区支持，比如 guardian/django-filter 等等结合。</li>
</ol>
<h3 id="不使用-DRF-应该如何写-WebAPI-做呢？"><a href="#不使用-DRF-应该如何写-WebAPI-做呢？" class="headerlink" title="不使用 DRF 应该如何写 WebAPI 做呢？"></a>不使用 DRF 应该如何写 WebAPI 做呢？</h3><p>我们先看看，不使用 DRF 的时代，API 是如何编写的。</p>
<p>这里我们用 function based view 来简单说明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最简单版本</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_hello</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">        <span class="string">&quot;这就是 key&quot;</span>: <span class="string">&quot;这就是 value&quot;</span>,</span><br><span class="line">        <span class="string">&quot;时间&quot;</span>: time.time()</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>刚开始学 DRF 的时候，我也有这种疑惑，这有必要需要一个 RESTFULAPI 的框架嘛？捋起袖子，JSON API 甩起来开咯。</p>
<p>之所以得出这个结论，是因为这个例子实在是过于简单。</p>
<p>当涉及到一定复杂程度的 API 的时候，问题就来了：</p>
<ol>
<li>权限是否需要区分？</li>
<li>分页需不需要做？</li>
<li>前端人员提交 Form 表单时，只能通过命令行或者是 POSTMAN 之类的工具提交参数，这会不会带来不便？后端人员写这些表单的各个字段，也是很手酸的事情。</li>
<li>拼接字典或者是字符串倒也还好，能不能有个序列器帮我直接序列化这模型，并且如果模型和模型之间有联系，最好也可以帮我完成模型和模型之间的关联。</li>
<li>Profile API 应该如何做？</li>
</ol>
<p>这都是我们需要考虑的。</p>
<p>如果不用 DRF, 而是由后端程序员直接写这些代码的话，也不是不行。</p>
<ol>
<li>对于第一点，可以直接在 fbv 上面加装饰器。</li>
<li>对于第二点，分页的时候可以直接将逻辑写在 fbv 里面。</li>
<li>前端 er 直接使用 PostMan 之类的工具就好了。</li>
<li>序列化，可以借助内置的序列化方法。</li>
<li>Profile 可以在提交参数的时候，附加一个参数比如 debug, 渲染的时候，将使用 HTML 里面内置一个 JSON 字符串的方式渲染出来。这样的话，就可以使用 Django Debug Tools 进行 Profile 了。</li>
</ol>
<p>很显然，这是个系统性的活。 假如接下来还要考虑限流、RESTFULAPI 的设计，这就相当蛋疼了。</p>
<p>显然，我们的 FBV 就会是这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@a_authority</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">complex_hello</span>(<span class="params">request</span>):</span></span><br><span class="line">    params = getParams(request)</span><br><span class="line">    .....</span><br><span class="line">    query_results = SomeModels.some_query()</span><br><span class="line">    .....</span><br><span class="line">    results = SomeModelsSerial(query_results)</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(results)</span><br></pre></td></tr></table></figure>

<p>看起来似乎是有规律可循的，既然有规律可循，就能封装一下，减轻负担。FBV 已经这样了，显然只能每次都要硬编码这些取参数，查询，序列化。当然，如果用生成器也能简化一部分函数代码。yield 实现方法太丑还是弃用吧。</p>
<p>我们试试 CBV 看看如何。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承并重写方法</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        query_results = SomeModels.some_query()</span><br><span class="line">        .....</span><br><span class="line">        results = SomeModelsSerial(query_results)</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        query_results = SomeModels.some_query()</span><br><span class="line">        .....</span><br><span class="line">        results = SomeModelsSerial(query_results)</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里相当于 view 函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 这里处理正式处理之前的逻辑，比如权限判断。</span></span><br><span class="line">        <span class="comment"># 如果是 GET 方法，则调用</span></span><br><span class="line">        results = self.get(request, *args, **kwargs):</span><br><span class="line">        <span class="comment"># 这里处理正式处理之后的逻辑，比如统计 list 的 total 值，加上时间戳</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(results)</span><br></pre></td></tr></table></figure>

<p>于是，除了使用 FBV 进行硬编码之外，还可以使用 CBV 的基类 进行扩展定制。</p>
<p>我们思考一下：</p>
<ol>
<li>假如我想渲染某个模型的 JSON 列表，就可以定制一个 ListViewAPI 出来。如果需要一个 DetailViewAPI, 就定制一个 DetailViewAPI 出来。</li>
<li>我们再声明一些 Permission 类，序列化类，模型，然后在 dispatch 中直接使用这些东西的话，就只需要在 get 和 post 里面编写一些最核心的逻辑了。</li>
<li>甚至，指定了分页器和查询，都完全不需要再 get 和 post 里面写代码。</li>
</ol>
<p>恭喜你，读到这里，你已经可以写一个极简的 DRF 出来了。</p>
<p>但写成 DRF 这种量级的程序，还需要做很多很多事情。</p>
<h3 id="DRF-处理请求的流程"><a href="#DRF-处理请求的流程" class="headerlink" title="DRF 处理请求的流程"></a>DRF 处理请求的流程</h3><p>要知道 DRF 的处理请求的流程，就要先知道 Django 的处理请求流程。</p>
<p>宏观来看</p>
<ol>
<li>请求先经过 MiddleWare , 接着判断 urlconf （默认为 ROOT_URLCONF),</li>
<li>匹配 URL, 将请求上下文 dispatch 到具体的 view.</li>
<li>处理完毕，经过 MiddleWare</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/topics/http/urls/">https://docs.djangoproject.com/en/2.0/topics/http/urls/</a></p>
<p>在本文的结尾的时候，我也将带大家从源码角度过一下，涉及到这个流程的相关的源码。这里先跳过。</p>
<p>那么，DRF 是如何处理一个请求的呢？我们忽略路由之类的东西，直接看对应的 CBV 的源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</span><br><span class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</span><br><span class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</span><br><span class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ...... 其他方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Dispatch methods</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns the initial request object.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Request(</span><br><span class="line">            request,</span><br><span class="line">            parsers=self.get_parsers(),</span><br><span class="line">            authenticators=self.get_authenticators(),</span><br><span class="line">            negotiator=self.get_content_negotiator(),</span><br><span class="line">            parser_context=parser_context</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Runs anything that needs to occur prior to calling the method handler.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.format_kwarg = self.get_format_suffix(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform content negotiation and store the accepted info on the request</span></span><br><span class="line">        neg = self.perform_content_negotiation(request)</span><br><span class="line">        request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Determine the API version, if versioning is in use.</span></span><br><span class="line">        version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">        request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Ensure that the incoming request is permitted</span></span><br><span class="line">        self.perform_authentication(request)</span><br><span class="line">        self.check_permissions(request)</span><br><span class="line">        self.check_throttles(request)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Note: Views are made CSRF exempt from within `as_view` as to prevent</span></span><br><span class="line">    <span class="comment"># accidental removal of this exemption in cases where `dispatch` needs to</span></span><br><span class="line">    <span class="comment"># be overridden.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        `.dispatch()` is pretty much the same as Django&#x27;s regular dispatch,</span></span><br><span class="line"><span class="string">        but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        <span class="comment"># 这里需要注意</span></span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 这里需要注意</span></span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<p>可以看出，当请求到达 dispatch 的时候，DRF 添加了一些钩子函数，用于开始 / 结束 / 错误控制。</p>
<ol>
<li>在 initialize_request 的时候，对 request 进行封装，添加上 parser / auth / negoriator / parser context</li>
<li>接着在 initial 方法里面校验了版本，进行了认证和鉴权，检查了限流</li>
</ol>
<p>一看，其实与我们之前想封装 APIView 的想法不谋而合，而我们只是想想，DRF 是详细实现。</p>
<h2 id="0x02-DjangorestFramework-的使用案例"><a href="#0x02-DjangorestFramework-的使用案例" class="headerlink" title="0x02 DjangorestFramework 的使用案例"></a>0x02 DjangorestFramework 的使用案例</h2><h3 id="如何开-WebAPI-接口"><a href="#如何开-WebAPI-接口" class="headerlink" title="如何开 WebAPI 接口"></a>如何开 WebAPI 接口</h3><p>回到我们的 yadjangoblog 上面来。这个时候我们想开一个博文列表 API:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 定义序列器，用于序列化查询的每一条。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostListSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    category = BlogCategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    tags = BlogTagSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    title = serializers.CharField()</span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = BlogPost</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;char_num&#x27;</span>, <span class="string">&#x27;vote_num&#x27;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;tags&#x27;</span>, <span class="string">&#x27;publish_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 定义过滤器，可以通过过滤器进行查询</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostFilter</span>(<span class="params">filters.FilterSet</span>):</span></span><br><span class="line">    title = filters.CharFilter(lookup_expr=<span class="string">&#x27;contains&#x27;</span>)</span><br><span class="line">    having_tags = filters.Filter(name=<span class="string">&quot;tags&quot;</span>, lookup_expr=<span class="string">&#x27;in&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = BlogPost</span><br><span class="line">        fields = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;char_num&#x27;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;tags&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 指定其他设置，具体大家看源码就好了。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPostListAPIView</span>(<span class="params">generics.ListAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    依照 category , tags , 时间 （年 / 月 / 日  年 / 月 年）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = BlogPost.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BlogPostListSerializer</span><br><span class="line">    filter_backends = (filters.DjangoFilterBackend, OrderingFilter,)</span><br><span class="line">    filter_class = BlogPostFilter</span><br><span class="line">    ordering_fields = (<span class="string">&#x27;publish_date&#x27;</span>,)</span><br><span class="line">    ordering = (<span class="string">&#x27;publish_date&#x27;</span>,)</span><br><span class="line">    permission_classes = (permissions.AllowAny,)</span><br><span class="line">    pagination_class = SmallResultsSetPagination</span><br></pre></td></tr></table></figure>

<p>在指定上面的操作之后，一个接口就快速的开出来了。</p>
<p>: TODO 插入一张图</p>
<p>当然，DRF 认认真真通读一遍的话，还是可以给自己节省不少时间的。</p>
<p>这是开接口，似乎，还少了什么，比如 Restful API.</p>
<h3 id="前端如何使用-WebAPI-接口"><a href="#前端如何使用-WebAPI-接口" class="headerlink" title="前端如何使用 WebAPI 接口"></a>前端如何使用 WebAPI 接口</h3><p>什么是 CORS 可以参考阮一峰的文章 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/04/cors.html">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
<p>在调试的时候，我们肯定是使用 ajax / fetch 方式请求。这就会遇到一个问题：</p>
<ul>
<li>跨域</li>
</ul>
<p>解决方式也很简单，服务端只要服务器实现了 CORS 接口，就可以跨源通信。</p>
<p>安装 django-cors-headers, 并在 settings 中开启 CORS_ORIGIN_ALLOW_ALL = True 即可。</p>
<p>这里参考了临书的解决方案，要感谢 @临书 , 附上参考地址 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24893786">https://zhuanlan.zhihu.com/p/24893786</a></p>
<p>对于本项目而言，使用了 axios 请求库，直接 get 即可。详细看前端代码即可。</p>
<h2 id="0x03-RESTFUL-API-设计"><a href="#0x03-RESTFUL-API-设计" class="headerlink" title="0x03 RESTFUL API 设计"></a>0x03 RESTFUL API 设计</h2><p>开发过程中，尽量靠近 RESTFUL API 的设计，而不是照搬。</p>
<p>举个其他领域的例子，有的人表述美就只有：</p>
<ul>
<li>已撸</li>
</ul>
<p>但是不同的美各有各的模样：</p>
<ul>
<li>手如柔荑，肤如凝脂，领如蝤蛴，齿如瓠犀，螓首蛾眉，巧笑倩兮，美目盼兮。</li>
</ul>
<p>同样，放在 RESFUL 的时候确实也出现了这种情况：</p>
<p>几乎所有的业务逻辑最后会落实到数据表的 CURDE, 但是所有业务逻辑并不能完全使用 CRUDE 描述。</p>
<p>我们看下面的例子</p>
<h3 id="关于请求"><a href="#关于请求" class="headerlink" title="关于请求"></a>关于请求</h3><p>举个例子，RESTFUL 适合纯粹 CURDE 的设计风格。</p>
<p>比如，新增博客，更新博客，查询博客，删除博客，查看是否含有博客</p>
<p>但语义在某些场景下表述不足， 比如，设计订单的时候，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">URL: /api/v1/user/some_user/orders</span><br><span class="line">你查看订单集合，这个好理解。get 方法</span><br><span class="line">你新增订单，这个好理解。put 方法</span><br><span class="line">URL: /api/v1/user/some_user/order/xxxxxxx</span><br><span class="line">你删除订单，这个好理解。delete 方法</span><br><span class="line">你获取订单，这个好理解。get 方法</span><br><span class="line">你修改订单，这个好理解。post 方法</span><br><span class="line"></span><br><span class="line">但修改订单，有的时候可能会比较复杂，有可能是取消订单，有可能是评价订单，有可能是其他。而 RESTFUL 表达这种情况就有些语义不足了。</span><br></pre></td></tr></table></figure>

<p>当然，个人经验是，字段越多，越难靠近 RESTFUL 规范</p>
<p>这个时候，就需要设计者做好 RESTFULAPI 的设计与语义化的平衡了。</p>
<h3 id="关于响应"><a href="#关于响应" class="headerlink" title="关于响应"></a>关于响应</h3><p>关于响应设计，主要有两点需要注意：</p>
<ul>
<li>状态码 (HTTP 状态码，也业务逻辑通用状态码）</li>
<li>响应内容 包含 业务逻辑通用状态码，剩下的视具体情况而定。</li>
</ul>
<p>HTTP 状态码用于标记资源情况，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">200 表示获取资源</span><br><span class="line">404 表示 NOT FOUND</span><br></pre></td></tr></table></figure>

<p>但有时候也存在语义表达不足问题，一般前后端也会约定一个通用的状态码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">通用状态码 错误信息 含义 HTTP 状态码</span><br><span class="line">999	    unknow_v2_error	未知错误	400</span><br><span class="line">1000	need_permission	需要权限	403</span><br><span class="line">1001	uri_not_found	资源不存在	404</span><br><span class="line">1002	missing_args	参数不全	400</span><br><span class="line">1003	image_too_large	上传的图片太大	400</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>至于响应内容，一般都是见招拆招的。建议查看文章末尾的 Douban 的相关 API 规范来提升姿势。</p>
<h2 id="0x04-Django-的处理请求流程代码解读"><a href="#0x04-Django-的处理请求流程代码解读" class="headerlink" title="0x04 Django 的处理请求流程代码解读"></a>0x04 Django 的处理请求流程代码解读</h2><p>这小节属于一时兴起写的番外篇。和本文主体内容没啥必要的关联。不感兴趣的可以直接跳转到文章末尾点赞哈。</p>
<p>WSGI 全称叫做 web 服务器网关接口，通常情况下，gunicorn 或者 uwsgi 接收来自 nginx 转发来的请求之后，向 web app 提供了环境信息（叫请求上下文会不会好些）以及一个 callback. 这样的话，web app 就可以接收这个环境信息，处理完毕，通过回调函数处理请求，并返回响应。一个极简的 webapp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span>(<span class="params">environ, start_response</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Simplest possible application object&quot;&quot;&quot;</span></span><br><span class="line">    data = <span class="string">&#x27;Hello, World!\n&#x27;</span></span><br><span class="line">    status = <span class="string">&#x27;200 OK&#x27;</span></span><br><span class="line">    response_headers = [</span><br><span class="line">        (<span class="string">&#x27;Content-type&#x27;</span>,<span class="string">&#x27;text/plain&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;Content-Length&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    ]</span><br><span class="line">    start_response(status, response_headers)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">iter</span>([data])</span><br></pre></td></tr></table></figure>

<p>现在我们看看 django 中是如何处理请求的。首先查看相关的 wsgi.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wsgi.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> django.core.wsgi <span class="keyword">import</span> get_wsgi_application</span><br><span class="line">os.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;config.settings&quot;</span>)</span><br><span class="line">application = get_wsgi_application()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接着查看 get_wsgi_application</span></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django.core.handlers.wsgi <span class="keyword">import</span> WSGIHandler</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_wsgi_application</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The public interface to Django&#x27;s WSGI support. Return a WSGI callable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Avoids making django.core.handlers.WSGIHandler a public API, in case the</span></span><br><span class="line"><span class="string">    internal WSGI implementation changes or moves in the future.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> WSGIHandler()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 于是自然而言的看到了 WSGIHandler</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIHandler</span>(<span class="params">base.BaseHandler</span>):</span></span><br><span class="line">    request_class = WSGIRequest</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(*args, **kwargs)</span><br><span class="line">        self.load_middleware()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        <span class="comment"># 有木有看到 environ 和 start_response ?? 这就是极简 web app 中的 webapp 核心方法。</span></span><br><span class="line">        set_script_prefix(get_script_name(environ))</span><br><span class="line">        signals.request_started.send(sender=self.__class__, environ=environ)</span><br><span class="line">        request = self.request_class(environ)</span><br><span class="line">        <span class="comment"># 注意这一行，有请求处理逻辑 具体要见下面代码</span></span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">        <span class="comment"># ......</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>嗯，看到了子类，就要看看基类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span>:</span></span><br><span class="line">    _request_middleware = <span class="literal">None</span></span><br><span class="line">    _view_middleware = <span class="literal">None</span></span><br><span class="line">    _template_response_middleware = <span class="literal">None</span></span><br><span class="line">    _response_middleware = <span class="literal">None</span></span><br><span class="line">    _exception_middleware = <span class="literal">None</span></span><br><span class="line">    _middleware_chain = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_middleware</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        注册 MiddleWare, 并赋值 _middleware_chain 方法，使之调用的时候可以先按照顺序从 setting 的 middleware 里面处理 requests</span></span><br><span class="line"><span class="string">        并在处理 request 的最后调用 私有方法 _get_response</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self._request_middleware = []</span><br><span class="line">        self._view_middleware = []</span><br><span class="line">        self._template_response_middleware = []</span><br><span class="line">        self._response_middleware = []</span><br><span class="line">        self._exception_middleware = []</span><br><span class="line"></span><br><span class="line">        handler = convert_exception_to_response(self._get_response)</span><br><span class="line">        <span class="comment"># 注意，这里面是倒着来的 代码中越在前面，实际运行的时候处理就越在后面</span></span><br><span class="line">        <span class="keyword">for</span> middleware_path <span class="keyword">in</span> <span class="built_in">reversed</span>(settings.MIDDLEWARE):</span><br><span class="line">            <span class="comment"># 依次添加 view middleware / template middleware / exception middleware</span></span><br><span class="line">            middleware = import_string(middleware_path)</span><br><span class="line">            mw_instance = middleware(handler)</span><br><span class="line">            handler = convert_exception_to_response(mw_instance)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We only assign to this when initialization is complete as it is used</span></span><br><span class="line">        <span class="comment"># as a flag for initialization being complete.</span></span><br><span class="line">        self._middleware_chain = handler</span><br><span class="line"></span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_response</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return an HttpResponse object for the given HttpRequest.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Setup default url resolver for this thread</span></span><br><span class="line">        set_urlconf(settings.ROOT_URLCONF)</span><br><span class="line"></span><br><span class="line">        response = self._middleware_chain(request)</span><br><span class="line">        <span class="comment"># ......</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_response</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Resolve and call the view, then apply view, exception, and</span></span><br><span class="line"><span class="string">        template_response middleware. This method is everything that happens</span></span><br><span class="line"><span class="string">        inside the request/response middleware.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        response = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 接着判断 urlconf （默认为 ROOT_URLCONF), 可以通过 middleware 进行设置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(request, <span class="string">&#x27;urlconf&#x27;</span>):</span><br><span class="line">            urlconf = request.urlconf</span><br><span class="line">            set_urlconf(urlconf)</span><br><span class="line">            resolver = get_resolver(urlconf)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            resolver = get_resolver()</span><br><span class="line"></span><br><span class="line">        resolver_match = resolver.resolve(request.path_info)</span><br><span class="line">        callback, callback_args, callback_kwargs = resolver_match</span><br><span class="line">        request.resolver_match = resolver_match</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Apply view middleware....</span></span><br><span class="line">        <span class="comment"># 注意，这个就是 view 函数</span></span><br><span class="line">        wrapped_callback = self.make_view_atomic(callback)</span><br><span class="line">        response = wrapped_callback(request, *callback_args, **callback_kwargs)</span><br><span class="line">        <span class="comment"># Complain if the view returned None (a common error).</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception_by_middleware</span>(<span class="params">self, exception, request</span>):</span></span><br><span class="line">        <span class="comment"># ......</span></span><br></pre></td></tr></table></figure>

<p>上面代码比较表达的意思比较简单，值得注意的地方我都加了注释。</p>
<p>需要特别注意的就是 middleware_chain 这个属性（实际上是一个方法）, 正是这个方法使得注册的 middleware （在 load_middleware 方法里）可以在 fbv 或者 cbv 处理 request 之前，通过对 request 进行处理。</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE. 参考链接"></a>0xEE. 参考链接</h2><p>还犹豫啥，Django 前后端分离最佳实践，点赞后，快上车吧</p>
<ul>
<li>前端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaVueBlog">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></li>
<li>扩展阅读之 douban restful api 设计  <a target="_blank" rel="noopener" href="https://developers.douban.com/wiki/?title=api_v2">https://developers.douban.com/wiki/?title=api_v2</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-22</strong> 开启本文</li>
<li><strong>2018-03-04</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/02/23/YaDjangoBlog%E4%B9%8B%E5%89%8D%E7%AB%AFVueJS%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/02/23/YaDjangoBlog%E4%B9%8B%E5%89%8D%E7%AB%AFVueJS%E7%AF%87/" class="post-title-link" itemprop="url">YaDjangoBlog 之 前端 VueJS 篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-02-23 10:13:30" itemprop="dateCreated datePublished" datetime="2018-02-23T10:13:30+08:00">2018-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-03-18 11:20:11" itemprop="dateModified" datetime="2018-03-18T11:20:11+08:00">2018-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>本文是 Django 全栈开发教程的第四篇</p>
<p>目录在这里，已经更新的文章如下</p>
<ul>
<li>Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的开发环境配置</li>
</ul>
<p>本文需要完成三件事情：</p>
<ul>
<li>第一件事情，介绍为什么选择 VueJS？</li>
<li>第二件事情，介绍 Vue 项目的一些注意点。</li>
<li>第三件事情，蜻蜓点水搬的带大家过一编，YaDjangoBlog 前端的项目结构，静态资源管理，路由以及组件。</li>
</ul>
<h2 id="0x01-为什么是-VueJS"><a href="#0x01-为什么是-VueJS" class="headerlink" title="0x01 为什么是 VueJS"></a>0x01 为什么是 VueJS</h2><p>国产框架 + 语法简洁是我入坑 VueJS 初衷。</p>
<p>后来却是 Vue 的丰富的生态和简洁的语法吸引了继续用下去。</p>
<p>这里要感谢为 VueJS 持续贡献代码的人，从 Vue 本身，到 VueCLI, 到 Router, 到 VueX, 如果没有那么多人为之贡献代码，可能今天这一小节就变成了，『为什么是 React 了』逃。</p>
<p>Vue 自称为 Vue 渐进式 JavaScript 框架。</p>
<p>什么是渐进式？</p>
<p>就是你可以逐步按照 Vue 的方式逐渐引入一些 Vue 的组件到项目中。没有必要上来就是 Vue 全家桶，依据场景逐步引入。</p>
<p>参考链接 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/51907207">https://www.zhihu.com/question/51907207</a></p>
<p>然而，依据我的经验，vue 全家桶用起来还是很舒服的。这里必须要感谢 Vue 社区。</p>
<p>模板语法，数据驱动，双向绑定。写起代码来简直就是一个字，爽。</p>
<h2 id="0x02-Vue-项目的一些注意点"><a href="#0x02-Vue-项目的一些注意点" class="headerlink" title="0x02 Vue 项目的一些注意点"></a>0x02 Vue 项目的一些注意点</h2><p>从项目角度，我们想想前端项目有哪些地方是需要注意的：</p>
<ol>
<li>开发环境和线上环境区分</li>
<li>前端资源打包</li>
</ol>
<ul>
<li>Vue 项目资源打包</li>
<li>DLL 打包</li>
<li>字体文件打包</li>
</ul>
<ol start="3">
<li>CSS/JS 如何管理</li>
<li>有哪些必要的依赖，如何引入第三方库</li>
<li>有哪些页面级组件，有哪些小组件？应该安排这些组件？组件与组件应该怎么通讯？</li>
<li>路由怎么管理</li>
<li>状态怎么管理</li>
<li>登录，鉴权怎么做</li>
</ol>
<p>限于篇幅，我就不一一讲解了。挑在 YaDjangoBlog 中使用到的技术简单介绍一下。</p>
<p>再次感谢 Vue 社区出品的 VueCLI 以及 Webpack 模板。</p>
<p>下面依次介绍：</p>
<ol>
<li>项目结构</li>
<li>静态资源管理</li>
<li>路由</li>
<li>组件</li>
</ol>
<h2 id="0x03-项目结构"><a href="#0x03-项目结构" class="headerlink" title="0x03 项目结构"></a>0x03 项目结构</h2><p>首先，YaDjangoBlog 文件的前端目录如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── build</span><br><span class="line">│   ├── build.js</span><br><span class="line">│   ├── build_iconfont.js <span class="comment"># 构建 iconfont 脚本</span></span><br><span class="line">│   ├── check-versions.js</span><br><span class="line">│   ├── logo.png</span><br><span class="line">│   ├── utils.js</span><br><span class="line">│   ├── vue-loader.conf.js</span><br><span class="line">│   ├── webpack.base.conf.js</span><br><span class="line">│   ├── webpack.dev.conf.js <span class="comment"># 增加了 AutoDllPlugin 用于自动打包 DLL</span></span><br><span class="line">│   └── webpack.prod.conf.js</span><br><span class="line">├── config</span><br><span class="line">│   ├── dev.env.js <span class="comment"># 可以在这里添加开发环境的环境变脸</span></span><br><span class="line">│   ├── index.js</span><br><span class="line">│   ├── prod.env.js</span><br><span class="line">│   └── test.env.js</span><br><span class="line">├── extra</span><br><span class="line">│   └── svg-icon <span class="comment"># 这里存放需要生成 iconfont 的字体文件。</span></span><br><span class="line">├── index.html</span><br><span class="line">├── package.json <span class="comment"># 这里添加了一些构建脚本</span></span><br><span class="line">├── packages</span><br><span class="line">│   └── theme-future <span class="comment"># 注意，这里是另一个子项目，使用 Gulp 构建的纯 CSS 子项目。</span></span><br><span class="line">├── src</span><br><span class="line">│   ├── App.vue</span><br><span class="line">│   ├── api <span class="comment"># 对 axios 进行初步封装</span></span><br><span class="line">│   ├── assets <span class="comment"># 从使用 Gulp 生成的 CSS 可以放在这里。</span></span><br><span class="line">│   ├── components <span class="comment"># 跨页面的组件放在这里</span></span><br><span class="line">│   ├── directives <span class="comment"># 指令</span></span><br><span class="line">│   ├── filters    <span class="comment"># 过滤器</span></span><br><span class="line">│   ├── main.js    <span class="comment"># 初始化 Vue 实例</span></span><br><span class="line">│   ├── pages      <span class="comment"># 页面</span></span><br><span class="line">│   ├── router     <span class="comment"># 路由</span></span><br><span class="line">│   ├── store      <span class="comment"># vuex</span></span><br><span class="line">│   └── utils      <span class="comment"># 常用工具类</span></span><br><span class="line">├── static</span><br><span class="line">│   ├── hightlight <span class="comment"># hightlight 脚本</span></span><br><span class="line">│   ├── iconfont   <span class="comment"># 本地构建的 iconfont</span></span><br><span class="line">│   ├── images</span><br><span class="line">│   └── js</span><br><span class="line">├── <span class="built_in">test</span>           <span class="comment"># 没写测试，大家开源项目不要学我.... 逃</span></span><br><span class="line">│   ├── e2e</span><br><span class="line">│   └── unit</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure>

<h2 id="0x04-静态资源管理"><a href="#0x04-静态资源管理" class="headerlink" title="0x04 静态资源管理"></a>0x04 静态资源管理</h2><p>静态资源管理，主要涉及到 JS/CSS/ 图片 / 字体</p>
<p>首先，由于使用了 VueCli 的模板，所以大可以按照 VueCli 提供的写法来写。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Header</span>&gt;</span><span class="tag">&lt;/<span class="name">Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Footer</span>&gt;</span><span class="tag">&lt;/<span class="name">Footer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">&#x27;app&#x27;</span>,</span></span><br><span class="line">  components: &#123;</span><br><span class="line"><span class="javascript">    Header: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./pages/commons/Header.vue&#x27;</span>),</span></span><br><span class="line"><span class="javascript">    Footer: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./pages/commons/Footer.vue&#x27;</span>),</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span>&gt;</span></span><br><span class="line">  $primary-color: #37b24d;</span><br><span class="line">  $dark-color: #2b5732;</span><br><span class="line">  $body-bg: #f9f9f9;</span><br><span class="line"><span class="css">  <span class="keyword">@import</span> <span class="string">&#x27;~spectre.css/src/spectre-icons.scss&#x27;</span>;</span></span><br><span class="line"><span class="css">  <span class="keyword">@import</span> <span class="string">&#x27;~spectre.css/src/spectre.scss&#x27;</span>;</span></span><br><span class="line"><span class="css">  <span class="keyword">@import</span> <span class="string">&#x27;~spectre.css/src/spectre-exp.scss&#x27;</span>;</span></span><br><span class="line"><span class="css">  <span class="keyword">@import</span> <span class="string">&#x27;./assets/theme-future/index.css&#x27;</span>;</span></span><br><span class="line">  a &#123;</span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:focus</span>,</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:hover</span>,</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:active</span>,</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-class">.active</span> &#123;</span></span><br><span class="line">      text-decoration: none;</span><br><span class="line">      box-shadow: 0 0 0 0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依据我个人经验，做了一部分的微调：</p>
<p><strong>第一</strong> 在代码中新建一个主题 CSS, 单独用于处理 SCSS 编译 CSS. 即除了 App.vue, 其他地方的 CSS 直接写在同一个地方。</p>
<p><strong>第二</strong> 对于字体文件，不引入 IconFont 在线字体，而是使用 SVG 本地编译字体。这样减少对 iconfont cdn 的依赖，可以以后直接迁移这个字体到其他 CDN 上。</p>
<p><strong>第三</strong> 对于依赖库管理，分为 npm 依赖库和外部 JS 依赖库两种</p>
<p>对于 NPM 依赖库，如果有使用过 ECharts3.0 的 SPA 开发者应该对于万恶的 DLL 非常熟悉了。最早的时候，我们是这样做的：</p>
<ul>
<li>先写一个编译脚本，指定相关依赖包，打包出 dll 和一个 manifest 文件</li>
<li>然后从 index.html 里引入打包好的 dll.</li>
<li>再从 webpack 的配置文件中引入这个文件。</li>
</ul>
<p>这种恶心的配置随着 autodll-webpack-plugin 的出现从而得到缓解，于是现在的你只需要配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> AutoDllPlugin(&#123;</span><br><span class="line">  inject: <span class="literal">true</span>, <span class="comment">// will inject the DLL bundles to index.html</span></span><br><span class="line">  debug: <span class="literal">true</span>,</span><br><span class="line">  filename: <span class="string">&#x27;[name]_[hash].js&#x27;</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    vendor: [</span><br><span class="line">      <span class="string">&#x27;@antv/data-set&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@antv/g2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@antv/g6&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;highlight.js&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-abbr&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-deflist&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-emoji&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-footnote&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-ins&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-katex&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-mark&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-sub&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-sup&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-task-lists&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;markdown-it-toc-and-anchor&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;typed.js&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;vue&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;vue-router&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [<span class="keyword">new</span> webpack.optimize.UglifyJsPlugin()],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>当然，如果你用了 ECharts, 有的时候会出现莫名其妙的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__DEV__ is not defined</span><br></pre></td></tr></table></figure>

<p>解决方法就是在这上面的插件里面加个插件定义一个 Global 的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new webpack.DefinePlugin(&#123;</span><br><span class="line">  __DEV__: false</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS: 去年的版本由于依赖库的一个路径问题导致 autodll-webpack-plugin 不能在 Windows 上使用，今年可以啦。还不快快用起来？</p>
</blockquote>
<p>对于外部的 JS/CSS 依赖库：</p>
<ol>
<li>直接拷贝到 static 下面，然后从 index.html 引入即可。</li>
<li>动态创建 script 标签（比如动态引入高德地图）</li>
</ol>
<h2 id="0x04-路由"><a href="#0x04-路由" class="headerlink" title="0x04 路由"></a>0x04 路由</h2><p>博客项目，实际上路由比较简单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">export default new Router(&#123;</span><br><span class="line">  mode: &#39;history&#39;,</span><br><span class="line">  base: &#39;&#x2F;&#39;,</span><br><span class="line">  &#x2F;&#x2F; 注释掉这里是因为和引入的 smooth-scroll 冲突</span><br><span class="line">  &#x2F;&#x2F; scrollBehavior (to, from, savedPosition) &#123;</span><br><span class="line">  &#x2F;&#x2F;   return &#123; x: 0, y: 0 &#125;</span><br><span class="line">  &#x2F;&#x2F; &#125;,</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;&#39;,</span><br><span class="line">      name: &#39;home&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Home.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x2F;&#x2F; 解决手贱带来的问题</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;index:suffix*&#39;,</span><br><span class="line">      name: &#39;index&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Home.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;blog&#39;,</span><br><span class="line">      name: &#39;blog&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Blog.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;blog&#x2F;post&#x2F;:title&#39;,</span><br><span class="line">      name: &#39;post&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Blog&#x2F;ArticlePost.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;blog&#x2F;:category(category&#x2F;\\d+)?&#x2F;:tags(tags&#x2F;\\d+)?&#x2F;:page(page&#x2F;\\d+)?&#39;,</span><br><span class="line">      name: &#39;blogposts&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Blog.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;archive&#39;,</span><br><span class="line">      name: &#39;archive&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Archive.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;gallery&#39;,</span><br><span class="line">      name: &#39;gallery&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Gallery.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;works&#39;,</span><br><span class="line">      name: &#39;works&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;Works.vue&#39;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: &#39;&#x2F;about&#39;,</span><br><span class="line">      name: &#39;about&#39;,</span><br><span class="line">      component: () &#x3D;&gt; import(&#39;..&#x2F;pages&#x2F;About.vue&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>除了 import 语法之外，需要注意的就是 ‘/blog/:category(category/\d+)?/:tags(tags/\d+)?/:page(page/\d+)?’ 这个奇怪的表达式。</p>
<p>这个表达式可以用于匹配下面的路由</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/blog/category/1/tags/2/page/3</span><br><span class="line">/blog/category/1/page/3</span><br><span class="line">/blog/tags/3/page/3</span><br><span class="line">/blog/page/3</span><br></pre></td></tr></table></figure>

<p>匹配完毕之后，就可以拿到 categroy tags page 的值然后提交数据库拿数据咯。</p>
<h2 id="0x05-组件"><a href="#0x05-组件" class="headerlink" title="0x05 组件"></a>0x05 组件</h2><p>博客里面需要注意的就三个组件</p>
<ul>
<li>ArticlePost 组件</li>
<li>分页组件</li>
<li>打字终端组件</li>
</ul>
<p>第一个，ArticlePost 组件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;p-article-post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-1 hide-xl&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-2 col-xl-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-sidebar&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>本文目录<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;articleToc&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-6 col-xl-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ArticleCard</span> <span class="attr">:article</span>=<span class="string">&quot;article&quot;</span> @<span class="attr">articleTocReady</span>=<span class="string">&quot;initArticleToc&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ArticleCard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-2 col-xl-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-sidebar&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>公告<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              MG 的编程小屋，其实就是我整理笔记，写写文章的地方。</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              专注 Python / JavaScript , 爱折腾的全干工程师 (Full Stuff Engineer)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              如果我的文章给您的日常开发带来很大帮助的话</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              您可以关注我的公众号</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/mp_wechat.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 200px&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              也可以扫描二维码进行投喂</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/tips_wechat.jpeg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 200px&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              听说关注或者进行投喂的人，技术都越来越牛咯。</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-1 hide-xl&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123;fetchBlogPost&#125; <span class="keyword">from</span> <span class="string">&#x27;../../api/blog&#x27;</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    name: <span class="string">&#x27;BlogPage&#x27;</span>,</span></span><br><span class="line">    components: &#123;</span><br><span class="line"><span class="javascript">      ArticleCard: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;../../components/Common/ArticleCard.vue&#x27;</span>),</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">        article: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="javascript">        articleToc: <span class="literal">undefined</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line"><span class="javascript">      <span class="string">&#x27;$route.params&#x27;</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.initArticle()</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.initArticle()</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      initArticleToc: <span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.articleToc = v;</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      initArticle: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> title = <span class="built_in">this</span>.$route.params.title;</span></span><br><span class="line"><span class="javascript">        fetchBlogPost(title).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="built_in">this</span>.article = res;</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>嗯，其实就是监听 url, 如果匹配上 url 的话，从 url 中取 title, 然后发送请求，接着取回响应的内容交给子组件处理。子组件处理完毕会 emit 出一个 toc 的值，将这个值赋值给左侧 toc 即可。</p>
<ul>
<li>分页组件</li>
</ul>
<p>见地址吧  <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaVueBlog/blob/master/src/components/Common/Pagination.vue">https://github.com/twocucao/YaVueBlog/blob/master/src/components/Common/Pagination.vue</a></p>
<ul>
<li>打字终端组件</li>
</ul>
<p>终端的样式，当然是抄别人的 CSS, 打字效果，来源于 typed.js 依赖库</p>
<h2 id="0x06-扩展"><a href="#0x06-扩展" class="headerlink" title="0x06. 扩展"></a>0x06. 扩展</h2><p>对于其他的实现，自然是要多多看代码咯。</p>
<p>其实前端工程化是一个很广的概念，本文没有提到代码风格、团队开发工作流、CSS 编写规范、组件优化、Webpack 详细配置等等。这都需要在日常开发中多多练习的。</p>
<p>笔者最近换了份工作，以 React 为技术栈。 加上篇幅和精力有限，也就是不在以 Vue 为前端这一块详细展开了。</p>
<p>下面的文章还是聚焦在后端上面。</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE. 参考链接"></a>0xEE. 参考链接</h2><p>还犹豫啥，Django 前后端分离最佳实践，点赞后，快上车吧</p>
<ul>
<li>前端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaVueBlog">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-03-18</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/02/23/YaDjangoBlog%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%9D%E6%AD%A5%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/02/23/YaDjangoBlog%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%9D%E6%AD%A5%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">YaDjangoBlog 的前后端设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-02-23 10:13:30" itemprop="dateCreated datePublished" datetime="2018-02-23T10:13:30+08:00">2018-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-03-18 14:59:27" itemprop="dateModified" datetime="2018-03-18T14:59:27+08:00">2018-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>本文是 Django 全栈开发教程的第二篇</p>
<p>目录在这里，已经更新的文章如下</p>
<ul>
<li>Django 全栈开发教程 - 2018 年不容错过的 Django 全栈项目 – 目录篇</li>
<li>Django 全栈开发教程 - YaDjangoBlog 的开发环境配置</li>
</ul>
<p>本文需要完成两件事情：</p>
<ul>
<li>第一件事情，回答一个问题：为什么要选择博客系统作为教程而不是别的？</li>
<li>第二件事情，简单说说 YaDjangoBlog 的前后端设计。</li>
</ul>
<h2 id="0x01-为什么是博客系统"><a href="#0x01-为什么是博客系统" class="headerlink" title="0x01 为什么是博客系统"></a>0x01 为什么是博客系统</h2><p>在目录评论区，有个读者问：</p>
<p>为什么选择博客系统？而不是别的系统？</p>
<p>一言以蔽之：因为合适。</p>
<p>为什么说合适？</p>
<ol>
<li>第一点：代码量相对合适，业务逻辑大家都很清楚，博客系统说简单也简单，说复杂也复杂，待会我们就可以谈到。简单的例子反而是入门和深入了解 Django 技术栈（而不是设计一个优秀的程序）的最佳案例。</li>
<li>第二点：言简意赅，知识点覆盖全面，注意，我们要学习的 Django 技术栈，Django 技术栈，Django 技术栈。不是学高可用架构设计，不是超级复杂系统的设计，不是业务逻辑设计。</li>
<li>第三点：日常开发都是见招拆招，依据业务逻辑来，作为开发者，总不能直接把公司的业务代码上传的 Github 上吧？</li>
</ol>
<p>不妨想想，其实写个博客系统压根就不需要这么麻烦的使用各种组件来给自己的博客系统贴金。那么，我为何还是要『为赋新词强说愁』呢？</p>
<p>答案是『醉翁之意不在酒，在乎山水之间』。通过这个简单的博客，来带大家过一遍 Django 技术栈，具体能学的多好，看个人努力。</p>
<p>当然，借此也吐槽一下，有的人认为，博客系统简单，不就是 Blog / Category / Tag / Comment，有啥可练手的？</p>
<p>其实不然，设计一个博客系统完全可以按照复杂系统的高标准来设计，举例来说：</p>
<ol>
<li>ORM 设计：如果我想把 Category/Tags/Comment 变成通用的，即可以对 Blog 进行分类 / 标签 / 评论，对新建的 Product 模型 也可以进行分类 / 标签 / 评论。</li>
<li>数据库设计：Category 可能有三到四级子分类怎么办？ Comment 支持评论区互相回复评论。这里的不但要通用，还要用树形结构实现放在一张表里面。</li>
<li>全文搜索：Blog 的 content 字段是长文对吧？这个总不能每次搜索都是 like 查询吧？Elasticsearch 怎么搞。</li>
<li>缓存和定时任务：PV 和 UV 量总不能每次访问都更新一次数据库吧？为什么不用 Redis 呢？用上了 Redis, 为什么不加上定时任务呢帮忙把 PV/UV 以及点赞数量啥的定期更新到数据库中？</li>
<li>Celery ：定时任务为啥不用神器 Celery 呢？</li>
<li>其他问题：如何对某个接口进行 profile? 如果逻辑比较复杂，是不是要补上单元测试。Django 单实例如何使用多域名？</li>
</ol>
<p>那一套太祖长拳从宋兵甲手里使出来，不过是威力平平；</p>
<blockquote>
<p>如果是从那乔峰手里使出来，那威力如何？</p>
</blockquote>
<h2 id="0x02-前后端分离"><a href="#0x02-前后端分离" class="headerlink" title="0x02 前后端分离"></a>0x02 前后端分离</h2><h3 id="前后端分离的必要性"><a href="#前后端分离的必要性" class="headerlink" title="前后端分离的必要性"></a>前后端分离的必要性</h3><p>为什么前后端分离？</p>
<ul>
<li>一是需求：简简单单的套模板已经不够了，还要富交互，代码量上去了。</li>
<li>二是技术条件成熟：NodeJS 横空出世，使得 JS 成了不仅仅可以在浏览器中运行的语言，成了一门和 Java,Python,Ruby 一样的客户端语言。</li>
<li>三是生态：轮子多，这车轱辘如你所愿。</li>
</ul>
<p>前端的职责变重，代码量则上来了，相应的，模块化工具就自然出来了。</p>
<blockquote>
<p>PS: 前后端分离也不是啥新概念，当年开发客户端的不也是前后端分离？ 当然，这里的前后端分离指的是浏览器与服务器的前后端分离。</p>
</blockquote>
<p>前后端分离之后，依旧是前端发送请求，后端返回对应的数据。</p>
<p>那么，哪里变了？我认为，主要有两点：</p>
<ol>
<li>前后端流程可以并行开发，即前后端可以同时干活。并且责任明确。</li>
<li>JS 可以干客户端语言干的事情。</li>
</ol>
<p>以前，我们都是由美工设计页面，前端开发模板，后端开发 API, 前端再套 API, 再交给后端，后端接过前端的页面套模板。一切看起来是那么的和谐。</p>
<p>但是，就是这么一个看起来一个简单的套模板 / 开发 API，就是一个时间黑洞。</p>
<p>比如说：</p>
<ul>
<li>小美（美工）设计好设计稿，交给小钱（前端）</li>
<li>小钱完成前端页面的设计，</li>
<li>小侯（后端）开发 API,</li>
<li>小钱套 API 后，完成页面设计，并将这个页面交给小侯</li>
<li>小侯要做的事情，把小钱的前端页面切分成模板引擎里面的语法，从数据库里面取数据，交给模板引擎渲染，完成套前端页面流程。</li>
</ul>
<p>接着，产品经理跳出来，指出页面设计中有两个地方需要优化，于是：</p>
<p>大家面临的选择就只有两个：</p>
<ol>
<li>合起伙来，解决掉产品经理</li>
<li>大家在反反复复，迂迂回回的需求变更、BUG 解决、调试中，浪费了一些不应该浪费的时间。</li>
</ol>
<p>那么前后端分离了，前后端的开发就如同客户端开发和服务端开发一样：</p>
<ul>
<li><p>前端 / 客户端 负责路由，负责什么时候请求什么 API, 该去优化性能就去优化性能。</p>
</li>
<li><p>后端 / 服务端 负责折腾后端组件，优化性能。</p>
</li>
<li><p>如果调页面，直接找前端去就好了。</p>
</li>
<li><p>如果是数据或者 API 有问题，直接找后端就好了。</p>
</li>
</ul>
<p>这么一分，其实职责就好界定了很多，由于修改与优化不会引发两个工种的交叉合作（前端改完，后端套模板）,BUG 率就减少了很多。</p>
<blockquote>
<p>PS: 其实职责好界定很多，但不能避免推锅。</p>
</blockquote>
<p>由于本博客只关注 Django 技术栈，而所谓使用 JavaScript 前后端通吃的『大前端』, 则不在我们的讨论范围之内。</p>
<blockquote>
<p>比起使用一门语言前后端通吃，笔者还是比较倾向于『见人说人话，见鬼说鬼话』, 即使用多种语言，去处理合适的问题的。</p>
</blockquote>
<h3 id="前后端分离的成本"><a href="#前后端分离的成本" class="headerlink" title="前后端分离的成本"></a>前后端分离的成本</h3><p>前后端分离并不是没有代价的。</p>
<p>对于前端：</p>
<ul>
<li>首次页面 Loading 速度</li>
<li>JWT 认证请求</li>
<li>在特定场景下，有些看起来在多页面开发过程中比较简单的事情，反而比较复杂。</li>
<li>需要注意内存的使用率。</li>
</ul>
<p>对于后端：</p>
<ul>
<li>JWT 认证响应，以前是 session 认证，而且 Django 都给你实现好了。现在变了，往往大家使用的都是 JWT 作为认证。</li>
</ul>
<p>但这些成本相比与节省的开发时间相比都是微不足道的。</p>
<p>当然，我会在本系列的后面抽出一篇教程来专门讲解 Django 内置用户的扩展和前后端分离的登录认证。</p>
<h2 id="0x03-博客系统设计"><a href="#0x03-博客系统设计" class="headerlink" title="0x03 博客系统设计"></a>0x03 博客系统设计</h2><p>这个博客最初要解决的问题是：</p>
<ol>
<li>hexo 用腻了，想自己写一个简单的博客系统。</li>
<li>这个博客要可以导入文章，我不需要编辑器功能，在本地编辑完毕之后，导入数据库就好。</li>
</ol>
<h3 id="页面构成"><a href="#页面构成" class="headerlink" title="页面构成"></a>页面构成</h3><ol>
<li>首页</li>
<li>博客列表页</li>
<li>博客存档页</li>
<li>博客历史页</li>
<li>博客详情页</li>
<li>关于我页面</li>
</ol>
<h3 id="模型构成"><a href="#模型构成" class="headerlink" title="模型构成"></a>模型构成</h3><p>首先 M 模型层</p>
<ol>
<li>PostgreSQL : 博文 / 博文类型 / 博文标签</li>
<li>Elasticsearch : 博文</li>
<li>Redis : 每篇博文的阅读量，点赞量</li>
</ol>
<p>这里需要注意的是：</p>
<ul>
<li>第一：博文类型-博文：1 对多，博文标签-博文：多对多</li>
<li>第二：博文中的 content 为文章内容，即可以在 Elasticsearch 中作为全文搜索的字段。具体降到 Elasticsearch 的时候我们会详细说明。</li>
<li>第三：博文中的 阅读量和点赞量放在 Redis 里面，由 Celery 的定时任务定期刷到内存中。</li>
</ul>
<p>再考虑 VT 视图模板层，VT 层，会根据情况 DjangorestFramework 来进行序列化和反序列化。</p>
<p>在设计模型的时候，尽量将涉及到模型的操作放在模型内。</p>
<p>关于如何设计更好的模型，在以后的文章将会讲解，先挖个坑。</p>
<h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p>理想环境中，我们的架构图如下：</p>
<p>哦，不好意思，放错图了，是这样的。</p>
<p>但这样的架构应该有专门的人来维护。</p>
<p>于是在人力有限的情况下，本项目的架构图是这样的。</p>
<p>哦，不好意思，放错图了，是这样的。</p>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE. 参考链接"></a>0xEE. 参考链接</h2><p>还犹豫啥，Django 前后端分离最佳实践，点赞后，快上车吧</p>
<ul>
<li>前端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaVueBlog">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-22</strong> 开启本文</li>
<li><strong>2018-02-27</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://twocucao.xyz/2018/02/22/YaDjangoBlog%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Micheal Gardner">
      <meta itemprop="description" content="Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MG的编程小屋">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/02/22/YaDjangoBlog%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">YaDjangoBlog 开发环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2018-02-22 10:13:30 / Modified: 12:49:04" itemprop="dateCreated datePublished" datetime="2018-02-22T10:13:30+08:00">2018-02-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>本文是 Django 全栈开发教程的第一篇，上一篇是第零篇，目录会随时更新，地址在这里 2018 年不容错过的 Django 全栈项目 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33903527">https://zhuanlan.zhihu.com/p/33903527</a></p>
<blockquote>
<p>为什么是第零篇，因为程序员从零计数呀。笑~~</p>
</blockquote>
<p>本文需要完成两件事情：</p>
<ul>
<li>配置基本的开发环境</li>
<li>让代码先运行一下</li>
</ul>
<p>如果你使用的 macOS, 那么可以跟着下文一步一步走。如果是 linux/window 用户，可能稍微需要在配置环境上多花点时间。</p>
<blockquote>
<p>本文默认你至少会在 iTerm2 下面使用基本的 bash 命令与 git , 如果使用的 ohmyzsh 就更好了。 建议先参考请查看我之前的文章里面的配置环境 如何优雅地使用 macOS <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/29892969">https://zhuanlan.zhihu.com/p/29892969</a></p>
</blockquote>
<h2 id="0x01-Python-开发环境配置"><a href="#0x01-Python-开发环境配置" class="headerlink" title="0x01 Python 开发环境配置"></a>0x01 Python 开发环境配置</h2><p>本小节的目的就是配置好基本的 python 开发环境</p>
<p>使用了神器 pyenv</p>
<blockquote>
<p>BTW: 为什么不直接用 pipenv ? 因为网络不通畅，如若不然，pipenv 比 pyenv 更适合用来做 python 依赖包管理。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新开终端</span></span><br><span class="line">git clone https://github.com/yyuu/pyenv.git ~/.pyenv</span><br><span class="line">git clone https://github.com/yyuu/pyenv-virtualenv.git ~/.pyenv/plugins/pyenv-virtualenv</span><br><span class="line">echo <span class="string">&#x27;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line">echo <span class="string">&#x27;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line">echo <span class="string">&#x27;eval &quot;$(pyenv init -)&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line">echo <span class="string">&#x27;eval &quot;$(pyenv virtualenv-init -)&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接着另开终端</span></span><br><span class="line"><span class="comment"># 不喜写兼容代码，所有代码均向 3.5+ 靠拢</span></span><br><span class="line">v=<span class="number">3.5</span><span class="number">.2</span>|wget http://mirrors.sohu.com/python/$v/Python-$v.tar.xz -P ~/.pyenv/cache/;pyenv install $v</span><br><span class="line">v=<span class="number">3.6</span><span class="number">.0</span>|wget http://mirrors.sohu.com/python/$v/Python-$v.tar.xz -P ~/.pyenv/cache/;pyenv install $v</span><br><span class="line">v=<span class="number">2.7</span><span class="number">.11</span>|wget http://mirrors.sohu.com/python/$v/Python-$v.tar.xz -P ~/.pyenv/cache/;pyenv install $v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Global Python 为 2.7.11, 备注：尽量不要把 Py3 设置为全局，否则由于 Homebrew 本身有一些依赖是依赖于 Py2 的，这样容易出现一些奇怪的问题。</span></span><br><span class="line">pyenv <span class="keyword">global</span> <span class="number">2.7</span><span class="number">.11</span></span><br><span class="line">pip install -i https://pypi.doubanio.com/simple requests</span><br><span class="line"><span class="comment"># 下面这个是用于安装基本的代码补全功能</span></span><br><span class="line">pip install -i https://pypi.doubanio.com/simple --upgrade <span class="string">&quot;jedi&gt;=0.9.0&quot;</span> <span class="string">&quot;json-rpc&gt;=1.8.1&quot;</span> <span class="string">&quot;service_factory&gt;=0.1.5&quot;</span> flake8 pytest autoflake hy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建最常用 Py3 虚拟环境</span></span><br><span class="line">pyenv virtualenv <span class="number">3.5</span><span class="number">.2</span> py3-daily</span><br><span class="line">pyenv activate py3-daily</span><br><span class="line">pip install -i https://pypi.doubanio.com/simple requests</span><br><span class="line">pip install -i https://pypi.doubanio.com/simple beatutifulsoup4</span><br><span class="line">pip install -i https://pypi.doubanio.com/simple ipython[notebook]</span><br><span class="line">pip install -i https://pypi.doubanio.com/simple jupyter</span><br><span class="line"><span class="comment"># 下面这个是用于安装基本的代码补全功能</span></span><br><span class="line">pip install -i https://pypi.doubanio.com/simple --upgrade <span class="string">&quot;jedi&gt;=0.9.0&quot;</span> <span class="string">&quot;json-rpc&gt;=1.8.1&quot;</span> <span class="string">&quot;service_factory&gt;=0.1.5&quot;</span> flake8 pytest autoflake hy</span><br></pre></td></tr></table></figure>

<p>好，Python 环境就安装完毕了。</p>
<h2 id="0x02-JavaScript-开发环境配置"><a href="#0x02-JavaScript-开发环境配置" class="headerlink" title="0x02 JavaScript 开发环境配置"></a>0x02 JavaScript 开发环境配置</h2><blockquote>
<p>本小节的目的就是配置好基本的 JS 开发环境，但估计 JSer 看了本小节依旧可以在配置上少一些麻烦。</p>
</blockquote>
<p>JS 可以前后端通吃，社区生态很丰富。ES6 之后从 python 和 ruby 里面借鉴了不少语法糖。现在写起来还是比较愉悦的。</p>
<p>JavaScript 不管开发前端应用还是后端应用，都需要安装 node 环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先安装 nvm</span></span><br><span class="line">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash</span><br><span class="line"><span class="comment"># 新开终端</span></span><br><span class="line">nvm install 8</span><br><span class="line">nvm use 8</span><br><span class="line">nvm <span class="built_in">alias</span> default 8</span><br><span class="line"></span><br><span class="line">npm install cnpm</span><br><span class="line">cnpm install yarn -g</span><br><span class="line"><span class="comment"># 设置镜像</span></span><br><span class="line">yarn config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>编辑 ~/.npmrc 配置文件，输入下文再配置各种奇奇怪怪的镜像地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">registry=https://registry.npm.taobao.org/</span><br><span class="line">chromedriver_cdnurl=http://cdn.npm.taobao.org/dist/chromedriver</span><br><span class="line">disturl=https://npm.taobao.org/dist</span><br><span class="line">operadriver_cdnurl=http://cdn.npm.taobao.org/dist/operadriver</span><br><span class="line">phantomjs_cdnurl=http://cdn.npm.taobao.org/dist/phantomjs</span><br><span class="line">fse_binary_host_mirror=https://npm.taobao.org/mirrors/fsevents</span><br><span class="line">sass_binary_site=http://cdn.npm.taobao.org/dist/node-sass</span><br><span class="line">electron_mirror=http://cdn.npm.taobao.org/dist/electron/</span><br></pre></td></tr></table></figure>

<p>配置完毕</p>
<h2 id="0x03-Docker-安装与配置"><a href="#0x03-Docker-安装与配置" class="headerlink" title="0x03 Docker 安装与配置"></a>0x03 Docker 安装与配置</h2><blockquote>
<p>本小节主要解决一个最蛋疼的问题，就是网络问题</p>
</blockquote>
<p>下载并安装 docker for mac 地址如下 <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/install/">https://docs.docker.com/docker-for-mac/install/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装成功后运行命令</span></span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<p>如果一切正常，则会显示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ docker run hello-world</span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">ca4f61b1923c: Pull complete</span><br><span class="line">Digest: sha256:083de497cff944f969d8499ab94f07134c50bcf5e6b9559b27182d3fa80ce3f7</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://cloud.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/engine/userguide/</span><br></pre></td></tr></table></figure>

<p>好，配置到这里。</p>
<p>你以为你已经配置好了，还先别激动，网络问题还没解决呢。小的镜像可以直接从 Docker 上直接拖下来，几百兆的镜像可就没这么容易了。</p>
<p>这里我们使用了阿里云的 Docker 容器镜像。</p>
<p>登录阿里云，到控制台，找到容器镜像服务，镜像加速器，</p>
<p>如下图：</p>
<p>右键点击桌面顶栏的 docker 图标，选择 Preferences ，在 Daemon 标签（Docker 17.03 之前版本为 Advanced 标签）下的 Registry mirrors 列表中将 <a target="_blank" rel="noopener" href="https://your-url.mirror.aliyuncs.com/">https://your-url.mirror.aliyuncs.com</a> 加到”registry-mirrors”的数组里，点击 Apply &amp; Restart 按钮，等待 Docker 重启并应用配置的镜像加速器。</p>
<p>Docker 配置完毕。</p>
<h2 id="0x04-项目试运行"><a href="#0x04-项目试运行" class="headerlink" title="0x04 项目试运行"></a>0x04 项目试运行</h2><p>运行项目之前，保持你我的工作环境基本一致</p>
<ul>
<li>创建一些必须的目录</li>
<li>clone 项目</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/Codes/YaBlog/DockerVolume/YaDjangoBlog/PostgreSQL/data</span><br><span class="line">mkdir -p ~/Codes/YaBlog/DockerVolume/YaDjangoBlog/Redis/data</span><br><span class="line">mkdir -p ~/Codes/YaBlog/DockerVolume/YaDjangoBlog/Backups</span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:twocucao/YaVueBlog.git</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:twocucao/YaDjangoBlog.git</span><br></pre></td></tr></table></figure>

<p>克隆下来项目之后还需要稍微折腾一下（没办法，CURD 开发 = 折腾折腾折腾 + 搬砖搬砖搬砖）</p>
<ul>
<li>运行 Vue 开发环境</li>
<li>运行 Docker 化的 django 环境</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新开一个终端 用于运行 Vue 应用</span></span><br><span class="line"><span class="comment"># 前端环境不放在 Docker 环境中。（因为开发环境没必要，生产环境才需要）</span></span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaVueBlog/ &amp;&amp; yarn &amp;&amp; <span class="built_in">cd</span> -</span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaVueBlog/packages/theme-future/ &amp;&amp; yarn &amp;&amp; <span class="built_in">cd</span> -</span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaVueBlog/</span><br><span class="line">npm run build:theme</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新开一个终端</span></span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaDjangoBlog/</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>看到下图，包含所有的命令。</p>
<p>这是我用 Makefile 编写的一系列命令，方便我在开发过程将主要的精力花在业务逻辑上而不是花时间在强记大量的琐碎的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaDjangoBlog/</span><br><span class="line">make build-all</span><br><span class="line"><span class="comment"># 等待运行后端所有组件</span></span><br></pre></td></tr></table></figure>

<p>然后，读者可以先去泡杯咖啡点个外卖吃个饭之类的。等待构建完毕。</p>
<p>需要注意的是，务必配置好 docker 镜像加速地址，否则根据国内情况，你可能需要多去泡几杯咖啡，多吃几顿饭。</p>
<p>好，接下来我们运行后端程序，首次运行需要花费不少时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaDjangoBlog/</span><br><span class="line">make django-just-up</span><br></pre></td></tr></table></figure>

<p>运行之后，终端结果如下：</p>
<p>可以发现，服务已经都开始启动了。</p>
<p>但不要冲动，先等等，因为一次开了如下的服务：</p>
<ul>
<li>postgres</li>
<li>redis</li>
<li>elasticsearch</li>
<li>mailhog</li>
<li>django</li>
<li>celerybeat</li>
<li>celeryworker</li>
<li>celeryflower</li>
</ul>
<p>需要多等会儿时间到各个服务运行正常。直到出现下图：</p>
<p>这意味着基本上所有的程序都运行正常了。如果有服务挂掉，欢迎到 github 的 issue 上提一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接着再新开一个终端 用于导入基础数据</span></span><br><span class="line"><span class="built_in">cd</span> ~/Codes/YaBlog/YaDjangoBlog/</span><br><span class="line">make django-import-articles</span><br></pre></td></tr></table></figure>

<p>好，那么，我们来验证一下如下几个地址：</p>
<ul>
<li>接口地址 <a target="_blank" rel="noopener" href="http://localhost:8000/api/v1/archive">http://localhost:8000/api/v1/archive</a></li>
<li>Vue 地址 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></li>
<li>在搜索框内输入 elasticsearch 查看接口是否正常返回数据</li>
<li>查看 celery 的 task 是否正确</li>
</ul>
<p>如果一切正常，则所有的截图应该如下</p>
<h2 id="0x05-Tmux-和-Tmuxinator"><a href="#0x05-Tmux-和-Tmuxinator" class="headerlink" title="0x05 Tmux 和 Tmuxinator"></a>0x05 Tmux 和 Tmuxinator</h2><p>我们在上文中可以发现有个极其蛋疼菊紧的问题。</p>
<p>当我们运行 make django-just-up 这个命令的时候，所有服务运行的同时，所有的标准输入都打印到一个终端。</p>
<p>这个和我们日常开发不太相同</p>
<ol>
<li>在 django 开发的时候，我们运行 runserver, 肯定是只想在那个终端里看到 runserver 的运行情况。而不是 Redis,Elasticsearch,PGsql 之类的 log。</li>
<li>并且，django 的热加载会有些小问题，有些错误只能 ctrl+c 关掉 runserver, 然后重启。但当我们想 ctrl+c 关掉 runserver 的时候，却把所有的的服务都关掉了。</li>
</ol>
<p>解决方式也简单：</p>
<p>对于暂时不想在开发时看到日志的服务，干脆直接放后台运行，执行我封装的命令 make django-before-up 把部分服务直接放在后台里，然后再开四个终端，运行下面的命令。</p>
<ul>
<li>make django-runserver # 运行 runserver , 并只把该容器的 log 打印出来。下面三者同上。</li>
<li>make django-celerybeat</li>
<li>make django-celeryworker</li>
<li>make django-celeryflower</li>
</ul>
<p>显然还是很麻烦，我这种懒人可是能少写几行代码就少些几行代码的。</p>
<p>那么我们还可以更省事（懒一些）么？</p>
<p>我之前写了一篇简单的 tmux 与 Tmuxinator 教程 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33369297">https://zhuanlan.zhihu.com/p/33369297</a> , 具体配置步骤参考文中即可。</p>
<p>配置好 Tmuxinator 之后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先软连接一下</span></span><br><span class="line">ln -svf ~/Codes/YaBlog/YaDjangoBlog/yadjangoblog.yml ~/.tmuxinator/yadjangoblog.yml</span><br></pre></td></tr></table></figure>

<p>当我需要运行的所有服务的时候，我只需要</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmuxinator start yadjangoblog</span><br></pre></td></tr></table></figure>
<p>就可以开启所有命令。</p>
<p>yadjangoblog.yml 的内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">windows:</span><br><span class="line">  - &quot;前端-页面开发&quot;:</span><br><span class="line">      root: ~&#x2F;Codes&#x2F;YaBlog&#x2F;YaVueBlog&#x2F;</span><br><span class="line">      layout: main-vertical</span><br><span class="line">      panes:</span><br><span class="line">        - &quot;前端页面 DEV&quot;:</span><br><span class="line">          - &quot;npm run dev&quot;</span><br><span class="line">  - &quot;前端-CSS 与字体文件&quot;:</span><br><span class="line">      root: ~&#x2F;Codes&#x2F;YaBlog&#x2F;YaVueBlog&#x2F;</span><br><span class="line">      layout: main-vertical</span><br><span class="line">      panes:</span><br><span class="line">        - &quot;npm run dev:theme&quot;</span><br><span class="line">        - &quot;npm run dev:iconfont&quot;</span><br><span class="line">  - &quot;后端-Django 及其服务&quot;:</span><br><span class="line">      root: ~&#x2F;Codes&#x2F;YaBlog&#x2F;YaDjangoBlog&#x2F;</span><br><span class="line">      layout: main-vertical</span><br><span class="line">      panes:</span><br><span class="line">        - &quot;make django-before-up &amp;&amp; make django-runserver&quot;</span><br><span class="line">  - &quot;后端-数据库相关&quot;:</span><br><span class="line">      layout: main-vertical</span><br><span class="line">      root: ~&#x2F;Codes&#x2F;YaBlog&#x2F;YaDjangoBlog&#x2F;</span><br><span class="line">      panes:</span><br><span class="line">        - &quot;sleep 20 &amp;&amp; make dbshell&quot;</span><br><span class="line">        - &quot;sleep 20 &amp;&amp; make shell&quot;</span><br><span class="line">  - &quot;后端-Celery&quot;:</span><br><span class="line">      layout: main-vertical</span><br><span class="line">      root: ~&#x2F;Codes&#x2F;YaBlog&#x2F;YaDjangoBlog&#x2F;</span><br><span class="line">      panes:</span><br><span class="line">        - &quot;sleep 20 &amp;&amp; make django-celerybeat&quot;</span><br><span class="line">        - &quot;sleep 20 &amp;&amp; make django-celeryworker&quot;</span><br></pre></td></tr></table></figure>

<h2 id="0x06-PyCharm-基本设置"><a href="#0x06-PyCharm-基本设置" class="headerlink" title="0x06 PyCharm 基本设置"></a>0x06 PyCharm 基本设置</h2><blockquote>
<p>大家应该都用 PyCharm 进行开发了吧。 如果是的话，不看本小节可能会让你栽个跟头</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这步是给 pycharm 打开代码做准备</span></span><br><span class="line">pyenv activate py3-daily</span><br><span class="line">pip install -i https://pypi.doubanio.com/simple -r requirements/local.txt</span><br></pre></td></tr></table></figure>

<p>务必完成下面两个步骤</p>
<ol>
<li>在 Preferences -&gt; project -&gt; interpreter 选择对应的 py3-daily 虚拟环境。</li>
<li>在侧边栏把 yadjangoblog , 注意小写的。右键标记为 sources root</li>
</ol>
<p>这样的标记相当于告诉 PyCharm , 这个项目的 PYTHONPATH 是 yadjangoblog/ , 否则使用 PyCharm 导入 AModel 会自动导入 from yadjangoblog.yaadmin.models from AModel 而不是 from yaadmin.models import AModel , 这会导致程序运行错误。</p>
<blockquote>
<p>PS: 包括后面跑单元测试的时候，均手动设置了 PYTHONPATH 变量。</p>
</blockquote>
<h2 id="0x07-开发流程"><a href="#0x07-开发流程" class="headerlink" title="0x07 开发流程"></a>0x07 开发流程</h2><p>本小节，从笔者开机开始，回顾一下环境配置好之后，笔者是如何进入开发状态的：</p>
<ol>
<li>开机。输入密码进入桌面。</li>
<li>打开 Iterm, 运行 tmuxinator start yadjangoblog 开启项目。打开 PyCharm 和 WebStorm</li>
<li>开发</li>
</ol>
<ul>
<li>在 WebStorm 中写写前端代码，在 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> 和 tmux 里的第一个 window 查看状态</li>
<li>在 PyCharm 中写写后端代码，在第三个 window 查看 runserver 状态，在第四个 window 的两个 Panel 运行 python manage.py 相关命令。</li>
<li>在 Chrome Elasticsearch Head 扩展里调试 Elasticsearch 语法</li>
<li>在 <a target="_blank" rel="noopener" href="http://localhost:8000/api/your-api-path">http://localhost:8000/api/your-api-path</a> 里调试前后端 API</li>
<li>在 <a target="_blank" rel="noopener" href="http://localhost:5555/">http://localhost:5555</a> 通过 flower 查看相关</li>
<li>…..</li>
<li>当然，你也可以新开一个终端里面，执行 make 查看相关还可以执行哪些命令。</li>
</ul>
<p>那么，具体执行这些命令背后究竟发生了什么？</p>
<ul>
<li>数十服务为何突然启动</li>
<li>数百个任务为何半夜消失</li>
<li>正常运行的服务为何屡屡崩溃</li>
<li>这一切的背后！是工程师的人性扭曲还是码畜的道德沦丧？是内存的爆发还是处理器的无奈？</li>
<li>敬请关注本专栏 『MG 的编程小屋』或者 Github 频道，让我们跟随教程走进全干工程师的代码世界。</li>
</ul>
<blockquote>
<p>不好意思，顺手打了个硬广，防止别人把我的文章砍头去尾直接扒过去。</p>
</blockquote>
<h2 id="0xEE-参考链接"><a href="#0xEE-参考链接" class="headerlink" title="0xEE. 参考链接"></a>0xEE. 参考链接</h2><p>还犹豫啥，点赞后，快上车吧</p>
<ul>
<li>前端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaVueBlog">https://github.com/twocucao/YaVueBlog</a></li>
<li>后端代码 <a target="_blank" rel="noopener" href="https://github.com/twocucao/YaDjangoBlog">https://github.com/twocucao/YaDjangoBlog</a></li>
</ul>
<hr>
<p>ChangeLog:</p>
<ul>
<li><strong>2018-02-22</strong> 重修文字</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Micheal Gardner</p>
  <div class="site-description" itemprop="description">Two roads diverged in a wood, and I took the one less traveled by, And that has made all the difference.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">96</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Micheal Gardner</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




  















  

  

</body>
</html>
