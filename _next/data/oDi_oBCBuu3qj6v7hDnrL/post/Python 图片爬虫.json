{"pageProps":{"post":{"tags":["Python"],"path":"20150309_图片爬虫.md","title":"Python 图片爬虫","slug":"Python 图片爬虫","date":"2017-12-01","category":"Python","lastMod":"2020-01-01","description":"这篇文章展示了基本的 Markdown 语法和格式.","thumbnail":"","content":"<h1 id=\"python-图片爬虫\"><a class=\"v-toc-item\" href=\"#python-图片爬虫\">#</a> Python 图片爬虫</h1>\n<h2 id=\"0x00-前言\"><a class=\"v-toc-item\" href=\"#0x00-前言\">#</a> 0x00 前言</h2>\n<p>在平时抓取部分自己喜欢的资源的时候，我们常常会去下载一些比较有用的资源，比如，我比较喜欢 GEM 的照片，但是，这个东西，总不能总是去找别人要吧，那么，怎么办？</p>\n<p>很简单，我们只需要通过 Python 写一个小小的爬虫就可以解决这些问题。</p>\n<p>什么是爬虫？自己可以百度去。</p>\n<p>我这里指的爬虫是那些可以模拟浏览器的行为的小程序。</p>\n<p>比如，我要抓取 G.E.M 的相片，那么，我就想个办法。把图片的地址解析出来。然后写一个小功能下载不就好了么。</p>\n<!--more-->\n<p>虽然，话是这么说，</p>\n<p>但，怎么下手？</p>\n<p>这在写这篇文章，并且写到这里的时候，刚刚决定了抓取几个站点</p>\n<p>（刚刚百度了 邓紫棋壁纸 得到这个网站 <a href=\"http://www.6188.com/show/12788_1.html\">http://www.6188.com/show/12788_1.html</a>)</p>\n<h2 id=\"0x01-准备工作以及爬取思路\"><a class=\"v-toc-item\" href=\"#0x01-准备工作以及爬取思路\">#</a> 0x01 准备工作以及爬取思路</h2>\n<p>Python3,Chrome 浏览器或者 Firefox,<br>\nPython3 基本依赖库 beautifulsoup4 lxml</p>\n<p>任务如下：</p>\n<ol>\n<li>\n<p>第一个简单案例 <a href=\"http://www.6188.com/show/12788_1.html\">http://www.6188.com/show/12788_1.html</a></p>\n</li>\n<li>\n<p>百度 API 解析</p>\n</li>\n<li>\n<p>虾米照片爬取</p>\n</li>\n</ol>\n<p>4.instagram 墙外下载 Gem 照片</p>\n<ol start=\"5\">\n<li>发烧级别的 GEM 粉丝 - 虾米网 down! down! down!</li>\n</ol>\n<p>涉及到的知识点：</p>\n<ol>\n<li>爬虫的最最基本思路</li>\n<li>几个解析方法 正则解析，bs4 解析，lxml 解析</li>\n<li>多线程使用</li>\n</ol>\n<h2 id=\"0x02-6188com-壁纸抓取-关键词爬虫\"><a class=\"v-toc-item\" href=\"#0x02-6188com-壁纸抓取-关键词爬虫\">#</a> 0x02 <a href=\"http://6188.com\">6188.com</a> 壁纸抓取 – 关键词爬虫</h2>\n<p>先说一下思路，首先，你要会点击下载按钮.(#-#)</p>\n<ol>\n<li>\n<p>访问 <a href=\"http://www.6188.com/show/12788_1.html\">http://www.6188.com/show/12788_1.html</a></p>\n</li>\n<li>\n<p>点击下载大图</p>\n</li>\n<li>\n<p>看大图，手动另存为</p>\n</li>\n</ol>\n<p>这是普通人下载图片的方式。</p>\n<p>让我们用程序员的眼光来看。</p>\n<p>浏览器呈现的具体的过程可以看我的 PyDjango 中关于计算机 Http 协议的部分。</p>\n<p>经过抓包 (http 包）分析 (chrome 的 F12), 知道，要想获取图片原始链接，有这么一个流程</p>\n<p>从 <a href=\"http://www.6188.com/show/12788_1.html\">http://www.6188.com/show/12788_1.html</a> 解析出下面链接</p>\n<p>从 <a href=\"http://www.6188.com/show.php?pic=/flashAll/20140211/1392111065nvjKS7.jpg\">http://www.6188.com/show.php?pic=/flashAll/20140211/1392111065nvjKS7.jpg</a> 解析下面链接</p>\n<p>从 <a href=\"http://pic.6188.com/upload_6188s/flashAll/20140211/1392111065nvjKS7.jpg\">http://pic.6188.com/upload_6188s/flashAll/20140211/1392111065nvjKS7.jpg</a> 下载图片。</p>\n<p>这样一看，非常简单明了。这就是下载一张图片的链接。</p>\n<p>同样道理，把下面的程序写成一个 for 循环，就可以直接下载 35 张图片。</p>\n<pre><code class=\"language-html\">http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span><span class=\"token number\">6188.</span>com<span class=\"token operator\">/</span>show<span class=\"token operator\">/</span><span class=\"token number\">12788_1.</span>html http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span><span class=\"token number\">6188.</span>com<span class=\"token operator\">/</span>show<span class=\"token operator\">/</span><span class=\"token number\">12788_2.</span>html\nhttp<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span><span class=\"token number\">6188.</span>com<span class=\"token operator\">/</span>show<span class=\"token operator\">/</span><span class=\"token number\">12788_3.</span>html <span class=\"token operator\">...</span> http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span><span class=\"token number\">6188.</span>com<span class=\"token operator\">/</span>show<span class=\"token operator\">/</span><span class=\"token number\">12788_35.</span>html\n</code></pre>\n<p>写的应该比较容易认出</p>\n<pre><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> re\n<span class=\"token keyword\">import</span> requests\n\n__author__ <span class=\"token operator\">=</span> <span class=\"token string\">'micheal'</span>\n\nr <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://www.6188.com/show/12788_1.html\"</span><span class=\"token punctuation\">)</span>\nm <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(/show\\.php.+jpg)\\\"\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\npic_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://www.6188.com\"</span> <span class=\"token operator\">+</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ndata <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>pic_url<span class=\"token punctuation\">)</span>\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\nm <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"src='(http://.+\\.jpg)\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\nreal_url <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">try</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"real_url-- 正在下载 --\"</span><span class=\"token operator\">+</span>real_url<span class=\"token punctuation\">)</span>\n    r <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>real_url<span class=\"token punctuation\">,</span>stream<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span>\n    fileName <span class=\"token operator\">=</span> <span class=\"token string\">\"GEM.jpg\"</span>\n    fileFullPath <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/home/micheal/Pictures/'</span><span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"正在下载\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">with</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>fileFullPath<span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token operator\">:</span>\n        <span class=\"token keyword\">for</span> chunk <span class=\"token keyword\">in</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">iter_content</span><span class=\"token punctuation\">(</span>chunk_size<span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n            <span class=\"token keyword\">if</span> chunk<span class=\"token operator\">:</span> # filter out keep<span class=\"token operator\">-</span>alive <span class=\"token keyword\">new</span> <span class=\"token class-name\">chunks</span>\n                f<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span>\n                f<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    pass\nexcept Exception<span class=\"token operator\">:</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"出错\"</span><span class=\"token punctuation\">)</span>\n    raise\n\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"任务完成\"</span><span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>添加 For 循环，优化一下</p>\n<pre><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> re\n<span class=\"token keyword\">import</span> requests\n\n__author__ <span class=\"token operator\">=</span> <span class=\"token string\">'micheal'</span>\n\ns <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> # 仿真 browser 使用一个会话\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    html_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://www.6188.com/show/12788_\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\".html\"</span>\n    r <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>html_url<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"downloading\"</span> <span class=\"token operator\">+</span> html_url<span class=\"token punctuation\">)</span>\n    m <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(/show\\.php.+jpg)\\\"\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n    pic_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://www.6188.com\"</span> <span class=\"token operator\">+</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    data <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>pic_url<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n    m <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"src='(http://.+\\.jpg)\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    real_url <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token operator\">:</span>\n        img_store_dir <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/micheal/Pictures/GEM/6188\"</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"real_url-- 正在下载 --\"</span><span class=\"token operator\">+</span>real_url<span class=\"token punctuation\">)</span>\n        r <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>real_url<span class=\"token punctuation\">,</span>stream<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span>\n        fileName <span class=\"token operator\">=</span> <span class=\"token string\">\"GEM\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\".jpg\"</span>\n        <span class=\"token keyword\">if</span> not os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n            os<span class=\"token punctuation\">.</span><span class=\"token function\">makedirs</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">)</span>\n        fileFullPath <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"正在下载\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">with</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>fileFullPath<span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token operator\">:</span>\n            <span class=\"token keyword\">for</span> chunk <span class=\"token keyword\">in</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">iter_content</span><span class=\"token punctuation\">(</span>chunk_size<span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n                <span class=\"token keyword\">if</span> chunk<span class=\"token operator\">:</span> # filter out keep<span class=\"token operator\">-</span>alive <span class=\"token keyword\">new</span> <span class=\"token class-name\">chunks</span>\n                    f<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span>\n                    f<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        pass\n    except Exception<span class=\"token operator\">:</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"出错\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">continue</span>\n    finally<span class=\"token operator\">:</span>\n        pass\n\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"任务完成\"</span><span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>###评价</p>\n<p>第一个小程序应该是非常容易看懂的。</p>\n<p>那么，这个程序有什么缺点呢？</p>\n<ul>\n<li>下载速度太慢，需要使用多线程，</li>\n<li>解析方法不具有通用性，这张网页中只有一个地址需要解析，所以正则表达式还是可以胜任。但是，复杂的网页肯定不行</li>\n<li>下载的图片太少了。</li>\n</ul>\n<h2 id=\"0x03-百度-api-的解析-关键词多线程\"><a class=\"v-toc-item\" href=\"#0x03-百度-api-的解析-关键词多线程\">#</a> 0x03 百度 API 的解析 – 关键词多线程</h2>\n<p>主要就是增加了一个多线程的任务，原理什么的基本上和上面那个的相似</p>\n<pre><code class=\"language-python\"><span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> os\nfrom queue <span class=\"token keyword\">import</span> Queue\n<span class=\"token keyword\">import</span> re\n<span class=\"token keyword\">import</span> threading\n<span class=\"token keyword\">import</span> requests\n\n__author__ <span class=\"token operator\">=</span> <span class=\"token string\">'micheal'</span>\n\nq <span class=\"token operator\">=</span> <span class=\"token function\">Queue</span><span class=\"token punctuation\">(</span>maxsize<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n# http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>image<span class=\"token punctuation\">.</span>baidu<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>i<span class=\"token operator\">?</span>tn<span class=\"token operator\">=</span>resultjsonavatarnew<span class=\"token operator\">&amp;</span>ie<span class=\"token operator\">=</span>utf<span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token operator\">&amp;</span>word<span class=\"token operator\">=</span><span class=\"token operator\">%</span><span class=\"token constant\">E9</span><span class=\"token operator\">%</span><span class=\"token number\">82</span><span class=\"token operator\">%</span><span class=\"token number\">93</span><span class=\"token operator\">%</span><span class=\"token constant\">E7</span><span class=\"token operator\">%</span><span class=\"token constant\">B4</span><span class=\"token operator\">%</span><span class=\"token constant\">AB</span><span class=\"token operator\">%</span><span class=\"token constant\">E6</span><span class=\"token operator\">%</span><span class=\"token constant\">A3</span><span class=\"token operator\">%</span><span class=\"token number\">8</span>B<span class=\"token operator\">&amp;</span>cg<span class=\"token operator\">=</span>star<span class=\"token operator\">&amp;</span>pn<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token operator\">&amp;</span>rn<span class=\"token operator\">=</span><span class=\"token number\">60</span>\n\ns <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\ndef <span class=\"token function\">worker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">while</span> True<span class=\"token operator\">:</span>\n        <span class=\"token keyword\">try</span><span class=\"token operator\">:</span>\n            real_url <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"正在下载\"</span> <span class=\"token operator\">+</span> real_url<span class=\"token punctuation\">)</span>\n\n            img_store_dir <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/micheal/Pictures/GEM/baidu\"</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"real_url-- 正在下载 --\"</span><span class=\"token operator\">+</span>real_url<span class=\"token punctuation\">)</span>\n            r <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>real_url<span class=\"token punctuation\">,</span>stream<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span>\n            fileName <span class=\"token operator\">=</span> real_url<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> not os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n                os<span class=\"token punctuation\">.</span><span class=\"token function\">makedirs</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">)</span>\n            fileFullPath <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>img_store_dir<span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"正在下载\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">str</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>status_code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">with</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>fileFullPath<span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token operator\">:</span>\n                <span class=\"token keyword\">for</span> chunk <span class=\"token keyword\">in</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">iter_content</span><span class=\"token punctuation\">(</span>chunk_size<span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n                    <span class=\"token keyword\">if</span> chunk<span class=\"token operator\">:</span> # filter out keep<span class=\"token operator\">-</span>alive <span class=\"token keyword\">new</span> <span class=\"token class-name\">chunks</span>\n                        f<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span>\n                        f<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            pass\n        except Exception <span class=\"token keyword\">as</span> e<span class=\"token operator\">:</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"出错\"</span><span class=\"token punctuation\">)</span>\n            raise e\n            <span class=\"token keyword\">continue</span>\n\n        finally<span class=\"token operator\">:</span>\n            pass\n\n        q<span class=\"token punctuation\">.</span><span class=\"token function\">task_done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    pass\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token operator\">:</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n        fr <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> <span class=\"token number\">60</span>\n        to <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span>\n        r <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://image.baidu.com/i?tn=resultjsonavatarnew&amp;ie=utf-8&amp;word=%E9%82%93%E7%B4%AB%E6%A3%8B&amp;cg=star&amp;pn=\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>fr<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"&amp;rn=\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"&amp;itg=1&amp;z=3&amp;fr=&amp;width=0&amp;height=0&amp;lm=-1&amp;ic=0&amp;s=0&amp;st=-1\"</span><span class=\"token punctuation\">)</span>\n        data <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span><span class=\"token function\">loads</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n            real_url <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">'imgs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'objURL'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>real_url<span class=\"token punctuation\">)</span>\n            q<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>real_url<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n            t <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span><span class=\"token function\">Thread</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>worker<span class=\"token punctuation\">)</span>\n            t<span class=\"token punctuation\">.</span>daemon <span class=\"token operator\">=</span> True\n            t<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nq<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"任务完成\"</span><span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>引入了多线程，但是抓取效果并不好，大概有 10% 左右的照片可能是有点问题的，把线程数目从 20 条调整小一些。</p>\n<p>先写到这里，明天接着写剩下来的代码。</p>\n<h2 id=\"0x04-抓取虾米的相册-反反爬虫\"><a class=\"v-toc-item\" href=\"#0x04-抓取虾米的相册-反反爬虫\">#</a> 0x04 抓取虾米的相册 – 反反爬虫</h2>\n<p>好吧，我们将魔手伸向了虾米音乐的图片板块</p>\n<p><a href=\"http://www.xiami.com/artist/pic-55712\">http://www.xiami.com/artist/pic-55712</a></p>\n<p>我们尝试使用昨天的方法获取页面。</p>\n<pre><code class=\"language-python\">ss <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> ss<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>“http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>xiami<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>artist<span class=\"token operator\">/</span>pic<span class=\"token operator\">-</span><span class=\"token number\">55712</span><span class=\"token operator\">?</span>spm<span class=\"token operator\">=</span><span class=\"token number\">0.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token punctuation\">.</span>IaKt5o<span class=\"token operator\">&amp;</span>page<span class=\"token operator\">=</span><span class=\"token number\">3</span>”<span class=\"token punctuation\">)</span>\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>但是出现问题了，</p>\n<pre><code class=\"language-html\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token constant\">DOCTYPE</span> <span class=\"token constant\">HTML</span> <span class=\"token constant\">PUBLIC</span> “<span class=\"token operator\">-</span><span class=\"token comment\">//IETF//DTD HTML 2.0//EN”></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">400</span> Bad Request<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body bgcolor<span class=\"token operator\">=</span>”white”<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n<span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">)</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>“script”<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>firstChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span>“exparams”<span class=\"token punctuation\">,</span>”category<span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span>userid<span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span>aplus<span class=\"token operator\">&amp;</span>yunid<span class=\"token operator\">=</span><span class=\"token operator\">&amp;&amp;</span>asid<span class=\"token operator\">=</span>AABI4v5USkJh1pUp01o<span class=\"token operator\">=</span>”<span class=\"token punctuation\">,</span>id<span class=\"token operator\">=</span>”tb<span class=\"token operator\">-</span>beacon<span class=\"token operator\">-</span>aplus”<span class=\"token punctuation\">,</span>src<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>location<span class=\"token operator\">></span>”https”<span class=\"token operator\">?</span>”<span class=\"token comment\">//s”:”//a”)+”.tbcdn.cn/s/aplus_v2.js”)</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span><span class=\"token number\">400</span> Bad Request<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>Your browser sent a request that <span class=\"token keyword\">this</span> server could not understand<span class=\"token punctuation\">.</span> Sorry <span class=\"token keyword\">for</span> the inconvenience<span class=\"token punctuation\">.</span><span class=\"token operator\">&lt;</span>br<span class=\"token operator\">/</span><span class=\"token operator\">></span>\nPlease report <span class=\"token keyword\">this</span> message and include the following information to us<span class=\"token punctuation\">.</span><span class=\"token operator\">&lt;</span>br<span class=\"token operator\">/</span><span class=\"token operator\">></span>\nThank you very much<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token constant\">URL</span><span class=\"token operator\">:</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>www<span class=\"token punctuation\">.</span>xiami<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>artist<span class=\"token operator\">/</span>pic<span class=\"token operator\">-</span><span class=\"token number\">55712</span><span class=\"token operator\">?</span>spm<span class=\"token operator\">=</span><span class=\"token number\">0.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token punctuation\">.</span>IaKt5o<span class=\"token operator\">&amp;</span>amp<span class=\"token punctuation\">;</span>page<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>Server<span class=\"token operator\">:</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>web<span class=\"token operator\">-</span>xiami<span class=\"token operator\">-</span>main<span class=\"token operator\">-</span><span class=\"token number\">030.</span>cm10<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>Date<span class=\"token operator\">:</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token number\">2015</span><span class=\"token operator\">/</span><span class=\"token number\">03</span><span class=\"token operator\">/</span><span class=\"token number\">10</span> <span class=\"token number\">20</span><span class=\"token operator\">:</span><span class=\"token number\">23</span><span class=\"token operator\">:</span><span class=\"token number\">36</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>hr<span class=\"token operator\">/</span><span class=\"token operator\">></span>Powered by Tengine<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span>\n\nProcess finished <span class=\"token keyword\">with</span> exit code <span class=\"token number\">0</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span>\n</code></pre>\n<p>我们前面使用的代码都是爬取一些没有做太多防止爬虫的网站，但是，我们今天准备爬取的是一个有防护措施的网站。</p>\n<p>没办法，修改一下 headers, 然后继续访问即可。</p>\n<h2 id=\"0xee-更新\"><a class=\"v-toc-item\" href=\"#0xee-更新\">#</a> 0xEE 更新</h2>\n<hr>\n<p>ChangeLog:</p>\n<ul>\n<li><strong>2017-12-19</strong> 重修文字</li>\n</ul>\n","toc":"<ul class=\"v-article-toc\">\n<li><a href=\"#python-%E5%9B%BE%E7%89%87%E7%88%AC%E8%99%AB\">Python 图片爬虫</a>\n<ul>\n<li><a href=\"#0x00-%E5%89%8D%E8%A8%80\">0x00 前言</a></li>\n<li><a href=\"#0x01-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%88%AC%E5%8F%96%E6%80%9D%E8%B7%AF\">0x01 准备工作以及爬取思路</a></li>\n<li><a href=\"#0x02-6188com-%E5%A3%81%E7%BA%B8%E6%8A%93%E5%8F%96-%E5%85%B3%E9%94%AE%E8%AF%8D%E7%88%AC%E8%99%AB\">0x02 6188.com 壁纸抓取 – 关键词爬虫</a></li>\n<li><a href=\"#0x03-%E7%99%BE%E5%BA%A6-api-%E7%9A%84%E8%A7%A3%E6%9E%90-%E5%85%B3%E9%94%AE%E8%AF%8D%E5%A4%9A%E7%BA%BF%E7%A8%8B\">0x03 百度 API 的解析 – 关键词多线程</a></li>\n<li><a href=\"#0x04-%E6%8A%93%E5%8F%96%E8%99%BE%E7%B1%B3%E7%9A%84%E7%9B%B8%E5%86%8C-%E5%8F%8D%E5%8F%8D%E7%88%AC%E8%99%AB\">0x04 抓取虾米的相册 – 反反爬虫</a></li>\n<li><a href=\"#0xee-%E6%9B%B4%E6%96%B0\">0xEE 更新</a></li>\n</ul>\n</li>\n</ul>\n"}},"__N_SSG":true}